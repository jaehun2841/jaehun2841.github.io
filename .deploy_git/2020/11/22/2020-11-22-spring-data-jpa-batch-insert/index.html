<!DOCTYPE html><html lang="lang"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Spring JPA Batch Insert 과연 생각대로 동작할까?"><meta name="keywords" content="Spring,JPA"><meta name="author" content="Carrey"><meta name="copyright" content="Carrey"><title>Spring JPA Batch Insert 과연 생각대로 동작할까? | Carrey`s 기술블로그</title><link rel="shortcut icon" href="../../../../melody-favicon.ico"><link rel="stylesheet" href="../../../../css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.0.0'
} </script><meta name="generator" content="Hexo 6.0.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0"><span class="toc-number">1.</span> <span class="toc-text">들어가며</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Batch-Insert-%EC%99%9C-insert-%ED%95%98%EB%82%98%EC%97%90-%EC%95%88%ED%95%A9%EC%B3%90%EC%A0%B8"><span class="toc-number">2.</span> <span class="toc-text">Batch Insert? 왜 insert 하나에 안합쳐져?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#JDBC-Batching"><span class="toc-number">3.</span> <span class="toc-text">JDBC Batching</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JDBC-Options"><span class="toc-number">3.1.</span> <span class="toc-text">JDBC Options</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#hibernate-jdbc-batch-size"><span class="toc-number">3.1.1.</span> <span class="toc-text">hibernate.jdbc.batch_size</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#hibernate-order-inserts-hibernate-order-updates"><span class="toc-number">3.1.2.</span> <span class="toc-text">hibernate.order_inserts, hibernate.order_updates</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#rewrite-%EC%98%B5%EC%85%98"><span class="toc-number">4.</span> <span class="toc-text">rewrite 옵션</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%A3%BC%EC%9D%98%ED%95%A0-%EC%A0%90"><span class="toc-number">5.</span> <span class="toc-text">주의할 점</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#JPA%EC%97%90%EC%84%9C-ID-%EC%B1%84%EB%B2%88-%EB%B0%A9%EC%8B%9D%EC%9D%84-GenerateType-IDENDITY-%EC%82%AC%EC%9A%A9-%EC%8B%9C-batch-insert%EB%A5%BC-%ED%95%A0-%EC%88%98-%EC%97%86%EB%8B%A4"><span class="toc-number">5.1.</span> <span class="toc-text">JPA에서 ID 채번 방식을 GenerateType.IDENDITY 사용 시 batch insert를 할 수 없다</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MySQL%EC%9D%98-%EA%B2%BD%EC%9A%B0-max-allowed-packet-%EA%B0%92%EC%9D%84-%EA%B3%A0%EB%A0%A4%ED%95%B4%EC%84%9C-%EC%8D%A8%EC%95%BC%ED%95%9C%EB%8B%A4"><span class="toc-number">5.2.</span> <span class="toc-text">MySQL의 경우 max_allowed_packet 값을 고려해서 써야한다.</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#SequenceGenerator%EC%9D%98-%EC%B1%84%EB%B2%88-%EB%B0%A9%EC%8B%9D%EC%9D%84-%EB%B3%80%EA%B2%BD%ED%95%B4%EC%84%9C-%EC%82%AC%EC%9A%A9%ED%95%98%EB%9D%BC"><span class="toc-number">6.</span> <span class="toc-text">SequenceGenerator의 채번 방식을 변경해서 사용하라</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#pooled-lo-optimizer%EB%A5%BC-%EC%A0%81%EC%9A%A9%ED%95%9C-%EC%BD%94%EB%93%9C"><span class="toc-number">7.</span> <span class="toc-text">pooled-lo optimizer를 적용한 코드</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%84%B1%EB%8A%A5-%EB%B9%84%EA%B5%90"><span class="toc-number">8.</span> <span class="toc-text">성능 비교</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#application-yml-%EC%84%A4%EC%A0%95-%EC%BD%94%EB%93%9C"><span class="toc-number">9.</span> <span class="toc-text">application.yml 설정 코드</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%B0%B8%EA%B3%A0"><span class="toc-number">10.</span> <span class="toc-text">참고</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://www.gravatar.com/avatar/3f8583b7b0f0c1ebd249dffad42707af?s=300"></div><div class="author-info__name text-center">Carrey</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="../../../../archives"><span class="pull-left">Articles</span><span class="pull-right">112</span></a><a class="author-info-articles__tags article-meta" href="../../../../tags"><span class="pull-left">Tags</span><span class="pull-right">27</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="../../../../index.html">Carrey`s 기술블로그</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Spring JPA Batch Insert 과연 생각대로 동작할까?</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2020-11-22</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="들어가며"><a href="#들어가며" class="headerlink" title="들어가며"></a>들어가며</h1><p>Spring JPA를 사용하며 대량으로 insert 시, 1건씩 insert 되기에 성능이 너무 안나온다고 생각을 하고 있었습니다.<br>그래서 초반에는 bulk insert와 같은 키워드로 검색을 해보니 Hibernate Batch Insert라는 내용이 있어<br>그대로 설정을 해보았으나 1건씩 insert 되기는 마찬가지였습니다.  </p>
<p>다른 사람들이 작성한 블로그를 읽어보면 뭔가 되는듯 한데, 나만 안되는 건가? 라는 생각이 들었고<br>끝내 원하던 방법을 찾아 그 내용을 공유하는 글을 작성하게 되었습니다. </p>
<p>예제 코드는 아래 github에 있습니다.<br><a target="_blank" rel="noopener" href="https://github.com/jaehun2841/spring-jpa-batch-insert-test">https://github.com/jaehun2841/spring-jpa-batch-insert-test</a></p>
<h1 id="Batch-Insert-왜-insert-하나에-안합쳐져"><a href="#Batch-Insert-왜-insert-하나에-안합쳐져" class="headerlink" title="Batch Insert? 왜 insert 하나에 안합쳐져?"></a>Batch Insert? 왜 insert 하나에 안합쳐져?</h1><p>대부분 Insert 구문은 아래와 같이 사용됩니다</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;e8e6255c-bd9b-4310-af8b-72ab1ce31259&#x27;</span>, <span class="number">620000</span>);</span><br></pre></td></tr></table></figure>



<p>우리는 모두 많은 데이터를 입력할 시, 아래와 방법처럼 insert 구문을 실행하지 않고</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;6c5fe953-ec38-4b26-b2f7-29a389cb8c03&#x27;</span>, <span class="number">619988</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;1959cb84-1dd5-42cc-95c1-8fd501881f1f&#x27;</span>, <span class="number">619989</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;daf8073e-78ea-435c-ac36-ac0796c4c283&#x27;</span>, <span class="number">619990</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;b98761f6-5f0b-448c-8f7f-aeffc22032d6&#x27;</span>, <span class="number">619991</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;9a740e9c-2249-4c05-9349-9118c5825755&#x27;</span>, <span class="number">619992</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;d1b0e19c-9002-40d9-a43c-ae5e7293a7f4&#x27;</span>, <span class="number">619993</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;5ac02554-a877-4d1e-93b1-3f15bb58261c&#x27;</span>, <span class="number">619994</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;36673f68-3c56-4be6-8e09-3d970d5f361e&#x27;</span>, <span class="number">619995</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;9d64f853-bd04-4ace-ba14-acc072f19729&#x27;</span>, <span class="number">619996</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;37190885-c1e7-4417-b545-f78130854acf&#x27;</span>, <span class="number">619997</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;fa7dc828-8aeb-45f1-9e80-8843890fd527&#x27;</span>, <span class="number">619998</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;6e860c36-00f5-4349-952c-f7c09dfcc263&#x27;</span>, <span class="number">619999</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;e8e6255c-bd9b-4310-af8b-72ab1ce31259&#x27;</span>, <span class="number">620000</span>);</span><br></pre></td></tr></table></figure>



<p>이와 같이 멀티라인 insert가 효율이 더 좋음을 알고 있기에, 이러한 방법을 사용할 것입니다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> </span><br><span class="line">(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;6c5fe953-ec38-4b26-b2f7-29a389cb8c03&#x27;</span>, <span class="number">619988</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;1959cb84-1dd5-42cc-95c1-8fd501881f1f&#x27;</span>, <span class="number">619989</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;daf8073e-78ea-435c-ac36-ac0796c4c283&#x27;</span>, <span class="number">619990</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;b98761f6-5f0b-448c-8f7f-aeffc22032d6&#x27;</span>, <span class="number">619991</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;9a740e9c-2249-4c05-9349-9118c5825755&#x27;</span>, <span class="number">619992</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;d1b0e19c-9002-40d9-a43c-ae5e7293a7f4&#x27;</span>, <span class="number">619993</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;5ac02554-a877-4d1e-93b1-3f15bb58261c&#x27;</span>, <span class="number">619994</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;36673f68-3c56-4be6-8e09-3d970d5f361e&#x27;</span>, <span class="number">619995</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;9d64f853-bd04-4ace-ba14-acc072f19729&#x27;</span>, <span class="number">619996</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;37190885-c1e7-4417-b545-f78130854acf&#x27;</span>, <span class="number">619997</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;fa7dc828-8aeb-45f1-9e80-8843890fd527&#x27;</span>, <span class="number">619998</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;6e860c36-00f5-4349-952c-f7c09dfcc263&#x27;</span>, <span class="number">619999</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;e8e6255c-bd9b-4310-af8b-72ab1ce31259&#x27;</span>, <span class="number">620000</span>);</span><br></pre></td></tr></table></figure>

<p>처음에 Hibernate에서 제공하는 batch insert가 이와 같은 기능인 줄 <strong>착각</strong> 하여 이런 기능을 제공하지 않는 줄 알았습니다.</p>
<h1 id="JDBC-Batching"><a href="#JDBC-Batching" class="headerlink" title="JDBC Batching"></a>JDBC Batching</h1><p><a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/orm/5.4/userguide/html_single/Hibernate_User_Guide.html#batch-jdbcbatch">batch-jdbcbatch</a> 이 글에는 JDBC에서 제공하는 batch 처리 옵션을 알려주고 있습니다.  </p>
<blockquote>
<p>JDBC offers support for batching together SQL statements that can be represented as a single PreparedStatement. Implementation wise this generally means that drivers will send the batched operation to the server in one call, which can save on network calls to the database. Hibernate can leverage JDBC batching. The following settings control this behavior.</p>
</blockquote>
<p>번역기를 통해 번역해보면..</p>
<blockquote>
<p>JDBC는 단일 PreparedStatement로 표현 될 수있는 SQL 문을 일괄 처리 할 수 있도록 지원합니다.<br>구현 측면에서 이것은 일반적으로 드라이버가 한 번의 호출로 일괄 처리 된 작업을 서버로 전송하여 데이터베이스에 대한 네트워크 호출을 절약 할 수 있음을 의미합니다.<br>Hibernate는 JDBC 일괄 처리를 활용할 수 있습니다. </p>
</blockquote>
<p>다시 한번 의역해보면..</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;6c5fe953-ec38-4b26-b2f7-29a389cb8c03&#x27;</span>, <span class="number">619988</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;1959cb84-1dd5-42cc-95c1-8fd501881f1f&#x27;</span>, <span class="number">619989</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;daf8073e-78ea-435c-ac36-ac0796c4c283&#x27;</span>, <span class="number">619990</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;b98761f6-5f0b-448c-8f7f-aeffc22032d6&#x27;</span>, <span class="number">619991</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;9a740e9c-2249-4c05-9349-9118c5825755&#x27;</span>, <span class="number">619992</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;d1b0e19c-9002-40d9-a43c-ae5e7293a7f4&#x27;</span>, <span class="number">619993</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;5ac02554-a877-4d1e-93b1-3f15bb58261c&#x27;</span>, <span class="number">619994</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;36673f68-3c56-4be6-8e09-3d970d5f361e&#x27;</span>, <span class="number">619995</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;9d64f853-bd04-4ace-ba14-acc072f19729&#x27;</span>, <span class="number">619996</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;37190885-c1e7-4417-b545-f78130854acf&#x27;</span>, <span class="number">619997</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;fa7dc828-8aeb-45f1-9e80-8843890fd527&#x27;</span>, <span class="number">619998</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;6e860c36-00f5-4349-952c-f7c09dfcc263&#x27;</span>, <span class="number">619999</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;e8e6255c-bd9b-4310-af8b-72ab1ce31259&#x27;</span>, <span class="number">620000</span>);</span><br></pre></td></tr></table></figure>

<p>이 SQL문을 그냥 한번에 실행해 주는 역할 정도만 한다는 의미입니다. (생각했던 multi-row insert가 아닌)</p>
<h2 id="JDBC-Options"><a href="#JDBC-Options" class="headerlink" title="JDBC Options"></a>JDBC Options</h2><h3 id="hibernate-jdbc-batch-size"><a href="#hibernate-jdbc-batch-size" class="headerlink" title="hibernate.jdbc.batch_size"></a>hibernate.jdbc.batch_size</h3><p>이 옵션은 몇개의 statement 즉, 하나의 sql이 쌓이면 DB서버로 요청할 지 정하는 단위입니다.<br>예를들어 10으로 정하면</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;b98761f6-5f0b-448c-8f7f-aeffc22032d6&#x27;</span>, <span class="number">619991</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;9a740e9c-2249-4c05-9349-9118c5825755&#x27;</span>, <span class="number">619992</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;d1b0e19c-9002-40d9-a43c-ae5e7293a7f4&#x27;</span>, <span class="number">619993</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;5ac02554-a877-4d1e-93b1-3f15bb58261c&#x27;</span>, <span class="number">619994</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;36673f68-3c56-4be6-8e09-3d970d5f361e&#x27;</span>, <span class="number">619995</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;9d64f853-bd04-4ace-ba14-acc072f19729&#x27;</span>, <span class="number">619996</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;37190885-c1e7-4417-b545-f78130854acf&#x27;</span>, <span class="number">619997</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;fa7dc828-8aeb-45f1-9e80-8843890fd527&#x27;</span>, <span class="number">619998</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;6e860c36-00f5-4349-952c-f7c09dfcc263&#x27;</span>, <span class="number">619999</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> (<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;e8e6255c-bd9b-4310-af8b-72ab1ce31259&#x27;</span>, <span class="number">620000</span>);</span><br></pre></td></tr></table></figure>

<p>이와 같이 sql이 10개가 내부 큐에 쌓이면 전송하는 방식입니다.</p>
<h3 id="hibernate-order-inserts-hibernate-order-updates"><a href="#hibernate-order-inserts-hibernate-order-updates" class="headerlink" title="hibernate.order_inserts, hibernate.order_updates"></a>hibernate.order_inserts, hibernate.order_updates</h3><p>아래와 같은 경우에는 batch insert가 적용되지 않습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">executeInserts</span><span class="params">()</span> &#123;</span><br><span class="line">  </span><br><span class="line">  List&lt;Child&gt; childList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">  <span class="keyword">for</span> ( <span class="type">int</span> i=<span class="number">0</span>; i&lt; <span class="number">10</span>; i++ ) &#123;</span><br><span class="line">    <span class="type">Parent</span> <span class="variable">parent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Parent</span>(...);</span><br><span class="line">    <span class="type">Child</span> <span class="variable">child</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Child</span>(...);</span><br><span class="line">  </span><br><span class="line">    child.setParent(parent);</span><br><span class="line">    childList.add(child);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  childRepository.saveAll(childList);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>내부적으로 parent가 insert되고 child가 insert가 되기 때문에 쓰기지연 SQL 저장소에는 이런식으로 구성이 되어 batch insert가 실행되지 않습니다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">7</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">7</span>, <span class="number">7</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">8</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">8</span>, <span class="number">8</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">9</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">9</span>, <span class="number">9</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">10</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">10</span>, <span class="number">10</span>);</span><br></pre></td></tr></table></figure>



<p>하지만 <code>hibernate.order_inserts = true</code> 가 적용되면 각각의 insert 구문이 정렬되어 batch insert가 가능해집니다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">7</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">8</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">9</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> parent (id) <span class="keyword">values</span> (<span class="number">10</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">1</span>, <span class="number">1</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">5</span>, <span class="number">5</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">6</span>, <span class="number">6</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">7</span>, <span class="number">7</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">8</span>, <span class="number">8</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">9</span>, <span class="number">9</span>);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> child(id, parent_id) <span class="keyword">values</span> (<span class="number">10</span>, <span class="number">10</span>);</span><br></pre></td></tr></table></figure>




<h1 id="rewrite-옵션"><a href="#rewrite-옵션" class="headerlink" title="rewrite 옵션"></a>rewrite 옵션</h1><p>정말로 multi-row insert가 지원이 안되나? 하고 찾아보니 jdbc.batch_size 옵션을 사용하면 내부적으로 <code>addBatch()</code> 메서드를 통해 batch로 처리하지만<br>multi-row는 지원되지 않았습니다.  </p>
<p>원하는 multi-row insert를 하기 위해선 jdbcUrl에 아래와 같은 옵션이 추가되어야 합니다.</p>
<ul>
<li><strong>MySQL</strong>  : jdbc:mysql:&#x2F;&#x2F;localhost:3306&#x2F;jpa-test?useSSL&#x3D;false&amp; <strong>rewriteBatchedStatements&#x3D;true</strong></li>
<li><strong>PostgreSQL</strong> : jdbc:postgresql:&#x2F;&#x2F;localhost:5432&#x2F;jpa-test?useSSL&#x3D;false&amp; <strong>rewriteBatchedInserts&#x3D;true</strong></li>
</ul>
<p>이 옵션을 추가하면,  connector 레벨에서 insert 구문을 재작성(rewrite) 하게 되어 아래와 같은 형태로 SQL이 재작성됩니다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> test_data (created_at, uuid, id) <span class="keyword">values</span> </span><br><span class="line">(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;6c5fe953-ec38-4b26-b2f7-29a389cb8c03&#x27;</span>, <span class="number">619988</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;1959cb84-1dd5-42cc-95c1-8fd501881f1f&#x27;</span>, <span class="number">619989</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;daf8073e-78ea-435c-ac36-ac0796c4c283&#x27;</span>, <span class="number">619990</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;b98761f6-5f0b-448c-8f7f-aeffc22032d6&#x27;</span>, <span class="number">619991</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;9a740e9c-2249-4c05-9349-9118c5825755&#x27;</span>, <span class="number">619992</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;d1b0e19c-9002-40d9-a43c-ae5e7293a7f4&#x27;</span>, <span class="number">619993</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;5ac02554-a877-4d1e-93b1-3f15bb58261c&#x27;</span>, <span class="number">619994</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;36673f68-3c56-4be6-8e09-3d970d5f361e&#x27;</span>, <span class="number">619995</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;9d64f853-bd04-4ace-ba14-acc072f19729&#x27;</span>, <span class="number">619996</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;37190885-c1e7-4417-b545-f78130854acf&#x27;</span>, <span class="number">619997</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;fa7dc828-8aeb-45f1-9e80-8843890fd527&#x27;</span>, <span class="number">619998</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;6e860c36-00f5-4349-952c-f7c09dfcc263&#x27;</span>, <span class="number">619999</span>)</span><br><span class="line">,(<span class="string">&#x27;2020-11-22 19:28:05.79&#x27;</span>, <span class="string">&#x27;e8e6255c-bd9b-4310-af8b-72ab1ce31259&#x27;</span>, <span class="number">620000</span>);</span><br></pre></td></tr></table></figure>



<h1 id="주의할-점"><a href="#주의할-점" class="headerlink" title="주의할 점"></a>주의할 점</h1><h2 id="JPA에서-ID-채번-방식을-GenerateType-IDENDITY-사용-시-batch-insert를-할-수-없다"><a href="#JPA에서-ID-채번-방식을-GenerateType-IDENDITY-사용-시-batch-insert를-할-수-없다" class="headerlink" title="JPA에서 ID 채번 방식을 GenerateType.IDENDITY 사용 시 batch insert를 할 수 없다"></a>JPA에서 ID 채번 방식을 GenerateType.IDENDITY 사용 시 batch insert를 할 수 없다</h2><blockquote>
<p>Hibernate disables insert batching at the JDBC level transparently if you use an identity identifier generator.</p>
</blockquote>
<p>Entity의 Id 채번방식을 GenerateType.IDENDITY을 사용하는 경우에는 batch insert가 적용되지 않습니다. (JDBC 레벨에서 차단)<br>실제 insert 시, <code>select last_insert_id()</code> 쿼리를 실행하여 다음에 insert할 ID를 채번해오기 때문에 batch insert를 막는듯 합니다.</p>
<p><strong>따라서 batch insert를 사용하기 위해선 ID 채번방식을 GenerateType.SEQUENCE나 GenerateType.TABLE을 사용해야 합니다.</strong></p>
<h2 id="MySQL의-경우-max-allowed-packet-값을-고려해서-써야한다"><a href="#MySQL의-경우-max-allowed-packet-값을-고려해서-써야한다" class="headerlink" title="MySQL의 경우 max_allowed_packet 값을 고려해서 써야한다."></a>MySQL의 경우 max_allowed_packet 값을 고려해서 써야한다.</h2><p>MySQL의 경우  max_allowed_packet이라는 설정값이 있습니다.<br>이 설정값은 DB server로 보낼 수 있는 최대 요청 packet size입니다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">show</span> <span class="keyword">global</span> variables <span class="keyword">like</span> <span class="string">&#x27;max_allowed_packet&#x27;</span></span><br></pre></td></tr></table></figure>

<p>위 SQL을 통해 확인 할 수 있으며, 기본적으로  4MB로 설정되어있습니다. </p>
<p>multi-row insert를 하는 경우 row수가 많아지면 max_allowed_packet size를 넘을 수 있기 때문에 적절한 batch_size를 고려해야 합니다.</p>
<h1 id="SequenceGenerator의-채번-방식을-변경해서-사용하라"><a href="#SequenceGenerator의-채번-방식을-변경해서-사용하라" class="headerlink" title="SequenceGenerator의 채번 방식을 변경해서 사용하라"></a>SequenceGenerator의 채번 방식을 변경해서 사용하라</h1><p>MySQL에서 SequenceGenerator의 동작방식은 아래와 같습니다.</p>
<ol>
<li><code>hibernate_sequence</code> 테이블에서 현재 sequence 값 조회 (select next_val from hibernate_sequence)</li>
<li><code>hibernate_sequence</code> 테이블 update (update hibernate_sequence set next_val + 1 where next_val &#x3D; ?)</li>
<li>Entity 객체에 ID를 부여해서 insert</li>
</ol>
<p>이와 같이 사용하는 경우 1개의 ID를 채번하는데 사용되는 query가 2개입니다.  따라서 batch insert를 하더라도 큰 성능 향상을 기대하기 어렵습니다.</p>
<p>이 경우 SequenceGenerator의 optimizer를 변경하여 사용하면 큰 성능 향상을 볼 수 있습니다.  </p>
<p>아래 글을 참고하면 hibernate id generator에 대한 optimizer 설명을 볼 수 있습니다.</p>
<ul>
<li><p><a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/orm/5.2/userguide/html_single/Hibernate_User_Guide.html#identifiers-generators-optimizer">identifires-generator-optimizer</a></p>
</li>
<li><p><a target="_blank" rel="noopener" href="https://woowabros.github.io/experience/2020/02/06/hikaricp-avoid-dead-lock-2.html">HikariCP Dead lock에서 벗어나기 (실전편)</a></p>
</li>
</ul>
<p>여기서는 간단하게 <code>pooled-lo</code> optimizer를 사용하도록 한 예시를 제공합니다.</p>
<p><img src="./PooledLoOptimizer.png" alt="PooledLoOptimizer"></p>
<p>한번에 일정 범위만큼 채번을 하여 메모리에 저장하여 사용하는 방식입니다.<br>ex) 한번에 1000개만큼 채번 후 <code>(update hibernate_sequence set next_val + 1000 where next_val = ?) </code> 1000개 ID를 메모리에 할당 후 사용</p>
<p>위와 같은 optimizer를 사용하면 1000개의 entity를 insert하는데 1번의 hibernate_sequence에 대한 쿼리가 실행되어 매우 효율적으로 ID채번이 가능합니다.</p>
<h1 id="pooled-lo-optimizer를-적용한-코드"><a href="#pooled-lo-optimizer를-적용한-코드" class="headerlink" title="pooled-lo optimizer를 적용한 코드"></a>pooled-lo optimizer를 적용한 코드</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Entity</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">TestData</span> &#123;</span><br><span class="line">    <span class="meta">@Id</span></span><br><span class="line">    <span class="meta">@GeneratedValue(strategy = GenerationType.AUTO, generator = &quot;test-sequence-generator&quot;)</span></span><br><span class="line">    <span class="meta">@GenericGenerator(</span></span><br><span class="line"><span class="meta">            name = &quot;test-sequence-generator&quot;,</span></span><br><span class="line"><span class="meta">            strategy = &quot;sequence&quot;,</span></span><br><span class="line"><span class="meta">            parameters = &#123;</span></span><br><span class="line"><span class="meta">                    @Parameter(name = SequenceStyleGenerator.SEQUENCE_PARAM, value = SequenceStyleGenerator.DEF_SEQUENCE_NAME),</span></span><br><span class="line"><span class="meta">                    @Parameter(name = SequenceStyleGenerator.INITIAL_PARAM, value = &quot;1&quot;),</span></span><br><span class="line"><span class="meta">                    @Parameter(name = SequenceStyleGenerator.INCREMENT_PARAM, value = &quot;1000&quot;),</span></span><br><span class="line"><span class="meta">                    @Parameter(name = AvailableSettings.PREFERRED_POOLED_OPTIMIZER, value = &quot;pooled-lo&quot;)</span></span><br><span class="line"><span class="meta">            &#125;</span></span><br><span class="line"><span class="meta">    )</span></span><br><span class="line">    <span class="keyword">private</span> Long id;</span><br><span class="line">    <span class="meta">@Column(name = &quot;uuid&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> String uuid;</span><br><span class="line">    <span class="meta">@Column(name = &quot;created_at&quot;)</span></span><br><span class="line">    <span class="keyword">private</span> LocalDateTime createdAt;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="title function_">TestData</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.id = <span class="number">0L</span>;</span><br><span class="line">        <span class="built_in">this</span>.uuid = UUID.randomUUID().toString();</span><br><span class="line">        <span class="built_in">this</span>.createdAt = LocalDateTime.now();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> TestData <span class="title function_">create</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">TestData</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="성능-비교"><a href="#성능-비교" class="headerlink" title="성능 비교"></a>성능 비교</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EntityScan</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">JpaBatchTestApplication</span> <span class="keyword">implements</span> <span class="title class_">CommandLineRunner</span> &#123;</span><br><span class="line">    <span class="meta">@Autowired</span></span><br><span class="line">    TestDataRepository testDataRepository;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        SpringApplication.run(JpaBatchTestApplication.class, args);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">        stopWatch.start();</span><br><span class="line">        List&lt;TestData&gt; testDataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">            testDataList.add(TestData.create());</span><br><span class="line">        &#125;</span><br><span class="line">        testDataRepository.saveAll(testDataList);</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        <span class="type">long</span> <span class="variable">totalTimeMillis</span> <span class="operator">=</span> stopWatch.getTotalTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;total time : &quot;</span> + totalTimeMillis);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>위 코드에 대해 3가지 방식의 설정으로 실행시간을 비교해 보았습니다. (총 10만건 insert)</p>
<ul>
<li>jdbc.batch_size 설정x + rewriteBatchedStatements &#x3D; false<ul>
<li>소요시간: 138,136ms (약 2분)</li>
</ul>
</li>
<li>jdbc.batch_size &#x3D; 20000 + rewriteBatchedStatements &#x3D; false<ul>
<li>소요시간: 52,710ms (약 52초)</li>
</ul>
</li>
<li>jdbc.batch_size &#x3D; 20000 + rewriteBatchedStatements &#x3D; true<ul>
<li>소요시간: 4,667ms (약 4초)</li>
</ul>
</li>
</ul>
<p>+추가) saveAll이 아닌 단건 save의 경우에는?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(String... args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line">        <span class="type">StopWatch</span> <span class="variable">stopWatch</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">StopWatch</span>();</span><br><span class="line">        stopWatch.start();</span><br><span class="line">        List&lt;TestData&gt; testDataList = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">        <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100000</span>; i++) &#123;</span><br><span class="line">          testDataRepository.save(TestData.create());</span><br><span class="line">        &#125;</span><br><span class="line">        stopWatch.stop();</span><br><span class="line">        <span class="type">long</span> <span class="variable">totalTimeMillis</span> <span class="operator">=</span> stopWatch.getTotalTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;total time : &quot;</span> + totalTimeMillis);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>위의 코드의 경우에는 소요시간이 <code>555,435ms</code> 만큼 소요 되었습니다.</p>
<p>위 성능테스트 비교 결과 <code>jdbc.batch_size + rewriteBatchedStatements = true</code>하는 옵션이 어마어마한 성능차이를 보여줌을 확인하였습니다.</p>
<h1 id="application-yml-설정-코드"><a href="#application-yml-설정-코드" class="headerlink" title="application.yml 설정 코드"></a>application.yml 설정 코드</h1><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:3306/jpa-test?useSSL=false</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.mariadb.jdbc.Driver</span></span><br><span class="line">    <span class="attr">hikari:</span></span><br><span class="line">      <span class="attr">pool-name:</span> <span class="string">jpa-test-hikari-pool</span></span><br><span class="line">      <span class="attr">maximum-pool-size:</span> <span class="number">5</span></span><br><span class="line">      <span class="attr">jdbc-url:</span> <span class="string">$&#123;spring.datasource.url&#125;</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">$&#123;spring.datasource.username&#125;</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">$&#123;spring.datasource.password&#125;</span></span><br><span class="line">      <span class="attr">driver-class-name:</span> <span class="string">$&#123;spring.datasource.driver-class-name&#125;</span></span><br><span class="line">      <span class="attr">data-source-properties:</span></span><br><span class="line">        <span class="attr">rewriteBatchedStatements:</span> <span class="literal">true</span></span><br><span class="line"></span><br><span class="line">  <span class="attr">jpa:</span></span><br><span class="line">    <span class="attr">hibernate:</span></span><br><span class="line">      <span class="attr">ddl-auto:</span> <span class="string">update</span></span><br><span class="line">    <span class="attr">show-sql:</span> <span class="literal">true</span></span><br><span class="line">    <span class="attr">properties:</span></span><br><span class="line">      <span class="attr">hibernate:</span></span><br><span class="line">        <span class="attr">format_sql:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">order_inserts:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">order_updates:</span> <span class="literal">true</span></span><br><span class="line">        <span class="attr">jdbc:</span></span><br><span class="line">          <span class="attr">batch_size:</span> <span class="number">20000</span></span><br><span class="line">        <span class="attr">dialect:</span> <span class="string">org.hibernate.dialect.MySQL57InnoDBDialect</span></span><br><span class="line">    <span class="attr">generate-ddl:</span> <span class="literal">true</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>HikariCP를 이용하는 경우 <code>spring.datasource.hikari.data-source-properties</code>에 queryString으로 들어갈 properties를 작성할 수 있습니다.</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li><a target="_blank" rel="noopener" href="https://www.baeldung.com/jpa-hibernate-batch-insert-update">https://www.baeldung.com/jpa-hibernate-batch-insert-update</a></li>
<li><a target="_blank" rel="noopener" href="http://blog.plura.io/?p=4493">http://blog.plura.io/?p=4493</a></li>
<li><a target="_blank" rel="noopener" href="https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-reference-configuration-properties.html">https://dev.mysql.com/doc/connector-j/5.1/en/connector-j-reference-configuration-properties.html</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@jerolba/persisting-fast-in-database-jdbc-76912ec2ef42">https://medium.com/@jerolba/persisting-fast-in-database-jdbc-76912ec2ef42</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/brettwooldridge/HikariCP/issues/758">https://github.com/brettwooldridge/HikariCP/issues/758</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.jboss.org/hibernate/orm/5.2/userguide/html_single/Hibernate_User_Guide.html#identifiers-generators-optimizer">https://docs.jboss.org/hibernate/orm/5.2/userguide/html_single/Hibernate_User_Guide.html#identifiers-generators-optimizer</a></li>
</ul>
</div></article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">Carrey</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="https://jaehun2841.github.io/2020/11/22/2020-11-22-spring-data-jpa-batch-insert/">https://jaehun2841.github.io/2020/11/22/2020-11-22-spring-data-jpa-batch-insert/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="post-meta__tag-list"><a class="post-meta__tags" href="../../../../tags/Spring/">Spring</a><a class="post-meta__tags" href="../../../../tags/JPA/">JPA</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="../../../../2022/03/11/2022-03-11-spring-cloud-config/"><i class="fa fa-chevron-left">  </i><span>Spring Cloud Config 시작하기</span></a></div><div class="next-post pull-right"><a href="../../../08/08/2020-08-08-spring-batch-db-connection-issue/"><span>Spring Batch에서 Chunk 작업이 길어지는 경우 주의할 점</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://jaehun2841.github.io/2020/11/22/2020-11-22-spring-data-jpa-batch-insert/';
  this.page.identifier = '2020/11/22/2020-11-22-spring-data-jpa-batch-insert/';
  this.page.title = 'Spring JPA Batch Insert 과연 생각대로 동작할까?';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'Carrey' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2022 By Carrey</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="../../../../js/utils.js?version=1.9.0"></script><script src="../../../../js/fancybox.js?version=1.9.0"></script><script src="../../../../js/sidebar.js?version=1.9.0"></script><script src="../../../../js/copy.js?version=1.9.0"></script><script src="../../../../js/fireworks.js?version=1.9.0"></script><script src="../../../../js/transition.js?version=1.9.0"></script><script src="../../../../js/scroll.js?version=1.9.0"></script><script src="../../../../js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>