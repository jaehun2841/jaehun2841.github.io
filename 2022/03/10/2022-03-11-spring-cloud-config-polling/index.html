<!DOCTYPE html><html lang="lang"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Spring Cloud Config 주기적으로 Polling 하기"><meta name="keywords" content="Spring"><meta name="author" content="Carrey"><meta name="copyright" content="Carrey"><title>Spring Cloud Config 주기적으로 Polling 하기 | Carrey`s 기술블로그</title><link rel="shortcut icon" href="../../../../melody-favicon.ico"><link rel="stylesheet" href="../../../../css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.0.0'
} </script><meta name="generator" content="Hexo 6.0.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%EB%93%A4%EC%96%B4%EA%B0%80%EB%A9%B0"><span class="toc-number">1.</span> <span class="toc-text">들어가며</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ConfigClientWatch-%EC%82%B4%ED%8E%B4%EB%B3%B4%EA%B8%B0"><span class="toc-number">2.</span> <span class="toc-text">ConfigClientWatch 살펴보기</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%84%A4%EC%A0%95%ED%95%98%EA%B8%B0"><span class="toc-number">3.</span> <span class="toc-text">설정하기</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Spring-Scheduler%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%98%EB%8A%94-%EB%AA%A8%EB%93%88%EC%9E%85%EB%8B%88%EB%8B%A4"><span class="toc-number">3.1.</span> <span class="toc-text">Spring Scheduler를 사용하는 모듈입니다.</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EA%B7%B8%EB%9F%AC%EB%82%98-context-refresh%EB%8A%94-%EB%B0%9C%EC%83%9D%ED%95%98%EC%A7%80-%EC%95%8A%EC%95%98%EB%8B%A4"><span class="toc-number">4.</span> <span class="toc-text">그러나 context refresh는 발생하지 않았다.</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EA%B7%B8%EB%9F%BC-config-client-state%EA%B0%92%EC%9D%80-%EC%96%B8%EC%A0%9C-%EB%B0%94%EB%80%8C%EB%8A%94%EA%B0%80"><span class="toc-number">5.</span> <span class="toc-text">그럼 config.client.state값은 언제 바뀌는가?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#API-%EC%9D%91%EB%8B%B5-%EA%B0%92-%EC%A4%91%EC%97%90-state-%EA%B0%92%EC%9D%B4-%EC%9E%88%EC%97%88%EB%82%98%EC%9A%94"><span class="toc-number">6.</span> <span class="toc-text">API 응답 값 중에 state 값이 있었나요?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#config-server%EC%97%90%EC%84%9C-state-%EA%B0%92%EC%9D%80-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%82%B4%EB%A0%A4%EC%A4%84-%EC%88%98-%EC%9E%88%EB%8A%94%EA%B0%80"><span class="toc-number">7.</span> <span class="toc-text">config server에서 state 값은 어떻게 내려줄 수 있는가?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EA%B7%B8%EB%9E%98%EB%8F%84-%EC%82%AC%EC%9A%A9%ED%95%B4%EB%B3%B4%EA%B3%A0-%EC%8B%B6%EC%97%88%EC%8A%B5%EB%8B%88%EB%8B%A4-%EC%95%88%EB%90%98%EB%A9%B4-%EB%90%98%EA%B2%8C%ED%95%98%EB%9D%BC-%E3%85%A0%E3%85%A0"><span class="toc-number">8.</span> <span class="toc-text">그래도 사용해보고 싶었습니다. (안되면 되게하라 ㅠㅠ)</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#application-yml-client-%ED%8E%B8%EC%A7%91"><span class="toc-number">8.1.</span> <span class="toc-text">application.yml (client) 편집</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%EC%97%AC%EA%B8%B0%EA%B9%8C%EC%A7%80-config-server%EB%A5%BC-%EB%B3%80%EA%B2%BD%ED%95%98%EA%B3%A0-%EB%8B%A4%EC%8B%9C-%EC%84%A4%EC%A0%95-%EC%A0%95%EB%B3%B4%EB%A5%BC-%EC%A1%B0%ED%9A%8C%ED%95%B4-%EB%B3%B4%EC%95%98%EC%8A%B5%EB%8B%88%EB%8B%A4"><span class="toc-number">8.2.</span> <span class="toc-text">여기까지 config server를 변경하고 다시 설정 정보를 조회해 보았습니다</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%A3%BC%EC%9D%98-%EC%82%AC%ED%95%AD"><span class="toc-number">9.</span> <span class="toc-text">주의 사항!!</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%ED%81%B4%EB%9D%BC%EC%9D%B4%EC%96%B8%ED%8A%B8%EC%97%90%EC%84%9C-ConfigClientWatch%EB%A5%BC-%EA%B8%B0%EB%B0%98%EC%9C%BC%EB%A1%9C-CustomConfigClientWatch-%EC%83%9D%EC%84%B1%ED%95%98%EA%B8%B0"><span class="toc-number">10.</span> <span class="toc-text">클라이언트에서 ConfigClientWatch를 기반으로 CustomConfigClientWatch 생성하기</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#application-yml-client-%EC%84%A4%EC%A0%95-%EC%88%98%EC%A0%95%ED%95%98%EA%B8%B0"><span class="toc-number">11.</span> <span class="toc-text">application.yml (client) 설정 수정하기</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%9A%94%EC%95%BD"><span class="toc-number">12.</span> <span class="toc-text">요약</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://www.gravatar.com/avatar/3f8583b7b0f0c1ebd249dffad42707af?s=300"></div><div class="author-info__name text-center">Carrey</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="../../../../archives"><span class="pull-left">Articles</span><span class="pull-right">115</span></a><a class="author-info-articles__tags article-meta" href="../../../../tags"><span class="pull-left">Tags</span><span class="pull-right">27</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="../../../../index.html">Carrey`s 기술블로그</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Spring Cloud Config 주기적으로 Polling 하기</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2022-03-11</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="들어가며"><a href="#들어가며" class="headerlink" title="들어가며"></a>들어가며</h1><p>해당 글에서 사용한 예제의 버전 정보는 아래와 같습니다</p>
<ul>
<li>kotlin 1.6.0</li>
<li>Spring Boot 2.6.3</li>
<li>Spring Cloud Dependencies 2021.0.1</li>
</ul>
<p>Spring Cloud Config 관련 글은 총 4개의 글로 작성되었습니다.</p>
<ul>
<li><a href="../2022-03-11-spring-cloud-config">Spring Cloud Config 시작하기</a></li>
<li><a href="../2022-03-11-spring-cloud-bus">Spring Cloud Bus 시작하기</a></li>
<li><a href="../2022-03-11-spring-cloud-config-monitor">Spring Cloud Config Monitor 시작하기</a></li>
<li><strong>Spring Cloud Config 주기적으로 Polling 하기</strong></li>
</ul>
<h1 id="ConfigClientWatch-살펴보기"><a href="#ConfigClientWatch-살펴보기" class="headerlink" title="ConfigClientWatch 살펴보기"></a>ConfigClientWatch 살펴보기</h1><p><img src="./spring-cloud-configclientwatch.jpg"></p>
<ul>
<li>이 글에서는 주기적으로 config server에서 설정 정보를 가져와 반영하는 방법을 설명합니다.</li>
<li>Spring Cloud Config 공식 문서에도 보이지 않는 히든(?) 기능 입니다.</li>
<li>Spring Cloud Config Client 코드를 보다가 발견한 기능입니다.</li>
<li>처음 이 기능을 발견했을 때는 주기적으로 config server에서 설정 정보를 불러와 변경 사항이 있는 경우 context refresh를 트리거 하는 컴포넌트라고 생각했습니다.</li>
</ul>
<p><img src="config-client-watch-code.png"></p>
<h1 id="설정하기"><a href="#설정하기" class="headerlink" title="설정하기"></a>설정하기</h1><p>아래와 같이 설정 후, ConfigClientWatch를 실행해 보았습니다.</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span> <span class="string">&quot;optional:configserver:http://localhost:8080&quot;</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment"># 추가된 기능</span></span><br><span class="line">      <span class="attr">watch:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">true</span> </span><br><span class="line">        <span class="attr">initialDelay:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="number">10000</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">jaehun-microservice-router</span></span><br><span class="line">      <span class="attr">fail-fast:</span> <span class="literal">true</span> </span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">initial-interval:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">multiplier:</span> <span class="number">1.1</span></span><br><span class="line">      <span class="attr">request-connect-timeout:</span> <span class="number">2000</span></span><br><span class="line">      <span class="attr">request-read-timeout:</span> <span class="number">10000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>spring.cloud.config.watch.enabled=true</code><ul>
<li>ConfigClientWatch를 사용합니다.</li>
<li>이 설정값이 true이어야 ConfigClientWatch bean이 생성됩니다.</li>
</ul>
</li>
<li><code>spring.cloud.config.watch.initialDelay=5000</code><ul>
<li>클라이언트 애플리케이션이 실행되고 첫번째 polling을 시작하기 전까지 대기 시간 입니다.</li>
<li>단위는 ms(밀리세컨드) 입니다.</li>
<li>기본값은 18000ms (&#x3D;3분)입니다.</li>
</ul>
</li>
<li><code>spring.cloud.config.watch.delay=10000</code><ul>
<li>ConfigClientWatch의 polling 주기 입니다.</li>
<li>단위는 ms(밀리세컨드) 입니다.</li>
<li>기본값은 500ms 입니다.</li>
</ul>
</li>
</ul>
<h2 id="Spring-Scheduler를-사용하는-모듈입니다"><a href="#Spring-Scheduler를-사용하는-모듈입니다" class="headerlink" title="Spring Scheduler를 사용하는 모듈입니다."></a>Spring Scheduler를 사용하는 모듈입니다.</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableScheduling</span></span><br><span class="line"><span class="meta">@SpringBootApplication</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ClientApplication</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">(args: <span class="type">Array</span>&lt;<span class="type">String</span>&gt;)</span></span> &#123;</span><br><span class="line">  runApplication&lt;ClientApplication&gt;(*args) &#123;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>스케줄러 bean이 등록될 수 있도록 <code>@EnableScheduling</code> 어노테이션을 선언해 줍니다.</li>
</ul>
<h1 id="그러나-context-refresh는-발생하지-않았다"><a href="#그러나-context-refresh는-발생하지-않았다" class="headerlink" title="그러나 context refresh는 발생하지 않았다."></a>그러나 context refresh는 발생하지 않았다.</h1><p><img src="./debug-state.png"></p>
<ul>
<li>config server에서 값을 변경하더라도  newState와 oldState의 값은 항상 null이었습니다.</li>
<li>따라서 stateChanged라는 메서드가 무조건 false로 떨어져 context refresh가 발생하지 않았습니다.</li>
</ul>
<h1 id="그럼-config-client-state값은-언제-바뀌는가"><a href="#그럼-config-client-state값은-언제-바뀌는가" class="headerlink" title="그럼 config.client.state값은 언제 바뀌는가?"></a>그럼 config.client.state값은 언제 바뀌는가?</h1><p><img src="how-to-state.png"></p>
<ul>
<li>config.client.state라는 문자열을 검색하니 <code>ConfigServicePropertySourceLocator</code> 라는 클래스에서 putValue 하는 코드가 보입니다</li>
<li><code>ConfigServicePropertySourceLocator</code> 의 locate 메서드는 getEnvironment라는 메서드를 통해 config server api를 호출하여 설정 정보를 불러 옵니다.</li>
<li>이후 설정 정보에 getState한 값을 config.client.state 프로퍼티에 바인딩 해줍니다.</li>
</ul>
<h1 id="API-응답-값-중에-state-값이-있었나요"><a href="#API-응답-값-중에-state-값이-있었나요" class="headerlink" title="API 응답 값 중에 state 값이 있었나요?"></a>API 응답 값 중에 state 값이 있었나요?</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">&#x27;http://config-server/jaehun-microservice-router/local/master&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jaehun-microservice-router&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;profiles&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="string">&quot;prod&quot;</span></span><br><span class="line">    <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;label&quot;</span><span class="punctuation">:</span> <span class="string">&quot;master&quot;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;version&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;state&quot;</span><span class="punctuation">:</span> <span class="keyword">null</span><span class="punctuation">,</span></span><br><span class="line">    <span class="attr">&quot;propertySources&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;jaehun-microservice-router-prod&quot;</span><span class="punctuation">,</span></span><br><span class="line">            <span class="attr">&quot;source&quot;</span><span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                <span class="attr">&quot;routing.weight.A&quot;</span><span class="punctuation">:</span> <span class="string">&quot;51&quot;</span><span class="punctuation">,</span></span><br><span class="line">                <span class="attr">&quot;\routing.weight.B&quot;</span><span class="punctuation">:</span> <span class="string">&quot;49&quot;</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>위의 API를 호출하여 message-platform-router에 대한 설정 정보를 요청했고, 요청 응답에는 version과 state라는 프로퍼티가 있습니다.</li>
<li>이 프로퍼티를 사용하면 <code>ConfigServicePropertySourceLocator</code> 를 이용해서 config.client.state라는 프로퍼티에 값을 변경할 수 있겠다고 생각했습니다.</li>
</ul>
<h1 id="config-server에서-state-값은-어떻게-내려줄-수-있는가"><a href="#config-server에서-state-값은-어떻게-내려줄-수-있는가" class="headerlink" title="config server에서 state 값은 어떻게 내려줄 수 있는가?"></a>config server에서 state 값은 어떻게 내려줄 수 있는가?</h1><p><img src="where-is-stae.png"></p>
<p>찾아보니 <strong>결과적으로는 state란 필드는 vault, native backend에서만 사용하는 것으로 확인하였습니다.</strong><br>하지만 저는 JDBC Backend를 사용하기 때문에 결과적으로는 state 값을 이용하긴 어려웠습니다.</p>
<h1 id="그래도-사용해보고-싶었습니다-안되면-되게하라-ㅠㅠ"><a href="#그래도-사용해보고-싶었습니다-안되면-되게하라-ㅠㅠ" class="headerlink" title="그래도 사용해보고 싶었습니다. (안되면 되게하라 ㅠㅠ)"></a>그래도 사용해보고 싶었습니다. (안되면 되게하라 ㅠㅠ)</h1><p>StateSupportJdbcEnvironmentRepository라는 커스텀한 클래스를 생성하였습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StateSupportJdbcEnvironmentRepository</span></span>(</span><br><span class="line">    <span class="meta">@Value(<span class="string">&quot;\$&#123;spring.cloud.config.server.jdbc.last-modified-timestamp-sql&#125;&quot;</span>)</span> <span class="keyword">private</span> <span class="keyword">val</span> findLastModifiedTimestampSql: String,</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> jdbcTemplate: JdbcTemplate,</span><br><span class="line">    properties: JdbcEnvironmentProperties</span><br><span class="line">) : JdbcEnvironmentRepository(jdbcTemplate, properties, PropertiesResultSetExtractor()) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">findOne</span><span class="params">(application: <span class="type">String</span>?, profile: <span class="type">String</span>?, label: <span class="type">String</span>?, includeOrigin: <span class="type">Boolean</span>)</span></span>: Environment &#123;</span><br><span class="line">        <span class="keyword">val</span> environment = <span class="keyword">super</span>.findOne(application, profile, label, includeOrigin).apply &#123;</span><br><span class="line">            state = findLastModifiedTimestamp(application, profile, label)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> environment</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">findLastModifiedTimestamp</span><span class="params">(application: <span class="type">String</span>?, profile: <span class="type">String</span>?, label: <span class="type">String</span>?)</span></span>: String &#123;</span><br><span class="line">        <span class="keyword">val</span> applicationCriteria = application ?: <span class="string">&quot;application&quot;</span></span><br><span class="line">        <span class="keyword">val</span> profileCriteria = profile ?: <span class="string">&quot;default&quot;</span></span><br><span class="line">        <span class="keyword">val</span> labelCriteria = label ?: <span class="string">&quot;master&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> jdbcTemplate.queryForObject(findLastModifiedTimestampSql, String::<span class="keyword">class</span>.java, applicationCriteria, profileCriteria, labelCriteria)</span><br><span class="line">            ?: <span class="string">&quot;&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>JdbcEnvironmentRepository를 상속하여 StateSupportJdbcEnvironmentRepository 라는 클래스를 만들었습니다.</li>
<li>super.findOne() 메서드를 호출하여 JdbcEnvironmentRepository에서 제공하는 기능을 그대로 사용하고 state 값만 채워주는 형태로 만들었습니다.</li>
<li>state는 db 내의 configuration 정보의 마지막 수정일자를 기준으로 state를 설정하도록 하였습니다.</li>
</ul>
<h2 id="application-yml-client-편집"><a href="#application-yml-client-편집" class="headerlink" title="application.yml (client) 편집"></a>application.yml (client) 편집</h2><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="attr">server:</span></span><br><span class="line">        <span class="attr">jdbc:</span>  </span><br><span class="line">          <span class="attr">last-modified-timestamp-sql:</span> <span class="string">select</span> <span class="string">unix_timestamp(max(modified_at))</span> <span class="string">from</span> <span class="string">remote_configurations</span> <span class="string">where</span> <span class="string">application</span> <span class="string">=</span> <span class="string">?</span> <span class="string">and</span> <span class="string">profile</span> <span class="string">=</span> <span class="string">?</span> <span class="string">and</span> <span class="string">label</span> <span class="string">=</span> <span class="string">?</span></span><br><span class="line">          <span class="attr">sql:</span> <span class="string">select</span> <span class="string">prop_key,</span> <span class="string">prop_value</span> <span class="string">from</span> <span class="string">remote_configurations</span> <span class="string">where</span> <span class="string">application=?</span> <span class="string">and</span> <span class="string">profile=?</span> <span class="string">and</span> <span class="string">label=?</span></span><br><span class="line">          <span class="attr">order:</span> <span class="number">1</span></span><br><span class="line">          <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># 중요!</span></span><br><span class="line">      <span class="attr">default-application-name:</span> <span class="string">application</span></span><br><span class="line">      <span class="attr">label:</span> <span class="string">master</span></span><br><span class="line">      <span class="attr">profile:</span> <span class="string">default</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="attr">monitor:</span></span><br><span class="line">        <span class="attr">endpoint:</span></span><br><span class="line">          <span class="attr">path:</span> <span class="string">/api/v1/remote-configurations</span></span><br><span class="line">  <span class="attr">datasource:</span></span><br><span class="line">    <span class="attr">url:</span> <span class="string">jdbc:mysql://localhost:6028/config-server</span></span><br><span class="line">    <span class="attr">username:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">root</span></span><br><span class="line">    <span class="attr">driver-class-name:</span> <span class="string">org.mariadb.jdbc.Driver</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jdbc</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">local</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>중요한 부분을 몇가지 설명하겠습니다.</p>
<ul>
<li><code>spring.cloud.config.server.jdbc.last-modified-timestamp-sql</code><ul>
<li>조회하고자 하는 설정 정보의 요소 중 가장 최신일자의 timestamp를 state 값으로 사용하기 위해 작성한 쿼리 입니다</li>
<li>설정 정보를 변경하면 modified_at 정보가 수정되므로 변경된 state를 API 응답값으로 내려줍니다.</li>
<li>클라이언트에서는 state 값이 변경됨을 인지하고 context refresh를 트리거 합니다.</li>
</ul>
</li>
<li><code>spring.cloud.config.server.jdbc.enabled=false</code><ul>
<li>enabled 옵션을 false로 해야 Spring Cloud Config에서 제공하는 JdbcRepository에 대한 Auto Configuration을 설정을 off 할 수 있습니다</li>
<li>우리가 작성한 StateSupportJdbcEnvironmentRepository를 Spring Cloud Config 코드에서 사용하기 위한 설정입니다.</li>
</ul>
</li>
</ul>
<h2 id="여기까지-config-server를-변경하고-다시-설정-정보를-조회해-보았습니다"><a href="#여기까지-config-server를-변경하고-다시-설정-정보를-조회해-보았습니다" class="headerlink" title="여기까지 config server를 변경하고 다시 설정 정보를 조회해 보았습니다"></a>여기까지 config server를 변경하고 다시 설정 정보를 조회해 보았습니다</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl --location --request GET <span class="string">&#x27;http://config-server/jaehun-microservice-router/prod/master&#x27;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">    <span class="string">&quot;name&quot;</span>: <span class="string">&quot;jaehun-microservice-router&quot;</span>,</span><br><span class="line">    <span class="string">&quot;profiles&quot;</span>: [</span><br><span class="line">        <span class="string">&quot;prod&quot;</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">&quot;label&quot;</span>: <span class="string">&quot;master&quot;</span>,</span><br><span class="line">    <span class="string">&quot;version&quot;</span>: null,</span><br><span class="line">    <span class="string">&quot;state&quot;</span>: <span class="string">&quot;1646663800.373522&quot;</span>,</span><br><span class="line">    <span class="string">&quot;propertySources&quot;</span>: [</span><br><span class="line">        &#123;</span><br><span class="line">            <span class="string">&quot;name&quot;</span>: <span class="string">&quot;jaehun-microservice-router-prod&quot;</span>,</span><br><span class="line">            <span class="string">&quot;source&quot;</span>: &#123;</span><br><span class="line">                <span class="string">&quot;routing.weight.A&quot;</span>: <span class="string">&quot;51&quot;</span>,</span><br><span class="line">                <span class="string">&quot;routing.weight.B&quot;</span>: <span class="string">&quot;49&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>이제는 state에 가장 최신 수정시각에 대한 timestamp 정보가 나오는 것을 확인할 수 있습니다.</li>
</ul>
<h1 id="주의-사항"><a href="#주의-사항" class="headerlink" title="주의 사항!!"></a>주의 사항!!</h1><p><img src="./caption.png"></p>
<ul>
<li>CompositeEnvironmentRepository에서는 backend repository가 1개인 경우에만 state 정보는 set 해줍니다.</li>
<li>아래와 같이 backend 설정이 2개 이상 들어가는 경우에는 state를 사용할 수 없습니다.</li>
</ul>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">jdbc</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">redis</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">local</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="클라이언트에서-ConfigClientWatch를-기반으로-CustomConfigClientWatch-생성하기"><a href="#클라이언트에서-ConfigClientWatch를-기반으로-CustomConfigClientWatch-생성하기" class="headerlink" title="클라이언트에서 ConfigClientWatch를 기반으로 CustomConfigClientWatch 생성하기"></a>클라이언트에서 ConfigClientWatch를 기반으로 CustomConfigClientWatch 생성하기</h1><p>spring cloud config에서 제공하는 ConfigClientWatch는 스케줄링 주기 마다 config server에 설정 정보를 요청하는 코드가 없습니다.</p>
<p>따라서 아래와 같이 코드를 수정하여 CustomConfigClientWatch 클래스를 생성했습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span> </span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">CustomConfigClientWatch</span></span>(</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> contextRefresher: ContextRefresher,</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> servicePropertySourceLocator: ConfigServicePropertySourceLocator</span><br><span class="line">) : Closeable, EnvironmentAware &#123;</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> running = AtomicBoolean(<span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> environment: Environment? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostConstruct</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">()</span></span> &#123;</span><br><span class="line">    running.compareAndSet(<span class="literal">false</span>, <span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">close</span><span class="params">()</span></span> &#123;</span><br><span class="line">    running.compareAndSet(<span class="literal">true</span>, <span class="literal">false</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setEnvironment</span><span class="params">(environment: <span class="type">Environment</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">this</span>.environment = environment</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Scheduled(</span></span><br><span class="line"><span class="meta">    initialDelayString = <span class="string">&quot;\$&#123;spring.cloud.config.watch.initialDelay:180000&#125;&quot;</span>,</span></span><br><span class="line"><span class="meta">    fixedDelayString = <span class="string">&quot;\$&#123;spring.cloud.config.watch.delay:500&#125;&quot;</span></span></span><br><span class="line"><span class="meta">  )</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">watchConfigServer</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (running.<span class="keyword">get</span>()) &#123;</span><br><span class="line">      <span class="keyword">val</span> newState = fetchState(environment)</span><br><span class="line">      <span class="keyword">val</span> oldState = ConfigClientStateHolder.getState()</span><br><span class="line"></span><br><span class="line">      <span class="comment">// only refresh if state has changed</span></span><br><span class="line">      <span class="keyword">if</span> (stateChanged(oldState, newState)) &#123;</span><br><span class="line">        ConfigClientStateHolder.setState(newState)</span><br><span class="line">        <span class="keyword">this</span>.contextRefresher.refresh()</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">fetchState</span><span class="params">(environment: <span class="type">Environment</span>?)</span></span>: String? &#123;</span><br><span class="line">    <span class="comment">// ConfigServicePropertySourceLocator를 통해 config server에서 설정 정보를 불러옵니다.</span></span><br><span class="line">    <span class="keyword">val</span> remoteConfigurationProperties = servicePropertySourceLocator.locate(environment)</span><br><span class="line">    <span class="keyword">return</span> remoteConfigurationProperties.getProperty(CONFIG_CLIENT_STATE_KEY)?.toString()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">stateChanged</span><span class="params">(oldState: <span class="type">String</span>?, newState: <span class="type">String</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> !newState.isNullOrBlank() &amp;&amp; oldState != newState</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> <span class="keyword">val</span> CONFIG_CLIENT_STATE_KEY = <span class="string">&quot;config.client.state&quot;</span></span><br></pre></td></tr></table></figure>

<ul>
<li><code>val newState = fetchState(environment)</code> 코드를 수정해 스케줄링 주기 마다 config server로 부터 설정을 불러오도록 합니다.</li>
<li>servicePropertySourceLocator.locate 로직에 의해 config server에서 받은 응답 중 state 값을 config.client.state 프로퍼티에 바인딩 합니다.</li>
<li>config server에서 설정 정보가 변경된 경우 현재 메모리에 저장된 oldState와 비교하여 다른 경우 context refresh를 호출합니다.</li>
</ul>
<h1 id="application-yml-client-설정-수정하기"><a href="#application-yml-client-설정-수정하기" class="headerlink" title="application.yml (client) 설정 수정하기"></a>application.yml (client) 설정 수정하기</h1><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">profiles:</span></span><br><span class="line">    <span class="attr">active:</span> <span class="string">local</span></span><br><span class="line">  <span class="attr">config:</span></span><br><span class="line">    <span class="attr">import:</span> <span class="string">&quot;optional:configserver:http://localhost:8080&quot;</span></span><br><span class="line">  <span class="attr">cloud:</span></span><br><span class="line">    <span class="attr">config:</span></span><br><span class="line">      <span class="comment"># 추가된 기능</span></span><br><span class="line">      <span class="attr">watch:</span></span><br><span class="line">        <span class="attr">enabled:</span> <span class="literal">false</span> <span class="comment"># spring cloud config에서 제공하는 ConfigClientWatch 사용x </span></span><br><span class="line">        <span class="attr">initialDelay:</span> <span class="number">5000</span></span><br><span class="line">        <span class="attr">delay:</span> <span class="number">10000</span></span><br><span class="line">      <span class="attr">name:</span> <span class="string">aehun-microservice-router</span></span><br><span class="line">      <span class="attr">fail-fast:</span> <span class="literal">true</span> </span><br><span class="line">      <span class="attr">retry:</span></span><br><span class="line">        <span class="attr">initial-interval:</span> <span class="number">1000</span></span><br><span class="line">        <span class="attr">max-attempts:</span> <span class="number">5</span></span><br><span class="line">        <span class="attr">multiplier:</span> <span class="number">1.1</span></span><br><span class="line">      <span class="attr">request-connect-timeout:</span> <span class="number">2000</span></span><br><span class="line">      <span class="attr">request-read-timeout:</span> <span class="number">10000</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>spring.cloud.config.watch.enabled=false</code><ul>
<li>위의 설정을 통해 명시적으로 spring cloud config에서 제공하는 ConfigClientWatch 사용하지 않도록 설정했습니다.</li>
</ul>
</li>
</ul>
<h1 id="요약"><a href="#요약" class="headerlink" title="요약"></a>요약</h1><ul>
<li>spring cloud config에서 제공하는 ConfigClientWatch라는 기능을 사용하고자 했으나, vault, native backend에서만 지원하였습니다.</li>
<li>JDBC Backend를 사용하기 때문에 Config Server에서 state 정보를 넣어 줄 수 있는 StateSupportJdbcEnvironmentRepository를 생성하였습니다..</li>
<li>state 정보는 값이 변경되면 갱신됨을 알리기 위해 쿼리된 결과의 modified_at 정보 중 가장 최신 값을 사용하였습니다.</li>
<li>클라이언트에서는 CustomConfigClientWatch를 생성하고 ConfigServicePropertySourceLocator를 통해 주기적으로 config server의 설정 값을 불러오도록 코드를 수정하였습니다.</li>
<li>주기적으로 불러오는 config server의 state 값을 확인하고 메모리 상의 state와 다른 경우 context refresher가 동작하도록 하였습니다.</li>
<li>위와 같은 설정을 통해 JDBC Backend를 사용하면서도 주기적으로 클라이언트에서 config server의 설정 정보를 가져와 property 정보를 변경할 수 있었습니다.</li>
</ul>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="../../../../tags/Spring/">Spring</a></div><nav id="pagination"><div class="next-post pull-right"><a href="../2022-03-11-spring-cloud-config-monitor/"><span>Spring Cloud Config Monitor 시작하기</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://jaehun2841.github.io/2022/03/10/2022-03-11-spring-cloud-config-polling/';
  this.page.identifier = '2022/03/10/2022-03-11-spring-cloud-config-polling/';
  this.page.title = 'Spring Cloud Config 주기적으로 Polling 하기';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'Carrey' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2022 By Carrey</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="../../../../js/utils.js?version=1.9.0"></script><script src="../../../../js/fancybox.js?version=1.9.0"></script><script src="../../../../js/sidebar.js?version=1.9.0"></script><script src="../../../../js/copy.js?version=1.9.0"></script><script src="../../../../js/fireworks.js?version=1.9.0"></script><script src="../../../../js/transition.js?version=1.9.0"></script><script src="../../../../js/scroll.js?version=1.9.0"></script><script src="../../../../js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>