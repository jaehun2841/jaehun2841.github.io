<!DOCTYPE html><html lang="lang"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Docker기반 Redis 구축하기 - (6) Docker를 이용한 Redis Cluster 설치하기"><meta name="keywords" content="Docker"><meta name="author" content="Carrey,undefined"><meta name="copyright" content="Carrey"><title>Docker기반 Redis 구축하기 - (6) Docker를 이용한 Redis Cluster 설치하기 | Carrey`s 기술블로그</title><link rel="shortcut icon" href="../../../../my-favicon.ico"><link rel="stylesheet" href="../../../../css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-cluster-구성도"><span class="toc-number">1.</span> <span class="toc-text">Redis Cluster 구성도</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#docker를-이용한-redis-cluster-설치"><span class="toc-number">2.</span> <span class="toc-text">Docker를 이용한 Redis Cluster 설치</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#git-설치-docker-file-다운로드"><span class="toc-number">2.1.</span> <span class="toc-text">Git 설치 + Docker file 다운로드</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-설치"><span class="toc-number">2.2.</span> <span class="toc-text">Docker 설치</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-compose-설치"><span class="toc-number">2.3.</span> <span class="toc-text">Docker-Compose 설치</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#docker-build"><span class="toc-number">2.4.</span> <span class="toc-text">Docker build</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-cluster를-빌드하기-위한-docker-composeyml-파일"><span class="toc-number">3.</span> <span class="toc-text">Redis Cluster를 빌드하기 위한 docker-compose.yml 파일</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-container-생성을-위한-dockerfile-작성"><span class="toc-number">4.</span> <span class="toc-text">Redis Container 생성을 위한 Dockerfile 작성</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-cluster-설정"><span class="toc-number">5.</span> <span class="toc-text">Redis Cluster 설정</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-cluster-실행-결과"><span class="toc-number">6.</span> <span class="toc-text">Redis Cluster 실행 결과</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#참고"><span class="toc-number">7.</span> <span class="toc-text">참고</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://www.gravatar.com/avatar/3f8583b7b0f0c1ebd249dffad42707af?s=300"></div><div class="author-info__name text-center">Carrey</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="../../../../archives"><span class="pull-left">Articles</span><span class="pull-right">65</span></a><a class="author-info-articles__tags article-meta" href="../../../../tags"><span class="pull-left">Tags</span><span class="pull-right">14</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container" style="background-image: url(true)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="../../../../index.html">Carrey`s 기술블로그</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">Docker기반 Redis 구축하기 - (6) Docker를 이용한 Redis Cluster 설치하기</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-12-01</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="redis-cluster-구성도">Redis Cluster 구성도</h1>
<p><img src="./Redis-Cluster-archi.PNG" alt="Redis-Cluster-archi"></p>
<p>간단하게 정리하면.</p>
<ul>
<li>각 서버 별로 Redis 3대를 설치. Master 1개, Slave 2개로 구성하여 Replication을 지원할 수 있도록 Cluster를 구성하였습니다.</li>
<li>각 서버 별로 Sentinel 3대를 설치. 양대비 원리에 맞추어 홀수개로 설정 하였습니다.</li>
<li>각각의 서버의 Sentinel 3대가 서버의 Master Redis를 감시합니다. (Failover 대기)</li>
<li>Redis Cluster를 서버 3대에 설치. Data Sharding을 하기 위해 저장소를 3개로 분리하였습니다.</li>
<li>HAProxy로 분산 처리 구축. 5000, 5002, 5004번 포트는 각 서버의 Master Redis를 바라봅니다.</li>
<li>5001, 5003, 5005번 포트는 각 서버의 Slave Redis 2대씩 바라봅니다.</li>
</ul>
<p>지금부터 Redis Cluster를 어떻게 설치 하였는지 설치 과정에 대해 알아보도록 하겠습니다.</p>
<h1 id="docker를-이용한-redis-cluster-설치">Docker를 이용한 Redis Cluster 설치</h1>
<p>Redis-Cluster를 설치하는 순서는 아래와 같습니다. (CentOS 7기준으로 설치 하였습니다.)</p>
<ul>
<li>Git 설치 (미리 올려둔 Docker file들을 다운받기 위함)</li>
<li>Docker 설치</li>
<li>Docker-Compose 설치</li>
<li>Docker Build</li>
</ul>
<h2 id="git-설치-docker-file-다운로드">Git 설치 + Docker file 다운로드</h2>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># git설치</span></span><br><span class="line">yum -y install git</span><br><span class="line">git --version <span class="comment"># git 버전 확인</span></span><br><span class="line"> </span><br><span class="line"><span class="comment">#Redis-Cluster 디렉터리 생성</span></span><br><span class="line">mkdir -p /home/redis/redis-cluster</span><br><span class="line"> </span><br><span class="line"><span class="comment">#Redis-Cluster-Home 이동</span></span><br><span class="line"><span class="built_in">cd</span> /home/redis/redis-cluster</span><br><span class="line"> </span><br><span class="line"><span class="comment">#아래 디렉터리들은 각 Redis Container의 외부볼륨으로 설정하기 위해 생성하였습니다.</span></span><br><span class="line"><span class="comment">#==&gt; Container 외부 볼륨을 설정해야 Redis Container가 삭제되더라도 Data가 보존됩니다.</span></span><br><span class="line"><span class="comment">#===&gt; dump.rdb 파일이 생성되는 장소</span></span><br><span class="line">mkdir -p ./redis-data/redis1</span><br><span class="line">mkdir -p ./redis-data/redis2</span><br><span class="line">mkdir -p ./redis-data/redis3</span><br><span class="line"> </span><br><span class="line"><span class="comment">#Docker file Download</span></span><br><span class="line"><span class="comment">#설치파일을 다운받습니다.</span></span><br><span class="line">git init</span><br><span class="line">git remote add origin <span class="string">"https://github.com/jaehun2841/redis-cluster-on-docker.git"</span></span><br><span class="line">git pull origin master</span><br></pre></td></tr></table></figure></p>
<h2 id="docker-설치">Docker 설치</h2>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#docker 설치</span></span><br><span class="line">curl -fsSL https://get.docker.com/ | sh</span><br><span class="line"> </span><br><span class="line"><span class="comment">#docker 설치 후 docker 시작</span></span><br><span class="line">service docker start</span><br></pre></td></tr></table></figure></p>
<p>Docker를 yum으로도 설치가 가능하지만 버전이 낮아 Docker-compose를 설치 할 수 없습니다.
차후에 update까지 필요하니 위 url에서 제공하는 shell script를 실행하여 설치하도록 합니다.
<strong>※ 위 Script는 sudo 명령 또는 root 권한을 필요로 합니다.</strong></p>
<p>Docker 설치 내용은 2장에서 기술한 내용을 참고하시길 바랍니다.</p>
<h2 id="docker-compose-설치">Docker-Compose 설치</h2>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#docker 공식 github에서 다운로드</span></span><br><span class="line">sudo curl -L <span class="string">"https://github.com/docker/compose/releases/download/1.23.1/docker-compose-<span class="variable">$(uname -s)</span>-<span class="variable">$(uname -m)</span>"</span> -o /usr/<span class="built_in">local</span>/bin/docker-compose</span><br><span class="line"></span><br><span class="line">chmod +x /usr/<span class="built_in">local</span>/bin/docker-compose</span><br></pre></td></tr></table></figure></p>
<p>Docker-Compose 설치 내용은 4장에서 기술한 내용을 참고하시길 바랍니다.</p>
<h2 id="docker-build">Docker build</h2>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># redis-cluster home 이동</span></span><br><span class="line"><span class="built_in">cd</span> /home/redis/redis-cluster</span><br><span class="line"> </span><br><span class="line"><span class="comment">#docker build</span></span><br><span class="line">docker-compose -f conf/docker-compose.yml up --build -d</span><br></pre></td></tr></table></figure></p>
<ul>
<li>-f 옵션으로 docker-compose.yml 파일을 설정합니다.
(docker-compose.yml 파일은 github redis-cluster 설치파일을 받을때 다운 받았습니다. )</li>
<li>up 명령으로 docker container를 실행합니다.</li>
<li>--build 옵션으로 build후 container를 실행합니다.</li>
<li>-d 옵션으로 background로 실행되도록 합니다.
(-d 옵션을 빼면 redis의 로그가....나오며 exit하는 순간 container가 stop됩니다.)</li>
</ul>
<h1 id="redis-cluster를-빌드하기-위한-docker-composeyml-파일">Redis Cluster를 빌드하기 위한 docker-compose.yml 파일</h1>
<p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"> </span><br><span class="line">  <span class="attr">redis-master:</span></span><br><span class="line">     <span class="attr">image:</span> <span class="attr">redis:5.0-alpine</span>   <span class="comment"># image 옵션으로 redis공식이미지를 기반으로 생성합니다.</span></span><br><span class="line">     <span class="attr">build:</span></span><br><span class="line">       <span class="attr">context:</span> <span class="string">..</span>             <span class="comment"># build file에 대한 context를 지정</span></span><br><span class="line">       <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span>  <span class="comment">#dockerfile명을 지정합니다. (Default는 "Dockerfile" 파일명을 가진 파일을 실행합니다.)</span></span><br><span class="line">     <span class="attr">network_mode:</span> <span class="string">"host"</span>      <span class="comment"># Image가 Container가 되었을때 network모드를 host모드로 설정합니다 (docker0 인터페이스를 사용하지 않고 Host OS의 eth0 인터페이스 사용)</span></span><br><span class="line">     <span class="attr">environment:</span>              <span class="comment"># Container 내부에서 사용 할 환경변수를 설정합니다.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REQUIREPASS=password1234</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CLIENTPORT=6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CLIENTHOST=192.168.137.101</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MASTERHOST=</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MASTERPORT=</span></span><br><span class="line">     <span class="attr">volumes:</span>  <span class="comment"># Host OS의 디렉터리와 Container내의 디렉터리와 연동합니다.</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"../redis-data/redis1:/data"</span></span><br><span class="line">     <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"> </span><br><span class="line">  <span class="attr">redis-slave1:</span></span><br><span class="line">     <span class="attr">image:</span> <span class="attr">redis:5.0-alpine</span></span><br><span class="line">     <span class="attr">build:</span></span><br><span class="line">       <span class="attr">context:</span> <span class="string">..</span></span><br><span class="line">       <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">     <span class="attr">network_mode:</span> <span class="string">"host"</span></span><br><span class="line">     <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REQUIREPASS=password1234</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CLIENTPORT=6380</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MASTERPORT=6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CLIENTHOST=192.168.137.101</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MASTERHOST=192.168.137.101</span></span><br><span class="line">     <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"../redis-data/redis2:/data"</span></span><br><span class="line">     <span class="attr">restart:</span> <span class="string">always</span></span><br><span class="line"> </span><br><span class="line">  <span class="attr">redis-slave2:</span></span><br><span class="line">     <span class="attr">image:</span> <span class="attr">redis:5.0-alpine</span></span><br><span class="line">     <span class="attr">build:</span></span><br><span class="line">       <span class="attr">context:</span> <span class="string">..</span></span><br><span class="line">       <span class="attr">dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line">     <span class="attr">network_mode:</span> <span class="string">"host"</span></span><br><span class="line">     <span class="attr">environment:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">REQUIREPASS=password1234</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CLIENTPORT=6381</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MASTERPORT=6379</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">CLIENTHOST=192.168.137.101</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">MASTERHOST=192.168.137.101</span> </span><br><span class="line">     <span class="attr">volumes:</span></span><br><span class="line">      <span class="bullet">-</span> <span class="string">"../redis-data/redis3:/data"</span></span><br><span class="line">     <span class="attr">restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure></p>
<blockquote>
<p><strong>Redis Container의 Network모드가 Host인 이유</strong>
Redis 공식 홈페이지의 cluster-tutorial에서 발췌한 내용입니다.</p>
<blockquote>
<p>Redis Cluster and Docker</p>
<p>Currently Redis Cluster does not support NATted environments and in general environments where IP addresses or TCP ports are remapped.
Docker uses a technique called port mapping: programs running inside Docker containers may be exposed with a different port compared to the one the program believes to be using.
This is useful in order to run multiple containers using the same ports, at the same time, in the same server.
<code>In order to make Docker compatible with Redis Cluster you need to use the host networking mode of Docker.</code> Please check the --net=host option in the Docker documentation for more information.</p>
</blockquote>
<p>Redis Cluster에서는 NAT환경과 IP주소 또는 TCP포트가 재 매핑되는 환경을 지원하지 않는다고 합니다.
따라서 Docker에서 Redis Cluster를 호환되게 하기 위해서는 Host 모드로 사용할 것을 권고하고 있습니다.</p>
</blockquote>
<h1 id="redis-container-생성을-위한-dockerfile-작성">Redis Container 생성을 위한 Dockerfile 작성</h1>
<p>Docker-Compose build를 사용하면서 Dockerfile에는 Redis Container를 구성하는 공통적인 로직을 담았습니다.
주로 내부에서 file을 생성하거나 Host OS의 파일을 Container가 생성하는 시점에 복사하기 위한 로직이 주로 들어있습니다.
그리고 접근권한이 막혀 파일이 실행되지 않는 문제를 해결하기 위해 접근권한을 변경하였습니다.</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">FROM redis:5.0-alpine //redis 이미지를 기반으로 빌드됨을 의미합니다.</span><br><span class="line"> </span><br><span class="line">MAINTAINER Carrey (jaehun2841@gmail.com)</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Copy Redis File</span></span><br><span class="line"><span class="comment"># 복사/추가 하는파일의 Container내 경로는 항상 절대경로로 작성하여야 합니다.</span></span><br><span class="line"><span class="comment"># 기존의 docker-entryporint.sh 파일을 삭제합니다.</span></span><br><span class="line">RUN rm -rf /usr/<span class="built_in">local</span>/bin/docker-entrypoint.sh  </span><br><span class="line"><span class="comment"># 공통적으로 적용할 redis.conf 파일을 복사합니다.</span></span><br><span class="line">ADD redis.conf /usr/<span class="built_in">local</span>/bin/redis.conf    </span><br><span class="line"><span class="comment"># Container가 생성, 시작하는 시점에 실행 시킬 docker-entrypoint.sh 파일을 복사합니다.</span></span><br><span class="line">ADD docker-entrypoint.sh /usr/<span class="built_in">local</span>/bin        </span><br><span class="line"> </span><br><span class="line"><span class="comment">## change access authority</span></span><br><span class="line">RUN chmod 755 /usr/<span class="built_in">local</span>/bin/redis.conf</span><br><span class="line">RUN chmod 755 /usr/<span class="built_in">local</span>/bin/docker-entrypoint.sh</span><br><span class="line"> </span><br><span class="line">RUN chown redis:redis /usr/<span class="built_in">local</span>/bin/redis.conf</span><br><span class="line">RUN chown redis:redis /usr/<span class="built_in">local</span>/bin/docker-entrypoint.sh</span><br><span class="line"></span><br><span class="line"><span class="comment">#Redis Container에 대한 Port를 지정합니다. (내부포트이며 외부노출은 안됨)</span></span><br><span class="line">EXPOSE <span class="variable">$CLIENTPORT</span> <span class="comment">#CLIENTPORT에 대한 값은 docker-compose.yml에 정의되어 있습니다.          </span></span><br><span class="line"><span class="comment"># Container가 생성, 시작하는 시점에 실행됩니다.</span></span><br><span class="line">ENTRYPOINT [<span class="string">"/usr/local/bin/docker-entrypoint.sh"</span>] </span><br><span class="line"><span class="comment"># Container 빌드가 완료되고 Redis Server를 실행시킵니다.</span></span><br><span class="line">CMD [ <span class="string">"redis-server"</span>,<span class="string">"/usr/local/bin/redis.conf"</span> ]</span><br></pre></td></tr></table></figure></p>
<h1 id="redis-cluster-설정">Redis Cluster 설정</h1>
<p>Redis Cluster에 대한 Replication 설정에 대해 알아보겠습니다.</p>
<p>설정 방법은 redis.conf 파일을 각 Container로 복사하여 공통적인 설정을 하였습니다.
각 redis.conf 파일에 대한 변경사항은 <code>docker-entrypoint.sh</code> 파일을 통해 redis.conf 파일 정보를 replace하였습니다.</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"> </span><br><span class="line"><span class="comment">## from redis-5.0</span></span><br><span class="line"><span class="comment"># Redis서버에 접근가능한 Host를 설정합니다.</span></span><br><span class="line">sed -i <span class="string">"s/bind 127.0.0.1/bind <span class="variable">$CLIENTHOST</span> 127.0.0.1/g"</span> /usr/<span class="built_in">local</span>/bin/redis.conf</span><br><span class="line"></span><br><span class="line"><span class="comment">### redis port inside redis.conf</span></span><br><span class="line"><span class="comment">#redis.conf 파일의 port 6379 문자열을 port $CLINETPORT로 변경합니다. </span></span><br><span class="line"><span class="comment">#($CLIENTPORT는 docker-compose.yml파일의 Environment에서 지정하였습니다.)</span></span><br><span class="line">sed -i <span class="string">"s/port 6379/port <span class="variable">$CLIENTPORT</span>/g"</span> /usr/<span class="built_in">local</span>/bin/redis.conf </span><br><span class="line"></span><br><span class="line"><span class="comment"># requirepass foobared 문자열을 requirepass $REQUIREPASS로 변경하였습니다. </span></span><br><span class="line"><span class="comment">#(Redis 접속 시 비밀번호를 설정하였습니다.)</span></span><br><span class="line">sed -i <span class="string">"s/# requirepass foobared/requirepass <span class="variable">$REQUIREPASS</span>/g"</span> /usr/<span class="built_in">local</span>/bin/redis.conf          </span><br><span class="line">sed -i <span class="string">"s/# masterauth &lt;master-password&gt;/masterauth <span class="variable">$REQUIREPASS</span>/g"</span> /usr/<span class="built_in">local</span>/bin/redis.conf   </span><br><span class="line"></span><br><span class="line"><span class="comment">### slaveof &lt;masterip&gt; &lt;masterport&gt; =&gt; slaveof $MASTERHOST $MASTERPORT</span></span><br><span class="line"><span class="comment"># $MASTERPORT가 공백이 아닌 Container에 대해 slaveof 설정을 통해 Master-Slave 설정을 합니다.</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$MASTERPORT</span>"</span> != <span class="string">""</span> ];<span class="keyword">then</span></span><br><span class="line">    sed -i <span class="string">"s/# slaveof &lt;masterip&gt; &lt;masterport&gt;/slaveof <span class="variable">$MASTERHOST</span> <span class="variable">$MASTERPORT</span>/g"</span> /usr/<span class="built_in">local</span>/bin/redis.conf  </span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># first arg is `-f` or `--some-option`</span></span><br><span class="line"><span class="comment"># or first arg is `something.conf`</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;1#-&#125;</span>"</span> != <span class="string">"<span class="variable">$1</span>"</span> ] || [ <span class="string">"<span class="variable">$&#123;1%.conf&#125;</span>"</span> != <span class="string">"<span class="variable">$1</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">set</span> -- redis-server <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># allow the container to be started with `--user`</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">'redis-server'</span> -a <span class="string">"<span class="variable">$(id -u)</span>"</span> = <span class="string">'0'</span> ]; <span class="keyword">then</span></span><br><span class="line">    chown -R redis .</span><br><span class="line">    <span class="built_in">exec</span> su-exec redis <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure></p>
<h1 id="redis-cluster-실행-결과">Redis Cluster 실행 결과</h1>
<p>Redis.log
<img src="./redis-replication-3746317.PNG" alt="redis-replication"></p>
<p>로그에서 0 clients connected (2 slaves) 라는 로그가 보입니다.
Redis에 접속한 클라이언트 수는 0 client이며
2개의 slave redis와 연결하고 있습니다.</p>
<p>중간부분 로그에서 로그를 보면 slave로 설정한 Redis와 연동이 되는 것을 확인 할 수 있습니다.</p>
<p>redis-cli &gt; info replication
<img src="./redis-replication2-3746337.PNG" alt="redis-replication2"></p>
<p>redis-cli에서 info replication 명령을 실행하였을 때, 조회되는 내용입니다.
slave0, slave1에 대한 참조를 가지고 있는 것을 확인 할 수 있습니다.</p>
<h1 id="참고">참고</h1>
<ul>
<li>https://redis.io/topics/cluster-tutorial</li>
</ul>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="../../../../tags/Docker/">Docker</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="../../02/2018-12-02-docker-7/"><i class="fa fa-chevron-left">  </i><span>Docker기반 Redis 구축하기 - (7) Docker를 이용한 Redis Sentinel 설치하기</span></a></div><div class="next-post pull-right"><a href="../2018-12-01-docker-5/"><span>Docker기반 Redis 구축하기 - (5) Docker Network구조</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://jaehun2841.github.io/2018/12/01/2018-12-01-docker-6/';
  this.page.identifier = '2018/12/01/2018-12-01-docker-6/';
  this.page.title = 'Docker기반 Redis 구축하기 - (6) Docker를 이용한 Redis Cluster 설치하기';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'Carrey' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2019 By Carrey</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="../../../../js/third-party/anime.min.js"></script><script src="../../../../js/third-party/jquery.min.js"></script><script src="../../../../js/third-party/jquery.fancybox.min.js"></script><script src="../../../../js/third-party/velocity.min.js"></script><script src="../../../../js/third-party/velocity.ui.min.js"></script><script src="../../../../js/utils.js?version=1.5.6"></script><script src="../../../../js/fancybox.js?version=1.5.6"></script><script src="../../../../js/sidebar.js?version=1.5.6"></script><script src="../../../../js/copy.js?version=1.5.6"></script><script src="../../../../js/fireworks.js?version=1.5.6"></script><script src="../../../../js/transition.js?version=1.5.6"></script><script src="../../../../js/scroll.js?version=1.5.6"></script><script src="../../../../js/head.js?version=1.5.6"></script></body></html>