<!DOCTYPE html><html lang="lang"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Docker기반 Redis 구축하기 - (7) Docker를 이용한 Redis Sentinel 설치하기"><meta name="keywords" content="Docker"><meta name="author" content="Carrey,undefined"><meta name="copyright" content="Carrey"><title>Docker기반 Redis 구축하기 - (7) Docker를 이용한 Redis Sentinel 설치하기 | Carrey`s 기술블로그</title><link rel="shortcut icon" href="../../../../my-favicon.ico"><link rel="stylesheet" href="../../../../css/index.css?version=1.5.6"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css?version=1.5.6"><link rel="dns-prefetch" href="https://cdn.staticfile.org"><link rel="dns-prefetch" href="https://cdn.bootcss.com"><link rel="dns-prefetch" href="https://creativecommons.org"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  }
} </script></head><body><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-sentinel이란"><span class="toc-number">1.</span> <span class="toc-text">Redis Sentinel이란?</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#role-change-원리"><span class="toc-number">2.</span> <span class="toc-text">Role Change 원리</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-sentinel-설치하기"><span class="toc-number">3.</span> <span class="toc-text">Redis Sentinel 설치하기</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#redis-sentinel-파일-다운로드"><span class="toc-number">3.1.</span> <span class="toc-text">Redis Sentinel 파일 다운로드</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#redis-sentinel-build"><span class="toc-number">3.2.</span> <span class="toc-text">Redis sentinel Build</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-sentinel-생성을-위한-docker-composeyml파일"><span class="toc-number">4.</span> <span class="toc-text">Redis Sentinel 생성을 위한 docker-compose.yml파일</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-sentinel-이미지-생성을-위한-dockerfile-작성"><span class="toc-number">5.</span> <span class="toc-text">Redis Sentinel 이미지 생성을 위한 Dockerfile 작성</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-sentinel-설정"><span class="toc-number">6.</span> <span class="toc-text">Redis Sentinel 설정</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#redis-sentinel-실행-결과"><span class="toc-number">7.</span> <span class="toc-text">Redis Sentinel 실행 결과</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#failover-test"><span class="toc-number">8.</span> <span class="toc-text">Failover Test</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#sdown-vs-odown"><span class="toc-number">8.1.</span> <span class="toc-text">sdown vs odown</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#중단되었던-6379-포트를-사용하는-redis-노드가-살아나면"><span class="toc-number">8.2.</span> <span class="toc-text">중단되었던 6379 포트를 사용하는 Redis 노드가 살아나면?</span></a></li></ol></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://www.gravatar.com/avatar/3f8583b7b0f0c1ebd249dffad42707af?s=300"></div><div class="author-info__name text-center">Carrey</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="../../../../archives"><span class="pull-left">Articles</span><span class="pull-right">33</span></a><a class="author-info-articles__tags article-meta" href="../../../../tags"><span class="pull-left">Tags</span><span class="pull-right">12</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container" style="background-image: url(true)"><div id="page-header"><span class="pull-left"> <a id="site-name" href="../../../../index.html">Carrey`s 기술블로그</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus"><a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span></div><div id="post-info"><div id="post-title">Docker기반 Redis 구축하기 - (7) Docker를 이용한 Redis Sentinel 설치하기</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2018-12-02</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="redis-sentinel이란">Redis Sentinel이란?</h1>
<p>Redis Cluster 운영환경에서 Master-Slave 관계를 가진 Redis가 있습니다.
시스템 오류나 알수 없는 원인으로 인해 Master Redis가 down되어 연결이 중단 되면, 사용자나 Application에서는 Redis Master를 통해 데이터를 등록 할 수 없게 됩니다.
이런 경우 Slave Redis를 Master Redis로 승격시켜 시스템이 정상적으로 운영 될 수 있도록 해야 합니다.</p>
<p>이 때 사용하는 게 Redis Sentinel입니다.
Sentinel은 Master Redis의 상태를 감시합니다. 그러다가 Master Redis가 Down이 되어버리면, Sentinel들은 Slave Redis들 중에 어떤 Redis 서버를 Master로 승격시킬지 투표하게 됩니다.
Slave Redis 중 Sentinel의 투표를 더 많이 받은 Redis Server가 Master Redis로 승격됩니다.
이후 장애를 해결한 원래 Master Redis는 재시작 시, 현재 Master Redis의 Slave Redis로 시작되게 됩니다.</p>
<p>이와같이, Redis Sentinel은 Redis Cluster 환경에서의 Failover를 자동으로 해주는 Redis의 한 Mode입니다.</p>
<h1 id="role-change-원리">Role Change 원리</h1>
<p><img src="./Redis-failover-1.PNG" alt="Redis-failover-1"></p>
<p>위의 상황은 6379 포트를 사용하는 Master Redis가 Down된 상황입니다.
Sentinel들은 일제히 Master Redis를 감시하다가 Down된 상황을 인지하고
2번째 그림처럼 Slave Redis들 중 어떤 Redis 서버를 Master Redis로 승격할 지 투표로 정하게 됩니다.
여기서 중요한 건 Redis Sentinel의 노드 갯수는 <code>항상 홀수로 설정</code>해야 합니다. (짝수 인 경우 1:1, 2:2 상황이 되어 어떤 Redis Server를 승격 시킬지 알 수 없기 때문입니다.)
위의 예제에서는 15485 번 포트를 사용하는 Slave Redis가 2대1로 선택되었습니다.
Sentinel은 바로 redis.conf 파일을 조작하여 Slave Redis를 Master Redis로 변경합니다.
그리고 자기 자신의 sentinel.conf 정보를 조작하여 감시하는 Redis 서버 정보를 update 합니다.
이후 Down되었던 기존의 Master Redis의 장애가 처리되어 Restart되는 경우를 보도록 하겠습니다.</p>
<p><img src="./Redis-failover-2.PNG" alt="Redis-failover-2"></p>
<p>Sentinel은 Down되었던 Master 정보를 메모리에 저장하고 있습니다.
이후 Down되었던 Master Redis가 장애를 처리하고 다시 시작 되는 경우, Master Redis의 redis.conf 파일을 조작하여
현재 Master Redis의 Slave로 설정합니다.</p>
<blockquote>
<p>이 경우 Sentinel의 설정 값이 따라 다르지만,
일시적으로 Master Redis가 2대가 됩니다.
만약에 Down 되었다가 Restart된 Redis에 Data가 저장되는 경우, Slave Redis로 전환되면서 Master의 rdb파일을 바탕으로 Data를 Update하기 때문에 데이터가 사라지는 상황이 오게 됩니다.
따라서 Down 되었다가 살아나는 Redis에 접근 하지 못하도록 막아야 합니다.</p>
</blockquote>
<h1 id="redis-sentinel-설치하기">Redis Sentinel 설치하기</h1>
<p>Docker, Docker-Compose, git은 Redis Cluster를 설치하며 설치 했다고 가정하겠습니다.</p>
<h2 id="redis-sentinel-파일-다운로드">Redis Sentinel 파일 다운로드</h2>
<p>기존에 github에 올려둔 Sentienel 설정파일을 다운로드 합니다.</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">mkdir -p /home/redis/redis-sentinel <span class="comment">#Redis-sentinel home 생성</span></span><br><span class="line"><span class="built_in">cd</span> /home/redis</span><br><span class="line">mkdir -p ./sentinel-data/sentinel1   <span class="comment">#외부 log파일 볼륨 설정</span></span><br><span class="line">mkdir -p ./sentinel-data/sentinel2</span><br><span class="line">mkdir -p ./sentinel-data/sentinel3</span><br><span class="line"> </span><br><span class="line">git init</span><br><span class="line">git remote add origin <span class="string">"https://github.com/jaehun2841/redis-sentinel-on-docker.git"</span></span><br><span class="line">git pull origin master <span class="comment">#github에서 sentinel 설정 파일 다운로드</span></span><br></pre></td></tr></table></figure></p>
<h2 id="redis-sentinel-build">Redis sentinel Build</h2>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> /home/redis/redis-sentinel</span><br><span class="line">docker-compose -f conf/sentinel-docker-compose.yml up --build -d</span><br></pre></td></tr></table></figure></p>
<h1 id="redis-sentinel-생성을-위한-docker-composeyml파일">Redis Sentinel 생성을 위한 docker-compose.yml파일</h1>
<p><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="attr">version:</span> <span class="string">'3'</span></span><br><span class="line"><span class="attr">services:</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">  redis-sentinel1:</span>                        <span class="comment">#Sentinel Container명</span></span><br><span class="line"><span class="attr">     image:</span> <span class="string">lgatica/redis-sentinel:4.0.2</span>  <span class="comment">#redis-sentinel 이미지를 바탕으로 빌드합니다.</span></span><br><span class="line"><span class="attr">     build:</span></span><br><span class="line"><span class="attr">       context:</span> <span class="string">..</span>                        <span class="comment">#Dockerfile context 설정</span></span><br><span class="line"><span class="attr">       dockerfile:</span> <span class="string">Dockerfile</span>             <span class="comment">#Dockerfile명 설정 (Default는 Dockerfile로 된 파일명을 찾습니다.)</span></span><br><span class="line"><span class="attr">     network_mode:</span> <span class="string">"host"</span></span><br><span class="line"><span class="attr">     environment:</span>                         <span class="comment">#Container에서 사용할 환경 변수 설정</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CLIENTHOST=192.168.137.101</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CLIENTPORT=26379</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">MASTERHOST=192.168.137.101</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">MASTERPORT=6379</span>                   <span class="comment">#Sentinel의 mymaster port를 적어줍니다.</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">QUORUM=2</span>                          <span class="comment">#QUORUM 값은 Sentinel들이 투표했을때 득표수가 2 이상인 Redis에 대해 Master로 승격할 수 있도록 하는 조건 값입니다.</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">DOWN_AFTER_MILLISEC=3000</span>          <span class="comment">#Redis master node down 후 3초 이후 failover 시작</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">FAILOVER_TIMEOUT=3000</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">REQUIREPASS=password1234</span></span><br><span class="line"><span class="attr">     volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"../../sentinel-data/sentinel1:/redis"</span>  <span class="comment">#Container 외부 볼륨 설정</span></span><br><span class="line"><span class="attr">     restart:</span> <span class="string">always</span>                         <span class="comment">#restart policy Container가 중지되거나 down되는 경우 무조건 다시 시작합니다.</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">  redis-sentinel2:</span></span><br><span class="line"><span class="attr">     image:</span> <span class="string">lgatica/redis-sentinel:4.0.2</span></span><br><span class="line"><span class="attr">     build:</span></span><br><span class="line"><span class="attr">       context:</span> <span class="string">..</span></span><br><span class="line"><span class="attr">       dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line"><span class="attr">     network_mode:</span> <span class="string">"host"</span></span><br><span class="line"><span class="attr">     environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CLIENTHOST=192.168.137.101</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CLIENTPORT=26380</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">MASTERHOST=192.168.137.101</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">MASTERPORT=6379</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">QUORUM=2</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">DOWN_AFTER_MILLISEC=3000</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">FAILOVER_TIMEOUT=3000</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">REQUIREPASS=password1234</span></span><br><span class="line"><span class="attr">     volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"../../sentinel-data/sentinel2:/redis"</span></span><br><span class="line"><span class="attr">     restart:</span> <span class="string">always</span></span><br><span class="line"> </span><br><span class="line"><span class="attr">  redis-sentinel3:</span></span><br><span class="line"><span class="attr">     image:</span> <span class="string">lgatica/redis-sentinel:4.0.2</span></span><br><span class="line"><span class="attr">     build:</span></span><br><span class="line"><span class="attr">       context:</span> <span class="string">..</span></span><br><span class="line"><span class="attr">       dockerfile:</span> <span class="string">Dockerfile</span></span><br><span class="line"><span class="attr">     network_mode:</span> <span class="string">"host"</span></span><br><span class="line"><span class="attr">     environment:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CLIENTHOST=192.168.137.101</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">CLIENTPORT=26381</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">MASTERHOST=192.168.137.101</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">MASTERPORT=6379</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">QUORUM=2</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">DOWN_AFTER_MILLISEC=3000</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">FAILOVER_TIMEOUT=3000</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">REQUIREPASS=password1234</span></span><br><span class="line"><span class="attr">     volumes:</span></span><br><span class="line"><span class="bullet">      -</span> <span class="string">"../../sentinel-data/sentinel3:/redis"</span></span><br><span class="line"><span class="attr">     restart:</span> <span class="string">always</span></span><br></pre></td></tr></table></figure></p>
<h1 id="redis-sentinel-이미지-생성을-위한-dockerfile-작성">Redis Sentinel 이미지 생성을 위한 Dockerfile 작성</h1>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#redis-sentinel 이미지 기반으로 빌드합니다.</span></span><br><span class="line">FROM lgatica/redis-sentinel:4.0.2   </span><br><span class="line"> </span><br><span class="line">MAINTAINER Carrey </span><br><span class="line"> </span><br><span class="line"><span class="comment">## Copy Redis File</span></span><br><span class="line"><span class="comment">## 복사/추가 하는파일의 Container내 경로는 항상 절대경로로 작성하여야 한다.</span></span><br><span class="line"><span class="comment"># 기존 container의 sentinel-entrypoint.sh 삭제합니다.</span></span><br><span class="line">RUN rm -rf /usr/<span class="built_in">local</span>/bin/sentinel-entrypoint.sh         </span><br><span class="line"></span><br><span class="line"><span class="comment"># sentinel 설정이 담긴 sentinel.conf 파일 복사합니다.</span></span><br><span class="line">ADD sentinel.conf /usr/<span class="built_in">local</span>/bin/sentinel.conf                          </span><br><span class="line"></span><br><span class="line"><span class="comment"># sentinel container 시작 시, 실행 시킬 docker-entrypoint.sh 파일을 복사합니다.</span></span><br><span class="line">ADD sentinel-entrypoint.sh /usr/<span class="built_in">local</span>/bin/sentinel-entrypoint.sh         </span><br><span class="line"> </span><br><span class="line"><span class="comment">## change access authority</span></span><br><span class="line"><span class="comment"># 복사한 파일에 대한 권한을 변경합니다. (Permission Denied 문제)</span></span><br><span class="line">RUN chmod 755 /usr/<span class="built_in">local</span>/bin/sentinel.conf                               </span><br><span class="line">RUN chmod 755 /usr/<span class="built_in">local</span>/bin/sentinel-entrypoint.sh</span><br><span class="line">RUN chown redis:redis /usr/<span class="built_in">local</span>/bin/sentinel.conf</span><br><span class="line">RUN chown redis:redis /usr/<span class="built_in">local</span>/bin/sentinel-entrypoint.sh</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Redis Container에 대한 Port를 지정합니다. (host 모드이기 때문에 외부 노출)</span></span><br><span class="line">EXPOSE <span class="variable">$CLIENTPORT</span>                                    </span><br><span class="line"></span><br><span class="line"><span class="comment"># Container가 생성, 시작하는 시점에 실행됩니다.</span></span><br><span class="line">ENTRYPOINT [<span class="string">"/usr/local/bin/sentinel-entrypoint.sh"</span>]        </span><br><span class="line"></span><br><span class="line"><span class="comment"># Container 빌드가 완료되고 Sentinel Server를 실행시킵니다. </span></span><br><span class="line"><span class="comment"># conf 파일 뿐만 아니라 --sentinel 옵션을 추가하여 Redis가 Sentinel 모드로 실행 되도록 합니다.</span></span><br><span class="line"><span class="comment"># Sentinel 또한 Redis Server이지만, Sentinel 설정을 하여 실행 시키는 것 뿐입니다.</span></span><br><span class="line">CMD [ <span class="string">"redis-server"</span>,<span class="string">"/usr/local/bin/sentinel.conf"</span>, <span class="string">"--sentinel"</span> ]</span><br></pre></td></tr></table></figure></p>
<h1 id="redis-sentinel-설정">Redis Sentinel 설정</h1>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="built_in">set</span> -e</span><br><span class="line"> </span><br><span class="line"><span class="comment"># bind 127.0.0.1 문자열을 각 이미지에서 설정한 $CLIENTHOST 값으로 변경합니다. </span></span><br><span class="line"><span class="comment"># $CLIENTPORT는 docker-compose.yml파일의 Environment에서 지정하였습니다.</span></span><br><span class="line">sed -i <span class="string">"s/bind 127.0.0.1/bind <span class="variable">$CLIENTHOST</span>/g"</span> /usr/<span class="built_in">local</span>/bin/sentinel.conf      </span><br><span class="line">         </span><br><span class="line"><span class="comment"># port 6379 문자열을 각 이미지에서 설정한 $CLIENTPORT 값으로 변경합니다. </span></span><br><span class="line"><span class="comment"># Sentinel 이미지 별로 port다르게 설정</span></span><br><span class="line">sed -i <span class="string">"s/port 6379/port <span class="variable">$CLIENTPORT</span>/g"</span> /usr/<span class="built_in">local</span>/bin/sentinel.conf  </span><br><span class="line"> </span><br><span class="line"><span class="comment"># sentinel에 대한 mymaster를 설정하는 부분입니다. </span></span><br><span class="line"><span class="comment"># 실제 Master Redis의 ip와 port를 설정하고 QUORUM 값을 설정합니다.</span></span><br><span class="line"><span class="comment"># QUORUM 값은 Slave-&gt;Master Role Change 시, slave redis가 받아야 하는 최소 투표 수 입니다.</span></span><br><span class="line">sed -i <span class="string">"s/sentinel monitor mymaster 127.0.0.1 6379 2/sentinel monitor mymaster <span class="variable">$MASTERHOST</span> <span class="variable">$MASTERPORT</span> <span class="variable">$QUORUM</span>/g"</span> /usr/<span class="built_in">local</span>/bin/sentinel.conf</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Redis server가 다운되고 후처리 실행 시간 까지 걸리는 시간을 지정합니다. </span></span><br><span class="line"><span class="comment"># ex)3000 -&gt; 3000 밀리세컨드 -&gt; 3초</span></span><br><span class="line">sed -i <span class="string">"s/sentinel down-after-milliseconds mymaster 30000/sentinel down-after-milliseconds mymaster <span class="variable">$DOWN_AFTER_MILLISEC</span>/g"</span> /usr/<span class="built_in">local</span>/bin/sentinel.conf</span><br><span class="line"> </span><br><span class="line"><span class="comment"># Redis failover timeout 시간을 설정 합니다.</span></span><br><span class="line">sed -i <span class="string">"s/sentinel failover-timeout mymaster 180000/sentinel failover-timeout mymaster <span class="variable">$FAILOVER_TIMEOUT</span>/g"</span> /usr/<span class="built_in">local</span>/bin/sentinel.conf</span><br><span class="line"> </span><br><span class="line"><span class="comment"># sentinel이 master redis에 접근할 때 인증하는 비밀번호를 설정합니다.</span></span><br><span class="line">sed -i <span class="string">"s/# sentinel auth-pass mymaster MySUPER--secret-0123passw0rd/sentinel auth-pass mymaster <span class="variable">$REQUIREPASS</span>/g"</span> /usr/<span class="built_in">local</span>/bin/sentinel.conf</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment"># first arg is `-f` or `--some-option`</span></span><br><span class="line"><span class="comment"># or first arg is `something.conf`</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$&#123;1#-&#125;</span>"</span> != <span class="string">"<span class="variable">$1</span>"</span> ] || [ <span class="string">"<span class="variable">$&#123;1%.conf&#125;</span>"</span> != <span class="string">"<span class="variable">$1</span>"</span> ]; <span class="keyword">then</span></span><br><span class="line">    <span class="built_in">set</span> -- redis-server <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># allow the container to be started with `--user`</span></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$1</span>"</span> = <span class="string">'redis-server'</span> -a <span class="string">"<span class="variable">$(id -u)</span>"</span> = <span class="string">'0'</span> ]; <span class="keyword">then</span></span><br><span class="line">    chown -R redis .</span><br><span class="line">    <span class="built_in">exec</span> su-exec redis <span class="string">"<span class="variable">$@</span>"</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> </span><br><span class="line"><span class="built_in">exec</span> <span class="string">"<span class="variable">$@</span>"</span></span><br></pre></td></tr></table></figure></p>
<h1 id="redis-sentinel-실행-결과">Redis Sentinel 실행 결과</h1>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker-compose -f conf/sentinel-docker-compose.yml up --build -d</span><br></pre></td></tr></table></figure></p>
<p><img src="./redis-sentinel-log.PNG" alt="redis-sentinel-log"></p>
<p>sentinel 1~3 까지의 로그를 모아보았습니다.
테스트용 port인 (6379~6381) 에 대한 master/slave 정보를 가지고 있는것을 볼수 있습니다.</p>
<p>로그처럼</p>
<p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel2_1  | 1:X 02 Dec 10:06:24.082 # +monitor master mymaster 192.168.137.101 6379 quorum 2</span><br></pre></td></tr></table></figure></p>
<p>sentinel이 자신의 마스터에 대한 정보를 가지고 모니터 하며 quorum 2를 가지고 있는 것을 볼 수 있습니다.</p>
<h1 id="failover-test">Failover Test</h1>
<p>자, Failover를 구성 했으니 실제로 Master를 한번 죽여보도록 해보겠습니다.</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop &lt;master_node_id&gt; <span class="comment"># Redis Master Container를 중지</span></span><br></pre></td></tr></table></figure></p>
<p><img src="./redis-failover-log.PNG" alt="redis-failover-log"></p>
<p>맨 처음 로그를 살펴보면 각 sentinel 노드에서 sdown 시그널을 발생시키고 있습니다.</p>
<p>중간정도 줄을 보면</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">+odown master mymaster 192.168.137.101 6379 <span class="comment">#quorum 3/2</span></span><br></pre></td></tr></table></figure></p>
<p>라는 로그가 나오게 되는데 3개의 sentinel에서 모두 sdown으로 인지하게 되는것입니다.
3/2의 뜻은  2개 노드에서 sdown이 발생 했을 때, odown 판정을 내린다는 다수결 투표 숫자입니다.
그런데 3개의 노드가 모두 투표를 하여 과반수 이상이 되었으므로 192.168.137.101 6379인 Redis 노드는 odown상태가 되었습니다.</p>
<p>그 바로 다음 줄 부터 failover 작업이 시작됩니다.
위의 예제에서는 6380 포트를 사용하는 redis노드가 새로운 마스터로 선출 되었습니다.
따라서 6380 포트를 사용하는 redis노드는 master로 role-change가 되면서 master 노드로써 역할을 수행하게 됩니다.</p>
<p>이렇게 Redis Sentinel을 이용하여 master node를 감시하며, 장애 상황에 대한 failover를 지원하고 있습니다.</p>
<h2 id="sdown-vs-odown">sdown vs odown</h2>
<p>Sentinel에서 down을 판단하는 방법은 <code>sdown</code>과 <code>odown</code>으로 이루어집니다.
failover 시 Master가 죽었다는 걸 판단하기 위해서는 <code>다수결의 원칙</code>이 적용됩니다. (그래서 Sentinel노드 갯수를 홀수로 설정하는 이유입니다.)</p>
<p>먼저, Master가 죽게 되면 Sentinel은 자신이 감시하고 있는 Master가 죽었다고 sdown 시그널을 표현합니다 (<code>Subjective Down</code> 이라 합니다.)
sdown은 단지 Master와 Sentinel 자기 자신이 연결이 되지 않음을 의미합니다.</p>
<p>위에서 보듯이 Master가 죽었으니 다른 Sentinel들도 연결이 끊어졌다고 sdown 시그널을 보냅니다.
그렇게 되면 다수결에 원칙에 따라 quorum값 만큼의 sdown이 발생하면 sentinel은 odown 시그널을 보냅니다. (<code>Objective Down</code>이라 합니다.)</p>
<p>odown은 다수결에 의해서 명시적으로 Master가 Down되었다고 선포하는 것과 같습니다.
그렇게 되면 Sentinel들은 다음 Master를 선출하기 위해 남아있는 Slave Redis들에게 투표를 하게 됩니다.
다수결의 원칙으로 더 많은 투표수를 받은 Slave가 Master로 선출되게 됩니다.</p>
<h2 id="중단되었던-6379-포트를-사용하는-redis-노드가-살아나면">중단되었던 6379 포트를 사용하는 Redis 노드가 살아나면?</h2>
<p>아까 stop했던 container를 다시 살려보겠습니다.</p>
<p><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start &lt;redis1_node_id&gt;</span><br></pre></td></tr></table></figure></p>
<p><img src="./redis-failover-3-3748019.PNG" alt="redis-failover-3"></p>
<p>3번째 줄부터 보시면, sentinel에서 <code>-sdown</code> 로그를 찍어주고 있습니다.
sentinel에서 연결되지 않았던 6379번 노드에 대해 정상적으로 커넥션이 맺어지고 있기 때문입니다.
중간 줄 부터 보게 되면다른 sentinel 노드에서도 <code>-sdown</code> 로그를 찍어주며 6379번 노드에 대한 부활을 알려주고 있습니다.</p>
<p>그런 다음에 <code>+convert-to-slave</code> 로그를 보면, 기존의 6379번 노드는 원래 master role을 수행 하던 Redis 노드였습니다.
하지만 현재 sentinel에 대한 mymaster는 6380번 노드이기 때문에 6379번 노드는 master role을 수행 할 수 없습니다.</p>
<p>따라서  <code>+role-change</code> 명령을 통해  기존에 master role -&gt; slave role로 변경되어야 합니다.
그리고 현재 master role 권한이 있는 6380번 노드의 slave으로 편입되게 됩니다.
redis-cli를 통해 6379번 노드에 접속하여 <code>info replication</code> 명령을 날려보았습니다.</p>
<p><img src="./redis-failover-4.PNG" alt="redis-failover-4"></p>
<p>현재 role은 <code>slave</code> 이며, 6380번 노드를 master로 설정하고 있습니다.</p>
<blockquote>
<p><strong>왜 기존의 master가 살아나면, slave로 전환하여 사용해야 할까?</strong></p>
<p>이유는 간단합니다.
Redis Master-Slave간 데이터 Replication을 이해 하면 쉽게 이해 할 수 있습니다
Redis의 데이터 Replication은 dump.rdb파일을 통해 이루어지는데,
master노드 만 dump.rdb파일에 데이터를 write 할 수 있습니다.
slave노드에서는 dump.rdb파일을 읽어서 데이터 replication을 하게 되는데,
만약 기존의 master의 role이 유지된다면, dump.rdb파일을 조작하여 기존의 master가 다운된 시간 동안
들어온 데이터가 삭제될 수 있습니다.
그렇게 때문에 데이터 정합성을 위해 기존의 master는 slave로 role이 전환되어야 합니다.</p>
</blockquote>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="../../../../tags/Docker/">Docker</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="../2018-12-02-docker-8/"><i class="fa fa-chevron-left">  </i><span>Docker기반 Redis 구축하기 - (8) HAProxy를 이용한 분산처리 환경 구축하기</span></a></div><div class="next-post pull-right"><a href="../../01/2018-12-01-docker-6/"><span>Docker기반 Redis 구축하기 - (6) Docker를 이용한 Redis Cluster 설치하기</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'http://yoursite-url/2018/12/02/2018-12-02-docker-7/';
  this.page.identifier = '2018/12/02/2018-12-02-docker-7/';
  this.page.title = 'Docker기반 Redis 구축하기 - (7) Docker를 이용한 Redis Sentinel 설치하기';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'Carrey' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 By Carrey</div><div class="framework-info"><span>Driven - </span><a href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file-o"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="../../../../js/third-party/anime.min.js"></script><script src="../../../../js/third-party/jquery.min.js"></script><script src="../../../../js/third-party/jquery.fancybox.min.js"></script><script src="../../../../js/third-party/velocity.min.js"></script><script src="../../../../js/third-party/velocity.ui.min.js"></script><script src="../../../../js/utils.js?version=1.5.6"></script><script src="../../../../js/fancybox.js?version=1.5.6"></script><script src="../../../../js/sidebar.js?version=1.5.6"></script><script src="../../../../js/copy.js?version=1.5.6"></script><script src="../../../../js/fireworks.js?version=1.5.6"></script><script src="../../../../js/transition.js?version=1.5.6"></script><script src="../../../../js/scroll.js?version=1.5.6"></script><script src="../../../../js/head.js?version=1.5.6"></script></body></html>