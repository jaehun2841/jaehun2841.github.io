<!DOCTYPE html><html lang="lang"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content="Item 11. Equals를 재정의하려거든 Hashcode도 재정의하라"><meta name="keywords" content="Effective-Java"><meta name="author" content="Carrey"><meta name="copyright" content="Carrey"><title>Item 11. Equals를 재정의하려거든 Hashcode도 재정의하라 | Carrey`s 기술블로그</title><link rel="shortcut icon" href="../../../../melody-favicon.ico"><link rel="stylesheet" href="../../../../css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.0.0'
} </script><meta name="generator" content="Hexo 6.0.0"><link rel="alternate" href="rss2.xml" title="Carrey`s 기술블로그" type="application/rss+xml">
</head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="true"><div class="toggle-sidebar-info text-center"><span data-toggle="Toggle article">Toggle site</span><hr></div><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar"></div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%84%9C%EB%A1%A0"><span class="toc-number">1.</span> <span class="toc-text">서론</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#hashcode%EC%9D%98-%EA%B7%9C%EC%95%BD"><span class="toc-number">2.</span> <span class="toc-text">hashcode의 규약</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#equals-%EB%A9%94%EC%84%9C%EB%93%9C%EB%8A%94-%EC%9E%AC%EC%A0%95%EC%9D%98%ED%96%88%EC%A7%80%EB%A7%8C-hashcode%EB%A5%BC-%EC%9E%AC%EC%A0%95%EC%9D%98%ED%95%98%EC%A7%80-%EC%95%8A%EC%9D%80-%EA%B2%BD%EC%9A%B0"><span class="toc-number">3.</span> <span class="toc-text">equals 메서드는 재정의했지만, hashcode를 재정의하지 않은 경우</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-1-hashcode%EB%A5%BC-%EC%9E%AC%EC%A0%95%EC%9D%98-%ED%95%98%EC%A7%80-%EC%95%8A%EC%9D%80-%EA%B2%BD%EC%9A%B0"><span class="toc-number">3.1.</span> <span class="toc-text">Test.1 hashcode를 재정의 하지 않은 경우</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Test-2-hashcode%EB%A5%BC-%EC%9E%AC%EC%A0%95%EC%9D%98-%ED%95%9C-%EA%B2%BD%EC%9A%B0"><span class="toc-number">3.2.</span> <span class="toc-text">Test.2 hashcode를 재정의 한 경우</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%B5%9C%EC%95%85%EC%9D%98-hashcode-%EA%B5%AC%ED%98%84"><span class="toc-number">4.</span> <span class="toc-text">최악의 hashcode 구현</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#hashcode%EA%B0%80-%EA%B0%99%EC%9C%BC%EB%A9%B4-HashMap%EC%97%90%EC%84%9C-%EC%96%B4%EB%96%BB%EA%B2%8C-%EB%8F%99%EC%9E%91%ED%95%A0%EA%B9%8C"><span class="toc-number">4.1.</span> <span class="toc-text">hashcode가 같으면 HashMap에서 어떻게 동작할까?</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%A2%8B%EC%9D%80-%ED%95%B4%EC%8B%9C-%ED%95%A8%EC%88%98-%EB%A7%8C%EB%93%A4%EA%B8%B0"><span class="toc-number">5.</span> <span class="toc-text">좋은 해시 함수 만들기</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#hashcode%EB%A5%BC-%ED%8E%B8%ED%95%98%EA%B2%8C-%EB%A7%8C%EB%93%A4%EC%96%B4-%EC%A3%BC%EB%8A%94-%EB%AA%A8%EB%93%88"><span class="toc-number">6.</span> <span class="toc-text">hashcode를 편하게 만들어 주는 모듈</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#hashcode%EB%A5%BC-%EC%9E%AC%EC%A0%95%EC%9D%98-%ED%95%A0-%EB%95%8C-%EC%A3%BC%EC%9D%98-%ED%95%A0-%EC%A0%90"><span class="toc-number">7.</span> <span class="toc-text">hashcode를 재정의 할 때 주의 할 점!</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%EC%B0%B8%EA%B3%A0"><span class="toc-number">8.</span> <span class="toc-text">참고</span></a></li></ol></div></div><div class="author-info hide"><div class="author-info__avatar text-center"><img src="https://www.gravatar.com/avatar/3f8583b7b0f0c1ebd249dffad42707af?s=300"></div><div class="author-info__name text-center">Carrey</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href="../../../../archives"><span class="pull-left">Articles</span><span class="pull-right">115</span></a><a class="author-info-articles__tags article-meta" href="../../../../tags"><span class="pull-left">Tags</span><span class="pull-right">27</span></a></div></div></div><div id="content-outer"><div class="no-bg" id="top-container"><div id="page-header"><span class="pull-left"> <a id="site-name" href="../../../../index.html">Carrey`s 기술블로그</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="post-info"><div id="post-title">Item 11. Equals를 재정의하려거든 Hashcode도 재정의하라</div><div id="post-meta"><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-01-12</time></div></div></div><div class="layout" id="content-inner"><article id="post"><div class="article-container" id="post-content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p><code>equals를 재정의한 클래스에서는 hashcode도 재정의 해야한다.</code><br>그렇지 않으면 hash를 사용하는 HashMap, HashSet과 같은 컬렉션의 원소로 사용될 때 문제가 발생할 것이다.</p>
<p>이번 글을 읽기 전에 아래 글을 먼저 읽어 해시, 해시테이블에 대한 용어를 먼저 익히는 것이 도움이 될 것 같다.</p>
<ul>
<li><a target="_blank" rel="noopener" href="http://bcho.tistory.com/1072">해쉬 테이블의 이해와 구현 (Hashtable) - 조대협의 블로그</a></li>
<li><a target="_blank" rel="noopener" href="https://d2.naver.com/helloworld/831311">Java HashMap은 어떻게 동작하는가? - Naver D2</a></li>
</ul>
<h1 id="hashcode의-규약"><a href="#hashcode의-규약" class="headerlink" title="hashcode의 규약"></a>hashcode의 규약</h1><ul>
<li>equals비교에 사용되는 정보가 변경되지 않았다면, 객체의 hashcode 메서드는 몇번을 호출해도 항상 일관된 값을 반환해야 한다.<br>(단, Application을 다시 실행한다면 값이 달라져도 상관없다. (메모리 소가 달라지기 때문))</li>
<li>equals메서드 통해 두 개의 객체가 같다고 판단했다면, 두 객체는 똑같은 hashcode 값을 반환해야 한다.</li>
<li>equals메서드가 두 개의 객체를 다르다고 판단했다 하더라도, 두 객체의 hashcode가 서로 다른 값을 가질 필요는 없다. (Hash Collision)<br>단, 다른 객체에 대해서는 다른 값을 반환해야 해시테이블의 성능이 좋아진다.</li>
</ul>
<h1 id="equals-메서드는-재정의했지만-hashcode를-재정의하지-않은-경우"><a href="#equals-메서드는-재정의했지만-hashcode를-재정의하지-않은-경우" class="headerlink" title="equals 메서드는 재정의했지만, hashcode를 재정의하지 않은 경우"></a>equals 메서드는 재정의했지만, hashcode를 재정의하지 않은 경우</h1><p>hashcode의 규약 2번째 조건을 위반하는 행위이다.<br>Effective Java 11장에서 설명하는 PhoneNumber 클래스를 생성해 테스트 해 보았다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(JUnit4.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashCodeTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> hashcode_재정의() &#123;</span><br><span class="line">        HashMap&lt;ExtendedPhoneNumber, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="keyword">new</span> <span class="title class_">ExtendedPhoneNumber</span>(<span class="number">707</span>, <span class="number">867</span>, <span class="number">5307</span>), <span class="string">&quot;제니&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Instance 1 hashcode : &quot;</span> + <span class="keyword">new</span> <span class="title class_">ExtendedPhoneNumber</span>(<span class="number">707</span>, <span class="number">867</span>, <span class="number">5307</span>).hashCode());</span><br><span class="line">        System.out.println(<span class="string">&quot;Instance 2 hashcode : &quot;</span> + <span class="keyword">new</span> <span class="title class_">ExtendedPhoneNumber</span>(<span class="number">707</span>, <span class="number">867</span>, <span class="number">5307</span>).hashCode());</span><br><span class="line">        Assert.assertEquals(map.get(<span class="keyword">new</span> <span class="title class_">ExtendedPhoneNumber</span>(<span class="number">707</span>, <span class="number">867</span>, <span class="number">5307</span>)), <span class="string">&quot;제니&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> hashcode_재정의안함() &#123;</span><br><span class="line">        HashMap&lt;PhoneNumber, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="keyword">new</span> <span class="title class_">PhoneNumber</span>(<span class="number">707</span>, <span class="number">867</span>, <span class="number">5307</span>), <span class="string">&quot;제니&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Instance 1 hashcode : &quot;</span> + <span class="keyword">new</span> <span class="title class_">PhoneNumber</span>(<span class="number">707</span>, <span class="number">867</span>, <span class="number">5307</span>).hashCode());</span><br><span class="line">        System.out.println(<span class="string">&quot;Instance 2 hashcode : &quot;</span> + <span class="keyword">new</span> <span class="title class_">PhoneNumber</span>(<span class="number">707</span>, <span class="number">867</span>, <span class="number">5307</span>).hashCode());</span><br><span class="line">        Assert.assertNotEquals(map.get(<span class="keyword">new</span> <span class="title class_">PhoneNumber</span>(<span class="number">707</span>, <span class="number">867</span>, <span class="number">5307</span>)), <span class="string">&quot;제니&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PhoneNumber</span> &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="type">int</span> firstNumber;</span><br><span class="line">        <span class="keyword">protected</span> <span class="type">int</span> secondNumber;</span><br><span class="line">        <span class="keyword">protected</span> <span class="type">int</span> thirdNumber;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> PhoneNumber)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">PhoneNumber</span> <span class="variable">p</span> <span class="operator">=</span> (PhoneNumber) o;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.firstNumber == p.firstNumber &amp;&amp;</span><br><span class="line">                    <span class="built_in">this</span>.secondNumber == p.secondNumber &amp;&amp;</span><br><span class="line">                    <span class="built_in">this</span>.thirdNumber == p.thirdNumber;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ExtendedPhoneNumber</span> <span class="keyword">extends</span> <span class="title class_">PhoneNumber</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ExtendedPhoneNumber</span><span class="params">(<span class="type">int</span> firstNumber, <span class="type">int</span> secondNumber, <span class="type">int</span> thirdNumber)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(firstNumber, secondNumber, thirdNumber);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">31</span>;</span><br><span class="line">            <span class="type">int</span> <span class="variable">hashcode</span> <span class="operator">=</span> Integer.hashCode(firstNumber);</span><br><span class="line">            hashcode = c * hashcode + Integer.hashCode(secondNumber);</span><br><span class="line">            hashcode = c * hashcode + Integer.hashCode(thirdNumber);</span><br><span class="line">            <span class="keyword">return</span> hashcode;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="Test-1-hashcode를-재정의-하지-않은-경우"><a href="#Test-1-hashcode를-재정의-하지-않은-경우" class="headerlink" title="Test.1 hashcode를 재정의 하지 않은 경우"></a>Test.1 hashcode를 재정의 하지 않은 경우</h2><p>PhoneNumber 클래스에서는 객체 동치성 체크를 위해 equals메서드를 재정의했다. <strong>하지만 hashcode 메서드는 재정의 하지 않았다.</strong><br>new를 통해 새로운 객체를 만들 때마다 늘 다른 hashcode를 리턴하여, 실제 HashMap에 key로 PhoneNumber클래스를 삽입하더라도<br>hashcode가 다르기 때문에 다른 버킷에가서 데이터를 조회 하려고해서 결과적으로 null이 나와 기댓값인 <code>&quot;제니&quot;</code>를 만족하지 못했다. </p>
<p>실제 로그를 찍어보니</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Instance 1 hashcode : 1686369710</span><br><span class="line">Instance 2 hashcode : 194706439</span><br></pre></td></tr></table></figure>
<p>두 개의 다른 객체에 대해 다른 hashcode를 리턴하고 있었다.</p>
<h2 id="Test-2-hashcode를-재정의-한-경우"><a href="#Test-2-hashcode를-재정의-한-경우" class="headerlink" title="Test.2 hashcode를 재정의 한 경우"></a>Test.2 hashcode를 재정의 한 경우</h2><p>ExtendPhoneNumber 클래스에서는 PhoneNumber를 상속 받은 뒤, hashCode 메서드를 재정의하였다.<br>(equals메서드는 PhoneNumber의 equals를 그대로 사용하였다.) </p>
<p>실제 로그를 찍어보니</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Instance 1 hashcode : 711611</span><br><span class="line">Instance 2 hashcode : 711611</span><br></pre></td></tr></table></figure>
<p>두 개의 ExtendPhoneNumber 객체에 대해 같은 hashcode를 리턴하고 있었다.<br>그렇기 때문에 HashMap에 삽입한 ExtendPhoneNumber 객체에 대해 new ExtendPhoneNumber()로 조회를 하니 같은 hashCode의 버킷을 조회하여<br><code>&quot;제니&quot;</code>라는 데이터를 얻어올 수 있었다.</p>
<h1 id="최악의-hashcode-구현"><a href="#최악의-hashcode-구현" class="headerlink" title="최악의 hashcode 구현"></a>최악의 hashcode 구현</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>이 코드는 동치인 모든 객체에서 똑같은 해시코드를 반환하니 적법한 해시코드 처럼 보인다.<br>하지만, 모든 객체에 대해 똑같은 해시코드를 반환하니 모든 객체가 같은 해시테이블 버킷에 담겨 연결리스트(Linked List)처럼 동작하게 된다.<br>평균 수행시간이 O(1)에서 O(n)으로 느려져서, 성능이 매우 낮아질 뿐더러 버킷에 대한 overflow가 발생하는 경우 데이터가 누락될 수도 있다.</p>
<h2 id="hashcode가-같으면-HashMap에서-어떻게-동작할까"><a href="#hashcode가-같으면-HashMap에서-어떻게-동작할까" class="headerlink" title="hashcode가 같으면 HashMap에서 어떻게 동작할까?"></a>hashcode가 같으면 HashMap에서 어떻게 동작할까?</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(JUnit4.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">HashCodeTest2</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> hashcode_재정의() &#123;</span><br><span class="line">        HashMap&lt;ExtendedPhoneNumber, String&gt; map = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">        map.put(<span class="keyword">new</span> <span class="title class_">ExtendedPhoneNumber</span>(<span class="number">707</span>, <span class="number">867</span>, <span class="number">5307</span>), <span class="string">&quot;제니&quot;</span>);</span><br><span class="line">        System.out.println(<span class="string">&quot;Instance 1 hashcode : &quot;</span> + <span class="keyword">new</span> <span class="title class_">ExtendedPhoneNumber</span>(<span class="number">707</span>, <span class="number">867</span>, <span class="number">5307</span>).hashCode());</span><br><span class="line">        System.out.println(<span class="string">&quot;Instance 2 hashcode : &quot;</span> + <span class="keyword">new</span> <span class="title class_">ExtendedPhoneNumber</span>(<span class="number">707</span>, <span class="number">867</span>, <span class="number">5301</span>).hashCode());</span><br><span class="line">        <span class="comment">//다른 객체를 넣어 데이터를 조회해 보았다.</span></span><br><span class="line">        Assert.assertEquals(map.get(<span class="keyword">new</span> <span class="title class_">ExtendedPhoneNumber</span>(<span class="number">707</span>, <span class="number">867</span>, <span class="number">5301</span>)), <span class="string">&quot;제니&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="meta">@AllArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">PhoneNumber</span> &#123;</span><br><span class="line">        <span class="keyword">protected</span> <span class="type">int</span> firstNumber;</span><br><span class="line">        <span class="keyword">protected</span> <span class="type">int</span> secondNumber;</span><br><span class="line">        <span class="keyword">protected</span> <span class="type">int</span> thirdNumber;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">equals</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!(o <span class="keyword">instanceof</span> PhoneNumber)) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="type">PhoneNumber</span> <span class="variable">p</span> <span class="operator">=</span> (PhoneNumber) o;</span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">this</span>.firstNumber == p.firstNumber &amp;&amp;</span><br><span class="line">                    <span class="built_in">this</span>.secondNumber == p.secondNumber &amp;&amp;</span><br><span class="line">                    <span class="built_in">this</span>.thirdNumber == p.thirdNumber;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NoArgsConstructor</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">ExtendedPhoneNumber</span> <span class="keyword">extends</span> <span class="title class_">PhoneNumber</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">public</span> <span class="title function_">ExtendedPhoneNumber</span><span class="params">(<span class="type">int</span> firstNumber, <span class="type">int</span> secondNumber, <span class="type">int</span> thirdNumber)</span> &#123;</span><br><span class="line">            <span class="built_in">super</span>(firstNumber, secondNumber, thirdNumber);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">42</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Instance 1 hashcode : 42</span><br><span class="line">Instance 2 hashcode : 42</span><br><span class="line"></span><br><span class="line">java.lang.AssertionError: </span><br><span class="line">Expected :null</span><br><span class="line">Actual   :제니</span><br><span class="line"> &lt;Click to see difference&gt;</span><br></pre></td></tr></table></figure>

<p>이 결과로 보아하니, hashcode가 같으면 같은 버킷에 LinkedList로 저장되면서 객체에 대해 equals 체크를 통해 데이터를 조회하는 것으로 판단 된다.</p>
<blockquote>
<p>설사 두 인스턴스가 같은 버킷에 담았더라도, hashmap.get메서드는 null을 반환한다.<br>만약 hashcode가 다른경우에는 동치성비교를 실행하지 않도록 최적화 되어있기 때문이다.<br>hashcode가 같더라도 동치성비교(equals)를 실행하여 객체에 대한 값(value)를 조회한다.</p>
</blockquote>
<h1 id="좋은-해시-함수-만들기"><a href="#좋은-해시-함수-만들기" class="headerlink" title="좋은 해시 함수 만들기"></a>좋은 해시 함수 만들기</h1><p>좋은 해시 함수는 서로 다른 인스턴스에 대해 다른 해시코드를 반환한다.<br>이게 바로 hashcode의 세번째 규약이 요구하는 속성이다.<br>이상적인 해시 함수는 주어진 (서로 다른) 인스턴스들을 32비트 정수 범위에 균일하게 분배해야 한다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span><br><span class="line"><span class="keyword">public</span> <span class="type">int</span> <span class="title function_">hashCode</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">c</span> <span class="operator">=</span> <span class="number">31</span>;</span><br><span class="line">    <span class="comment">//1. int변수 result를 선언한 후 첫번째 핵심 필드에 대한 hashcode로 초기화 한다.</span></span><br><span class="line">    <span class="type">int</span> <span class="variable">result</span> <span class="operator">=</span> Integer.hashCode(firstNumber);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//2. 기본타입 필드라면 Type.hashCode()를 실행한다</span></span><br><span class="line">    <span class="comment">//Type은 기본타입의 Boxing 클래스이다.</span></span><br><span class="line">    result = c * result + Integer.hashCode(secondNumber);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//3. 참조타입이라면 참조타입에 대한 hashcode 함수를 호출 한다.</span></span><br><span class="line">    <span class="comment">//4. 값이 null이면 0을 더해 준다.</span></span><br><span class="line">    result = c * result + address == <span class="literal">null</span> ? <span class="number">0</span> : address.hashCode();</span><br><span class="line"></span><br><span class="line">    <span class="comment">//5. 필드가 배열이라면 핵심 원소를 각각 필드처럼 다룬다.</span></span><br><span class="line">    <span class="keyword">for</span> (String elem : arr) &#123;</span><br><span class="line">      result = c * result + elem == <span class="literal">null</span> ? <span class="number">0</span> : elem.hashCode();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//6. 배열의 모든 원소가 핵심필드이면 Arrays.hashCode를 이용한다.</span></span><br><span class="line">    result = c * result + Arrays.hashCode(arr);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//7. result = 31 * result + c 형태로 초기화 하여 </span></span><br><span class="line">    <span class="comment">//result를 리턴한다.</span></span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>hashcode를 다 구현했다면, 이 메서드가 동치인 인스턴스에 대해 똑같은 해시코드를 반환할지 TestCase를 작성해보자</li>
<li>파생필드는 hashcode 계산에서 제외해도 된다.</li>
<li>equals 비교에 사용되지 않는 필드는 반드시 제외한다.</li>
<li>31 * result를 곱하는 순서에 따라 result 값이 달라진다.</li>
<li>곱할 숫자를 31로 지정하는 이유는 31이 홀수 이면서 소수(prime)이기 때문이다. 2를 곱하는 것은 shift연산과 같은 결과를 내기 떄문에 추천하지 않는다.</li>
<li>31을 이용하면 (i &lt;&lt; 5) - i와 같이 최적화 할 수 있다.</li>
</ul>
<h1 id="hashcode를-편하게-만들어-주는-모듈"><a href="#hashcode를-편하게-만들어-주는-모듈" class="headerlink" title="hashcode를 편하게 만들어 주는 모듈"></a>hashcode를 편하게 만들어 주는 모듈</h1><ul>
<li>Objects.hash()<ul>
<li>내부적으로 AutoBoxing이 일어나 성능이 떨어진다.</li>
</ul>
</li>
<li>Lombok의 @EqualsAndHashCode</li>
<li>Google의 @AutoValue</li>
</ul>
<h1 id="hashcode를-재정의-할-때-주의-할-점"><a href="#hashcode를-재정의-할-때-주의-할-점" class="headerlink" title="hashcode를 재정의 할 때 주의 할 점!"></a>hashcode를 재정의 할 때 주의 할 점!</h1><ul>
<li>불변 객체에 대해서는 hashcode 생성비용이 많이 든다면, hashcode를 캐싱하는 것도 고려하자<ul>
<li>스레드 안전성까지 고려해야 한다.</li>
</ul>
</li>
<li>성능을 높인답시고 hashcode를 계산할 떄 핵심필드를 생략해서는 안된다.<ul>
<li>속도는 빨라지겠지만, hash품질이 나빠져 해시테이블 성능을 떨어뜨릴 수 있다 (Hashing Collision)</li>
</ul>
</li>
<li>hashcode 생성규칙을 API사용자에게 공표하지 말자<ul>
<li>그래야 클라이언트가 hashcode값에 의지한 코드를 짜지 않는다.</li>
<li>다음 릴리즈 시, 성능을 개선할 여지가 있다.</li>
</ul>
</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 11. equals를 재정의하려거든 hashcode도 재정의하라</li>
</ul>
</div></article><div class="post-meta__tag-list"><a class="post-meta__tags" href="../../../../tags/Effective-Java/">Effective-Java</a></div><nav id="pagination"><div class="prev-post pull-left"><a href="../../13/effective-java-item12/"><i class="fa fa-chevron-left">  </i><span>Item 12. toString을 항상 재정의하라</span></a></div><div class="next-post pull-right"><a href="../../10/effective-java-item10/"><span>Item 10. Equals는 일반 규약을 지켜 재정의하라</span><i class="fa fa-chevron-right"></i></a></div></nav><div id="disqus_thread"></div><script>var unused = null;
var disqus_config = function () {
  this.page.url = 'https://jaehun2841.github.io/2019/01/12/effective-java-item11/';
  this.page.identifier = '2019/01/12/effective-java-item11/';
  this.page.title = 'Item 11. Equals를 재정의하려거든 Hashcode도 재정의하라';
}
var d = document, s = d.createElement('script');
s.src = "https://" + 'Carrey' +".disqus.com/embed.js";
s.setAttribute('data-timestamp', '' + +new Date());
(d.head || d.body).appendChild(s);</script></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2023 By Carrey</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_page_pv"><i class="fa fa-file"></i><span id="busuanzi_value_page_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="../../../../js/utils.js?version=1.9.0"></script><script src="../../../../js/fancybox.js?version=1.9.0"></script><script src="../../../../js/sidebar.js?version=1.9.0"></script><script src="../../../../js/copy.js?version=1.9.0"></script><script src="../../../../js/fireworks.js?version=1.9.0"></script><script src="../../../../js/transition.js?version=1.9.0"></script><script src="../../../../js/scroll.js?version=1.9.0"></script><script src="../../../../js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>