<!DOCTYPE html><html lang="lang"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Carrey"><meta name="copyright" content="Carrey"><title>공부하고, 경험하고, 삽질해서 얻은 지식들을 기록합니다. | Carrey`s 기술블로그</title><link rel="shortcut icon" href="../../melody-favicon.ico"><link rel="stylesheet" href="../../css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.0.0'
} </script><meta name="generator" content="Hexo 6.0.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://www.gravatar.com/avatar/3f8583b7b0f0c1ebd249dffad42707af?s=300"></div><div class="author-info__name text-center">Carrey</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href=".."><span class="pull-left">Articles</span><span class="pull-right">112</span></a><a class="author-info-articles__tags article-meta" href="../../tags"><span class="pull-left">Tags</span><span class="pull-right">27</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="../../index.html">Carrey`s 기술블로그</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Carrey`s 기술블로그</div><div id="site-sub-title">공부하고, 경험하고, 삽질해서 얻은 지식들을 기록합니다.</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="../../2019/02/28/effective-java-item58/">Item 58. 전통적인 for 문보다는 For-Each문을 사용하라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-02-28</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>스트림(Stream)이 제격인 작업이 있고, 반복이 제격인 작업이 있다.   </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(Iterator&lt;Element&gt; i = c.iterator(); i.hasNext();) &#123;</span><br><span class="line">    <span class="type">Element</span> <span class="variable">e</span> <span class="operator">=</span> i.next();</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; a.length; i++) &#123;</span><br><span class="line">    <span class="type">int</span> <span class="variable">z</span> <span class="operator">=</span> a[i]; <span class="comment">// a[i]로 무언가를 한다.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위의 for문과 같은 관용구들은 while문 보다는 낫지만 가장 탁월한 방법은 아니다.<br><strong>반복자와 인덱스 변수는 모두 코드를 지저분하게 할 뿐 우리에게 필요한 건 원소들 뿐이다.</strong><br>또한 컬렉션이냐 배열이냐에 따라 코드 형태가 달라지기 때문에 주의해야 한다.</p>
<h1 id="향상된-for문-enhanced-for-statement"><a href="#향상된-for문-enhanced-for-statement" class="headerlink" title="향상된 for문 (enhanced for statement)"></a>향상된 for문 (enhanced for statement)</h1><ul>
<li>반복자와 인덱스 변수를 사용하지 않으니 코드가 깔끔해지고 오류가 날 일이 없다.</li>
<li>하나의 관용구로 되어있어서 배열이든 컬렉션이든 코드의 형태가 같다.</li>
<li>콜론(:)은 <strong>안의(in)</strong> 라고 읽으면 된다. (elements안의 각 원소 e에 대해)</li>
<li>반복 대상이 컬렉션이든 배열이든 for-each문을 사용해도 속도는 그대로이다.</li>
<li>for-each 문이 만들어 내는 코드는 사람이 손으로 최적화한 것과 사실상 같다.</li>
</ul>
<h1 id="컬렉션이-중첩되는-경우-for-each의-이점이-커진다"><a href="#컬렉션이-중첩되는-경우-for-each의-이점이-커진다" class="headerlink" title="컬렉션이 중첩되는 경우 for-each의 이점이 커진다."></a>컬렉션이 중첩되는 경우 for-each의 이점이 커진다.</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Suit</span> &#123; CLUB, DIAMOND, HEART, SPADE&#125;</span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Rank</span> &#123; ACE, DEUCE, THREE, FOUR, FIVE, SIX, SEVEN, EIGHT, NINE, TEN, JACK, QUEEN, KING&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Collection&lt;Suit&gt; suits = Arrays.asList(Suit.values());</span><br><span class="line"><span class="keyword">static</span> Collection&lt;Rank&gt; ranks = Arrays.asList(Rank.values());</span><br><span class="line"></span><br><span class="line">List&lt;Card&gt; deck = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span>(Iterator&lt;Suit&gt; i = suits.iterator(); i.hasNext();) &#123;</span><br><span class="line">    <span class="keyword">for</span>(Iterator&lt;Rank&gt; j = ranks.iterator(); j.hasNext();) &#123;</span><br><span class="line">        deck.add(<span class="keyword">new</span> <span class="title class_">Card</span>(i.next(), j.next()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><code>deck.add(new Card(i.next(), j.next()));</code> 줄이 오류를 일으킨다.</li>
<li>원래대로 하면 숫자 1개당 rank가 여러번 불려야 하는데 저러면 숫자 1개에 rank 1개 불려 <code>NoSuchElementException</code> 을 던진다.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Suit</span> &#123; CLUB, DIAMOND, HEART, SPADE&#125;</span><br><span class="line"><span class="keyword">enum</span> <span class="title class_">Rank</span> &#123; ACE, DEUCE, THREE, FOUR, FIVE, SIX, SEVEN, EIGHT, NINE, TEN, JACK, QUEEN, KING&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> Collection&lt;Suit&gt; suits = Arrays.asList(Suit.values());</span><br><span class="line"><span class="keyword">static</span> Collection&lt;Rank&gt; ranks = Arrays.asList(Rank.values());</span><br><span class="line"></span><br><span class="line">List&lt;Card&gt; deck = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"><span class="keyword">for</span>(Suit suit : suits) &#123;</span><br><span class="line">    <span class="keyword">for</span>(Rank rank : ranks) &#123;</span><br><span class="line">        deck.add(<span class="keyword">new</span> <span class="title class_">Card</span>(suit, rank));   </span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>위와 같이 for-each를 사용하면 깔끔하고 간단하게 코드를 짤 수 있다.</li>
</ul>
<h1 id="for-each를-사용할-수-없는-상황"><a href="#for-each를-사용할-수-없는-상황" class="headerlink" title="for-each를 사용할 수 없는 상황"></a>for-each를 사용할 수 없는 상황</h1><ul>
<li><strong>파괴적인 필터링(destructive filtering)</strong><ul>
<li>컬렉션을 순회하면서 선택된 원소를 제거해야 한다면 반복자의 remove 메서드를 호출해야 한다.</li>
<li>Java 8 부터 Collection의 removeIf 메서드를 사용해 컬렉션을 명시적으로 순회하지 않을 수 있다.</li>
</ul>
</li>
<li><strong>변형(transforming)</strong><ul>
<li>리스트나 배열을 순회하면서 원소 값 일부 혹은 전체를 교체하는 경우에는 인덱스를 사용해야 한다.</li>
</ul>
</li>
<li><strong>병렬 반복(parallel iteration)</strong><ul>
<li>여러 컬렉션을 병렬로 순회해야 한다면 각각의 반복자와 인덱스 변수를 사용해 엄격하고 명시적으로 제어해야 한다.</li>
</ul>
</li>
</ul>
<h1 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h1><ul>
<li>for문 대신 for-each를 사용할 수 있는 경우는 무조건 사용하자</li>
<li>전통적인 for문과 비교했을 때, for-each문은 명료하고 유연하고 버그를 예방해 준다.</li>
<li>for-each문은 컬렉션과 배열은 물론 Iterable 인터페이스를 구현한 객체라면 무엇이든 순회 가능하다.</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 58. 전통적인 for 문보다는 for-each문을 사용하라</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/02/28/effective-java-item57/">Item 57. 지역변수의 범위를 최소화하라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-02-28</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p><strong>클래스의 멤버와 접근권한을 최소화하라 (Item 15)</strong> 와 취지가 비슷한 장이다.<br>지역변수의 유효범위를 최소로 줄이면 코드 가독성과 유지보수성이 높아지고 오류 가능성은 낮아진다.  </p>
<h1 id="가장-처음-쓰일-때-선언하라"><a href="#가장-처음-쓰일-때-선언하라" class="headerlink" title="가장 처음 쓰일 때 선언하라"></a>가장 처음 쓰일 때 선언하라</h1><ul>
<li>사용하려면 멀었는데 미리 변수부터 선언하는 코드는 어수선하고 가독성이 좋지 못하다. </li>
<li>막상 쓰일 시점에 되서는 무슨 타입이었는지, 무슨 값으로 초기화 했는지 기억이 나지 않을 경우가 있다. </li>
<li>변수가 쓰이는 범위보다 너무 앞서 선언하거나, 다 쓴 뒤에도 할당해제가 되지 않고 여전히 살아있게 된다.</li>
<li>변수의 scope를 제한하지 못하면 예상하지 못한 결과를 초래할 수 있으니 주의해야 한다.</li>
</ul>
<h1 id="모든-지역변수는-선언과-동시에-초기화-하라"><a href="#모든-지역변수는-선언과-동시에-초기화-하라" class="headerlink" title="모든 지역변수는 선언과 동시에 초기화 하라"></a>모든 지역변수는 선언과 동시에 초기화 하라</h1><ul>
<li><p>초기화에 필요한 정보가 충분하지 않다면 충분해질 때까지 선언을 미뤄야한다.</p>
</li>
<li><p>try-catch-finally 구문에서는 예외다.</p>
</li>
<li><p>변수를 초기화 하는 표현식에서 checked exception을 던질 가능성이 있으면, try 절 안에서 초기화 해야한다.</p>
</li>
<li><p>만약, catch나 finally절에서 변수를 이용해야 한다면, try절 바로 앞에 변수를 선언해야 한다.</p>
</li>
<li><p>반복문에서는 반복 변수(loop variable)의 범위가 반복문의 몸체, 그리고 for 키워드와 몸체 사이 괄호 안으로 제한된다.</p>
</li>
<li><p>반복자 (index)를 사용해야 하는 경우에는 for-each 구문보다 전통적인 for문이 낫다.</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (Element e : c) &#123;</span><br><span class="line">    <span class="comment">// e로 무언가를 반복하는 로직을 구성</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(Iterator&lt;Element&gt; i = c.iterator(); i.hasNext();) &#123;</span><br><span class="line">    <span class="type">Element</span> <span class="variable">e</span> <span class="operator">=</span> i.next(); <span class="comment">//e와 i로 무언가를 한다.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="while-문을-사용하는-경우에도-for문을-사용하는-것이-낫다"><a href="#while-문을-사용하는-경우에도-for문을-사용하는-것이-낫다" class="headerlink" title="while 문을 사용하는 경우에도 for문을 사용하는 것이 낫다."></a>while 문을 사용하는 경우에도 for문을 사용하는 것이 낫다.</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Iterator&lt;Element&gt; i = c.iterator();</span><br><span class="line"><span class="keyword">while</span>(i.hasNext()) &#123;</span><br><span class="line">    doSomeThing(i.next());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Iterator&lt;Element&gt; i2 = c2.iterator();</span><br><span class="line"><span class="keyword">while</span>(i.hasNext()) &#123; </span><br><span class="line">    doSomeThing(i2.next());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>복붙의 여파로 i2.hasNext()이지만 i.hasNext()를 사용하였다.</li>
<li>컴파일도 잘되고 실행도 잘되지만, 기대한 결과가 도출되지 않는다.</li>
<li>for문을 포함한 for-each문을 사용하는 경우에는 이러한 문제를 컴파일 타임에 잡아준다.<br>(반복자의 유효범위가 for문의 종료와 함께 끝나기 때문이다.)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(Iterator&lt;Element&gt; i = c.iterator(); i.hasNext();) &#123;</span><br><span class="line">    <span class="type">Element</span> <span class="variable">e</span> <span class="operator">=</span> i.next();</span><br><span class="line">&#125; </span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(Iterator&lt;Element&gt; i2 = c2.iterator(); i.hasNext();) &#123;</span><br><span class="line">    <span class="type">Element</span> <span class="variable">e2</span> <span class="operator">=</span> i2.next();</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<ul>
<li>두번째 코드의 i.hasNext()에서 i를 찾을 수 없다는 오류를 보여준다.</li>
</ul>
<h1 id="메서드를-작게-유지하고-한-가지-기능에-집중하라"><a href="#메서드를-작게-유지하고-한-가지-기능에-집중하라" class="headerlink" title="메서드를 작게 유지하고 한 가지 기능에 집중하라"></a>메서드를 작게 유지하고 한 가지 기능에 집중하라</h1><ul>
<li>한 메서드에서 여러 가지 기능을 처리한다면 그중 한 기능과만 관련된 지역변수라도 다른 기능을 수행하는 코드에서 접근할 수 있다.</li>
<li>단순히 메서드를 기능별로만 쪼개자</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 57. 지역변수의 범위를 최소화하라</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/02/24/2019-02-24-mongodb-3/">Mongo DB Aggregation Pipeline - SpringBoot에서 사용하기</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-02-24</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/MongoDB/">MongoDB</a></span><div class="content"><h1 id="SpringBoot에서-MongoDB-간단설정하기"><a href="#SpringBoot에서-MongoDB-간단설정하기" class="headerlink" title="SpringBoot에서 MongoDB 간단설정하기"></a>SpringBoot에서 MongoDB 간단설정하기</h1><h2 id="Maven"><a href="#Maven" class="headerlink" title="Maven"></a>Maven</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>

<ul>
<li>Spring-boot-starter-data-mongodb Dependency로 간단하게 mongoldb 관련 모든 라이브러리를 로드 할 수 있습니다.</li>
</ul>
<h2 id="application-yml"><a href="#application-yml" class="headerlink" title="application.yml"></a>application.yml</h2><figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">data:</span></span><br><span class="line">    <span class="attr">mongodb:</span></span><br><span class="line">      <span class="attr">uri:</span> <span class="string">mongodb://127.0.0.1:27017/employee-test</span></span><br><span class="line">      <span class="attr">username:</span> <span class="string">myUser</span></span><br><span class="line">      <span class="attr">password:</span> <span class="string">myUserIsCarrey</span></span><br></pre></td></tr></table></figure>

<ul>
<li>SpringBoot에서는 단순하게 application.yml에 connection-uri정보만 있으면 Spring Boot 서버 시작 시<br>MongoDB와 연결할 수 있습니다.</li>
</ul>
<h2 id="Mongo-DB-Config"><a href="#Mongo-DB-Config" class="headerlink" title="Mongo DB Config"></a>Mongo DB Config</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MongoConfiguration</span> <span class="keyword">extends</span> <span class="title class_">AbstractMongoConfiguration</span> &#123;</span><br><span class="line"></span><br><span class="line">   <span class="meta">@Value(&quot;$&#123;spring.data.mongodb.uri&#125;&quot;)</span></span><br><span class="line">   <span class="keyword">private</span> String url;</span><br><span class="line">   <span class="meta">@Value(&quot;$&#123;spring.data.mongodb.username&#125;&quot;)</span></span><br><span class="line">   <span class="keyword">private</span> String username;</span><br><span class="line">   <span class="meta">@Value(&quot;$&#123;spring.data.mongodb.password&#125;&quot;)</span></span><br><span class="line">   <span class="keyword">private</span> String password;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> MongoClient <span class="title function_">mongoClient</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">MongoClientURI</span> <span class="variable">mongoClientURI</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MongoClientURI</span>(<span class="built_in">this</span>.url);</span><br><span class="line">        <span class="type">MongoCredential</span> <span class="variable">mongoCredential</span> <span class="operator">=</span> </span><br><span class="line">            MongoCredential.createCredential(<span class="built_in">this</span>.username, mongoClientURI.getDatabase(),<span class="built_in">this</span>.password.toCharArray());</span><br><span class="line">        <span class="type">ServerAddress</span> <span class="variable">serverAddress</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ServerAddress</span>(mongoClientURI.getHosts().get(<span class="number">0</span>));</span><br><span class="line">        <span class="type">MongoClientOptions</span> <span class="variable">options</span> <span class="operator">=</span> MongoClientOptions.builder().build();</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MongoClient</span>(serverAddress, mongoCredential, options);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> String <span class="title function_">getDatabaseName</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">MongoClientURI</span>(<span class="built_in">this</span>.url).getDatabase();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>MongoDB Client 객체를 생성하는 코드를 추가하였습니다.</li>
<li>credential을 사용하는 경우 저런식으로 credential 객체를 만들어줘야 합니다.</li>
<li>그렇지 않으면 <code>Command aggregate failed: not authorized on DB to execute command</code> 에러가 발생하며 Mongo DB 기능을 이용할 수 없습니다.</li>
</ul>
<h1 id="예제로-풀어보는-Mongo-DB-Aggregation-pipeline"><a href="#예제로-풀어보는-Mongo-DB-Aggregation-pipeline" class="headerlink" title="예제로 풀어보는 Mongo DB Aggregation pipeline"></a>예제로 풀어보는 Mongo DB Aggregation pipeline</h1><p>예제로 등록한 employee collection은 오라클 DB의 예제 DB인 employee 테이블을 차용하였습니다.</p>
<h2 id="문제-1"><a href="#문제-1" class="headerlink" title="문제 1."></a>문제 1.</h2><p><strong>20 번 및 30 번 부서에서 근무하는 모든 사원들의 ENAME 집합과 부서번호를 출력하라</strong></p>
<h3 id="Mongo-DB-Aggregation-pipeline"><a href="#Mongo-DB-Aggregation-pipeline" class="headerlink" title="Mongo DB Aggregation pipeline"></a>Mongo DB Aggregation pipeline</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">db.employee.aggregate(</span><br><span class="line">    <span class="punctuation">[</span> </span><br><span class="line">        <span class="punctuation">&#123;</span> </span><br><span class="line">            $match <span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">                deptId <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                	$in<span class="punctuation">:</span> <span class="punctuation">[</span><span class="number">20</span><span class="punctuation">,</span> <span class="number">30</span><span class="punctuation">]</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">            <span class="punctuation">&#125;</span> </span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span> </span><br><span class="line">            $group <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            	_id<span class="punctuation">:</span> <span class="string">&quot;$deptId&quot;</span><span class="punctuation">,</span></span><br><span class="line">                enames<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                    $addToSet<span class="punctuation">:</span> <span class="string">&quot;$ename&quot;</span></span><br><span class="line">                <span class="punctuation">&#125;</span></span><br><span class="line">        	<span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">        <span class="punctuation">&#123;</span></span><br><span class="line">            $project <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">                _id <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">                deptId <span class="punctuation">:</span> <span class="string">&quot;$_id&quot;</span><span class="punctuation">,</span></span><br><span class="line">                enames <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">            <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">]</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<h3 id="Spring-Data-MongoDB를-이용한-Java-Code"><a href="#Spring-Data-MongoDB를-이용한-Java-Code" class="headerlink" title="Spring Data MongoDB를 이용한 Java Code"></a>Spring Data MongoDB를 이용한 Java Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Autowired</span></span><br><span class="line">    <span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 20 번 및 30 번 부서에서 근무하는 모든 사원들의 ENAME 집합과 부서번호를 출력하라</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> deptNos</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> List&lt;UserListByDeptNo&gt; <span class="title function_">getUserListByDeptNo</span><span class="params">(List&lt;Integer&gt; deptNos)</span> &#123;</span><br><span class="line"></span><br><span class="line">        <span class="comment">//match</span></span><br><span class="line">        <span class="type">Criteria</span> <span class="variable">criteria</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Criteria</span>().where(<span class="string">&quot;deptId&quot;</span>).in(deptNos);</span><br><span class="line">        <span class="type">MatchOperation</span> <span class="variable">matchOperation</span> <span class="operator">=</span> Aggregation.match(criteria);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//group</span></span><br><span class="line">        <span class="type">GroupOperation</span> <span class="variable">groupOperation</span> <span class="operator">=</span> Aggregation.group(<span class="string">&quot;deptId&quot;</span>)</span><br><span class="line">                                                   .addToSet(<span class="string">&quot;ename&quot;</span>).as(<span class="string">&quot;enames&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//projection</span></span><br><span class="line">        <span class="type">ProjectionOperation</span> <span class="variable">projectionOperation</span> <span class="operator">=</span> Aggregation.project(<span class="string">&quot;enames&quot;</span>)</span><br><span class="line">                                                             .and(previousOperation()).as(<span class="string">&quot;deptId&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//aggrgation</span></span><br><span class="line">        AggregationResults&lt;UserListByDeptNo&gt; aggregate =</span><br><span class="line">                <span class="built_in">this</span>.mongoTemplate.aggregate(newAggregation(matchOperation, groupOperation, projectionOperation),</span><br><span class="line">                                             Employee.class,</span><br><span class="line">                                             UserListByDeptNo.class);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> aggregate.getMappedResults();</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>



<h2 id="문제2"><a href="#문제2" class="headerlink" title="문제2"></a>문제2</h2><p><strong>부서별 연봉합계 순위를 랭킹하여라</strong></p>
<h3 id="Mongo-DB-Aggregation-pipeline-1"><a href="#Mongo-DB-Aggregation-pipeline-1" class="headerlink" title="Mongo DB Aggregation pipeline"></a>Mongo DB Aggregation pipeline</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">db.employee.aggregate(</span><br><span class="line"> <span class="punctuation">[</span> </span><br><span class="line">     <span class="punctuation">&#123;</span> </span><br><span class="line">         <span class="attr">&quot;$group&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">            <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;deptId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;$deptId&quot;</span> <span class="punctuation">,</span> <span class="attr">&quot;deptName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;$deptName&quot;</span><span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">            <span class="attr">&quot;totalSal&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;$sum&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;$sal&quot;</span><span class="punctuation">&#125;</span></span><br><span class="line">         <span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">&#125;</span> <span class="punctuation">,</span> </span><br><span class="line">     <span class="punctuation">&#123;</span> <span class="attr">&quot;$sort&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;totalSal&quot;</span> <span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">&#125;</span><span class="punctuation">&#125;</span> <span class="punctuation">,</span> </span><br><span class="line">     <span class="punctuation">&#123;</span> </span><br><span class="line">         <span class="attr">&quot;$project&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> </span><br><span class="line">             <span class="attr">&quot;deptId&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;$_id.deptId&quot;</span> <span class="punctuation">,</span> </span><br><span class="line">             <span class="attr">&quot;deptName&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;$_id.deptName&quot;</span> <span class="punctuation">,</span> </span><br><span class="line">             <span class="attr">&quot;totalSal&quot;</span> <span class="punctuation">:</span> <span class="number">1</span></span><br><span class="line">     	<span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">&#125;</span></span><br><span class="line"> <span class="punctuation">]</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>


<h3 id="Spring-Data-MongoDB를-이용한-Java-Code-1"><a href="#Spring-Data-MongoDB를-이용한-Java-Code-1" class="headerlink" title="Spring Data MongoDB를 이용한 Java Code"></a>Spring Data MongoDB를 이용한 Java Code</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> List&lt;SalRankByDept&gt; <span class="title function_">getSalRankByDepts</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">       <span class="comment">//Group</span></span><br><span class="line">       <span class="type">GroupOperation</span> <span class="variable">groupOperation</span> <span class="operator">=</span> Aggregation.group(<span class="string">&quot;deptId&quot;</span>, <span class="string">&quot;deptName&quot;</span>)</span><br><span class="line">               .sum(<span class="string">&quot;sal&quot;</span>).as(<span class="string">&quot;totalSal&quot;</span>);</span><br><span class="line">       <span class="comment">//Sort</span></span><br><span class="line">       <span class="type">SortOperation</span> <span class="variable">sortOperation</span> <span class="operator">=</span> Aggregation.sort(Sort.Direction.DESC, <span class="string">&quot;totalSal&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//Projection</span></span><br><span class="line">       <span class="type">ProjectionOperation</span> <span class="variable">projectionOperation</span> <span class="operator">=</span> Aggregation.project(<span class="string">&quot;deptId&quot;</span>, <span class="string">&quot;deptName&quot;</span>,<span class="string">&quot;totalSal&quot;</span>);</span><br><span class="line"></span><br><span class="line">       <span class="comment">//aggrgation</span></span><br><span class="line">       AggregationResults&lt;SalRankByDept&gt; aggregate =</span><br><span class="line">               <span class="built_in">this</span>.mongoTemplate.aggregate(newAggregation(groupOperation, sortOperation, projectionOperation),</span><br><span class="line">                       Employee.class,</span><br><span class="line">                       SalRankByDept.class);</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> aggregate.getMappedResults();</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>





<h1 id="삽질-끝판왕-도전기"><a href="#삽질-끝판왕-도전기" class="headerlink" title="삽질 끝판왕 도전기"></a>삽질 끝판왕 도전기</h1><p>위의 예제 코드 2개를 보면 특이한 점이 한가지 있습니다.<br>바로 Projection Operation 부분이 살짝 다른데요.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">//projection</span></span><br><span class="line"><span class="type">ProjectionOperation</span> <span class="variable">projectionOperation</span> <span class="operator">=</span> Aggregation.project(<span class="string">&quot;enames&quot;</span>).and(previousOperation()).as(<span class="string">&quot;deptId&quot;</span>);</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Projection</span></span><br><span class="line"><span class="type">ProjectionOperation</span> <span class="variable">projectionOperation</span> <span class="operator">=</span> Aggregation.project(<span class="string">&quot;deptId&quot;</span>, <span class="string">&quot;deptName&quot;</span>,<span class="string">&quot;totalSal&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>위의 코드에서는 grouping key에 대해 조회 할 때</p>
<p><code>.and(previousOperation()).as(&quot;deptId&quot;)</code> 라고 and 메서드에 <code>previousOperation()</code> 라는 메서드를 적어주었습니다.<br>두번째 코드에서는 그냥 grouping Key를 projection field에 나열하였습니다. </p>
<p>무슨 차이일까요?</p>
<ul>
<li>첫번째 코드는 grouping key가 1개이다.</li>
<li>두번째 코드는 grouping key가 2개이다.</li>
</ul>
<p>위와 같은 차이가 있습니다.</p>
<p>만약에 1번 코드를 2번처럼 사용한다면</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">ProjectionOperation</span> <span class="variable">projectionOperation</span> <span class="operator">=</span> Aggregation.project(<span class="string">&quot;deptId&quot;</span>, <span class="string">&quot;enames&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>이와 같이 사용할 수 있을 것입니다.<br>위의 코드로 수정하고 프로그램을 실행해 보면…</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Caused by: java.lang.IllegalArgumentException: Parameter deptId must not be null!</span><br></pre></td></tr></table></figure>

<p>라는 메세지가 나오면서 런타임 예외를 던집니다.<br>뭐 때문에 나는 발생하는 예외 일까요?</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> Document <span class="title function_">toDocument</span><span class="params">(AggregationOperationContext context)</span> &#123;</span><br><span class="line">    <span class="type">Document</span> <span class="variable">operationObject</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">    <span class="keyword">if</span> (<span class="built_in">this</span>.idFields.exposesNoNonSyntheticFields()) &#123;</span><br><span class="line">        operationObject.put(<span class="string">&quot;_id&quot;</span>, (Object)<span class="literal">null</span>);</span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (<span class="built_in">this</span>.idFields.exposesSingleNonSyntheticFieldOnly()) &#123;</span><br><span class="line">        <span class="type">FieldReference</span> <span class="variable">reference</span> <span class="operator">=</span> context.getReference((Field)<span class="built_in">this</span>.idFields.iterator().next());</span><br><span class="line">        operationObject.put(<span class="string">&quot;_id&quot;</span>, reference.toString());</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">Document</span> <span class="variable">inner</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Document</span>();</span><br><span class="line">        <span class="type">Iterator</span> <span class="variable">var4</span> <span class="operator">=</span> <span class="built_in">this</span>.idFields.iterator();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">while</span>(var4.hasNext()) &#123;</span><br><span class="line">            <span class="type">ExposedField</span> <span class="variable">field</span> <span class="operator">=</span> (ExposedField)var4.next();</span><br><span class="line">            <span class="type">FieldReference</span> <span class="variable">reference</span> <span class="operator">=</span> context.getReference(field);</span><br><span class="line">            inner.put(field.getName(), reference.toString());</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        operationObject.put(<span class="string">&quot;_id&quot;</span>, inner);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">Iterator</span> <span class="variable">var8</span> <span class="operator">=</span> <span class="built_in">this</span>.operations.iterator();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">while</span>(var8.hasNext()) &#123;</span><br><span class="line">        GroupOperation.<span class="type">Operation</span> <span class="variable">operation</span> <span class="operator">=</span> (GroupOperation.Operation)var8.next();</span><br><span class="line">        operationObject.putAll(operation.toDocument(context));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Document</span>(<span class="string">&quot;$group&quot;</span>, operationObject);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>원인은 GroupOperation 내부에 있습니다.</strong><br>Aggregation 클래스들의 toDocument 메서드는 MongoDB에 보낼 실제 명령어 구조를 짜는 메서드입니다.  </p>
<ul>
<li>첫 번째 if 조건인 <code>this.idFields.exposesNoNonSyntheticFields()</code>은 idFields.isEmpty() 인 경우를 체크 합니다.<ul>
<li>Group key가 없는 경우는 _id 필드가 null이 되어집니다.</li>
</ul>
</li>
<li>두 번째 if 조건인 <code>this.idFields.exposesSingleNonSyntheticFieldOnly()</code> 은 group key가 1개인 경우를 체크 합니다.<ul>
<li>group key가 1개인 경우에는 group key 필드에 대한 필드명이 <strong>_id</strong> 로 표현되어 다음 파이프라인에서 사용됩니다.</li>
<li><code>operationObject.put(&quot;_id&quot;, reference.toString());</code> 여기서 _id에 대한 타입은 <strong>String</strong> 으로 결정나기 때문에<br>다음 파이프라인에서 _id.field와 같은 행위를 할 수 없게 됩니다.</li>
<li>따라서 {_id : “$deptId”}로 BSON이 생성되기 때문에 다음 파이프라인인 Projection에서는 <strong>deptId인 필드는 찾을 수 없게 되는 것입니다.</strong></li>
</ul>
</li>
<li>마지막 else 조건은 group key가 여러 개인 경우에 대해 Document 객체에 key값을 매핑시킵니다.<ul>
<li>다음 파이프라인에서 _id.field와 같은 형태로 접근이 가능하기 때문에 group key가 여러개 인 경우에는<br>projection operation에서 group key만 써줘도 자연스럽게 표현이 됩니다.</li>
<li>내부적으로는 <code>&#123;deptId : &quot;$_id.deptId&quot;, deptName: &quot;$_id.deptName&quot;&#125;</code> 과 같은 형태로 사용 됩니다.</li>
</ul>
</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/02/24/2019-02-24-mongodb-2/">Mongo DB Aggregation Pipeline</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-02-24</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/MongoDB/">MongoDB</a></span><div class="content"><h1 id="Aggregation-Pipeline"><a href="#Aggregation-Pipeline" class="headerlink" title="Aggregation Pipeline"></a>Aggregation Pipeline</h1><p>Mongo DB의 Aggregation Framework는 데이터 처리 파이프라인의 개념을 모델로 합니다.<br>문서는 여러 단계의 파이프라인을 거쳐 변화하고 하나의 문서의 형태로 집계할 수 있습니다.</p>
<p><strong>파이프라인(pipeline)</strong> 이란, 이전 단계의 연산결과를 다음 단계연산에 이용하는 것을 의미합니다.</p>
<p><img src="./aggregation-pipeline.svg" alt="aggregation-pipeline"></p>
<h1 id="Stages"><a href="#Stages" class="headerlink" title="Stages"></a>Stages</h1><h2 id="Stages-db-collection-aggregate"><a href="#Stages-db-collection-aggregate" class="headerlink" title="Stages(db.collection.aggregate)"></a>Stages(db.collection.aggregate)</h2><p>db.collection.aggregate 메서드는 파이프라인 단계를 Array의 형태로 나타냅니다.<br>Document는 파이프라인 Array의 순서대로 가공되며, <code>$out</code> 및 <code>$geoNear</code> 를 제외한 모든 단계는 파이프라인에 여러 번 나타날 수 있습니다.</p>
<h2 id="Match"><a href="#Match" class="headerlink" title="$Match"></a>$Match</h2><ul>
<li>조건에 만족하는 Document만 Filtering</li>
</ul>
<h3 id="입력-형식"><a href="#입력-형식" class="headerlink" title="입력 형식"></a>입력 형식</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $match: &#123; &lt;query&gt; &#125; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="예제"><a href="#예제" class="headerlink" title="예제"></a>예제</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> ObjectId(<span class="string">&quot;512bc95fe835e68f199c8686&quot;</span>)<span class="punctuation">,</span> <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dave&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span> <span class="attr">&quot;views&quot;</span> <span class="punctuation">:</span> <span class="number">100</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> ObjectId(<span class="string">&quot;512bc962e835e68f199c8687&quot;</span>)<span class="punctuation">,</span> <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dave&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">85</span><span class="punctuation">,</span> <span class="attr">&quot;views&quot;</span> <span class="punctuation">:</span> <span class="number">521</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> ObjectId(<span class="string">&quot;55f5a192d4bede9ac365b257&quot;</span>)<span class="punctuation">,</span> <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ahn&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span> <span class="attr">&quot;views&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> ObjectId(<span class="string">&quot;55f5a192d4bede9ac365b258&quot;</span>)<span class="punctuation">,</span> <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;li&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">55</span><span class="punctuation">,</span> <span class="attr">&quot;views&quot;</span> <span class="punctuation">:</span> <span class="number">5000</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> ObjectId(<span class="string">&quot;55f5a1d3d4bede9ac365b259&quot;</span>)<span class="punctuation">,</span> <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;annT&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">60</span><span class="punctuation">,</span> <span class="attr">&quot;views&quot;</span> <span class="punctuation">:</span> <span class="number">50</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> ObjectId(<span class="string">&quot;55f5a1d3d4bede9ac365b25a&quot;</span>)<span class="punctuation">,</span> <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;li&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">94</span><span class="punctuation">,</span> <span class="attr">&quot;views&quot;</span> <span class="punctuation">:</span> <span class="number">999</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> ObjectId(<span class="string">&quot;55f5a1d3d4bede9ac365b25b&quot;</span>)<span class="punctuation">,</span> <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ty&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">95</span><span class="punctuation">,</span> <span class="attr">&quot;views&quot;</span> <span class="punctuation">:</span> <span class="number">1000</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.articles.aggregate(</span><br><span class="line">    <span class="punctuation">[</span> <span class="punctuation">&#123;</span> $match <span class="punctuation">:</span> <span class="punctuation">&#123;</span> author <span class="punctuation">:</span> <span class="string">&quot;dave&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>

<h3 id="연산-결과"><a href="#연산-결과" class="headerlink" title="연산 결과"></a>연산 결과</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> ObjectId(<span class="string">&quot;512bc95fe835e68f199c8686&quot;</span>)<span class="punctuation">,</span> <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dave&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">80</span><span class="punctuation">,</span> <span class="attr">&quot;views&quot;</span> <span class="punctuation">:</span> <span class="number">100</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> ObjectId(<span class="string">&quot;512bc962e835e68f199c8687&quot;</span>)<span class="punctuation">,</span> <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dave&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">85</span><span class="punctuation">,</span> <span class="attr">&quot;views&quot;</span> <span class="punctuation">:</span> <span class="number">521</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="Group"><a href="#Group" class="headerlink" title="$Group"></a>$Group</h2><ul>
<li>Document에 대한 Grouping 연산을 수행</li>
<li>Group에 대한 id를 지정해야하고, 특정 필드에 대한 집계 연산이 가능</li>
<li>$group은 연산된 Document에 대한 정렬을 지원하지 않음</li>
</ul>
<h3 id="입력-형식-1"><a href="#입력-형식-1" class="headerlink" title="입력 형식"></a>입력 형식</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $group: &#123; _id: &lt;expression&gt;, &lt;field1&gt;: &#123; &lt;accumulator1&gt; : &lt;expression1&gt; &#125;, ... &#125; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="accumulator"><a href="#accumulator" class="headerlink" title="accumulator"></a>accumulator</h3><table>
<thead>
<tr>
<th>Name</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/operator/aggregation/addToSet/#grp._S_addToSet"><code>$addToSet</code></a></td>
<td>id로 Grouping 한 데이터를 중복되지 않은 Set의 형태로 저장</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/operator/aggregation/avg/#grp._S_avg"><code>$avg</code></a></td>
<td>숫자 값의 평균을 반환. 숫자가 아닌 값을 무시.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/operator/aggregation/first/#grp._S_first"><code>$first</code></a></td>
<td>각 그룹에 대한 첫 번째 Document의 값을 반환. <br />Document가 정의된 순서가 있는 경우에만 ordering을 지원</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/operator/aggregation/last/#grp._S_last"><code>$last</code></a></td>
<td>각 그룹에 대한 마지막 Document의 값을 반환. <br />Document가 정의된 순서가 있는 경우에만 ordering을 지원</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/operator/aggregation/max/#grp._S_max"><code>$max</code></a></td>
<td>각 그룹에서 가장 큰 값을 반환</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/operator/aggregation/mergeObjects/#exp._S_mergeObjects"><code>$mergeObjects</code></a></td>
<td>각 그룹에 대한 입력 Document를 조합하여 작성한 Document를 반환합니다.</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/operator/aggregation/min/#grp._S_min"><code>$min</code></a></td>
<td>각 그룹에서 가장 작은 값을 반환</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/operator/aggregation/push/#grp._S_push"><code>$push</code></a></td>
<td>각 그룹의 필드 값의 배열을 반환</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/operator/aggregation/stdDevPop/#grp._S_stdDevPop"><code>$stdDevPop</code></a></td>
<td>입력 값의 모집단 표준 편차를 반환</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/operator/aggregation/stdDevSamp/#grp._S_stdDevSamp"><code>$stdDevSamp</code></a></td>
<td>입력 값의 샘플 표준 편차를 반환</td>
</tr>
<tr>
<td><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/reference/operator/aggregation/sum/#grp._S_sum"><code>$sum</code></a></td>
<td>각 그룹의 숫자형 데이터의 합을 반환. 숫자가 아닌 값은 무시</td>
</tr>
</tbody></table>
<h3 id="예시"><a href="#예시" class="headerlink" title="예시"></a>예시</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;abc&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> <span class="attr">&quot;quantity&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> <span class="attr">&quot;date&quot;</span> <span class="punctuation">:</span> ISODate(<span class="string">&quot;2014-03-01T08:00:00Z&quot;</span>) <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;jkl&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span> <span class="attr">&quot;quantity&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;date&quot;</span> <span class="punctuation">:</span> ISODate(<span class="string">&quot;2014-03-01T09:00:00Z&quot;</span>) <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;xyz&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> <span class="attr">&quot;quantity&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> <span class="attr">&quot;date&quot;</span> <span class="punctuation">:</span> ISODate(<span class="string">&quot;2014-03-15T09:00:00Z&quot;</span>) <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;xyz&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> <span class="attr">&quot;quantity&quot;</span> <span class="punctuation">:</span> <span class="number">20</span><span class="punctuation">,</span> <span class="attr">&quot;date&quot;</span> <span class="punctuation">:</span> ISODate(<span class="string">&quot;2014-04-04T11:21:39.736Z&quot;</span>) <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;abc&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;price&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> <span class="attr">&quot;quantity&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> <span class="attr">&quot;date&quot;</span> <span class="punctuation">:</span> ISODate(<span class="string">&quot;2014-04-04T21:23:13.331Z&quot;</span>) <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="연산-년-x2F-월-x2F-일을-기준으로-group"><a href="#연산-년-x2F-월-x2F-일을-기준으로-group" class="headerlink" title="연산 - 년&#x2F;월&#x2F;일을 기준으로 group"></a>연산 - 년&#x2F;월&#x2F;일을 기준으로 group</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db.sales.aggregate(</span><br><span class="line">   <span class="punctuation">[</span></span><br><span class="line">      <span class="punctuation">&#123;</span></span><br><span class="line">        $group <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">           _id <span class="punctuation">:</span> <span class="punctuation">&#123;</span> month<span class="punctuation">:</span> <span class="punctuation">&#123;</span> $month<span class="punctuation">:</span> <span class="string">&quot;$date&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span> day<span class="punctuation">:</span> <span class="punctuation">&#123;</span> $dayOfMonth<span class="punctuation">:</span> <span class="string">&quot;$date&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span> year<span class="punctuation">:</span> <span class="punctuation">&#123;</span> $year<span class="punctuation">:</span> <span class="string">&quot;$date&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">           totalPrice<span class="punctuation">:</span> <span class="punctuation">&#123;</span> $sum<span class="punctuation">:</span> <span class="punctuation">&#123;</span> $multiply<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;$price&quot;</span><span class="punctuation">,</span> <span class="string">&quot;$quantity&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">           averageQuantity<span class="punctuation">:</span> <span class="punctuation">&#123;</span> $avg<span class="punctuation">:</span> <span class="string">&quot;$quantity&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">           count<span class="punctuation">:</span> <span class="punctuation">&#123;</span> $sum<span class="punctuation">:</span> <span class="number">1</span> <span class="punctuation">&#125;</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<ul>
<li>년&#x2F;월&#x2F;일을 기준으로 집계</li>
<li><code>$price</code> x <code>$quantity</code> 를 곱한 값의 합을 <strong>totalPrice</strong> 필드로 지정</li>
<li><code>$quantity</code> 필드 값의 평균을 <strong>averageQuantity</strong> 필드로 지정</li>
<li>Group별 데이터의 갯수를 <strong>count</strong> 로 지정</li>
</ul>
<h3 id="연산-결과-1"><a href="#연산-결과-1" class="headerlink" title="연산 결과"></a>연산 결과</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;month&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> <span class="attr">&quot;day&quot;</span> <span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span> <span class="attr">&quot;year&quot;</span> <span class="punctuation">:</span> <span class="number">2014</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;totalPrice&quot;</span> <span class="punctuation">:</span> <span class="number">50</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;averageQuantity&quot;</span> <span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;count&quot;</span> <span class="punctuation">:</span> <span class="number">1</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;month&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="attr">&quot;day&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="attr">&quot;year&quot;</span> <span class="punctuation">:</span> <span class="number">2014</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;totalPrice&quot;</span> <span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;averageQuantity&quot;</span> <span class="punctuation">:</span> <span class="number">15</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;count&quot;</span> <span class="punctuation">:</span> <span class="number">2</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> </span><br><span class="line">    <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;month&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> <span class="attr">&quot;day&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;year&quot;</span> <span class="punctuation">:</span> <span class="number">2014</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;totalPrice&quot;</span> <span class="punctuation">:</span> <span class="number">40</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;averageQuantity&quot;</span> <span class="punctuation">:</span> <span class="number">1.5</span><span class="punctuation">,</span> </span><br><span class="line">    <span class="attr">&quot;count&quot;</span> <span class="punctuation">:</span> <span class="number">2</span> </span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="Project"><a href="#Project" class="headerlink" title="$Project"></a>$Project</h2><ul>
<li>Project에서 지정한 필드 값을 다음 파이프라인 단계로 전달</li>
<li>RDB의 select 와 같은 역할</li>
<li>Field : 0 - 해당 필드 안보여줌</li>
<li>Filed : 1 - 해당 필드는 보여줌</li>
</ul>
<h3 id="입력형식"><a href="#입력형식" class="headerlink" title="입력형식"></a>입력형식</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $project: &#123; &lt;specification(s)&gt; &#125; &#125;</span><br></pre></td></tr></table></figure>



<h3 id="예제-1"><a href="#예제-1" class="headerlink" title="예제"></a>예제</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  title<span class="punctuation">:</span> <span class="string">&quot;abc123&quot;</span><span class="punctuation">,</span></span><br><span class="line">  isbn<span class="punctuation">:</span> <span class="string">&quot;0001122223334&quot;</span><span class="punctuation">,</span></span><br><span class="line">  author<span class="punctuation">:</span> <span class="punctuation">&#123;</span> last<span class="punctuation">:</span> <span class="string">&quot;zzz&quot;</span><span class="punctuation">,</span> first<span class="punctuation">:</span> <span class="string">&quot;aaa&quot;</span> <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">  copies<span class="punctuation">:</span> <span class="number">5</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>title, author 필드만 표시</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.books.aggregate( [ &#123; $project : &#123; title : 1 , author : 1 &#125; &#125; ] )</span><br></pre></td></tr></table></figure>



<h3 id="연산-결과-2"><a href="#연산-결과-2" class="headerlink" title="연산 결과"></a>연산 결과</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;title&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;abc123&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;author&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span> <span class="attr">&quot;last&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;zzz&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;first&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;aaa&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="Sort"><a href="#Sort" class="headerlink" title="$Sort"></a>$Sort</h2><ul>
<li>정렬 조건에 맞게 파이프라인의 연산결과를 정렬</li>
<li>ASC : 1, DESC : -1로 표현</li>
</ul>
<h3 id="입력-형식-2"><a href="#입력-형식-2" class="headerlink" title="입력 형식"></a>입력 형식</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $sort: &#123; &lt;field1&gt;: &lt;sort order&gt;, &lt;field2&gt;: &lt;sort order&gt; ... &#125; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="예제-2"><a href="#예제-2" class="headerlink" title="예제"></a>예제</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">88</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">92</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">97</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">71</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">79</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">83</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">db.users.aggregate(</span><br><span class="line">   <span class="punctuation">[</span></span><br><span class="line">     <span class="punctuation">&#123;</span> $sort <span class="punctuation">:</span> <span class="punctuation">&#123;</span> score <span class="punctuation">:</span> <span class="number">-1</span><span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">]</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="연산-결과-3"><a href="#연산-결과-3" class="headerlink" title="연산 결과"></a>연산 결과</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">97</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">92</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">88</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">83</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">79</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">71</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<h2 id="Skip"><a href="#Skip" class="headerlink" title="$Skip"></a>$Skip</h2><ul>
<li>입력한 갯수만큼 차례대로 Document를 skip 한 데이터를 다음 파이프라인으로 전달</li>
</ul>
<h3 id="입력-형식-3"><a href="#입력-형식-3" class="headerlink" title="입력 형식"></a>입력 형식</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $skip: &lt;positive integer&gt; &#125;</span><br></pre></td></tr></table></figure>

<h3 id="예제-3"><a href="#예제-3" class="headerlink" title="예제"></a>예제</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.article.aggregate(</span><br><span class="line">    <span class="punctuation">&#123;</span> $skip <span class="punctuation">:</span> <span class="number">5</span> <span class="punctuation">&#125;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>


<h2 id="Sample"><a href="#Sample" class="headerlink" title="$Sample"></a>$Sample</h2><ul>
<li>Collection 내에서 입력한 갯수만큼 Random하게 Document 출력</li>
</ul>
<h3 id="입력-형식-4"><a href="#입력-형식-4" class="headerlink" title="입력 형식"></a>입력 형식</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> $sample<span class="punctuation">:</span> <span class="punctuation">&#123;</span> size<span class="punctuation">:</span> &lt;positive integer&gt; <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="예제-4"><a href="#예제-4" class="headerlink" title="예제"></a>예제</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dave123&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;q1&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="attr">&quot;q2&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dave2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;q1&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span> <span class="attr">&quot;q2&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span>  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ahn&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;q1&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="attr">&quot;q2&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span>  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;li&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;q1&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="attr">&quot;q2&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span>  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;annT&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;q1&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span> <span class="attr">&quot;q2&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span>  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;li&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;q1&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="attr">&quot;q2&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span>  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ty&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;q1&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span> <span class="attr">&quot;q2&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span>  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.users.aggregate(</span><br><span class="line">   <span class="punctuation">[</span> <span class="punctuation">&#123;</span> $sample<span class="punctuation">:</span> <span class="punctuation">&#123;</span> size<span class="punctuation">:</span> <span class="number">3</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span> <span class="punctuation">]</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="연산-결과-4"><a href="#연산-결과-4" class="headerlink" title="연산 결과"></a>연산 결과</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;dave2&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;q1&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span> <span class="attr">&quot;q2&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span>  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;li&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;q1&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span> <span class="attr">&quot;q2&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span>  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">7</span><span class="punctuation">,</span> <span class="attr">&quot;name&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ty&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;q1&quot;</span> <span class="punctuation">:</span> <span class="keyword">false</span><span class="punctuation">,</span> <span class="attr">&quot;q2&quot;</span> <span class="punctuation">:</span> <span class="keyword">true</span>  <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<h2 id="Count"><a href="#Count" class="headerlink" title="$Count"></a>$Count</h2><ul>
<li>스테이지에 입력하는 문서 수의 카운트가 포함된 문서를 다음 단계로 전달합니다.</li>
</ul>
<h3 id="입력-형식-5"><a href="#입력-형식-5" class="headerlink" title="입력 형식"></a>입력 형식</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> $count<span class="punctuation">:</span> &lt;string&gt; <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="예시-역사-점수-데이터가-있을때"><a href="#예시-역사-점수-데이터가-있을때" class="headerlink" title="예시 - 역사 점수 데이터가 있을때"></a>예시 - 역사 점수 데이터가 있을때</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">88</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">92</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">97</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">71</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">79</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">6</span><span class="punctuation">,</span> <span class="attr">&quot;subject&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;History&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;score&quot;</span> <span class="punctuation">:</span> <span class="number">83</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="scores-Collection에서-80점-초과인-데이터를-조회하고-그에-대한-Count를-계산"><a href="#scores-Collection에서-80점-초과인-데이터를-조회하고-그에-대한-Count를-계산" class="headerlink" title="scores Collection에서 80점 초과인 데이터를 조회하고 그에 대한 Count를 계산"></a>scores Collection에서 80점 초과인 데이터를 조회하고 그에 대한 Count를 계산</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">db.scores.aggregate(</span><br><span class="line">  <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      $match<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">        score<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">          $gt<span class="punctuation">:</span> <span class="number">80</span></span><br><span class="line">        <span class="punctuation">&#125;</span></span><br><span class="line">      <span class="punctuation">&#125;</span></span><br><span class="line">    <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      $count<span class="punctuation">:</span> <span class="string">&quot;passing_scores&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h3 id="연산-결과-5"><a href="#연산-결과-5" class="headerlink" title="연산 결과"></a>연산 결과</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;passing_scores&quot;</span> <span class="punctuation">:</span> <span class="number">4</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="addField"><a href="#addField" class="headerlink" title="$addField"></a>$addField</h2><ul>
<li>Document에 새 필드를 추가합니다.</li>
<li>$addFields는 Document 및 새로 추가된 필드에서 모든 기존 필드가 포함된 문서를 출력합니다.</li>
<li>실제 Document의 문서 내용을 바꾸는 것이 아닌 조회를 하는 용도</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> $addFields<span class="punctuation">:</span> <span class="punctuation">&#123;</span> &lt;newField&gt;<span class="punctuation">:</span> &lt;expression&gt;<span class="punctuation">,</span> ... <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="예시-score라는-collection에-아래와-같은-데이터가-있을때"><a href="#예시-score라는-collection에-아래와-같은-데이터가-있을때" class="headerlink" title="예시 - score라는 collection에 아래와 같은 데이터가 있을때"></a>예시 - score라는 collection에 아래와 같은 데이터가 있을때</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  _id<span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  student<span class="punctuation">:</span> <span class="string">&quot;Maya&quot;</span><span class="punctuation">,</span></span><br><span class="line">  homework<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="number">10</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">,</span> <span class="number">10</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  quiz<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="number">10</span><span class="punctuation">,</span> <span class="number">8</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  extraCredit<span class="punctuation">:</span> <span class="number">0</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  _id<span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  student<span class="punctuation">:</span> <span class="string">&quot;Ryan&quot;</span><span class="punctuation">,</span></span><br><span class="line">  homework<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="number">5</span><span class="punctuation">,</span> <span class="number">6</span><span class="punctuation">,</span> <span class="number">5</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  quiz<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="number">8</span><span class="punctuation">,</span> <span class="number">8</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  extraCredit<span class="punctuation">:</span> <span class="number">8</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="집계-연산을-하여-homework-quiz-필드에-대한-Array의-합을-기존-Document에-추가"><a href="#집계-연산을-하여-homework-quiz-필드에-대한-Array의-합을-기존-Document에-추가" class="headerlink" title="집계 연산을 하여, homework, quiz 필드에 대한 Array의 합을 기존 Document에 추가"></a>집계 연산을 하여, homework, quiz 필드에 대한 Array의 합을 기존 Document에 추가</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">db.scores.aggregate( <span class="punctuation">[</span></span><br><span class="line">   <span class="punctuation">&#123;</span></span><br><span class="line">     $addFields<span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">       totalHomework<span class="punctuation">:</span> <span class="punctuation">&#123;</span> $sum<span class="punctuation">:</span> <span class="string">&quot;$homework&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">,</span></span><br><span class="line">       totalQuiz<span class="punctuation">:</span> <span class="punctuation">&#123;</span> $sum<span class="punctuation">:</span> <span class="string">&quot;$quiz&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line">     <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span><span class="punctuation">,</span></span><br><span class="line">   <span class="punctuation">&#123;</span></span><br><span class="line">     $addFields<span class="punctuation">:</span> <span class="punctuation">&#123;</span> totalScore<span class="punctuation">:</span></span><br><span class="line">       <span class="punctuation">&#123;</span> $add<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;$totalHomework&quot;</span><span class="punctuation">,</span> <span class="string">&quot;$totalQuiz&quot;</span><span class="punctuation">,</span> <span class="string">&quot;$extraCredit&quot;</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br><span class="line">   <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span> )</span><br></pre></td></tr></table></figure>



<h3 id="연산-결과-6"><a href="#연산-결과-6" class="headerlink" title="연산 결과"></a>연산 결과</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;student&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Maya&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;homework&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="number">10</span><span class="punctuation">,</span> <span class="number">5</span><span class="punctuation">,</span> <span class="number">10</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;quiz&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="number">10</span><span class="punctuation">,</span> <span class="number">8</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;extraCredit&quot;</span> <span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;totalHomework&quot;</span> <span class="punctuation">:</span> <span class="number">25</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;totalQuiz&quot;</span> <span class="punctuation">:</span> <span class="number">18</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;totalScore&quot;</span> <span class="punctuation">:</span> <span class="number">43</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;student&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;Ryan&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;homework&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="number">5</span><span class="punctuation">,</span> <span class="number">6</span><span class="punctuation">,</span> <span class="number">5</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;quiz&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="number">8</span><span class="punctuation">,</span> <span class="number">8</span> <span class="punctuation">]</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;extraCredit&quot;</span> <span class="punctuation">:</span> <span class="number">8</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;totalHomework&quot;</span> <span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;totalQuiz&quot;</span> <span class="punctuation">:</span> <span class="number">16</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;totalScore&quot;</span> <span class="punctuation">:</span> <span class="number">40</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="limit"><a href="#limit" class="headerlink" title="$limit"></a>$limit</h2><ul>
<li>파이프라인 연산으로 출력된 Document의 갯수를 제한</li>
</ul>
<h3 id="입력-형식-6"><a href="#입력-형식-6" class="headerlink" title="입력 형식"></a>입력 형식</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123; $limit: &lt;positive integer&gt; &#125;</span><br></pre></td></tr></table></figure>



<h3 id="예제-5"><a href="#예제-5" class="headerlink" title="예제"></a>예제</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.article.aggregate(</span><br><span class="line">    <span class="punctuation">&#123;</span> $limit <span class="punctuation">:</span> <span class="number">5</span> <span class="punctuation">&#125;</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure>



<h2 id="unwind"><a href="#unwind" class="headerlink" title="$unwind"></a>$unwind</h2><ul>
<li>Document내의 배열 필드를 기반으로 각각의 Document로 분리</li>
</ul>
<h3 id="입력-형식-7"><a href="#입력-형식-7" class="headerlink" title="입력 형식"></a>입력 형식</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  $unwind<span class="punctuation">:</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      path<span class="punctuation">:</span> &lt;field path&gt;<span class="punctuation">,</span></span><br><span class="line">      includeArrayIndex<span class="punctuation">:</span> &lt;string&gt;<span class="punctuation">,</span></span><br><span class="line">      preserveNullAndEmptyArrays<span class="punctuation">:</span> &lt;boolean&gt;</span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>Field</th>
<th>Type</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>path</code></td>
<td>string</td>
<td>배열 필드의 필드 경로.<br />필드 경로를 지정하려면 <code>$</code> 기호를 사용하여 필드 이름에 접두사를 붙이고 따옴표로 묶습니다. (ex : <code>&quot;$arrayField&quot;</code>)</td>
</tr>
<tr>
<td><code>includeArrayIndex</code></td>
<td>string</td>
<td>요소의 배열 index값을 저장할 새 필드의 이름. <br />이름은 달러 기호 “$”로 시작할 수 없습니다. (필수 아님)</td>
</tr>
<tr>
<td><code>preserveNullAndEmptyArrays</code></td>
<td>boolean</td>
<td>만약 true로 설정 시, path Field값이 null, 빈 배열인 경우에 <code>$unwind</code> 연산 결과가 Document에 표시 됨.<br />만약 false로 설정 시,<code>$unwind</code> 연산 결과가 Document에 표시 되지 않음. (default false) (필수 아님)</td>
</tr>
</tbody></table>
<h3 id="예제-1-기본-예제"><a href="#예제-1-기본-예제" class="headerlink" title="예제 1 - 기본 예제"></a>예제 1 - 기본 예제</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ABC1&quot;</span><span class="punctuation">,</span> sizes<span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;S&quot;</span><span class="punctuation">,</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span> <span class="string">&quot;L&quot;</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.aggregate( <span class="punctuation">[</span> <span class="punctuation">&#123;</span> $unwind <span class="punctuation">:</span> <span class="string">&quot;$sizes&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">]</span> )</span><br></pre></td></tr></table></figure>



<h3 id="연산-결과-1"><a href="#연산-결과-1" class="headerlink" title="연산 결과 1"></a>연산 결과 1</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ABC1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;S&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ABC1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ABC1&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;L&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="예제-2-includeArrayIndex-속성을-이용한-Index-출력"><a href="#예제-2-includeArrayIndex-속성을-이용한-Index-출력" class="headerlink" title="예제 2 - includeArrayIndex 속성을 이용한 Index 출력"></a>예제 2 - includeArrayIndex 속성을 이용한 Index 출력</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ABC&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;S&quot;</span><span class="punctuation">,</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span> <span class="string">&quot;L&quot;</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;EFG&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;IJK&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;M&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;LMN&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;XYZ&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.aggregate( <span class="punctuation">[</span> </span><br><span class="line">    <span class="punctuation">&#123;</span> $unwind<span class="punctuation">:</span> <span class="punctuation">&#123;</span> path<span class="punctuation">:</span> <span class="string">&quot;$sizes&quot;</span><span class="punctuation">,</span> includeArrayIndex<span class="punctuation">:</span> <span class="string">&quot;arrayIndex&quot;</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span> </span><br><span class="line"><span class="punctuation">]</span> )</span><br></pre></td></tr></table></figure>



<h3 id="연산-결과-2"><a href="#연산-결과-2" class="headerlink" title="연산 결과 2"></a>연산 결과 2</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ABC&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;S&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;arrayIndex&quot;</span> <span class="punctuation">:</span> NumberLong(<span class="number">0</span>) <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ABC&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;arrayIndex&quot;</span> <span class="punctuation">:</span> NumberLong(<span class="number">1</span>) <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ABC&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;L&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;arrayIndex&quot;</span> <span class="punctuation">:</span> NumberLong(<span class="number">2</span>) <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;IJK&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;arrayIndex&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>



<h3 id="예제-3-preserveNullAndEmptyArrays-속성을-이용한-출력"><a href="#예제-3-preserveNullAndEmptyArrays-속성을-이용한-출력" class="headerlink" title="예제 3 - preserveNullAndEmptyArrays 속성을 이용한 출력"></a>예제 3 - preserveNullAndEmptyArrays 속성을 이용한 출력</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ABC&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span> <span class="string">&quot;S&quot;</span><span class="punctuation">,</span> <span class="string">&quot;M&quot;</span><span class="punctuation">,</span> <span class="string">&quot;L&quot;</span><span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;EFG&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="punctuation">[</span> <span class="punctuation">]</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;IJK&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span><span class="punctuation">:</span> <span class="string">&quot;M&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;LMN&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">5</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;XYZ&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="keyword">null</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">db.inventory.aggregate( <span class="punctuation">[</span></span><br><span class="line">   <span class="punctuation">&#123;</span> $unwind<span class="punctuation">:</span> <span class="punctuation">&#123;</span> path<span class="punctuation">:</span> <span class="string">&quot;$sizes&quot;</span><span class="punctuation">,</span> preserveNullAndEmptyArrays<span class="punctuation">:</span> <span class="keyword">true</span> <span class="punctuation">&#125;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">]</span> )</span><br></pre></td></tr></table></figure>



<h3 id="연산-결과-3"><a href="#연산-결과-3" class="headerlink" title="연산 결과 3"></a>연산 결과 3</h3><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ABC&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;S&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ABC&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;ABC&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;L&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">2</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;EFG&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">3</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;IJK&quot;</span><span class="punctuation">,</span> <span class="attr">&quot;sizes&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;M&quot;</span> <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#123;</span> <span class="attr">&quot;_id&quot;</span> <span class="punctuation">:</span> <span class="number">4</span><span class="punctuation">,</span> <span class="attr">&quot;item&quot;</span> <span class="punctuation">:</span> <span class="string">&quot;LMN&quot;</span> <span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>





<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/core/aggregation-pipeline/">https://docs.mongodb.com/master/core/aggregation-pipeline/</a></li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/02/24/effective-java-item56/">Item 56. 공개된 API 요소에는 항상 문서화 주석을 작성하라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-02-24</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>API를 쓸모 있게 하려면 잘 작성된 문서도 곁들여야 한다.<br>전통적으로 API는 사람이 직접 작성하므로 코드가 변경되면 매번 함께 수정해야 하는데,<br>자바에서는 자바독(JavaDoc)이라는 유틸리티가 이 귀찮은 작업을 도와준다.</p>
<p>문서화 주석을 작성하는 규칙은 공식 언어 명세에 속하진 않지만 자바 프로그래머라면 응당 알아야 하는 업계 표준 API라 할 수 있다.</p>
<h1 id="모든-공개된-리소스에-주석을-달아야-한다"><a href="#모든-공개된-리소스에-주석을-달아야-한다" class="headerlink" title="모든 공개된 리소스에 주석을 달아야 한다."></a>모든 공개된 리소스에 주석을 달아야 한다.</h1><ul>
<li>API를 올바로 문서화 하려면 공개된 클래스, 인터페이스, 메서드, 필드 선언에 문서화 주석을 달아야 한다.  </li>
<li>직렬화 할 수 있는 클래스라면 직렬화 형태에 대해서도 적어야 한다.  </li>
<li>문서화 주석이 없다면 JavaDoc도 그저 공개 API 요소들의 선언만 나열해 주는게 전부다.  </li>
<li>문서가 잘 갖춰지지 않은 API는 쓰기 헷갈려서 오류의 원인이 되기 쉽다.  </li>
<li>기본 생성자에는 문서화 주석을 달 방법이 없으니 공개 클래스는 절대 기본 생성자를 사용하면 안된다.  </li>
<li>유지 보수까지 고려한다면 대다수의 공개되지 않은 클래스, 인터페이스, 생성자, 메서드, 필드에도 문서화 주석을 달아야 한다.</li>
</ul>
<h1 id="메서드용-문서화-주석에는-규약을-명료하게-기술해야-한다"><a href="#메서드용-문서화-주석에는-규약을-명료하게-기술해야-한다" class="headerlink" title="메서드용 문서화 주석에는 규약을 명료하게 기술해야 한다."></a>메서드용 문서화 주석에는 규약을 명료하게 기술해야 한다.</h1><ul>
<li>메서드용 문서화 주석에는 해당 메서드와 클라이언트 사이의 규약을 명료하게 기술해야 한다.</li>
<li>메서드가 어떻게 동작하는지를 적는게 아니라 무엇을 하는지 기술해야 한다.<br>(how가 아닌 what을 기술해야한다.)</li>
<li>클라이언트가 해당 메서드를 호출하기 위한 전제조건(precondition)을 모두 나열해야 한다.</li>
<li>메서드가 성공적으로 수행된 후에 만족해야 하는 사후조건(postcondition)도 모두 나열해야 한다.</li>
<li>일반적으로 전제조건은 @throw 태그로 비검사 예외를 선언하여 암시적으로 기술한다.<br>비검사 예외 하나가 전제조건 하나와 연결되는 것이다.</li>
<li>@param 태그를 이용해 그 조건에 영향받는 매개변수에 기술 할 수도 있다.</li>
</ul>
<h1 id="전제조건과-사후조건-뿐만-아니라-부작용도-문서화-하라"><a href="#전제조건과-사후조건-뿐만-아니라-부작용도-문서화-하라" class="headerlink" title="전제조건과 사후조건 뿐만 아니라 부작용도 문서화 하라"></a>전제조건과 사후조건 뿐만 아니라 부작용도 문서화 하라</h1><ul>
<li><strong>부작용</strong>이란 <strong>사후조건으로 명확히 나타나지는 않지만 시스템의 상태에 따라 어떠한 변화</strong>를 가져오는 것을 의미</li>
<li>예를들어 메서드에서 백그라운드 스레드를 실행시키는 메서드라면 그 사실을 문서에 밝혀야 한다.</li>
</ul>
<h1 id="문서화-태그"><a href="#문서화-태그" class="headerlink" title="문서화 태그"></a>문서화 태그</h1><ul>
<li>@param <ul>
<li>메서드의 파라미터에 대한 정보</li>
<li>매개변수가 뜻하는 값을 명사구로 쓴다.</li>
</ul>
</li>
<li>@return <ul>
<li>메서드의 반환타입이 void가 아니라면 반환 타입을 명시</li>
<li>반환값이 뜻하는 값을 명사구로 작성</li>
<li>드물게는 산술표현식으로도 작성하기도 한다.</li>
</ul>
</li>
<li>@throws <ul>
<li>발생가능성이 있는 모든 예외에 대해 명시</li>
<li>if로 시작해 해당 예외를 던지를 조건을 설명하는 절이 뒤따른다.</li>
</ul>
</li>
<li>@code<ul>
<li>태그로 감싼 내용을 코드용 폰트로 렌더링한다.</li>
<li>태그로 감싼 내용에 포함된 HTML 요소나 다른 JavaDoc 태그를 무시한다.</li>
<li>@기호에는 무조건 탈출문자를 붙여야 하니 문서화 주석안의 코드에서 annotation을 사용한다면 주의해야한다.</li>
</ul>
</li>
<li>@implSpec<ul>
<li>자기사용 패턴(self-use pattern)에 대해서도 문서에 남겨 다른 프로그래머에게 그 메서드를 올바르게 재정의 하는 방법을 알려야 한다.</li>
<li>일반적인 문서화 주석은 해당 메서드와 클라이언트 사이의 관계를 설명</li>
<li>@implSpec 주석은 해당 메서드와 하위 클래스 사이의 관계를 설명하여, 하위 클래스들이 그 메서드를 상속하거나 super 키워드를 이용해 호출할 때 그 메서드가 어떻게 동작하는지를 명확히 인지하고 사용하게 해야 한다.</li>
<li>-tag “implSpec:a:Implementation Requirement” 스위치를 키지 않으면 @implSpec 태그를 무시</li>
</ul>
</li>
<li>@literal<ul>
<li>이 태그는 &lt;, &gt;와 같은 HTML 태그를 무시하게 해준다.</li>
<li>@code와 비슷하지만, 코드 폰트로 렌더링 하지는 않는다.</li>
<li>A geometric series converges if {@literal |r| &lt; 1}. 처럼 사용 할 수 있다.</li>
<li>API 문서에서 가독성을 높이기 위해 사용한다.</li>
</ul>
</li>
</ul>
<p>관례상 @param, @return, @throws 태그의 설명에는 마침표를 붙이지 않는다.<br>(한글로 작성하는 경우에는 온전한 종결어미로 끝나면 마침표를 붙여주는게 일관돼 보인다.)</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Returns the element at the specified position in this list.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* &lt;p&gt;This method is &lt;i&gt;not&lt;/i&gt; guaranteed to run in constant time.</span></span><br><span class="line"><span class="comment">* In some implementations it may run in time proportional to the element position.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> index index of the element to return</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> the element at the specified position in this list</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> IndexOutOfBoundsException if the index is out of range</span></span><br><span class="line"><span class="comment">*         (&#123;<span class="doctag">@code</span> index &lt; 0 || index &gt;= size()&#125;)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span>;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 이 리스트에서 지정한 위치의 원소를 반환한다.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* &lt;p&gt;이 메서드는 상수시간에 수행됨을 보장하지 &lt;i&gt;않는다.&lt;/i&gt; </span></span><br><span class="line"><span class="comment">* 구현에 따라 원소의 위치에 비례해 시간이 걸릴 수도 있다.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> index 반환할 원소의 인덱스</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> 이 리스트에서 지정한 위치의 원소</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> IndexOutOfBoundsException index가 범위를 벗어나면,</span></span><br><span class="line"><span class="comment">*         즉, (&#123;<span class="doctag">@code</span> index &lt; 0 || index &gt;= size()&#125;) 이면 발생한다.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span>;</span><br></pre></td></tr></table></figure>



<h1 id="html-태그의-사용"><a href="#html-태그의-사용" class="headerlink" title="html 태그의 사용"></a>html 태그의 사용</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Returns the element at the specified position in this list.</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* &lt;p&gt;This method is &lt;i&gt;not&lt;/i&gt; guaranteed to run in constant time.</span></span><br><span class="line"><span class="comment">* In some implementations it may run in time proportional to the element position.</span></span><br><span class="line"><span class="comment">* <span class="doctag">@param</span> index index of the element to return</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> the element at the specified position in this list</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> IndexOutOfBoundsException if the index is out of range</span></span><br><span class="line"><span class="comment">*         (&#123;<span class="doctag">@code</span> index &lt; 0 || index &gt;= size()&#125;)</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">E <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span>;</span><br></pre></td></tr></table></figure>

<ul>
<li>위에서 보면 <p>나 <i>와 같은 html 태그가 사용되었다.</li>
<li>JavaDoc 유틸리티는 문서화 주석을 HTML로 변환하므로 문서화 주석 안의 HTML 요소들이 최종 HTML문서에 반영된다.</li>
</ul>
<h1 id="요약-설명"><a href="#요약-설명" class="headerlink" title="요약 설명"></a>요약 설명</h1><ul>
<li><p>각 문서화 주석의 첫 번째 문장은 해당 요소의 요약 설명(Summary description)으로 간주된다.</p>
</li>
<li><p><code>Returns the element at the specified position in this list.</code> 와 같은 문장이 이에 속한다.</p>
</li>
<li><p>첫 번째 <code>.</code> 기호가 나타나기 전까지의 문장을 첫 번째 문장으로 간주한다.</p>
</li>
<li><p>예를들어 “머스터드 대령이나 Mrs. 피콕 같은 용의자.”라고 하면 첫 번째 마침표가 나오는<br>“머스터드 대령이나 Mrs.” 까지만 요약 설명이 된다.</p>
</li>
<li><p>위와 같은 예제를 해결하기 위해선 @literal을 사용한다.<br>ex)  머스터드 대령이나 {@literal Mrs.} 피콕 같은 용의자.</p>
</li>
<li><p>Java 10부터는 {@summary}라는 요약 설명 전용 태그가 추가되어 한번에 사용 가능하다.<br>{@summary 머스터드 대령이나 Mrs. 피콕 같은 용의자.}</p>
</li>
<li><p><strong>요약 설명이란, 문서화 주석의 첫 문장이다.</strong> 라고 말하면 살짝 오해의 소지가 있다.<br>주석 작성 규약에 따르면 요약 설명은 완전한 문장이 되는 경우가 드물기 때문이다.<br>메서드와 생성자의 요약 설명은 해당 메서드와 생성자의 동작을 설명하는 (주어가 없는) 동사구여야 한다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ArrayList(int initialCapacity): Constructs an empty list with the specified initail capacity</span><br><span class="line">Collection.size(): Returns the number of elements in this collection.</span><br></pre></td></tr></table></figure>
</li>
<li><p>클래스나 인터페이스, 필드의 요약설명은 대상을 설명하는 명사절이어야 한다.<br>클래스와 인터페이스의 대상은 그 인스턴스이고, 필드의 대상은 필드 자신이다.  </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Instant: An instantaneous point on the time-line (타임라인상의 특정순간(지점))</span><br><span class="line">Math.PI: The double value that is closer than any other to pi, the ratio of the circumference of a circle to its diamter (원주율(pi)에 가장 가까운 double 값)</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="색인-Index-기능"><a href="#색인-Index-기능" class="headerlink" title="색인(Index) 기능"></a>색인(Index) 기능</h1><ul>
<li><p>자바 9부터는 JavaDoc이 생성한 HTML 문서에 대해 검색(색인) 기능이 추가되어 광대한 API 문서를 누비는 일이 수월해짐</p>
</li>
<li><p>@index 태그를 사용해 API에서 중요한 용어를 추가로 색인화 할 수 있다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">This method compiles with the &#123;@index IEEE 754&#125; standard.</span><br></pre></td></tr></table></figure></li>
</ul>
<h1 id="제네릭-타입이나-제네릭-메서드의-주석"><a href="#제네릭-타입이나-제네릭-메서드의-주석" class="headerlink" title="제네릭 타입이나 제네릭 메서드의 주석"></a>제네릭 타입이나 제네릭 메서드의 주석</h1><ul>
<li>제네릭 타입이나 제네릭 메서드를 문서화 할 때는 모든 타입 매개변수에 주석을 달아야 한다.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/* </span></span><br><span class="line"><span class="comment"> * An object that maps keys to values.  A map cannot contain duplicate keys;</span></span><br><span class="line"><span class="comment"> * each key can map to at most one value.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &lt;K&gt; the type of keys maintained by this map</span></span><br><span class="line"><span class="comment"> * @param &lt;V&gt; the type of mapped values</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Map</span>&lt;K, V&gt; &#123;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"> <span class="comment">/* </span></span><br><span class="line"><span class="comment"> * 키와 값을 매핑하는 객체, 맵은 키를 중복해서 가질 수 없다.</span></span><br><span class="line"><span class="comment"> * 즉, 키 하나가 가리킬 수 있는 값은 최대 1개다.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * @param &lt;K&gt; 이 맵이 관리하는 키의 타입</span></span><br><span class="line"><span class="comment"> * @param &lt;V&gt; 매핑된 값의 타입</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Map</span>&lt;K, V&gt; &#123;</span><br></pre></td></tr></table></figure>



<h1 id="열거타입에는-상수별로-주석을-달아라"><a href="#열거타입에는-상수별로-주석을-달아라" class="headerlink" title="열거타입에는 상수별로 주석을 달아라"></a>열거타입에는 상수별로 주석을 달아라</h1><ul>
<li>열거 타입을 문서화할 때는 상수들에도 주석을 달아야 한다.</li>
<li>열거 타입 자체와 열거 타입의 public 메서드도 물론이다.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* An instrument section of a symphony orchestra</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">enum</span> <span class="title class_">OrchestraSection</span> &#123;</span><br><span class="line">    <span class="comment">/** WoodWinds, such as flute, clarinet and oboe */</span></span><br><span class="line">    WOODWIND,</span><br><span class="line">    <span class="comment">/** Brass instruments, such as french horn and trumper */</span></span><br><span class="line">    BRASS,</span><br><span class="line">    <span class="comment">/** Percussion instruments, such as timpani, cymbals */</span></span><br><span class="line">    PERCUSSION,</span><br><span class="line">    <span class="comment">/** Stringed instruments, such as violin and cello */</span></span><br><span class="line">    STRING</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="애너테이션-타입을-문서화-할-때는-멤버에도-주석을-달아라"><a href="#애너테이션-타입을-문서화-할-때는-멤버에도-주석을-달아라" class="headerlink" title="애너테이션 타입을 문서화 할 때는 멤버에도 주석을 달아라"></a>애너테이션 타입을 문서화 할 때는 멤버에도 주석을 달아라</h1><ul>
<li>애너테이션 타입을 문서화할 때는 멤버들에도 모두 주석을 달아야 한다.</li>
<li>애너테이션 타입 자체도 물론이다.</li>
<li>필드 설명은 명사구로 한다.</li>
<li>애너테이션 타입의 요약 설명은 프로그램 요소에 이 애너테이션을 단다는 것이 어떤 의미인지를 설명하는 동사구로 한다.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Indicates that the annotated method is a test method that </span></span><br><span class="line"><span class="comment"> * must throw the designated exception to pass</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Target(ElementType.METHOD)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ExceptionTest &#123;</span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     *  The exception that the annotated test method must throw</span></span><br><span class="line"><span class="comment">     *  in order to pass. (The test is permitted to throw any subtype</span></span><br><span class="line"><span class="comment">     *  of the type described by this class object.)</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    Class&lt;? <span class="keyword">extends</span> <span class="title class_">Throwable</span>&gt; value();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="패키지를-설명하는-문서화-주석은-package-info-java에-작성한다"><a href="#패키지를-설명하는-문서화-주석은-package-info-java에-작성한다" class="headerlink" title="패키지를 설명하는 문서화 주석은 package-info.java에 작성한다."></a>패키지를 설명하는 문서화 주석은 package-info.java에 작성한다.</h1><ul>
<li>패키지를 설명하는 문서화 주석은 package-info.java에 명시한다.</li>
<li>패키지 선언을 반드시 포함해야 하며 패키지 선언관련 애너테이션을 추가로 포함할 수도 있다.</li>
<li>모듈 시스템을 사용한다면, module-info.java 파일에 작성하면 된다.</li>
</ul>
<h1 id="스레드-안전-수준을-반드시-API-설명에-포함해야-한다"><a href="#스레드-안전-수준을-반드시-API-설명에-포함해야-한다" class="headerlink" title="스레드 안전 수준을 반드시 API 설명에 포함해야 한다."></a>스레드 안전 수준을 반드시 API 설명에 포함해야 한다.</h1><ul>
<li>클래스 혹은 정적 메서드가 스레드 안전하든 그렇지 않든, 스레드 안전 수준을 반드시 API 설명에 포함해야 한다.</li>
<li>직렬화할 수 있는 클래스라면 직렬화 형태도 API 설명에 기술해야 한다.</li>
</ul>
<h1 id="JavaDoc은-메서드-주석을-상속-시킬-수-있다"><a href="#JavaDoc은-메서드-주석을-상속-시킬-수-있다" class="headerlink" title="JavaDoc은 메서드 주석을 상속 시킬 수 있다."></a>JavaDoc은 메서드 주석을 상속 시킬 수 있다.</h1><ul>
<li>문서화 주석이 없는 API 요소를 발견하면 JavaDoc이 가장 가까운 문서화 주석을 찾아준다.</li>
<li>상위 클래스보다 구현한 인터페이스 주석을 더 먼저 찾는다.</li>
<li>@inheritedDoc 태그를 사용해 상위 타입의 문서화 주석 일부를 상속할 수 있다.</li>
<li>클래스는 자신이 구현한 인터페이스의 문서화 주석을 재사용할 수 있다.</li>
</ul>
<h1 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h1><ul>
<li><p>문서화 주석은 API를 문서화 하는 가장 훌륭하고 효과적인 방법이다.</p>
</li>
<li><p>공개 API라면 빠짐없이 설명을 달아야 한다.</p>
</li>
<li><p>표준 규약을 일관되게 지키자.</p>
</li>
<li><p>문서화 주석이외에 HTML 태그를 사용할 수 있다.</p>
</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 56. 공개된 API 요소에는 항상 문서화 주석을 작성하라</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/02/24/effective-java-item55/">Item 55. 옵셔널 반환은 신중히 하라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-02-24</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>자바 8 전에는  메서드가 특정 조건에서 값을 반환할 수 없을 때 취할 수 있는 선택지가 두 가지 있었다.</p>
<ul>
<li>Exception Throw<ul>
<li>예외는 반드시 예외적인 상황에서만 사용해야 한다.</li>
<li>예외는 실행 스택을 추적(StackTrace)를 캡처하기 때문에 비용이 비싸다.</li>
</ul>
</li>
<li>Null Return<ul>
<li>null을 리턴하는 경우에는 NPE(Null Pointer Exception)을 항상 조심해야한다.</li>
</ul>
</li>
</ul>
<p>자바 8이 등장하면서 Optional이라는 또 하나의 선택지가 추가되었다.</p>
<h1 id="Optional-이란"><a href="#Optional-이란" class="headerlink" title="Optional 이란?"></a>Optional 이란?</h1><ul>
<li>Optional이란, 값이 있을 수도 있고 없을 수도 있는 객체이다.  참조 타입의 객체를 한번 감싼 일종의 래퍼 클래스 이다.  </li>
<li>Optional은 원소를 최대 1개 가질 수 있는 불변 Collection이다.</li>
<li>자바 8 이전의 코드보다 null-safe한 로직을 처리 할 수 있게 해준다.</li>
<li>Optional을 반환하여 좀 더 로직을 유연하게 작성할 수 있게 해준다.</li>
</ul>
<h1 id="Optional-메서드"><a href="#Optional-메서드" class="headerlink" title="Optional 메서드"></a>Optional 메서드</h1><ul>
<li><strong>Optional.empty()</strong><ul>
<li>내부 값이 비어있는 Optional 객체 반환</li>
</ul>
</li>
<li><strong>Optional.of(T value)</strong><ul>
<li>내부 값이 value인 Optional 객체 반환</li>
<li>만약 value가 null인 경우 <code>NullPointerException</code> 발생</li>
</ul>
</li>
<li><strong>Optional.ofNullable(T value)</strong><ul>
<li>가장 자주 쓰이는 Optional 생성 방법</li>
<li>value가 null이면, empty Optional을 반환하고, 값이 있으면 Optional.of로 생성</li>
</ul>
</li>
<li><strong>T get()</strong><ul>
<li>Optional 내의 값을 반환</li>
<li>만약 Optional 내부 값이 null인 경우 <code>NoSuchElementException</code> 발생</li>
</ul>
</li>
<li><strong>boolean isPresent()</strong><ul>
<li>Optional 내부 값이 null이면 false, 있으면 true</li>
<li>Optional 내부에서만 사용해야하는 메서드라고 생각</li>
</ul>
</li>
<li><strong>boolean isEmpty()</strong><ul>
<li>Optional 내부의 값이 null이면 true, 있으면 false</li>
<li>isPresent() 메서드의 반대되는 메서드</li>
</ul>
</li>
<li><strong>void ifPresent(Consumer&lt;? super T&gt; consumer)</strong><ul>
<li>Optional 내부의 값이 있는 경우 consumer 함수를 실행</li>
</ul>
</li>
<li><strong>Optional<T> filter(Predicate<T> predicate)</strong><ul>
<li>Optional에 filter 조건을 걸어 조건에 맞을 때만 Optional 내부 값이 있음</li>
<li>조건이 맞지 않으면 Optional.empty를 리턴</li>
</ul>
</li>
<li><strong>Optional<U> map(Funtion&lt;? super T, ? extends U&gt; f)</strong><ul>
<li>Optional 내부의 값을 Function을 통해 가공</li>
</ul>
</li>
<li><strong>T orElse(T other)</strong><ul>
<li>Optional 내부의 값이 있는 경우 그 값을 반환</li>
<li>Optional 내부의 값이 null인 경우 other을 반환</li>
</ul>
</li>
<li><strong>T orElseGet(Supplier&lt;? extends T&gt; supplier)</strong><ul>
<li>Optional 내부의 값이 있는 경우 그 값을 반환</li>
<li>Optional 내부의 값이 null인 경우 supplier을 실행한 값을 반환</li>
</ul>
</li>
<li><strong>T orElseThrow()</strong><ul>
<li>Optional 내부의 값이 있는 경우 그 값을 반환</li>
<li>Optional 내부의 값이 null인 경우 <code>NoSuchElementException</code> 발생</li>
</ul>
</li>
<li><strong>T orElseThrow(Supplier&lt;? extends X&gt; exceptionSupplier)</strong><ul>
<li>Optional 내부의 값이 있는 경우 그 값을 반환</li>
<li>Optional 내부의 값이 null인 경우 exceptionSupplier을 실행하여 Exception 발생</li>
</ul>
</li>
</ul>
<h1 id="Java8-이전의-코드"><a href="#Java8-이전의-코드" class="headerlink" title="Java8 이전의 코드"></a>Java8 이전의 코드</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">School</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> ClassRoom classRoom;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ClassRoom</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Teacher teacher;</span><br><span class="line">    <span class="keyword">private</span> List&lt;Student&gt; students;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Teacher</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> Subject subject;</span><br><span class="line">    <span class="keyword">private</span> String name;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Subject</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> String subjectName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>학교, 교실, 선생님, 과목이라는 클래스가 주루룩 있을 때 이 학교의 교실의 선생님의 과목을 반환하는 코드를 작성하면</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">school.getClassRoom().getTeacher().getSubject().getSubjectName();</span><br></pre></td></tr></table></figure>

<p>위와 같은 코드를 작성 할 수 있는데, 위와 같은 코드는 전혀 null-safe 하지 않은 코드가 된다.<br>그렇게 null처리를 추가해보면..</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(school != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="type">ClassRoom</span> <span class="variable">classRoom</span> <span class="operator">=</span> school.getClassRoom();</span><br><span class="line">    <span class="keyword">if</span>(classRoom != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="type">Teacher</span> <span class="variable">teacher</span> <span class="operator">=</span> classRoom.getTeacher();</span><br><span class="line">        <span class="keyword">if</span>(teacher != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> teacher.getSubject();</span><br><span class="line">            <span class="keyword">if</span>(subject != <span class="literal">null</span>) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">subjectName</span> <span class="operator">=</span> subject.getSubjectName();</span><br><span class="line">                <span class="keyword">return</span> subjectName;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>대충 위와 같은 if 지옥이 발생하게 된다. 조금 다듬어서..</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(school == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">ClassRoom</span> <span class="variable">classRoom</span> <span class="operator">=</span> school.getClassRoom();</span><br><span class="line"><span class="keyword">if</span>(classRoom == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Teacher</span> <span class="variable">teacher</span> <span class="operator">=</span> classRoom.getTeacher();</span><br><span class="line"><span class="keyword">if</span>(teacher == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">Subject</span> <span class="variable">subject</span> <span class="operator">=</span> teacher.getSubject();</span><br><span class="line"><span class="keyword">if</span>(subject == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> subject.getSubjectName();</span><br></pre></td></tr></table></figure>

<p>이정도로 바꿀 수 있겠지만, 만족스러운 코드는 아니다.</p>
<h1 id="Optional을-이용한-코드"><a href="#Optional을-이용한-코드" class="headerlink" title="Optional을 이용한 코드"></a>Optional을 이용한 코드</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Optional.ofNullable(school).map(School::getClassRoom)    <span class="comment">//Optional&lt;School&gt;</span></span><br><span class="line">                           .map(ClassRoom::getTeacher)   <span class="comment">//Optional&lt;ClassRoom&gt;</span></span><br><span class="line">                           .map(Teacher::getSubject)     <span class="comment">//Optional&lt;Teacher&gt;</span></span><br><span class="line">                           .map(Subject::getSubjectName) <span class="comment">//Optional&lt;Subject&gt;</span></span><br><span class="line">                           .orElse(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>map 메서드에서 null인 경우 empty Optional을 반환하기 때문에 NPE가 발생하지 않음</li>
<li>최후에 orElse 구문에서 Optional 내부의 값이 null인 경우 파라미터로 들어간 null을 반환하기 때문에<br>NPE에 안전하다.</li>
</ul>
<h1 id="Optional을-활용한-예제"><a href="#Optional을-활용한-예제" class="headerlink" title="Optional을 활용한 예제"></a>Optional을 활용한 예제</h1><h2 id="Optional을-사용하지-않은-예제"><a href="#Optional을-사용하지-않은-예제" class="headerlink" title="Optional을 사용하지 않은 예제"></a>Optional을 사용하지 않은 예제</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;E&gt;&gt; E <span class="title function_">max</span><span class="params">(Collection&lt;E&gt; c)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(c.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;빈 컬렉션&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">E</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span>(E e : c) &#123;</span><br><span class="line">        <span class="keyword">if</span>(result == <span class="literal">null</span> || e.compareTo(result) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            result = Objects.requiredNonNull(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Optional을-사용한-예제"><a href="#Optional을-사용한-예제" class="headerlink" title="Optional을 사용한 예제"></a>Optional을 사용한 예제</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;E&gt;&gt; Optional&lt;E&gt; <span class="title function_">max</span><span class="params">(Collection&lt;E&gt; c)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span>(c.isEmpty()) &#123;</span><br><span class="line">        <span class="keyword">return</span> Optional.empty();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="type">E</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">for</span>(E e : c) &#123;</span><br><span class="line">        <span class="keyword">if</span>(result == <span class="literal">null</span> || e.compareTo(result) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            result = Objects.requiredNonNull(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> Optional.of(result);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Optional을 반환하여 client에서 더욱 더 유연하게 로직을 작성할 수 있다.</li>
<li>Optional.of에 null을 넣으면 <code>NullPointerException</code> 이 발생하니 주의해야 한다.</li>
<li>Optional을 리턴하는 메서드에서는 null을 리턴해서는 안된다. (Optional의 취지와 맞지 않기 때문)</li>
</ul>
<h2 id="Stream을-이용한-버전"><a href="#Stream을-이용한-버전" class="headerlink" title="Stream을 이용한 버전"></a>Stream을 이용한 버전</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E <span class="keyword">extends</span> <span class="title class_">Comparable</span>&lt;E&gt;&gt; Optional&lt;E&gt; <span class="title function_">max</span><span class="params">(Collection&lt;E&gt; c)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> c.stream().max(Comparator.naturalOrder());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="왜-Optional을-사용해야-하는가"><a href="#왜-Optional을-사용해야-하는가" class="headerlink" title="왜 Optional을 사용해야 하는가?"></a>왜 Optional을 사용해야 하는가?</h1><p>기존 로직에서는 null을 반환하거나 예외를 던졌는데, Optional이 등장하고 나서는 Optional을 사용하는 것이 좋다고 한다.<br>그걸 구별하는 기준은 무엇일까?  Optional은 검사 예외와 취지가 비슷하다.<br>즉, 반환값이 있을 수도 있고, 없을 수도 있음을 API 사용자에게 명확히 알려준다.<br>만약 비검사 예외를 던지거나 null을 반환한다면 API 사용자가 그 사실을 인지하지 못해 런타임에서 예상치 못한 장애로 발전할 수 있다.<br>하지만 검사 예외(checked Exception)을 던지면 사용자 코드에서는 try-catch 구문을 통해 예외를 처리하는 로직을 추가해야 한다.<br>비슷하게, 메서드가 Optional을 반환한다면 클라이언트는 값을 받지 못했을 때의 취할 행동을 선택해야 한다.<br>그중 하나는 기본값을 설정하는 것이다.</p>
<h2 id="Optional-활용1-기본값-defalut-를-정해둘-수-있다"><a href="#Optional-활용1-기본값-defalut-를-정해둘-수-있다" class="headerlink" title="Optional 활용1 - 기본값(defalut)를 정해둘 수 있다."></a>Optional 활용1 - 기본값(defalut)를 정해둘 수 있다.</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">String</span> <span class="variable">lastWordInLexicon</span> <span class="operator">=</span> max(words).orElse(<span class="string">&quot;단어 없음..&quot;</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>실제로 예외를 던진 것이 아니라, empty Optional이 리턴되기 때문에<br>예외 생성 비용이 들지 않는다.</li>
</ul>
<h2 id="Optional-활용2-원하는-예외를-던질-수-있다"><a href="#Optional-활용2-원하는-예외를-던질-수-있다" class="headerlink" title="Optional 활용2 - 원하는 예외를 던질 수 있다."></a>Optional 활용2 - 원하는 예외를 던질 수 있다.</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Toy</span> <span class="variable">myToy</span> <span class="operator">=</span> max(toys).orElseThrow(TemperTantrumException::<span class="keyword">new</span>);</span><br></pre></td></tr></table></figure>

<ul>
<li>값이 없는 경우 원하는 예외를 던질 수 있다.</li>
</ul>
<h2 id="Optional-활용3-항상-값이-채워져-있는-경우"><a href="#Optional-활용3-항상-값이-채워져-있는-경우" class="headerlink" title="Optional 활용3 - 항상 값이 채워져 있는 경우"></a>Optional 활용3 - 항상 값이 채워져 있는 경우</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Element</span> <span class="variable">lastNobleGas</span> <span class="operator">=</span> max(Elements.NOBLE_GASES).get();</span><br></pre></td></tr></table></figure>

<ul>
<li>값이 없는 경우에는 NoSuchElementException이 발생하니 반드시 값이 있는 경우에만 사용해야 한다.</li>
</ul>
<h2 id="Optional-활용4-기본값을-설정하는-비용이-큰-경우"><a href="#Optional-활용4-기본값을-설정하는-비용이-큰-경우" class="headerlink" title="Optional 활용4 - 기본값을 설정하는 비용이 큰 경우"></a>Optional 활용4 - 기본값을 설정하는 비용이 큰 경우</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Connection</span> <span class="variable">connection</span> <span class="operator">=</span> getConnection(datasource).orElseGet(() -&gt; getLocalConnection());</span><br></pre></td></tr></table></figure>

<ul>
<li>기본값을 설정하는 비용이 아주 커서 부담이 되는 경우 orElseGet을 사용하면,<br>값이 처음 필요할 때 Supplier를 사용해 생성하므로 초기 생성비용을 낮출 수 있다.</li>
</ul>
<h1 id="Optional-안티-패턴"><a href="#Optional-안티-패턴" class="headerlink" title="Optional 안티 패턴"></a>Optional 안티 패턴</h1><h2 id="Collection-Stream-배열은-Optional로-감싸지-말자"><a href="#Collection-Stream-배열은-Optional로-감싸지-말자" class="headerlink" title="Collection, Stream, 배열은 Optional로 감싸지 말자"></a>Collection, Stream, 배열은 Optional로 감싸지 말자</h2><p>Optional&lt;List<T>&gt;를 반환하기 보다는 빈 ArrayList를 반환하는 것이 좋다. 그렇게 하면 클라이언트 코드에서 Optional 처리 코드를 넣지 않아도 된다.</p>
<h2 id="Optional을-Map의-키나-값으로-사용하지-말자"><a href="#Optional을-Map의-키나-값으로-사용하지-말자" class="headerlink" title="Optional을 Map의 키나 값으로 사용하지 말자"></a>Optional을 Map의 키나 값으로 사용하지 말자</h2><p>만약 Optional을 Map에서 사용한다면 모호한 상황이 발생한다. </p>
<ul>
<li>Key 자체가 없는 경우</li>
<li>Key는 있지만, 속이 빈 Optional인 경우</li>
</ul>
<p>쓸데없이 복잡도만 높아지게 되고 전혀 쓸모없는 짓이니 사용하지 말자.<br>일반화 하자면, <strong>Optional은 Collection의 키, 값, 원소나 배열의 원소로 사용하는게 적절한 상황은 거의 없다.</strong></p>
<h2 id="isPresent-를-사용하지-말자"><a href="#isPresent-를-사용하지-말자" class="headerlink" title="isPresent()를 사용하지 말자"></a>isPresent()를 사용하지 말자</h2><p>위에서 설명 했듯이 isPresent()는 Optional 객체 내부의 값이 있는경우 true, 없는 경우 false를 반환한다.<br>위의 학교예제를 잠시 따오면..</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(school.isPresent()) &#123;</span><br><span class="line">    Optional&lt;ClassRoom&gt; classRoom = school.getClassRoom();</span><br><span class="line">    <span class="keyword">if</span>(classRoom.isPresent()) &#123;</span><br><span class="line">        Optional&lt;Teacher&gt; teacher = classRoom.getTeacher();</span><br><span class="line">        <span class="keyword">if</span>(teacher.isPresent()) &#123;</span><br><span class="line">            Optional&lt;Subject&gt; subject = teacher.getSubject();</span><br><span class="line">            <span class="keyword">if</span>(subject.isPresent()) &#123;</span><br><span class="line">                <span class="type">String</span> <span class="variable">subjectName</span> <span class="operator">=</span> subject.getSubjectName();</span><br><span class="line">                <span class="keyword">return</span> subjectName;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">return</span> <span class="literal">null</span>;</span><br></pre></td></tr></table></figure>

<p>이와 같이 사용 될 수 있다.  기존의 if 지옥과 별 다를게 없는 로직이며, Optional의 취지를 제대로 이해하지 못한 로직이다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Optional.ofNullable(school).map(School::getClassRoom)    <span class="comment">//Optional&lt;School&gt;</span></span><br><span class="line">                           .map(ClassRoom::getTeacher)   <span class="comment">//Optional&lt;ClassRoom&gt;</span></span><br><span class="line">                           .map(Teacher::getSubject)     <span class="comment">//Optional&lt;Teacher&gt;</span></span><br><span class="line">                           .map(Subject::getSubjectName) <span class="comment">//Optional&lt;Subject&gt;</span></span><br><span class="line">                           .orElse(<span class="literal">null</span>);</span><br></pre></td></tr></table></figure>

<p>반드시 이런식으로 사용하도록 하는 것이 좋겠다.</p>
<h1 id="추가-내용"><a href="#추가-내용" class="headerlink" title="추가 내용"></a>추가 내용</h1><ul>
<li>박싱된 기본타입을 사용할 때에는 OptionalInt, OptionalDouble, OptionalLong을 사용하자<ul>
<li>박싱된 기본타입을 담는 Optional은 기본타입 보다 무거울 수 밖에 없다. </li>
<li>따라서 OptionalInt, OptionalDouble, OptionalLong을 사용하는 것이 조금 더 낫다.</li>
</ul>
</li>
<li>값을 반환하지 못할 가능성이 있고, 호출할 때마다 반환값이 없을 가능성을 염두에 둬야 하는 메서드라면<br> Optional을 반환해야 하는 상황일 수 있다.</li>
<li>Optional을 반환값 이외의 용도로 쓰는 경우는 거의 없다.</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 55. 옵셔널 반환은 신중히 하라</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/02/20/2019-02-20-mongodb-1/">Mongo DB 기본쿼리</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-02-20</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/MongoDB/">MongoDB</a></span><div class="content"><h1 id="MongoDB-CRUD-Operation"><a href="#MongoDB-CRUD-Operation" class="headerlink" title="MongoDB CRUD Operation"></a>MongoDB CRUD Operation</h1><p>Mongo DB는 Create, Read, Update, Delete Operation을 제공합니다.</p>
<h2 id="DDL-SQL-vs-Mongo-DB"><a href="#DDL-SQL-vs-Mongo-DB" class="headerlink" title="DDL SQL vs Mongo DB"></a>DDL SQL vs Mongo DB</h2><p><img src="./create_sql_vs_mongo.png" alt="create_sql_vs_mongo"></p>
<p><img src="./create_sql_vs_mongo_2.png" alt="create_sql_vs_mongo_2"></p>
<h1 id="Create-Operations"><a href="#Create-Operations" class="headerlink" title="Create Operations"></a>Create Operations</h1><p>Create, Insert Operation은 컬렉션(Collection)에 도큐먼트(Documents)를 삽입합니다.<br>만약 컬렉션이 아직 존재하지 않는다면, 도큐먼트 삽입과 동시에 컬렉션이 생성됩니다.</p>
<p>Mongo DB는 아래와 같은 도큐먼트 삽입을 위한 메서드를 제공합니다.</p>
<ul>
<li>db.collection.insertOne() <strong>(collection 자리에 실제 collection명을 기재)</strong></li>
<li>db.collection.insertMany()</li>
</ul>
<p>모든 Mongo DB의 삽입 연산은 단일 컬렉션을 대상으로 하며, 모든 쓰기 작업은 단일 도큐먼트에 대해 원자적입니다.</p>
<p><img src="./insertOne.svg" alt="insertOne"></p>
<h2 id="Insert-SQL-vs-Mongo-DB-Insert"><a href="#Insert-SQL-vs-Mongo-DB-Insert" class="headerlink" title="Insert SQL vs Mongo DB Insert"></a>Insert SQL vs Mongo DB Insert</h2><p><img src="./insert_sql_vs_mongo.png" alt="insert_sql_vs_mongo"></p>
<h1 id="Read-Operations"><a href="#Read-Operations" class="headerlink" title="Read Operations"></a>Read Operations</h1><p>읽기 작업(Read Operations)는 컬렉션에서 도큐먼트(Documents)를 검색합니다. (컬렉션을 쿼리하여 문서를 조회)<br>Mongo DB는 아래와 같은 도큐먼트 조회를 위한 메서드를 제공합니다.</p>
<ul>
<li>db.collection.find() <strong>(collection 자리에 실제 collection명을 기재)</strong></li>
</ul>
<p>Mongo DB 쿼리 간 filter와 조건을 통해 특정한 도큐먼트를 조회할 수 있습니다.<br><img src="./read-query.svg" alt="read-query"></p>
<p>위의 쿼리는 SQL로 표현한다면 아래와 같습니다.</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">SELECT</span> name, address</span><br><span class="line"><span class="keyword">FROM</span> users</span><br><span class="line"><span class="keyword">WHERE</span> age <span class="operator">&gt;</span> <span class="number">18</span></span><br><span class="line">LIMIT <span class="number">5</span></span><br></pre></td></tr></table></figure>



<h2 id="Select-SQL-vs-Mongo-DB-Read"><a href="#Select-SQL-vs-Mongo-DB-Read" class="headerlink" title="Select SQL vs Mongo DB Read"></a>Select SQL vs Mongo DB Read</h2><p><img src="./read_sql_vs_mongo.png" alt="read_sql_vs_mongo"></p>
<p><img src="./read_sql_vs_mongo2.png" alt="read_sql_vs_mongo2"></p>
<p><img src="./read_sql_vs_mongo3.png" alt="read_sql_vs_mongo3"></p>
<h1 id="Update-Operations"><a href="#Update-Operations" class="headerlink" title="Update Operations"></a>Update Operations</h1><p>수정 작업 (Update Operations)은 컬렉션 내에 존재하는 도큐먼트를 수정합니다.<br>Mongo DB는 컬렉션 내의 도큐먼트 수정을 위해 아래와 같은 메서드를 제공합니다. </p>
<ul>
<li>db.collection.updateOne() <strong>(collection 자리에 실제 collection명을 기재)</strong></li>
<li>db.collection.updateMany()</li>
<li>db.collection.replaceOne()</li>
</ul>
<p>Mongo DB에서는 단일 컬렉션을 대상으로 update operation을 지원합니다.<br>Mongo DB 내의 모든 쓰기 작업은 단일 도큐먼트 레벨에서 원자적입니다.</p>
<p><img src="./update-query.svg" alt="update-query"></p>
<h2 id="Update-SQL-vs-Mongo-DB-Update"><a href="#Update-SQL-vs-Mongo-DB-Update" class="headerlink" title="Update SQL vs Mongo DB Update"></a>Update SQL vs Mongo DB Update</h2><p><img src="./update_sql_vs_mongo.png" alt="update_sql_vs_mongo"></p>
<h1 id="Delete-Operations"><a href="#Delete-Operations" class="headerlink" title="Delete Operations"></a>Delete Operations</h1><p>삭제 작업 (Delete Operations)은 컬렉션 내의 도큐먼트를 삭제합니다.<br>Mongo DB는 컬렉션 내의 도큐먼트 삭제를 위해 아래와 같은 메서드를 제공합니다.</p>
<ul>
<li>db.collection.deleteOne() <strong>(collection 자리에 실제 collection명을 기재)</strong></li>
<li>db.collection.deleteMany()</li>
</ul>
<p>Mongo DB에서의 삭제 작업은 단일 Collection을 대상으로 합니다.<br>Mongo DB 내의 모든 쓰기 작업은 단일 도큐먼트 레벨에서 원자적입니다.</p>
<p>특정 filter나 조건을 주어 특정한 도큐먼트를 삭제 할 수 있습니다. (Read Operation과 비슷)</p>
<p><img src="./delete-query.svg" alt="delete-query"></p>
<h2 id="Delete-SQL-vs-Mongo-DB-Delete"><a href="#Delete-SQL-vs-Mongo-DB-Delete" class="headerlink" title="Delete SQL vs Mongo DB Delete"></a>Delete SQL vs Mongo DB Delete</h2><p><img src="./delete_sql_vs_mongo.png" alt="delete_sql_vs_mongo"></p>
<h1 id="Spring-Data-MongoDB를-이용한-CRUD"><a href="#Spring-Data-MongoDB를-이용한-CRUD" class="headerlink" title="Spring Data MongoDB를 이용한 CRUD"></a>Spring Data MongoDB를 이용한 CRUD</h1><p>Spring에서 Mongo DB 연동 시에는 spring-data에서 제공하는 spring-data-mongodb를 이용하는게 가장 편리합니다.</p>
<h1 id="Maven-설정"><a href="#Maven-설정" class="headerlink" title="Maven 설정"></a>Maven 설정</h1><h2 id="spring-data-mongodb-dependency-추가"><a href="#spring-data-mongodb-dependency-추가" class="headerlink" title="spring-data-mongodb dependency 추가"></a>spring-data-mongodb dependency 추가</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-data-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>2.1.1.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="Mongo-DB-QueryDsl-Dependency-추가"><a href="#Mongo-DB-QueryDsl-Dependency-추가" class="headerlink" title="Mongo DB QueryDsl Dependency 추가"></a>Mongo DB QueryDsl Dependency 추가</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.querydsl<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>querydsl-mongodb<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>4.2.1<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line"> </span><br></pre></td></tr></table></figure>
<h2 id="Document-class-Build-Plugin-설정"><a href="#Document-class-Build-Plugin-설정" class="headerlink" title="Document class Build Plugin 설정"></a>Document class Build Plugin 설정</h2><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mysema.maven<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>apt-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.1.3<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">executions</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>jpa-processor<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>process<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>target/generated-sources/java<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">processor</span>&gt;</span>com.querydsl.apt.jpa.JPAAnnotationProcessor<span class="tag">&lt;/<span class="name">processor</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">execution</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>mongodb-processor<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">goals</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">goal</span>&gt;</span>process<span class="tag">&lt;/<span class="name">goal</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">goals</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">outputDirectory</span>&gt;</span>target/generated-sources/java<span class="tag">&lt;/<span class="name">outputDirectory</span>&gt;</span></span><br><span class="line">                <span class="tag">&lt;<span class="name">processor</span>&gt;</span>org.springframework.data.mongodb.repository.support.MongoAnnotationProcessor<span class="tag">&lt;/<span class="name">processor</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">execution</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">executions</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br></pre></td></tr></table></figure>





<h2 id="Entity-생성"><a href="#Entity-생성" class="headerlink" title="Entity 생성"></a>Entity 생성</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> by Carrey on 2019-02-20</span></span><br><span class="line"><span class="comment"> * Employee Test</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="meta">@Setter</span></span><br><span class="line"><span class="meta">@Getter</span></span><br><span class="line"><span class="meta">@AllArgsConstructor</span></span><br><span class="line"><span class="meta">@Document(collection = &quot;employee&quot;)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Employee</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Id</span></span><br><span class="line">	<span class="keyword">private</span> <span class="type">int</span> id;</span><br><span class="line">	<span class="keyword">private</span> String ename;</span><br><span class="line">	<span class="keyword">private</span> String job;</span><br><span class="line">	<span class="keyword">private</span> Integer mgrId;</span><br><span class="line">    	<span class="meta">@Indexed</span></span><br><span class="line">	<span class="keyword">private</span> LocalDate hiredate;</span><br><span class="line">	<span class="keyword">private</span> <span class="type">long</span> sal;</span><br><span class="line">	<span class="keyword">private</span> Long commision;</span><br><span class="line">    	<span class="meta">@Indexed</span></span><br><span class="line">	<span class="keyword">private</span> Integer deptId;</span><br><span class="line">	<span class="keyword">private</span> String deptName;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">raiseSalary</span><span class="params">(DoubleFunction&lt;Long&gt; raiseFormula)</span> &#123;</span><br><span class="line">		<span class="built_in">this</span>.sal = raiseFormula.apply(<span class="built_in">this</span>.sal);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><strong>@Document</strong> : Class가 Mongo DB Document라는 의미를 지정 (collection 속성에 collection 명 지정)</li>
<li><strong>@Id</strong> : Document내의 ID지정 (_id 필드에 해당 값이 매핑)<br>(주의! <code>org.springframework.data.annotation.Id</code>를 import 해야함)</li>
<li>JPA에서는 @Entity 클래스의 ID설정이 무조건 필요했지만, Mongo DB는 선택적으로 @Id지정 가능<br>(@Id를 지정하지 않으면 도큐먼트에 <code>ObjectId라는 키가 자동으로 생성됨</code>)</li>
<li><strong>@Indexed</strong> : Collection Index를 지정 (단일인덱스 여러개 지정가능)<br>(복합 인덱스도 있으나 일단 기술하지 않음)</li>
</ul>
<h2 id="Repository-생성"><a href="#Repository-생성" class="headerlink" title="Repository 생성"></a>Repository 생성</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@Author</span> by Carrey on 2019-02-20</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">EmployeeMongoRepository</span> <span class="keyword">extends</span> <span class="title class_">MongoRepository</span>&lt;Employee, Integer&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="MongoRepository-lt-T-ID-gt-에서-제공하는-메서드"><a href="#MongoRepository-lt-T-ID-gt-에서-제공하는-메서드" class="headerlink" title="MongoRepository&lt;T ,ID&gt;에서 제공하는 메서드"></a>MongoRepository&lt;T ,ID&gt;에서 제공하는 메서드</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">/** CRUDRepository.saveAll */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; List&lt;S&gt; <span class="title function_">saveAll</span><span class="params">(Iterable&lt;S&gt; entities)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** CRUDRepository.findAll */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">List&lt;T&gt; <span class="title function_">findAll</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** CRUDRepository.findAll */</span></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">List&lt;T&gt; <span class="title function_">findAll</span><span class="params">(Sort sort)</span>;</span><br><span class="line"></span><br><span class="line">&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; S <span class="title function_">insert</span><span class="params">(S entity)</span>;</span><br><span class="line"></span><br><span class="line">&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; List&lt;S&gt; <span class="title function_">insert</span><span class="params">(Iterable&lt;S&gt; entities)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; List&lt;S&gt; <span class="title function_">findAll</span><span class="params">(Example&lt;S&gt; example)</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Override</span></span><br><span class="line">&lt;S <span class="keyword">extends</span> <span class="title class_">T</span>&gt; List&lt;S&gt; <span class="title function_">findAll</span><span class="params">(Example&lt;S&gt; example, Sort sort)</span>;</span><br></pre></td></tr></table></figure>



<h2 id="QueryDsl을-이용한-Read-Operations"><a href="#QueryDsl을-이용한-Read-Operations" class="headerlink" title="QueryDsl을 이용한 Read Operations"></a>QueryDsl을 이용한 Read Operations</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Repository</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">EmployeeRepository</span> <span class="keyword">extends</span> <span class="title class_">QuerydslRepositorySupport</span> &#123;</span><br><span class="line"></span><br><span class="line">	<span class="meta">@Autowired</span></span><br><span class="line">	<span class="keyword">private</span> MongoTemplate mongoTemplate;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/**</span></span><br><span class="line"><span class="comment">	 * Creates a new &#123;<span class="doctag">@link</span> QuerydslRepositorySupport&#125; for the given &#123;<span class="doctag">@link</span> MongoOperations&#125;.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * <span class="doctag">@param</span> operations must not be &#123;<span class="doctag">@literal</span> null&#125;.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">public</span> <span class="title function_">EmployeeRepository</span><span class="params">(MongoOperations operations)</span> &#123;</span><br><span class="line">		<span class="built_in">super</span>(operations);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">    	<span class="comment">//2000$가 넘는 고액 연봉자 조회 쿼리</span></span><br><span class="line">	<span class="keyword">public</span> List&lt;Employee&gt; <span class="title function_">getCoreEmployees</span><span class="params">()</span> &#123;</span><br><span class="line"></span><br><span class="line">		<span class="type">QEmployee</span> <span class="variable">qEmployee</span> <span class="operator">=</span> QEmployee.employee;</span><br><span class="line">		List&lt;Employee&gt; coreEmployees = from(qEmployee).where(qEmployee.sal.gt(<span class="number">2000L</span>))</span><br><span class="line">							      .fetch();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">return</span> coreEmployees;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>queryDsl 방식의 장점<ul>
<li>Spring-data 패키지의 메서드를 그대로 쓰기 때문에 JPA에서 사용하던 쿼리와 똑같다.</li>
</ul>
</li>
<li>queryDsl 방식의 단점<ul>
<li>@Document class를 mongodb-processor를 이용하여 Q클래스로 만들어야 한다.</li>
<li>Aggregation pipeline을 지원하지 않는다. (가장 큰 단점)</li>
</ul>
</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li><a target="_blank" rel="noopener" href="https://docs.mongodb.com/master/crud/">https://docs.mongodb.com/master/crud/</a></li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/02/17/effective-java-item48/">Item 48. 스트림 병렬화는 주의해서 적용하라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-02-17</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>주류 언어 중, 동시성 프로그래밍 측면에서는 항상 자바는 앞서왔다.<br>처음 릴리즈된 1996년부터 스레드, 동기화, wait&#x2F;notify를 지원했다. </p>
<ul>
<li>자바 5부터는 동시성 컬렉션인 java.util.concurrent 라이브러리와 실행자(Excutor) 프레임워크를 지원했다. </li>
<li>자바 7부터는 고성능 병렬 분해(parallel decom-position) 프레임워크인 fork-join 패키지를 추가했다.<br>(Fork-join pool에 대한 설명은 <a target="_blank" rel="noopener" href="https://okky.kr/article/345720">https://okky.kr/article/345720</a> 여기 참고)  </li>
<li>자바 8부터는 parallel 메서드만 한 번 호출하면 파이프라인을 병렬 실행할 수 있는 Stream을 지원했다.</li>
</ul>
<p>자바로 동시성 프로그램을 작성하기가 점점 쉬워지고 있지만, 이를 올바르고 빠르게 작성하는 일은 어렵다.<br>동시성 프로그래밍을 할 때는 안전성(safety)과 응답 가능(liveness) 상태를 유지하기 애써야 한다.<br>병렬 스트림 파이프라인 프로그래밍에서도 다를 바 없다.</p>
<h1 id="파이프라인-병렬화가-불가능-한-경우-성능-개선이-되지-않는다"><a href="#파이프라인-병렬화가-불가능-한-경우-성능-개선이-되지-않는다" class="headerlink" title="파이프라인 병렬화가 불가능 한 경우 성능 개선이 되지 않는다."></a>파이프라인 병렬화가 불가능 한 경우 성능 개선이 되지 않는다.</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RunWith(SpringRunner.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MersenPrimeTest</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test1</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        primes().map(p -&gt; TWO.pow(p.intValueExact()).subtract(ONE))</span><br><span class="line">                .filter(mersenne -&gt; mersenne.isProbablePrime(<span class="number">50</span>))</span><br><span class="line">                .limit(<span class="number">20</span>)</span><br><span class="line">                .forEach(System.out::println);</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;running time : &quot;</span> + (end - start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Test</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">test2</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="type">long</span> <span class="variable">start</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        primes().parallel().map(p -&gt; TWO.pow(p.intValueExact()).subtract(ONE))</span><br><span class="line">                .filter(mersenne -&gt; mersenne.isProbablePrime(<span class="number">50</span>))</span><br><span class="line">                .limit(<span class="number">20</span>)</span><br><span class="line">                .forEach(System.out::println);</span><br><span class="line">        <span class="type">long</span> <span class="variable">end</span> <span class="operator">=</span> System.currentTimeMillis();</span><br><span class="line">        System.out.println(<span class="string">&quot;running time : &quot;</span> + (end - start));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">static</span> Stream&lt;BigInteger&gt; <span class="title function_">primes</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Stream.iterate(TWO, BigInteger::nextProbablePrime);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>스트림을 이용한 처음 20개의 메르센 소수를 생성하는 프로그램이다.<br>이 프로그램을 실행 시켜보니 test1은 8.2초 정도의 수행시간을 보여줬다<br>test2는 stream의 성능을 향상시켜보고자 parallel()을 호출했다.<br>하지만 메르센 소수의 값이 프린트 되지 않았고, 강제로 중지 하기 전까지 계속 돌고 있었다.<br>아무것도 안된 원인은 stream 라이브러리가 이 파이프라인을 병렬화 하는 방법을 찾아내지 못했기 때문이다.  </p>
<ul>
<li>데이터 소스가 Stream.iterate인 경우</li>
<li>중간 연산으로 limit()를 사용하는 경우<br>위 두 가지 경우에는 파이프라인 병렬화로 성능 향상을 기대하기 어렵다.<br>뿐만 아니라 파이프라인 병렬화는 limit를 다룰 때 <strong>CPU 코어가 남는다면, 원소를 몇 개 더 처리한 후 제한된 개수 이후의 결과를 버려도 아무런 해가 없다고 가정한다.</strong></li>
</ul>
<p>따라서 스트림 파이프라인을 마구잡이로 병렬화 해선 안된다. 성능이 오히려 더 나빠질 수 있다.</p>
<h1 id="언제-병렬화를-사용하나"><a href="#언제-병렬화를-사용하나" class="headerlink" title="언제 병렬화를 사용하나?"></a>언제 병렬화를 사용하나?</h1><ul>
<li><p>ArrayList</p>
</li>
<li><p>HashMap</p>
</li>
<li><p>HashSet</p>
</li>
<li><p>ConcurrentHashMap</p>
</li>
<li><p>배열(Array)</p>
</li>
<li><p>int&#x2F;long 범위</p>
</li>
</ul>
<p>스트림의 데이터 소스가 위와 같은 클래스의 인스턴스 일 때 병렬화의 효과가 가장 좋다.<br>위 자료구조들은 모두 데이터를 원하는 크기로 정확하고 손쉽게 나눌 수 있어 다수의 스레드에 분배하기에 좋다.<br>나누는 작업은 <strong>Spliterator</strong>가 담당하며, Spliterator 객체는 Stream, Iterable의 spliterator() 메서드로 얻어올 수 있다.</p>
<p>또한 위의 자료구조는 <strong>참조 지역성(locality of reference)</strong> 이 높아 성능이 좋다.</p>
<h1 id="참조-지역성-Locality-of-Reference"><a href="#참조-지역성-Locality-of-Reference" class="headerlink" title="참조 지역성 (Locality of Reference)"></a>참조 지역성 (Locality of Reference)</h1><p><img src="./locality.PNG" alt="locality"></p>
<p>만일 캐시(Cache)가 어떤 별도의 알고리즘 없이 중간 매개체로만 사용된다면,<br>CPU가 Cache에서 데이터를 읽고 쓰는 속도나 메인 메모리에서 읽고 쓰는 속도나 마찬가지가 될 것이다.  </p>
<p>캐시 메모리가 제 역할을 하는 것은 데이터의 지역성(locality)를 이용하기 때문.<br>데이터의 지역성은 다음의 세가지로 분류</p>
<ul>
<li>공간적 지역성 (partial locality) <ul>
<li>메인메모리에서 CPU가 요청한 주소지점의 데이터에 인접한 주소들이 앞으로 참조될 확률이 높음을 의미</li>
<li>이웃한 원소들의 참조가 메모리에 연속적으로 저장되어 있어 다음 참조에 대한 접근 속도가 빠르게 함</li>
</ul>
</li>
<li>시간적 지역성 (temporal locality)<ul>
<li>한번 참조되었던 데이터는 후에 다시 참조될 가능성이 높음을 의미</li>
</ul>
</li>
<li>순차적 지역성 (sequential locality)<ul>
<li>따로 분기가 없는 한 데이터가 기억장치에 저장된 순서대로 인출되고 실행될 가능성이 높음을 의미 (FIFO)</li>
</ul>
</li>
</ul>
<h1 id="스트림-파이프라인의-종단-연산"><a href="#스트림-파이프라인의-종단-연산" class="headerlink" title="스트림 파이프라인의 종단 연산"></a>스트림 파이프라인의 종단 연산</h1><p>스트림 파이프라인의 종단연산의 동작방식 역시 병렬 수행 효율에 영향을 준다.<br>종단 연산 중 병렬화에 가장 적합한 것은 축소(reduction)이다.<br>축소는 파이프라인에서 만들어진 모든 원소를 하나로 합치는 작업이다.<br>예를 들면 min, max, sum, count 같이 완성된 형태로 제공되는 메서드가 있다.<br>anyMatch, allMatch, noneMatch처럼 조건에 맞음년 바로 반환되는 메서드도 병렬화에 적합하다.</p>
<p>반면, 가변 축소(Mutable Reduction)을 수행하는 Stream의 collect 메서드는 병렬화에 적합하지 않다.<br>컬렉션들을 합치는 부담이 크기 때문이다.</p>
<h1 id="병렬화에-대해-잘모르면-안하는게-낫다"><a href="#병렬화에-대해-잘모르면-안하는게-낫다" class="headerlink" title="병렬화에 대해 잘모르면 안하는게 낫다"></a>병렬화에 대해 잘모르면 안하는게 낫다</h1><p>스트림을 잘못 병렬화하면 (응답 불가를 포함해) 성능이 나빠질 뿐만 아니라 결과 자체가 잘못되거나 예상 못한 동작이 발생할 수 있다.<br>(결과가 잘못되거나 오동작하는 것은 <strong>안전 실패(safety failure)</strong> 이라 한다.)<br>안전 실패는 병렬화한 파이프라인이 사용하는 mappers, filters 혹은 프로그래머가 제공한 다른 함수 객체가 명시한대로 동작하지 않을 때 발생할 수 있다.</p>
<p>Stream 명세는 이때 사용되는 함수 객체에 관한 엄중한 규약을 정의해놨다.</p>
<h2 id="Stream-명세는-함수-객체에-대한-규약"><a href="#Stream-명세는-함수-객체에-대한-규약" class="headerlink" title="Stream 명세는 함수 객체에 대한 규약"></a>Stream 명세는 함수 객체에 대한 규약</h2><ol>
<li>Stream의 reduce 연산에 건네지는 accumulator(누적기)와 combiner(결합기) 함수는 반드시 <strong>결합법칙</strong>을 만족해야 한다.<br>(결합 법칙 : (a op b) op c &#x3D; a op (b op c))</li>
<li>간섭받지 않아야 한다 (non-interfering) - 파이프라인이 수행되는 동안 <strong>데이터소스가 변경되지 않아야한다.</strong></li>
<li>상태를 갖지 않아야 한다 (stateless)<br>위의 요구사항을 지키지 못하더라도 순차적으로 실행하면 올바른 결과를 얻을 수 있다.<br>하지만 병렬로 수행하면 기대한 결과가 나오지 않을 수 있고, 실패할 수 있으니 주의해야 한다.</li>
</ol>
<h1 id="스트림-병렬화는-오직-성능-최적화-수단임을-기억하라"><a href="#스트림-병렬화는-오직-성능-최적화-수단임을-기억하라" class="headerlink" title="스트림 병렬화는 오직 성능 최적화 수단임을 기억하라"></a>스트림 병렬화는 오직 성능 최적화 수단임을 기억하라</h1><p>다른 최적화와 마찬가지로 변경 전후로 반드시 성능테스트를 진행하여 병렬화를 사용할 가치가 있는지 확인해야 한다.<br>이상적으로는 운영 시스템과 같은 환경에서 테스트하는 것이 좋다.<br>보통은 병렬 스트림 파이프라인도 공통의 포크-조인 풀에서 수행되므로 (같은 스레드 풀을 사용)<br>잘못된 파이프라인 하나가 다른 부분의 성능에까지 악영향을 줄 수 있음을 유념하자<br>조건이 잘 갖춰지면 parallel 메서드 호출 하나로 거의 프로세서 코어 수에 비례하는 성능 향상을 볼 수 있다.</p>
<h1 id="스트림-파이프라인-병렬화가-효과적인-예"><a href="#스트림-파이프라인-병렬화가-효과적인-예" class="headerlink" title="스트림 파이프라인 병렬화가 효과적인 예"></a>스트림 파이프라인 병렬화가 효과적인 예</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">long</span> <span class="title function_">pi</span><span class="params">(<span class="type">long</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> LongStream.rangeClosed(<span class="number">2</span>, n)</span><br><span class="line">                     .mapToObj(BigInteger::valueOf)</span><br><span class="line">                     .filter(i -&gt; i.isProbablePrime(<span class="number">50</span>))</span><br><span class="line">                     .count();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="type">long</span> <span class="title function_">pi</span><span class="params">(<span class="type">long</span> n)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> LongStream.rangeClosed(<span class="number">2</span>, n)</span><br><span class="line">                     .parallel()</span><br><span class="line">                     .mapToObj(BigInteger::valueOf)</span><br><span class="line">                     .filter(i -&gt; i.isProbablePrime(<span class="number">50</span>))</span><br><span class="line">                     .count();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>𝛑(n) : n 보다 작거나 같은 소수의 개수를 계산하는 함수</li>
<li>책에서는 위의 함수를 실행하는데 31초, 아래 parallel()이 추가된 함수를 실행하는데 9.2초가 걸렸다고 한다.</li>
</ul>
<h1 id="Random한-수의-경우"><a href="#Random한-수의-경우" class="headerlink" title="Random한 수의 경우"></a>Random한 수의 경우</h1><p>무작위 수들로 이뤄진 스트림을 병렬화하려거든 ThreadLocalRandom(혹은 Random) 보다는<br>SplittableRandom 인스턴스를 이용하자. SplittableRandom은 정확히 이럴 때 쓰고자 설계된 것이라<br>병렬화 하면 성능이 선형으로 증가한다. 한편 ThreadLocalRandom은 단일 스레드에서 사용하고자 만들어 졌다.<br>병렬로 사용하는 경우에는 SplittableRandom &gt; SplittableRandom 성능을 보인다.  </p>
<p>그냥 Random의 경우에는 모든 연산을 동기화하기 때문에 병렬 처리하면 최악의 성능을 보일 것이다.</p>
<h1 id="요약"><a href="#요약" class="headerlink" title="요약"></a>요약</h1><ul>
<li>계산도 올바로 수행하고 성능도 빨라질거라는 확신 없이는 스트림 파이프라인 병렬화는 시도조차 하지 말자</li>
<li>스트림 병렬화를 잘못하면 프로그램이 오동작하거나 성능이 급격히 떨어질 수 있다.</li>
<li>병렬화를 할 경우에는 성능테스트를 반드시 진행하고, 결과가 정확한지 확인해야 한다.</li>
<li>계산도 정확하고 성능도 좋아졌음이 확실할 때, 그럴 때만 병렬화 버전을 운영 코드에 반영하라</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 48. 스트림 병렬화는 주의해서 적용하라</li>
<li><a target="_blank" rel="noopener" href="https://okky.kr/article/345720">Thread pool과 ForkJoinPool</a></li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/02/16/effective-java-item47/">Item 47. 반환 타입으로는 스트림보다 컬렉션이 낫다</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-02-16</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Array형태의 Linear한 자료구조를 반환하는 메서드는 수없이 많다.<br>이런 메서드의 반환타입으로 아래와 같은 타입을 사용했다.</p>
<ul>
<li>Collection<E>, Set<E>, List<E>와 같은 컬렉션 인터페이스</li>
<li>E[]와 같은 배열</li>
<li>Iterable<E> 인터페이스</li>
</ul>
<p>기본은 Collection<E> 타입이다.<br>for-each 문에서만 쓰이거나, (contain(Object) 같은) 일부 Collection 메서드를 구현 할 수 없을 때는 Iterable 인터페이스를 사용한다.<br>성능에 민감한 상황이면, E[] 형태의 배열을 주로 사용해 왔다. </p>
<p>자바 8이 스트림이라는 개념을 들고오면서 선택이 더욱 복잡해지게 되었다.</p>
<h1 id="Stream은-반복-loop-을-지원하지-않는다"><a href="#Stream은-반복-loop-을-지원하지-않는다" class="headerlink" title="Stream은 반복(loop)을 지원하지 않는다."></a>Stream은 반복(loop)을 지원하지 않는다.</h1><p>Stream은 반복을 지원하지 않는다.<br>다라서 Stream과 반복을 알맞게 조합해야 좋은 코드가 나온다.<br>API를 Stream만 사용하도록 하면 for-each를 사용하고자 하는 개발자는 불편을 겪을 것이다.<br>(Stream은 Iterator 인터페이스가 정의한 추상메서드를 포함하고 있다. 하지만, Iterator를 확장하진 않아 for-each로 반복하지 못한다.)</p>
<h2 id="API에서-Stream만-반환하는-경우"><a href="#API에서-Stream만-반환하는-경우" class="headerlink" title="API에서 Stream만 반환하는 경우"></a>API에서 Stream만 반환하는 경우</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* Returns a snapshot of all processes visible to the current process.</span></span><br><span class="line"><span class="comment">* &lt;p&gt;</span></span><br><span class="line"><span class="comment">* &lt;em&gt;Note that processes are created and terminate asynchronously. There</span></span><br><span class="line"><span class="comment">* is no guarantee that a process in the stream is alive or that no other</span></span><br><span class="line"><span class="comment">* processes may have been created since the inception of the snapshot.</span></span><br><span class="line"><span class="comment">* &lt;/em&gt;</span></span><br><span class="line"><span class="comment">*</span></span><br><span class="line"><span class="comment">* <span class="doctag">@return</span> a Stream of ProcessHandles for all processes</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> SecurityException if a security manager has been installed and</span></span><br><span class="line"><span class="comment">*         it denies RuntimePermission(&quot;manageProcess&quot;)</span></span><br><span class="line"><span class="comment">* <span class="doctag">@throws</span> UnsupportedOperationException if the implementation</span></span><br><span class="line"><span class="comment">*         does not support this operation</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">static</span> Stream&lt;ProcessHandle&gt; <span class="title function_">allProcesses</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> ProcessHandleImpl.children(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ProcessHandle ph : ProcessHandle.allProcesses()::iterator) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위의 코드는 자바 타입추론의 한계로 컴파일되지 않는다.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Test.java:6 error: method reference not expected here</span><br><span class="line">for (ProcessHandle ph : ProcessHandle.allProcesses()::iterator) &#123;</span><br><span class="line">                        ^</span><br></pre></td></tr></table></figure>

<p>이 오류를 바로 잡으려면 메서드 참조를 매개변수화된 Iterable로 적절히 형변환 해줘야 한다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(ProcessHandle ph : (Iterable&lt;ProcessHandle&gt;) ProcessHandle.allProcesses().iterator()) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>책에서는 이런식으로 억지로 형변환을 하면, 작동은 한다고 한다.<br>(하지만 실제로 코드를 실행해 본 결과 <code>ClassCastException</code>이 발생하였다.)</p>
<h3 id="Stream-lt-E-gt-를-Iterable-lt-E-gt-로-중개해주는-어댑터"><a href="#Stream-lt-E-gt-를-Iterable-lt-E-gt-로-중개해주는-어댑터" class="headerlink" title="Stream&lt;E&gt;를 Iterable&lt;E&gt;로 중개해주는 어댑터"></a>Stream<code>&lt;</code>E<code>&gt;</code>를 Iterable<code>&lt;</code>E<code>&gt;</code>로 중개해주는 어댑터</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; Iterable&lt;E&gt; <span class="title function_">iterableOf</span><span class="params">(Stream&lt;E&gt; stream)</span> &#123;</span><br><span class="line">	<span class="keyword">return</span> stream::iterator;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (ProcessHandle ph : iterableOf(ProcessHandle.allProcesses()) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>iterableOf 메서드를 통해 명시적으로 Iterable으로 반환할 수 있다.</p>
<h2 id="API에서-Iterator만-반환하는-경우"><a href="#API에서-Iterator만-반환하는-경우" class="headerlink" title="API에서 Iterator만 반환하는 경우"></a>API에서 Iterator만 반환하는 경우</h2><p>API에서 Iterator만 반환하는 경우에도 Stream 코드가 편한 개발자들은 불편을 겪을 수 있다.<br>자바는 Iterator -&gt; Stream을 위한 어댑터를 제공하지 않지만, 손쉽게 구현이 가능하다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//Iterator&lt;E&gt;를 Stream&lt;E&gt;로 중개해주는 어댑터</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span>&lt;E&gt; Stream&lt;E&gt; <span class="title function_">streamOf</span><span class="params">(Iterable&lt;E&gt; iterable)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> StreamSupport.stream(iterable.spliterator(), <span class="literal">false</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>객체 시퀀스를 반환하는 메서드를 작성할 때, 메서드가 오직 Stream 파이프라인에서만 쓰인다면 마음놓고 Stream을 반환하자.<br>하지만 for-each를 사용하는 개발자와 Stream을 사용하는 개발자를 모두 배려하여 Stream과 Iterable을 동시에 제공할 수 있도록 하는 것이 좋다.<br>따라서 <strong>원소 시퀀스를 반환하는 공개 API의 반환 타입에는 Collection이나 그 하위타입을 쓰는 것이 일반적이다</strong></p>
<h1 id="컬렉션-내의-시퀀스가-크면-전용-컬렉션을-구현하라"><a href="#컬렉션-내의-시퀀스가-크면-전용-컬렉션을-구현하라" class="headerlink" title="컬렉션 내의 시퀀스가 크면 전용 컬렉션을 구현하라"></a>컬렉션 내의 시퀀스가 크면 전용 컬렉션을 구현하라</h1><p>반환하는 시퀀스의 크기가 메모리에 올려도 안전할 만큼 작다면 ArrayList나 HashSet 같은 표준 컬렉션 구현체를 반환하는게 최선일 수 있다.<br>하지만 단지 컬렉션을 반환한다는 이유로 <strong>덩치 큰 시퀀스를 메모리에 올려서는 안된다.</strong></p>
<h2 id="예시-입력-집합의-멱집합을-전용-컬렉션에-담아-반환한다"><a href="#예시-입력-집합의-멱집합을-전용-컬렉션에-담아-반환한다" class="headerlink" title="예시 - 입력 집합의 멱집합을 전용 컬렉션에 담아 반환한다."></a>예시 - 입력 집합의 멱집합을 전용 컬렉션에 담아 반환한다.</h2><p>멱집합이란, <strong>한 집합의 모든 부분집합을 원소로 하는 집합</strong>이다.<br>예를 들어 (a, b, c)의 멱집합은 ((), (a), (b), (c), (a, b), (a, c), (b, c), (a, b, c))이다.<br>원소의 갯수가 n개일 때, 원소의 갯수는 2^n개가 된다.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">PowerSet</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> &lt;E&gt; Collection&lt;Set&lt;E&gt;&gt; <span class="title function_">of</span><span class="params">(Set&lt;E&gt; s)</span> &#123;</span><br><span class="line">       List&lt;E&gt; src = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(s);</span><br><span class="line">       <span class="keyword">if</span>(src.size() &gt; <span class="number">30</span>) &#123;</span><br><span class="line">           <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(<span class="string">&quot;집합에 원소가 너무 많습니다(최대 30개).: &quot;</span> + s);</span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">       <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">AbstractList</span>&lt;Set&lt;E&gt;&gt;() &#123;</span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="number">1</span> &lt;&lt; src.size();</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">contains</span><span class="params">(Object o)</span> &#123;</span><br><span class="line">               <span class="keyword">return</span> o <span class="keyword">instanceof</span> Set &amp;&amp; src.containsAll((Set) o);</span><br><span class="line">           &#125;</span><br><span class="line"></span><br><span class="line">           <span class="meta">@Override</span></span><br><span class="line">           <span class="keyword">public</span> Set&lt;E&gt; <span class="title function_">get</span><span class="params">(<span class="type">int</span> index)</span> &#123;</span><br><span class="line">               Set&lt;E&gt; result = <span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;();</span><br><span class="line">               <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; index != <span class="number">0</span>; i++, index &gt;&gt;=<span class="number">1</span>) &#123;</span><br><span class="line">                   <span class="keyword">if</span>((index &amp; <span class="number">1</span>) == <span class="number">1</span>) &#123;</span><br><span class="line">                       result.add(src.get(i));</span><br><span class="line">                   &#125;</span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span> result;</span><br><span class="line">           &#125;</span><br><span class="line">       &#125;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>입력 집합의 원소 수가 30을 넘으면 Power.of가 예외를 던진다.<br>(size() 메서드의 리턴타입은 int이기 때문에 최대길이는 2^31 - 1 또는 Integer.MAX_VALUE로 제한 되기 때문)</li>
<li>이는 Stream이나, Iterable이 아닌 Collection을 쓸 때의 단점을 보여준다.<br>(Stream이나 Iterable은 size에 대한 고민이 필요없기 때문)</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">Collection</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">Iterable</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="comment">// Query Operations</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * Returns the number of elements in this collection.  If this collection</span></span><br><span class="line"><span class="comment">     * contains more than &#123;<span class="doctag">@code</span> Integer.MAX_VALUE&#125; elements, returns</span></span><br><span class="line"><span class="comment">     * &#123;<span class="doctag">@code</span> Integer.MAX_VALUE&#125;.</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span> the number of elements in this collection</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="type">int</span> <span class="title function_">size</span><span class="params">()</span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li>Collection 인터페이스에서는 collection의 size가 int 범위를 넘어가는 경우 Integer.MAX_VALUE를 리턴하라고 하지만 만족스러운 해법은 아니다.</li>
</ul>
<h1 id="Stream이-나을-때도-있다"><a href="#Stream이-나을-때도-있다" class="headerlink" title="Stream이 나을 때도 있다."></a>Stream이 나을 때도 있다.</h1><p>위의 예제처럼 AbstractCollection을 활용해서 Collection 구현체를 리턴 할 때는 Iterator용 메서드 외에 2개만 더 구현하면 된다.<br>바로 <code>contains</code>과 <code>size</code>이다.  </p>
<p>하지만 반복이 시작되기 전에는 (시퀀스의 내용을 확정할 수 없는 등의 사유로) contains와 size를 구현할 수 없는 경우에는 Collection이나 Iterable을 반환하는 편이 낫다.</p>
<h2 id="예시-입력-리스트의-모든-부분-리스트를-Stream으로-반환"><a href="#예시-입력-리스트의-모든-부분-리스트를-Stream으로-반환" class="headerlink" title="예시 - 입력 리스트의 모든 부분 리스트를 Stream으로 반환"></a>예시 - 입력 리스트의 모든 부분 리스트를 Stream으로 반환</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">SubList</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; Stream&lt;List&lt;E&gt;&gt; <span class="title function_">of</span><span class="params">(List&lt;E&gt; list)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> Stream.concat(Stream.of(Collections.emptyList()), </span><br><span class="line">                             prefixes(list).flatMap(SubList::suffixes));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; Stream&lt;List&lt;E&gt;&gt; <span class="title function_">prefixes</span><span class="params">(List&lt;E&gt; list)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> IntStream.rangeClosed(<span class="number">1</span>, list.size())</span><br><span class="line">                        .mapToObj(end -&gt; list.subList(<span class="number">0</span>, end));</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; Stream&lt;List&lt;E&gt;&gt; <span class="title function_">suffixes</span><span class="params">(List&lt;E&gt; list)</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> IntStream.rangeClosed(<span class="number">0</span>, list.size())</span><br><span class="line">                        .mapToObj(start -&gt; list.subList(start, list.size()));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>(a, b, c)의 prefixes는 (a), (a, b), (a, b, c) 이다</li>
<li>(a, b, c)의 suffixes는 (c), (b, c), (a, b, c) 이다</li>
<li>Stream.concat 메서드는 반환되는 Stream에 빈 리스트를 추가하며, flatMap은 모든 Stream을 하나의 Stream으로 만든다.</li>
</ul>
<h2 id="위의-내용과-같은-로직-for-loop를-이용한-코드"><a href="#위의-내용과-같은-로직-for-loop를-이용한-코드" class="headerlink" title="위의 내용과 같은 로직 - for loop를 이용한 코드"></a>위의 내용과 같은 로직 - for loop를 이용한 코드</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> (<span class="type">int</span> <span class="variable">start</span> <span class="operator">=</span> <span class="number">0</span>; start &lt; src.size(); start++) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">end</span> <span class="operator">=</span> start + <span class="number">1</span>; end &lt;= src.size(); end++) &#123;</span><br><span class="line">        System.out.println(src.subList(start, end));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="위의-로직과-같은-로직-Stream-중첩"><a href="#위의-로직과-같은-로직-Stream-중첩" class="headerlink" title="위의 로직과 같은 로직 - Stream 중첩"></a>위의 로직과 같은 로직 - Stream 중첩</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;E&gt; Stream&lt;List&lt;E&gt;&gt; <span class="title function_">of</span><span class="params">(List&lt;E&gt; list)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> IntStream.range(<span class="number">0</span>, list.size())</span><br><span class="line">        .mapToObj(start -&gt; </span><br><span class="line">                  IntStream.rangeClosed(start + <span class="number">1</span>, list.size())</span><br><span class="line">                           .mapToObj(end -&gt; list.subList(start, end)))</span><br><span class="line">        .flatMap(x -&gt; x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h1 id="요약"><a href="#요약" class="headerlink" title="요약"></a>요약</h1><ul>
<li>Stream이나 Iterable을 리턴하는 API에는 Stream -&gt; Iterable, Iterable -&gt; Stream으로 변환하기 위한 어댑터 메서드가 필요하다.</li>
<li>어댑터는 클라이언트 코드를 어수선하게 만들고 더 느리다 (책에서는 2.3배정도 느리다함)</li>
<li>원소 시퀀스를 반환하는 메서드를 작성할 때는 Stream, Iterator를 모두 지원할 수 있게 작성하자<br> (되도록 Collection으로 하는게 좋다.)</li>
<li>원소의 갯수가 많다면, 멱집합의 예처럼 전용 컬렉션을 리턴하는 방법도 고민하자</li>
<li>만약 나중에 Stream 인터페이스가 Iterable을 지원하도록 수정된다면, 그때는 안심하고 Stream을 반환하면 된다.</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 47. 반환 타입으로는 스트림보다 컬렉션이 낫다</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/02/16/effective-java-item45/">Item 45. 스트림은 주의해서 사용하라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-02-16</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>스트림 API는 다량의 데이터 처리 작업(순차적이든 병렬적이든)을 돕고자 자바8에 추가되었다.<br>이 API가 제공하는 추상 개념 중 핵심은 두 가지다. </p>
<ul>
<li>스트림(Stream)은 데이터 원소의 유한 혹은 무한 시퀀스(sequence)를 의미</li>
<li>스트림 파이프라인(Stream Pipeline)은 이 원소들로 수행하는 연산단계를 표현하는 개념</li>
</ul>
<p>스트림의 원소들은 어디서부터든 올 수 있다. 대표적으로</p>
<ul>
<li>컬렉션 (Collection)</li>
<li>배열 (Array)</li>
<li>파일 (File)</li>
<li>정규표현식 (Regex Pattern Matcher)</li>
<li>난수 생성기 (Random Generator)</li>
<li>다른 스트림 (Other Stream)</li>
</ul>
<p>스트림 안의 데이터 원소들은 객체 참조(reference)나 기본 타입(int, long, double)을 지원한다.</p>
<ul>
<li><strong>Stream</strong> : 객체 참조타입에 대한 Stream</li>
<li><strong>IntStream</strong> : int 타입에 대한 Stream</li>
<li><strong>LongStream</strong> : long 타입에 대한 Stream</li>
<li><strong>DoubleStream</strong> : double 타입에 대한 Stream</li>
</ul>
<p>기본타입의 경우 위의 IntStream, LongStream, DoubleStream과 같은 Stream을 사용하는 것이 성능상 좋다.</p>
<h1 id="스트림-파이프라인-Stream-Pipeline"><a href="#스트림-파이프라인-Stream-Pipeline" class="headerlink" title="스트림 파이프라인 (Stream Pipeline)"></a>스트림 파이프라인 (Stream Pipeline)</h1><p>스트림 파이프 라인은 소스 스트림에서 시작해 종단 연산(terminal operation)으로 끝나며,<br>그 사이에 하나 이상의 중간 연산(intermediate operation)이 있을 수 있다.</p>
<h2 id="종단-연산-terminal-operation"><a href="#종단-연산-terminal-operation" class="headerlink" title="종단 연산 (terminal operation)"></a>종단 연산 (terminal operation)</h2><ul>
<li><p><strong>forEach(Consumer&lt;? super T&gt; consumer)</strong> : Stream의 요소를 순회</p>
</li>
<li><p><strong>count()</strong> : 스트림 내의 요소 수 반환</p>
</li>
<li><p><strong>max(Comparator&lt;? super T&gt; comparator)</strong> : 스트림 내의 최대 값 반환 </p>
</li>
<li><p><strong>min(Comparator&lt;? super T&gt; comparator)</strong> : 스트림 내의 최소 값 반환</p>
</li>
<li><p><strong>allMatch(Predicate&lt;? super T&gt; predicate)</strong> : 스트림 내에 모든 요소가 predicate 함수에 만족할 경우 true</p>
</li>
<li><p><strong>anyMatch(Predicate&lt;? super T&gt; predicate)</strong> : 스트림 내에 하나의 요소라도 predicate 함수에 만족할 경우 true</p>
</li>
<li><p><strong>noneMatch(Predicate&lt;? super T&gt; predicate)</strong> : 스트림 내에 모든 요소가 predicate 함수에 만족하지않는 경우 true</p>
</li>
<li><p><strong>sum()</strong> : 스트림 내의 요소의 합 (IntStream, LongStream, DoubleStream)</p>
</li>
<li><p><strong>average()</strong> : 스트림 내의 요소의 평균 (IntStream, LongStream, DoubleStream)</p>
</li>
</ul>
<h2 id="중간-연산-intermediate-operation"><a href="#중간-연산-intermediate-operation" class="headerlink" title="중간 연산 (intermediate operation)"></a>중간 연산 (intermediate operation)</h2><ul>
<li><p>f<strong>ilter(Predicate&lt;? super T&gt; predicate)</strong> : predicate 함수에 맞는 요소만 사용하도록 필터</p>
</li>
<li><p><strong>map(Function&lt;? Super T, ? extends R&gt; function)</strong> : 요소 각각의 function 적용</p>
</li>
<li><p><strong>flatMap(Function&lt;? Super T, ? extends R&gt; function)</strong> : 스트림의 스트림을 하나의 스트림으로 변환</p>
</li>
<li><p><strong>distinct()</strong> : 중복 요소 제거</p>
</li>
<li><p><strong>sort()</strong> : 기본 정렬</p>
</li>
<li><p><strong>sort(Comparator&lt;? super T&gt; comparator)</strong> : comparator 함수를 이용하여 정렬</p>
</li>
<li><p><strong>skip(long n)</strong> : n개 만큼의 스트림 요소 건너뜀</p>
</li>
<li><p><strong>limit(long maxSize)</strong> : maxSize 갯수만큼만 출력</p>
</li>
</ul>
<h1 id="스트림의-지연-평가-Lazy-evaluation"><a href="#스트림의-지연-평가-Lazy-evaluation" class="headerlink" title="스트림의 지연 평가(Lazy evaluation)"></a>스트림의 지연 평가(Lazy evaluation)</h1><p>스트림에 대한 평가는 종단 연산이 호출될 때 이뤄지며, 종단 연산에 쓰이지 않는 데이터 원소는 계산에 쓰이지 않는다.<br>이러한 지연 평가가 무한 스트림을 다룰 수 있게 해주는 열쇠다.  </p>
<p>쉽게 말해 <strong>종단 연산(terminal operation)이 없는 스트림 파이프라인은 아무 일도 일어나지 않는다.</strong></p>
<h1 id="Stream-예제-아나그램-anagram"><a href="#Stream-예제-아나그램-anagram" class="headerlink" title="Stream 예제 - 아나그램(anagram)"></a>Stream 예제 - 아나그램(anagram)</h1><h2 id="일반-loop를-이용한-코드"><a href="#일반-loop를-이용한-코드" class="headerlink" title="일반 loop를 이용한 코드"></a>일반 loop를 이용한 코드</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">dectionary</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(args[<span class="number">0</span>]);</span><br><span class="line">    <span class="type">int</span> <span class="variable">minGroupSize</span> <span class="operator">=</span> Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    Map&lt;String, Set&lt;String&gt;&gt; groups = <span class="keyword">new</span> <span class="title class_">HashMap</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">try</span> (<span class="type">Scanner</span> <span class="variable">s</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Scanner</span>(dectionary)) &#123;</span><br><span class="line">        <span class="keyword">while</span>(s.hasNext()) &#123;</span><br><span class="line">            <span class="type">String</span> <span class="variable">word</span> <span class="operator">=</span> s.next();</span><br><span class="line">            groups.computeIfAbsent(alphabetize(word), </span><br><span class="line">                                   (unused) -&gt; <span class="keyword">new</span> <span class="title class_">TreeSet</span>&lt;&gt;()).add(word);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">catch</span> (FileNotFoundException e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(Set&lt;String&gt; group : groups.values()) &#123;</span><br><span class="line">        <span class="keyword">if</span>(group.size() &gt;= minGroupSize) &#123;</span><br><span class="line">            System.out.println(group.size() + <span class="string">&quot;: &quot;</span> + group);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> String <span class="title function_">alphabetize</span><span class="params">(String s)</span> &#123;</span><br><span class="line">    <span class="type">char</span>[] a = s.toCharArray();</span><br><span class="line">    Arrays.sort(a);</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>(a);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>자바 8에서 추가된 computeIfAbsent 메서드를 사용했다</li>
<li>computeIfAbsent : 맵 안에 키가 있는지 찾은 다음, 있으면 단순히 그 키에 매핑된 값을 반환한다.</li>
</ul>
<h2 id="Stream을-과도하게-쓴-코드"><a href="#Stream을-과도하게-쓴-코드" class="headerlink" title="Stream을 과도하게 쓴 코드"></a>Stream을 과도하게 쓴 코드</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">dectionary</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(args[<span class="number">0</span>]);</span><br><span class="line">    <span class="type">int</span> <span class="variable">minGroupSize</span> <span class="operator">=</span> Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>(Stream&lt;String&gt; words = Files.lines(dectionary.toPath())) &#123;</span><br><span class="line">        words.collect(</span><br><span class="line">            groupingBy(word -&gt; word.chars().sorted()</span><br><span class="line">                       .collect(StringBuilder::<span class="keyword">new</span>,</span><br><span class="line">                                (sb, c) -&gt; sb.append((<span class="type">char</span>) c),</span><br><span class="line">                                StringBuilder::append).toString()))</span><br><span class="line">            .values().stream()</span><br><span class="line">            .filter(group -&gt; group.size() &gt;= minGroupSize)</span><br><span class="line">            .map(group -&gt; group.size() + <span class="string">&quot;: &quot;</span> + group)</span><br><span class="line">            .forEach(System.out::println);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>스트림을 과용하면 프로그램이 읽거나 유지보수 하기 어려워진다.</li>
</ul>
<h2 id="Stream을-적절히-활용한-코드"><a href="#Stream을-적절히-활용한-코드" class="headerlink" title="Stream을 적절히 활용한 코드"></a>Stream을 적절히 활용한 코드</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    <span class="type">File</span> <span class="variable">dectionary</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(args[<span class="number">0</span>]);</span><br><span class="line">    <span class="type">int</span> <span class="variable">minGroupSize</span> <span class="operator">=</span> Integer.parseInt(args[<span class="number">1</span>]);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">try</span>(Stream&lt;String&gt; words = Files.lines(dectionary.toPath())) &#123;</span><br><span class="line">        words.collect(groupingBy(word -&gt; alphabetize(word)))</span><br><span class="line">            .values().stream()</span><br><span class="line">            .filter(group -&gt; group.size() &gt;= minGroupSize)</span><br><span class="line">            .forEach(group -&gt; System.out.println(group.size() + <span class="string">&quot;: &quot;</span> + group));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>스트림을 적절하게 사용하면 명료해진다.</li>
<li>람다에서는 타입 추론 기능을 사용하기 때문에 주로 타입 이름을 생략한다.<br>따라서 매개변수 이름을 잘 지어야 스트림 파이프라인의 가독성이 유지된다.</li>
<li>연산에 적절한 이름을 지어 주고 도우미 메서드를 적정히 활용하는 것은 일반 반복코드보다 스트림 파이프라인에서 훨씬 크다</li>
</ul>
<h1 id="기존-코드는-필요한-경우에만-스트림으로-리팩터링-하자"><a href="#기존-코드는-필요한-경우에만-스트림으로-리팩터링-하자" class="headerlink" title="기존 코드는 필요한 경우에만 스트림으로 리팩터링 하자"></a>기존 코드는 필요한 경우에만 스트림으로 리팩터링 하자</h1><p>스트림을 처음 쓰기 시작하면 모든 반복문을 스트림으로 바꾸고 싶은 유혹이 생긴다.<br>스트림으로 바꾸는 게 가능할 지라도, 가독성과 유지보수 측면에서 볼 때 손해를 볼 수 있기 때문에 무작정 바꾸지는 말자<br>스트림과 반복문을 적절히 활용하는 것이 최선이다.</p>
<h1 id="코드블럭-vs-람다-lambda"><a href="#코드블럭-vs-람다-lambda" class="headerlink" title="코드블럭 vs 람다(lambda)"></a>코드블럭 vs 람다(lambda)</h1><ul>
<li>코드블럭에서는 범위 안의 지역변수를 읽고 수정할 수 있다.</li>
<li>람다에서는 final이거나 사실상 final인 변수만 읽을 수 있다. (캡처)<br>지역 변수를 수정하는 것은 불가능하다.</li>
<li>코드 블럭에서는 return을 이용해 메서드를 빠져나갈 수 있다.</li>
<li>코드 블럭에서는 break, continue문을 통해 블럭 바깥의 반복문을 종료 할 수 있다.</li>
<li>메서드 선언에 명시된 예외(Exception)을 던질 수 있다.</li>
<li>하지만 람다로는 모든 것이 불가능하다.</li>
</ul>
<h1 id="스트림이-적합한-경우"><a href="#스트림이-적합한-경우" class="headerlink" title="스트림이 적합한 경우"></a>스트림이 적합한 경우</h1><ul>
<li>원소들의 시퀀스를 일관되게 변환한다.</li>
<li>원소들의 시퀀스를 필터링한다.</li>
<li>원소들의 시퀀스를 하나의 연산을 사용해 결합한다. (더하기, 연결하기, 최소값 등..)</li>
<li>원소들의 시퀀스를 컬렉션에 모은다</li>
<li>원소들의 시퀀스에서 특정 조건을 만족하는 원소를 찾는다.</li>
</ul>
<h1 id="스트림이-적합하지-않은-경우"><a href="#스트림이-적합하지-않은-경우" class="headerlink" title="스트림이 적합하지 않은 경우"></a>스트림이 적합하지 않은 경우</h1><ul>
<li>데이터가 파이프라인의 여러 단계(stage)를 통과할 때 이 데이터의 각 단계에서의 값들에 동시에 접근하기 어려운 경우</li>
<li>스트림 파이프라인은 한 값을 다른 값에 매핑하고 나면 원래의 값을 잃는 구조이기 때문</li>
</ul>
<h2 id="예제-메르센-소수-출력하기"><a href="#예제-메르센-소수-출력하기" class="headerlink" title="예제 - 메르센 소수 출력하기"></a>예제 - 메르센 소수 출력하기</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> Stream&lt;BigInteger&gt; <span class="title function_">primes</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Stream.iterator(TWO, BigInteger::nextProbablePrime);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>위의 코드는 무한 스트림을 반환하는 메서드이다.</li>
<li>아직 종단 연산이 없기 때문에 실행되지는 않는 스트림이다.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    primes().map(p -&gt; TWO.pow(p.intValueExact().subtract(ONE)))</span><br><span class="line">            .filter(mersenne -&gt; mersenne.isProbablePrime(<span class="number">50</span>))</span><br><span class="line">            .limit(<span class="number">20</span>)</span><br><span class="line">            .forEach(System.out::println);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>위의 코드는 메르센 소수를 20개를 출력하는 프로그램이다.</li>
</ul>
<h1 id="예제-데카르트-곱"><a href="#예제-데카르트-곱" class="headerlink" title="예제 - 데카르트 곱"></a>예제 - 데카르트 곱</h1><h2 id="데카르트-곱을-반복을-이용하여-구현"><a href="#데카르트-곱을-반복을-이용하여-구현" class="headerlink" title="데카르트 곱을 반복을 이용하여 구현"></a>데카르트 곱을 반복을 이용하여 구현</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Card&gt; <span class="title function_">newDeck</span><span class="params">()</span> &#123;</span><br><span class="line">    List&lt;Card&gt; result = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="keyword">for</span>(Suit suit : Suit.values()) </span><br><span class="line">        <span class="keyword">for</span>(Rank rank : Rank.values())</span><br><span class="line">            result.add(<span class="keyword">new</span> <span class="title class_">Card</span>(suit, rank));</span><br><span class="line">    <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<ul>
<li>카드는 숫자(rank)와 무늬(suit)를 묶은 불변 값 클래스이거 숫자와 무늬는 열거타입이다.</li>
<li>for-each를 통해 스트림을 모르는 개발자라도 쉽게 알아 볼 수 있는 코드이다</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;Card&gt; <span class="title function_">newDeck</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> Stream.of(Suit.values())</span><br><span class="line">    .flatMap(suit -&gt; Stream.of(Rank.values())</span><br><span class="line">                      .map(rank -&gt; <span class="keyword">new</span> <span class="title class_">Card</span>(suit, rank)))</span><br><span class="line">    .collect(toList());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Stream을 중첩하여 만든 코드이다.</li>
<li>개발자에 따라 어떤 코드가 가독성, 유지보수성이 좋은 코드인지 갈리겠지만,<br>내 기준에는 첫번째 코드가 더 가독성과 유지보수성이 좋아보인다.</li>
</ul>
<h1 id="요약"><a href="#요약" class="headerlink" title="요약"></a>요약</h1><ul>
<li>스트림과 함수형 프로그래밍에 익숙한 프로그래머라면 스트림방식이 좀 더 명확하다</li>
<li>스트림을 사용할 때가 있고, 반복을 사용할 때가 있다.</li>
<li>스트림과 반복 중 어느 쪽이 나은지 확신하기 어렵다면 둘 다 해보고 더 나은 쪽을 택하는 것이 좋다.</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 45. 스트림은 주의해서 사용하라</li>
</ul>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="../4/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="../../">1</a><span class="space">&hellip;</span><a class="page-number" href="../4/">4</a><span class="page-number current">5</span><a class="page-number" href="../6/">6</a><span class="space">&hellip;</span><a class="page-number" href="../12/">12</a><a class="extend next" rel="next" href="../6/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2022 By Carrey</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="../../js/utils.js?version=1.9.0"></script><script src="../../js/fancybox.js?version=1.9.0"></script><script src="../../js/sidebar.js?version=1.9.0"></script><script src="../../js/copy.js?version=1.9.0"></script><script src="../../js/fireworks.js?version=1.9.0"></script><script src="../../js/transition.js?version=1.9.0"></script><script src="../../js/scroll.js?version=1.9.0"></script><script src="../../js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>