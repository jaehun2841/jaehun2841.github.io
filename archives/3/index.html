<!DOCTYPE html><html lang="lang"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="description" content=""><meta name="keywords" content=""><meta name="author" content="Carrey"><meta name="copyright" content="Carrey"><title>공부하고, 경험하고, 삽질해서 얻은 지식들을 기록합니다. | Carrey`s 기술블로그</title><link rel="shortcut icon" href="../../melody-favicon.ico"><link rel="stylesheet" href="../../css/index.css?version=1.9.0"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css?version=1.9.0"><meta name="format-detection" content="telephone=no"><meta http-equiv="x-dns-prefetch-control" content="on"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  hexoVersion: '6.0.0'
} </script><meta name="generator" content="Hexo 6.0.0"></head><body><canvas class="fireworks"></canvas><i class="fa fa-arrow-right" id="toggle-sidebar" aria-hidden="true"></i><div id="sidebar" data-display="false"><div class="author-info"><div class="author-info__avatar text-center"><img src="https://www.gravatar.com/avatar/3f8583b7b0f0c1ebd249dffad42707af?s=300"></div><div class="author-info__name text-center">Carrey</div><div class="author-info__description text-center"></div><hr><div class="author-info-articles"><a class="author-info-articles__archives article-meta" href=".."><span class="pull-left">Articles</span><span class="pull-right">112</span></a><a class="author-info-articles__tags article-meta" href="../../tags"><span class="pull-left">Tags</span><span class="pull-right">27</span></a></div></div></div><nav class="no-bg" id="nav"><div id="page-header"><span class="pull-left"> <a id="site-name" href="../../index.html">Carrey`s 기술블로그</a></span><i class="fa fa-bars toggle-menu pull-right" aria-hidden="true"></i><span class="pull-right menus">   <a class="site-page" href="/">Home</a><a class="site-page" href="/archives">Archives</a><a class="site-page" href="/tags">Tags</a><a class="site-page" href="/categories">Categories</a></span><span class="pull-right"></span></div><div id="site-info"><div id="site-title">Carrey`s 기술블로그</div><div id="site-sub-title">공부하고, 경험하고, 삽질해서 얻은 지식들을 기록합니다.</div></div></nav><div id="content-outer"><div class="layout" id="content-inner"><div class="recent-post-item article-container"><a class="article-title" href="../../2019/12/22/2019-12-22-spring-import/">Custom @Enable Annotation 만들어보기</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-12-22</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Spring/">Spring</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Spring-Configuration/">Spring Configuration</a></span><div class="content"><h1 id="Multi-모듈-프로젝트에서-발생하는-일"><a href="#Multi-모듈-프로젝트에서-발생하는-일" class="headerlink" title="Multi 모듈 프로젝트에서 발생하는 일"></a>Multi 모듈 프로젝트에서 발생하는 일</h1><p>Maven, Gradle을 이용해서 멀티 모듈을 구성하다 보면 각 모듈 별로 중복된 Bean을 계속 생성 코드를 만드는 경우가 있습니다.<br>(ex: Datasource, TransactionManager 등등)  </p>
<blockquote>
<p>예시 : Custom Module에서만 사용하는 JPA 환경 구성입니다.<br>일반적으로 하나의 DataSource를 사용하신다면, Spring AutoConfiguration을 이용하면 편리하게 구성하실 수 있습니다.<br>하지만 실무에서는 DataSource를 2개 이상 구성해서 쓰는 경우도 있기에, 직접 경험한 예시를 사용하게 되었습니다.</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EntityScan(basePackages = &#123;&quot;com.your.packages.module1&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(basePackages = &#123;&quot;com.your.packages.module1&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Module_1_Configuration</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@ConfigurationProperties(prefix = &quot;spring.custom-module.datasource&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> HikariConfig <span class="title function_">hikariConfig</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@FlywayDatasource</span></span><br><span class="line">  <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">(HikariConfig hikariConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(hikariConfig);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title function_">entityManagerFactory</span><span class="params">(</span></span><br><span class="line"><span class="params">    EntityManagerFactoryBuilder builder,</span></span><br><span class="line"><span class="params">    DataSource dataSource</span></span><br><span class="line"><span class="params">  )</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.dataSource(dataSource)</span><br><span class="line">      .packages(<span class="string">&quot;com.your.packages.module1&quot;</span>)</span><br><span class="line">      .build();</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> JpaTransactionManager <span class="title function_">transactionManager</span><span class="params">(EntityManagerFactory entityManagerFactory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JpaTransactionManager</span>(entityManagerFactory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EntityScan(basePackages = &#123;&quot;com.your.packages.module2&quot;&#125;)</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories(basePackages = &#123;&quot;com.your.packages.module2&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Module_2_Configuration</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@ConfigurationProperties(prefix = &quot;spring.custom-module.datasource&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> HikariConfig <span class="title function_">hikariConfig</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">(HikariConfig hikariConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(hikariConfig);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title function_">entityManagerFactory</span><span class="params">(</span></span><br><span class="line"><span class="params">    EntityManagerFactoryBuilder builder,</span></span><br><span class="line"><span class="params">    DataSource dataSource</span></span><br><span class="line"><span class="params">  )</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.dataSource(dataSource)</span><br><span class="line">      .packages(<span class="string">&quot;com.your.packages.module2&quot;</span>)</span><br><span class="line">      .build();</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> JpaTransactionManager <span class="title function_">transactionManager</span><span class="params">(EntityManagerFactory entityManagerFactory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JpaTransactionManager</span>(entityManagerFactory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>위의 두 Configuation 코드는 99% 같은 코드입니다.<br>하지만 왜 같은 코드 두개를 짰을까요?  </p>
<p>첫 번째는 packages 설정이 달랐습니다.</p>
<ul>
<li>packages(“com.your.packages.module1”)</li>
<li>packages(“com.your.packages.module2”)</li>
</ul>
<p>두 번째는 EntityScan, EnableJpaRepositories의 basePackages 설정이 달랐습니다.</p>
<ul>
<li>basePackages &#x3D; {“com.your.packages.module1”}</li>
<li>basePackages &#x3D; {“com.your.packages.module2”}</li>
</ul>
<p>세 번째는</p>
<ul>
<li>module1에서는 DataSource Bean에 <code>@FlywayDataSource</code> annotation이 있고</li>
<li>module2에서는 DataSource Bean에 <code>@FlywayDataSource</code> annotation이 없습니다.</li>
</ul>
<p>코드가 거의 같더라도, 약간의 설정이 다르다는 이유로 거의 같은 두 개의 Configuration을 사용했습니다.</p>
<h1 id="리팩토링1-EnableCustomDataSource"><a href="#리팩토링1-EnableCustomDataSource" class="headerlink" title="리팩토링1 - @EnableCustomDataSource"></a>리팩토링1 - @EnableCustomDataSource</h1><p>Spring을 사용하다 보면 @Enable~ 하는 Annotation을 자주 보았을 것이고, 실제로도 많이 사용해 보셨을 겁니다.  </p>
<ul>
<li>EnableCaching</li>
<li>EnableTransactionManagement</li>
<li>EnableJpaRepositories</li>
<li>EnableConfigurationProperties</li>
<li>EnableAsync</li>
</ul>
<p>이 처럼 많은 Enable Annotation들을 Spring에서 사용하고 있고, 실제로 개발자가 해야할 귀찮은<br>Configuration이나 BeanPostProcessing 같은 처리들을 손쉽게 하도록 도와줍니다.  </p>
<p>그렇기 때문에 이번 리팩토링도 Spring의 이런 부분을 벤치마킹하여 <code>@EnableCustomDataSource</code> 를 한번 만들어 보겠습니다.   </p>
<p>최종적인 모습은 아래와 같은 코드로 깔끔하게 리팩토링을 하는 그림이면 좋겠네요</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableCustomDataSource(basePackage = &#123;&quot;com.your.packages.module1&quot;&#125;)</span></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Module1Configuration</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<h1 id="리팩토링2-다른-Enable-Annotation-내부는-어떻게-생겼을까"><a href="#리팩토링2-다른-Enable-Annotation-내부는-어떻게-생겼을까" class="headerlink" title="리팩토링2 - 다른 @Enable~ Annotation 내부는 어떻게 생겼을까?"></a>리팩토링2 - 다른 @Enable~ Annotation 내부는 어떻게 생겼을까?</h1><p><img src="./EnableAsync.png" alt="EnableAsync"></p>
<p><img src="./EnableConfigurationProperties.png" alt="EnableConfigurationProperties"></p>
<p><img src="./EnableJpaRepositories.png" alt="EnableJpaRepositories"></p>
<p>혹시 3개의 Annotation의 공통점이 보이시나요?<br>모두 <code>@Import</code> Annotation을 통해 어떤 class를 import하고 있습니다.<br>대부분의 Enable의 Annotation은 위와 같이 Configuration 클래스를 Import하는 형식으로 많이 작성되고 있습니다.<br>(이외에는 SpringAutoConfiguration으로 작동하는 것들도 있는 것 같습니다.)</p>
<h1 id="리팩토링3-EnableCustomDataSource-생성"><a href="#리팩토링3-EnableCustomDataSource-생성" class="headerlink" title="리팩토링3 - @EnableCustomDataSource 생성"></a>리팩토링3 - @EnableCustomDataSource 생성</h1><p>위 에서 많은 개발자들이 만든 @Enable Annotation 생성 방식을 모방하여 만들어 보겠습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.Type)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Import(??.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableCustomDataSource &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>일단 @EnableCustomDataSource를 만들었습니다.<br>근데 @Import Annotation에 지정할 Configuration Class가 없어서.. 어떻게 해야 할지 잘 모르겠네요.<br>위에는 2개의 Configuration이 있는데 말이죠</p>
<h1 id="리팩토링-4-ImportSelector를-이용한-선택적-Configuration-사용"><a href="#리팩토링-4-ImportSelector를-이용한-선택적-Configuration-사용" class="headerlink" title="리팩토링 4 - ImportSelector를 이용한 선택적 Configuration 사용"></a>리팩토링 4 - ImportSelector를 이용한 선택적 Configuration 사용</h1><p>spring-context 라이브러리에서는 @Import Annotation processing에 대한 3가지 Interface를 지원합니다.</p>
<ul>
<li>ImportSelector</li>
<li>ImportBeanDefinitionRegistrar</li>
<li>ImportAware</li>
</ul>
<p>먼저 ImportSelector를 사용하여 선택적으로 Configuration을 사용해 보겠습니다.<br>ImportSelector는 Annotation Attribute의 값에 따라 Import할 Configuration을 지정할 수 있습니다.  </p>
<p>그렇기 때문에 @EnableCustomDataSource의 Attribute를 수정해보았습니다.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.Type)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Import(CustomDataSourceConfigurationSelector.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableCustomDataSource &#123;</span><br><span class="line">  Module <span class="title function_">module</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">enum</span> <span class="title class_">Module</span> &#123; ONE, TWO &#125;</span><br></pre></td></tr></table></figure>


<p>ImportSelector를 구현한 CustomDataSourceConfigurationSelector 코드를 구성하였습니다.  </p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CustomDataSourceConfigurationSelector</span> <span class="keyword">implements</span> <span class="title class_">ImportSelector</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> String[] selectImports(AnnotationMetadata importingClassMetadata) &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//find annotation attribute (module)</span></span><br><span class="line">    Map&lt;String, Object&gt; metaData = importingClassMetadata.getAnnotationAttributes(EnableCustomDataSource.class.getName());</span><br><span class="line">    <span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> AnnotationAttributes.fromMap(metaData);</span><br><span class="line">    <span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> attributes.getEnum(<span class="string">&quot;module&quot;</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//determine configuration class</span></span><br><span class="line">    <span class="type">String</span> <span class="variable">configurationClass</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">switch</span> (<span class="keyword">module</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> ONE:</span><br><span class="line">          configurationClass = Module_1_Configuration.class.getName();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> TWO:</span><br><span class="line">          configurationClass = Module_2_Configuration.class.getName();</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">String</span>[]&#123;configurationClass&#125;;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


<p>Module1의 CustomDataSourceConfiguration에서 Module.ONE이라고 설정을 정의해주면<br>Module_1_Configuration에 대한 설정을 Import할 수 있습니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCustomDataSource(module = Module.ONE)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CustomDataSourceConfiguration</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="리팩토링-5-ImportBeanDefinitionRegistrar를-이용한-직접-Bean-생성하기"><a href="#리팩토링-5-ImportBeanDefinitionRegistrar를-이용한-직접-Bean-생성하기" class="headerlink" title="리팩토링 5 - ImportBeanDefinitionRegistrar를 이용한 직접 Bean 생성하기"></a>리팩토링 5 - ImportBeanDefinitionRegistrar를 이용한 직접 Bean 생성하기</h1><p>ImportBeanDefinitionRegistrar를 이용하면 직접 beanRegistry에 Bean을 등록할 수 있습니다.</p>
<blockquote>
<p>하지만 추천하는 방식은 아닙니다.<br>실제로 Bean이 등록되는 순서를 제어하기 어렵기 때문에 원하는대로 실행이 되지 않을 수 있습니다.<br>토비의 스프링 ver2에서도 가급적이면 사용을 하지 않을 것을 권장하고 있습니다. </p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomDataSourceBeanDefinitionRegistrar</span> <span class="keyword">implements</span> <span class="title class_">ImportBeanDefinitionRegistrar</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">BEAN_NAME</span> <span class="operator">=</span> <span class="string">&quot;customDataSourceConfiguration&quot;</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> &#123;</span><br><span class="line">      Map&lt;String, Object&gt; metaData = importingClassMetadata.getAnnotationAttributes(EnableCustomDataSource.class.getName());</span><br><span class="line">      <span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> AnnotationAttributes.fromMap(metaData);</span><br><span class="line">      EnableCustomDataSource.<span class="type">Module</span> <span class="variable">module</span> <span class="operator">=</span> attributes.getEnum(<span class="string">&quot;module&quot;</span>);</span><br><span class="line"></span><br><span class="line">      <span class="type">AbstractBeanDefinition</span> <span class="variable">beanDefinition</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">      <span class="keyword">switch</span> (<span class="keyword">module</span>) &#123;</span><br><span class="line">          <span class="keyword">case</span> ONE:</span><br><span class="line">              beanDefinition = BeanDefinitionBuilder</span><br><span class="line">                      .rootBeanDefinition(Module_1_Configuration.class)</span><br><span class="line">                      .getBeanDefinition();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">          <span class="keyword">case</span> TWO:</span><br><span class="line">              beanDefinition = BeanDefinitionBuilder</span><br><span class="line">                      .rootBeanDefinition(Module_2_Configuration.class)</span><br><span class="line">                      .getBeanDefinition();</span><br><span class="line">              <span class="keyword">break</span>;</span><br><span class="line">      &#125;</span><br><span class="line">      registry.registerBeanDefinition(BEAN_NAME, beanDefinition);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.Type)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Import(CustomDataSourceBeanDefinitionRegistrar.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableCustomDataSource &#123;</span><br><span class="line">  Module <span class="title function_">module</span><span class="params">()</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="리팩토링-6-ImportAware를-이용한-Annoataion-attribute-주입"><a href="#리팩토링-6-ImportAware를-이용한-Annoataion-attribute-주입" class="headerlink" title="리팩토링 6 - ImportAware를 이용한 Annoataion attribute 주입"></a>리팩토링 6 - ImportAware를 이용한 Annoataion attribute 주입</h1><p>마지막으로 ImportAware입니다.</p>
<p>ImportAware interface는 @Import하는 Configuration class에 @Import 메타 annoatation을 사용하는 annoatation의 attribute를 사용할 수 있도록 해줍니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.Type)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Import(CustomDataSourceConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableCustomDataSource &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomDataSourceConfiguration</span> <span class="keyword">implements</span> <span class="title class_">ImportAware</span> &#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@ConfigurationProperties(prefix = &quot;spring.custom-module.datasource&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> HikariConfig <span class="title function_">hikariConfig</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">(HikariConfig hikariConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(hikariConfig);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title function_">entityManagerFactory</span><span class="params">(</span></span><br><span class="line"><span class="params">    EntityManagerFactoryBuilder builder,</span></span><br><span class="line"><span class="params">    DataSource dataSource</span></span><br><span class="line"><span class="params">  )</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.dataSource(dataSource)</span><br><span class="line">      .packages(<span class="string">&quot;com.your.packages.module2&quot;</span>)</span><br><span class="line">      .build();</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> JpaTransactionManager <span class="title function_">transactionManager</span><span class="params">(EntityManagerFactory entityManagerFactory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JpaTransactionManager</span>(entityManagerFactory);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setImportMetadata</span><span class="params">(annoatationMetadata: AnnotationMetadata)</span> &#123;</span><br><span class="line">    <span class="comment">//use @EnableCustomDataSource annotation attribute</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위와 같이 @EnableCustomDataSource annotation의 attribute를 사용할 수 있는 메서드를 제공합니다.</p>
<p>그렇게 되면, 애초에 2개의 파일로 분리되었던 </p>
<ul>
<li>Module_1_Configuration</li>
<li>Module_2_Configuration</li>
</ul>
<p>이 두가지 파일을 하나로 합칠 수 있을 것 같습니다.</p>
<p>두개의 파일을 하나로 합쳐서 CustomDataSourceConfiguration이라는 class를 만들고<br>@EnableCustomDataSource annotation에서 @Import 해보겠습니다.</p>
<h2 id="basePackages-attribute-추가"><a href="#basePackages-attribute-추가" class="headerlink" title="basePackages attribute 추가"></a>basePackages attribute 추가</h2><p>@EnableCustomDataSource annotation의 attribute를 조금 변경해 보겠습니다.<br>여태까지 사용한 module attribute는 이제 의미가 없을 것 같습니다.<br>파일을 하나로 합치기로 했기 때문이죠</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.Type)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@Import(CustomDataSourceConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableCustomDataSource &#123;</span><br><span class="line">  String[] basePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>Module1Configuration class에 드디어 우리가 원하던 대로 @EnableCustomDataSource를 사용해보게 되었습니다.<br>이게 껍데기는 완성되었고 내부 로직만 잘 구성하면 될듯 합니다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableCustomDataSource(basePackages = &#123;&quot;com.your.package.module1&quot;&#125;)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Module1Configuration</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="ImportAware-메서드-코드-구성"><a href="#ImportAware-메서드-코드-구성" class="headerlink" title="ImportAware 메서드 코드 구성"></a>ImportAware 메서드 코드 구성</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomDataSourceConfiguration</span> <span class="keyword">implements</span> <span class="title class_">ImportAware</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String[] basePackages;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@ConfigurationProperties(prefix = &quot;spring.custom-module.datasource&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> HikariConfig <span class="title function_">hikariConfig</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">(HikariConfig hikariConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(hikariConfig);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title function_">entityManagerFactory</span><span class="params">(</span></span><br><span class="line"><span class="params">    EntityManagerFactoryBuilder builder,</span></span><br><span class="line"><span class="params">    DataSource dataSource</span></span><br><span class="line"><span class="params">  )</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.dataSource(dataSource)</span><br><span class="line">      .packages(<span class="built_in">this</span>.basePackages)</span><br><span class="line">      .build();</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> JpaTransactionManager <span class="title function_">transactionManager</span><span class="params">(EntityManagerFactory entityManagerFactory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JpaTransactionManager</span>(entityManagerFactory);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setImportMetadata</span><span class="params">(annoatationMetadata: AnnotationMetadata)</span> &#123;</span><br><span class="line">    <span class="comment">//use @EnableCustomDataSource annotation attribute</span></span><br><span class="line">    Map&lt;String, Object&gt; metaData = importingClassMetadata.getAnnotationAttributes(EnableCustomDataSource.class.getName());</span><br><span class="line">    <span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> AnnotationAttributes.fromMap(metaData);</span><br><span class="line">    </span><br><span class="line">    String[] basePackages = attributes.get(<span class="string">&quot;basePackages&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.basePackages = basePackages; <span class="comment">// initialize member variable basePackages</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>CustomDataSourceConfiguration을 @Import를 통해 Import하게 되면 @Bean 메서드 보다 setImportMetadata가 먼저 실행됩니다.<br>(이유는 ImportAwareBeanPostProcessor에 의해 @Configuration Bean 초기화 이전에 setImportMetadata 메서드가 실행되기 때문입니다.) </p>
<blockquote>
<p>주의: ImportAware를 구현한 Configuration class에는 반드시 @Configuration Annotation을 붙여야 합니다.<br>그래야 Spring 내부적으로 ConfigurationClassPargser가 작동할 때 scan 되어 나중에 ImportAwareBeanPostProcessor에 의해 Post Processing이 될 수 있습니다.</p>
</blockquote>
<h1 id="리팩토링-7-아직-끝나지-않았다"><a href="#리팩토링-7-아직-끝나지-않았다" class="headerlink" title="리팩토링 7 - 아직 끝나지 않았다."></a>리팩토링 7 - 아직 끝나지 않았다.</h1><p>아직 끝나지 않았습니다.</p>
<p>Configuration class를 두 개로 나눈 두번째 이유 @EntityScan, @EnableJpaRepositories의 basePackages에 대한 설정이 다르기 때문입니다.<br>이 문제를 해결하기 위해서는 Spring에서 제공하는 @AliasFor annoataion을 사용해 보았습니다.</p>
<p><img src="./AliasFor.png" alt="AliasFor"></p>
<p>@AliasFor Annotation은 Spring 4.2에서 추가된 Annotation입니다. </p>
<ul>
<li>AliasFor을 이용해 Attribute의 다른 속성에 값을 바인딩 할 수 있습니다.<br>위의 예시처럼 value로 들어온 값을 attribute의 값에 바인딩</li>
<li>Annotation의 메타 Annotation의 attribute에 값을 바인딩 할 수 있습니다.<br><strong>(우리는 이 기능을 사용해 보도록 할 것입니다.)</strong></li>
</ul>
<blockquote>
<p>주의: Spring framework 5.2 하위버전에서 AliasFor이 Array에 대해서는 잘 적용이 안되는 이슈가 있었습니다.<br>이 이슈는 Spring framework 5.2, Springboot 2.2.0 이후에는 잘 적용이 됩니다.<br>혹시나 적용이 안되시는 분은 Spring version up을 권장드립니다.</p>
</blockquote>
<h2 id="EnableCustomDataSource-수정"><a href="#EnableCustomDataSource-수정" class="headerlink" title="@EnableCustomDataSource 수정"></a>@EnableCustomDataSource 수정</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Target(ElementType.Type)</span></span><br><span class="line"><span class="meta">@Retention(RetentionPolicy.RUNTIME)</span></span><br><span class="line"><span class="meta">@EntityScan</span> <span class="comment">// meta annotation으로 추가</span></span><br><span class="line"><span class="meta">@EnableJpaRepositories</span> <span class="comment">// meta annotation으로 추가</span></span><br><span class="line"><span class="meta">@Import(CustomDataSourceConfiguration.class)</span></span><br><span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableCustomDataSource &#123;</span><br><span class="line">  <span class="meta">@AliasFor(annotation = EntityScan.class, attribute = &quot;basePackages&quot;)</span></span><br><span class="line">  String[] jpaEntityBasePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">  <span class="meta">@AliasFor(annotation = EnableJpaRepositories.class, attribute = &quot;basePackages&quot;)</span></span><br><span class="line">  String[] jpaRepositoriesBasePackages() <span class="keyword">default</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>@AliasFor annotation은 @Repeatable meta annotation이 없기 때문에 하나의 메서드에 중첩해서 사용할 수 없습니다.<br>그렇기 때문에 @EntityScan에 대한 basePackages를 설정할 수 있는 메서드와<br>@EnableJpaRepositories에 대한 basePacakges를 설정할 수 있는 메서드로 분리 하였습니다.</p>
<p>위와 같이 설정해 주면<br>jpaEntityBasePackages -&gt; <code>EntityScan.basePackages</code>로 바인딩 됩니다.<br>jpaRepositoriesBasePackages -&gt; <code>EnableJpaRepositories.basePackages</code>로 바인딩 됩니다.<br>물론 EnableCustomDataSource의 attribute로도 사용할 수 있습니다.</p>
<h2 id="CustomDataSourceConfiguration-수정"><a href="#CustomDataSourceConfiguration-수정" class="headerlink" title="CustomDataSourceConfiguration 수정"></a>CustomDataSourceConfiguration 수정</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomDataSourceConfiguration</span> <span class="keyword">implements</span> <span class="title class_">ImportAware</span> &#123;</span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> String[] basePackages;</span><br><span class="line">  </span><br><span class="line">  ...</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setImportMetadata</span><span class="params">(annoatationMetadata: AnnotationMetadata)</span> &#123;</span><br><span class="line">    <span class="comment">//use @EnableCustomDataSource annotation attribute</span></span><br><span class="line">    Map&lt;String, Object&gt; metaData = importingClassMetadata.getAnnotationAttributes(EnableCustomDataSource.class.getName());</span><br><span class="line">    <span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> AnnotationAttributes.fromMap(metaData);</span><br><span class="line">    </span><br><span class="line">    String[] basePackages = attributes.get(<span class="string">&quot;jpaEntityBasePackages&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.basePackages = basePackages; <span class="comment">// initialize member variable basePackages</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>attribute가 변경되어 attribute명을 변경하였습니다.</p>
<h1 id="리팩토링-8-FlywayDataSource는-어째요"><a href="#리팩토링-8-FlywayDataSource는-어째요" class="headerlink" title="리팩토링 8 - FlywayDataSource는 어째요?"></a>리팩토링 8 - FlywayDataSource는 어째요?</h1><p>Flyway는 Database 자동 구성에 도움을 주는 라이브러리입니다.<br>(저장된 sql을 versioning하고 내부적으로 version관리를 하여 자동으로 Database를 초기화 하도록 해줍니다.)</p>
<p>이런 FlywayDatasource는 보통 하나의 모듈에서만 초기화 하게됩니다.<br>보통 하나의 DataSource만 사용하는 상황에서는 Flyway를 적용하는 대상도 하나이기 때문에 문제가 안되지만<br>지금과 같은 다중 DataSource를 사용하는 상황에서는 제약이 생길 수 있습니다.</p>
<p>그래서 @FlywayDataSource annotation을 지정하여 이 DataSource에 Flyway를 적용할 지 말지 결정할 수 있습니다.<br>여기서는 Springboot에서 제공하는 @ConditionalOnProperty를 이용하여 Bean 생성을 해보도록 하겠습니다.</p>
<p><img src="./ConditionalOnProperty.png" alt="ConditionalOnProperty"></p>
<ul>
<li><strong>prefix</strong>: 사용하고자 하는 property의 prefix입니다.</li>
<li><strong>name</strong>: Condition에 유효한 property인지 테스트할 property명</li>
<li><strong>havingValue</strong>: prefix + name property의 값이 어떤 value일 경우 조건식이 참이 될지 결정하는 값입니다.</li>
<li><strong>matchIfMissing</strong>: property를 찾을 수 없는 경우 조건식의 default 값을 정의합니다.</li>
</ul>
<h2 id="property-추가"><a href="#property-추가" class="headerlink" title="property 추가"></a>property 추가</h2><figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">spring.custom.datasource.flyway.enable</span> = <span class="string">true</span></span><br></pre></td></tr></table></figure>

<p>이와 같이 custom property를 추가해보겠습니다. (custom datasource에 대한 flyway를 쓸지 말지에 대한 설정입니다.)</p>
<h2 id="CustomDataSourceConfiguration-수정-1"><a href="#CustomDataSourceConfiguration-수정-1" class="headerlink" title="CustomDataSourceConfiguration 수정"></a>CustomDataSourceConfiguration 수정</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CustomDataSourceConfiguration</span> <span class="keyword">implements</span> <span class="title class_">ImportAware</span> &#123;</span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="meta">@ConfigurationProperties(prefix = &quot;spring.custom-module.datasource&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> HikariConfig <span class="title function_">hikariConfig</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariConfig</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">    prefix = &quot;spring.custom.datasource.flyway&quot;, </span></span><br><span class="line"><span class="meta">    name = [&quot;enable&quot;],</span></span><br><span class="line"><span class="meta">    havingValue = &quot;true&quot;, </span></span><br><span class="line"><span class="meta">    matchIfMissing = false</span></span><br><span class="line"><span class="meta">  )</span></span><br><span class="line">  <span class="meta">@FlywayDataSource</span></span><br><span class="line">  <span class="meta">@Bean(&quot;dataSource&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> DataSource <span class="title function_">dataSourceUsingFlyway</span><span class="params">(HikariConfig hikariConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(hikariConfig);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@ConditionalOnProperty(</span></span><br><span class="line"><span class="meta">    prefix = &quot;spring.custom.datasource.flyway&quot;, </span></span><br><span class="line"><span class="meta">    name = [&quot;enable&quot;],</span></span><br><span class="line"><span class="meta">    havingValue = &quot;false&quot;, </span></span><br><span class="line"><span class="meta">    matchIfMissing = true</span></span><br><span class="line"><span class="meta">  )</span></span><br><span class="line">  <span class="meta">@Bean(&quot;dataSource&quot;)</span></span><br><span class="line">  <span class="keyword">public</span> DataSource <span class="title function_">dataSource</span><span class="params">(HikariConfig hikariConfig)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">HikariDataSource</span>(hikariConfig);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> LocalContainerEntityManagerFactoryBean <span class="title function_">entityManagerFactory</span><span class="params">(</span></span><br><span class="line"><span class="params">  	EntityManagerFactoryBuilder builder,</span></span><br><span class="line"><span class="params">    DataSource dataSource</span></span><br><span class="line"><span class="params">  )</span>&#123;</span><br><span class="line">    <span class="keyword">return</span> builder.dataSource(dataSource)</span><br><span class="line">      .packages(<span class="string">&quot;com.your.packages.module2&quot;</span>)</span><br><span class="line">      .build();</span><br><span class="line">  &#125;</span><br><span class="line">   </span><br><span class="line">  <span class="meta">@Bean</span></span><br><span class="line">  <span class="keyword">public</span> JpaTransactionManager <span class="title function_">transactionManager</span><span class="params">(EntityManagerFactory entityManagerFactory)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">JpaTransactionManager</span>(entityManagerFactory);</span><br><span class="line">  &#125;</span><br><span class="line">  </span><br><span class="line">  <span class="meta">@Override</span></span><br><span class="line">  <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setImportMetadata</span><span class="params">(annoatationMetadata: AnnotationMetadata)</span> &#123;</span><br><span class="line">    <span class="comment">//use @EnableCustomDataSource annotation attribute</span></span><br><span class="line">    Map&lt;String, Object&gt; metaData = importingClassMetadata.getAnnotationAttributes(EnableCustomDataSource.class.getName());</span><br><span class="line">    <span class="type">AnnotationAttributes</span> <span class="variable">attributes</span> <span class="operator">=</span> AnnotationAttributes.fromMap(metaData);</span><br><span class="line">    </span><br><span class="line">    String[] basePackages = attributes.get(<span class="string">&quot;jpaEntityBasePackages&quot;</span>);</span><br><span class="line">    <span class="built_in">this</span>.basePackages = basePackages; <span class="comment">// initialize member variable basePackages</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이와 같이 CustomDataSourceConfiguration에서 DataSource Bean을 생성하는 코드를 두개로 하고<br><code>spring.custom.datasource.flyway.enable</code> 값에 따라 자동으로 Bean을 생성하도록 코드를 구성하였습니다.  </p>
<p>FlywayDataSource를 사용하는 module에만 <code>spring.custom.datasource.flyway.enable</code> 를 추가하여 Bean이 생성되도록 하였습니다.<br>FlywayDataSource를 사용하지 않는 module에는 <code>spring.custom.datasource.flyway.enable</code> 를 설정하지 않고 사용하여<br>일반적인 DataSource만 사용하도록 구성하였습니다.</p>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>토비의 스프링 Ver.2</li>
<li><a target="_blank" rel="noopener" href="https://medium.com/@circlee7/spring-conditional-annotation-e288ccf6b536">Spring Conditional annotation</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring/docs/4.2.0.RC2_to_4.2.0.RC3/Spring%20Framework%204.2.0.RC3/org/springframework/core/annotation/AliasFor.html">Spring AliasFor</a></li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/08/04/2019-08-04-spring-rest-docs/">Spring Rest Docs를 이용한 API 문서 만들기</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-08-04</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Spring/">Spring</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Spring-Rest-Docs/">Spring-Rest-Docs</a></span><div class="content"><p>Spring Rest API 문서를 자동으로 생성하고자  할 때, 보통 Swagger로 많이 사용하지만<br>이번에는 Spring Rest Docs를 사용하여 API 문서를 자동으로 작성 할 수 있도록 해봤습니다.</p>
<p>포스팅에 작성된 코드는 <a target="_blank" rel="noopener" href="https://github.com/jaehun2841/spring-rest-docs-example">https://github.com/jaehun2841/spring-rest-docs-example</a> 에서 참고하시길 바랍니다.</p>
<h1 id="Spring-Rest-Docs란"><a href="#Spring-Rest-Docs란" class="headerlink" title="Spring Rest Docs란"></a>Spring Rest Docs란</h1><p>Spring Rest Docs는 테스트 코드를 기반으로 자동으로 API문서를 작성할 수 있게 해주는 프레임워크입니다.<br>그렇기 때문에 반드시 <code>Test가 통과되어야 문서가 작성</code> 된다는 장점이 있습니다.<br>(그렇기 때문에 API Spec이 변경되거나 추가&#x2F;삭제 되는 부분에 대해 항상 테스트 코드를 수정하여야 하며, API 문서가 최신화 될 수 있도록 해줍니다.)<br>기본적으로 asciidoc을 사용하여 문서를 작성합니다 . (asciidoc은 마크다운과 비슷하게 html문서를 작성할 수 있는 언어입니다.)<br>원하는 경우에는 mark down을 사용할 수도 있지만, 이번 포스트에서는 asciidoc을 이용하여 API 문서를 작성해 보도록 하겠습니다.</p>
<h1 id="Spring-Rest-Docs-Architecture"><a href="#Spring-Rest-Docs-Architecture" class="headerlink" title="Spring Rest Docs Architecture"></a>Spring Rest Docs Architecture</h1><p><img src="./asciidoctor.png" alt="asciidoctor-task"></p>
<ul>
<li>Test Case를 수행하면 산출물이 <document-name>.adoc 파일로 &#x2F;build&#x2F;generate-snippets 디렉토리에 생성됩니다. (default path)</li>
<li>&#x2F;src&#x2F;docs&#x2F;asciidoc 디렉토리에 &#x2F;build&#x2F;generate-snippets에 있는 adoc 파일을 include하여 문서를 생성할 수 있습니다.<ul>
<li>&#x2F;build&#x2F;generate-snippets&#x2F;*.adoc 파일들은 API Request, Response에 대한 명세들만 있는 파일이고</li>
<li>&#x2F;src&#x2F;docs&#x2F;asciidoc&#x2F;*.adoc 파일들이 실제 사용자에게 html파일로 변환되어 제공되는 API 문서 파일입니다.</li>
<li>따라서 &#x2F;src&#x2F;docs&#x2F;asciidoc&#x2F;*.adoc 에 API 문서를 작성하고,<br>필요한 API Request, Response Spec은 자동 생성된 &#x2F;build&#x2F;generate-snippets&#x2F;*.adoc 파일들을 이용해 표현해줍니다.</li>
<li>이렇게 하면 향후 API Spec이 변경되더라도, 문서를 수정하지 않아도 되는 장점이 있습니다.</li>
</ul>
</li>
<li>이렇게 생성된 asciidoc 문서는 AsciidoctorTask를 통해 html 문서로 processing 되어 &#x2F;build&#x2F;asciidoc&#x2F;html5 하위에 html문서로 생성됩니다.<ul>
<li>html 문서가 생성되는 기준은 &#x2F;src&#x2F;docs&#x2F;asciidoc&#x2F;*.adoc 파일을 기준으로 생성됩니다.</li>
</ul>
</li>
</ul>
<h2 id="예시"><a href="#예시" class="headerlink" title="예시"></a>예시</h2><h3 id="x2F-src-x2F-docs-x2F-asciidoc-디렉토리-내에-html로-제공될-문서를-asciidoc으로-작성"><a href="#x2F-src-x2F-docs-x2F-asciidoc-디렉토리-내에-html로-제공될-문서를-asciidoc으로-작성" class="headerlink" title="&#x2F;src&#x2F;docs&#x2F;asciidoc 디렉토리 내에 html로 제공될 문서를 asciidoc으로 작성"></a>&#x2F;src&#x2F;docs&#x2F;asciidoc 디렉토리 내에 html로 제공될 문서를 asciidoc으로 작성</h3><p><img src="./src-template.png" alt="docuement-templates"></p>
<h3 id="Test-Case의-산출물"><a href="#Test-Case의-산출물" class="headerlink" title="Test Case의 산출물"></a>Test Case의 산출물</h3><ul>
<li>&#x2F;build&#x2F;generated-snippets 디렉토리 하위에 생성</li>
<li>Request, Response Spec에 대한 정보를 생성</li>
<li>&#x2F;src&#x2F;docs&#x2F;asciidoc&#x2F;*.adoc 파일에서 include해서 사용<br><img src="./snippets.png" alt="snippets"><h3 id="x2F-src-x2F-docs-x2F-asciidoc-디렉토리-adoc파일을-기반으로-생성된-html-파일"><a href="#x2F-src-x2F-docs-x2F-asciidoc-디렉토리-adoc파일을-기반으로-생성된-html-파일" class="headerlink" title="&#x2F;src&#x2F;docs&#x2F;asciidoc 디렉토리 adoc파일을 기반으로 생성된 html 파일"></a>&#x2F;src&#x2F;docs&#x2F;asciidoc 디렉토리 adoc파일을 기반으로 생성된 html 파일</h3><img src="./processed-html.png" alt="processed-html"></li>
</ul>
<p>자세한 부분은 아래 예시를 따라하면서 보시면 좋을 것 같습니다.</p>
<h1 id="Spring-Rest-Docs-시작하기"><a href="#Spring-Rest-Docs-시작하기" class="headerlink" title="Spring Rest Docs 시작하기"></a>Spring Rest Docs 시작하기</h1><h2 id="개발-스펙"><a href="#개발-스펙" class="headerlink" title="개발 스펙"></a>개발 스펙</h2><ul>
<li>Spring Boot 2.1.6.RELEASE</li>
<li>Junit 5</li>
<li>Kotlin 1.3.41 (저희 팀에서 코틀린만 써서 코틀린이 편하네요)</li>
<li>Gradle 5.4.1</li>
<li>Asciidoctor 1.5.9.2</li>
</ul>
<h2 id="Test-Library"><a href="#Test-Library" class="headerlink" title="Test Library"></a>Test Library</h2><p>Spring Rest Docs는 3가지 테스트 라이브러리를 지원합니다.</p>
<ul>
<li>MockMvc (@WebMvcTest)</li>
<li>WebTestClient (Mono &#x2F; Flux, @WebTestClient)</li>
<li>Rest Assured (IntegrationTest, @SpringBootTest)</li>
</ul>
<p>API 문서를 작성할 때 Spring Mvc를 사용하는 환경이라면 가장 가볍게 돌릴 수 있는게 MockMvc를 사용하는 것이라 생각합니다.<br>그래서 이번 포스팅에서는 MockMvc를 사용한 예제로만 진행하도록 하겠습니다.</p>
<h2 id="Gradle-설정"><a href="#Gradle-설정" class="headerlink" title="Gradle 설정"></a>Gradle 설정</h2><h3 id="asciidoctor-plugin-설정"><a href="#asciidoctor-plugin-설정" class="headerlink" title="asciidoctor plugin 설정"></a>asciidoctor plugin 설정</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    ext &#123;</span><br><span class="line">        kotlinVersion = <span class="string">&#x27;1.3.41&#x27;</span></span><br><span class="line">        springBootVersion = <span class="string">&quot;2.1.6.RELEASE&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    repositories &#123;</span><br><span class="line">        mavenCentral()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&quot;org.springframework.boot:spring-boot-gradle-plugin:$springBootVersion&quot;</span></span><br><span class="line">        classpath <span class="string">&quot;org.jetbrains.kotlin:kotlin-gradle-plugin:$kotlinVersion&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">plugins &#123;</span><br><span class="line">    id <span class="string">&#x27;org.asciidoctor.convert&#x27;</span> version <span class="string">&#x27;1.5.9.2&#x27;</span></span><br><span class="line">    id <span class="string">&#x27;org.springframework.boot&#x27;</span> version <span class="string">&#x27;2.1.6.RELEASE&#x27;</span></span><br><span class="line">    id <span class="string">&quot;io.spring.dependency-management&quot;</span> version <span class="string">&quot;1.0.5.RELEASE&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;io.spring.dependency-management&#x27;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&#x27;kotlin&#x27;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;groovy&quot;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;org.springframework.boot&quot;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;io.spring.dependency-management&quot;</span></span><br><span class="line">apply <span class="attr">plugin:</span> <span class="string">&quot;kotlin-kapt&quot;</span></span><br><span class="line"></span><br><span class="line">group = <span class="string">&#x27;com.example&#x27;</span></span><br><span class="line">version = <span class="string">&#x27;0.0.1-SNAPSHOT&#x27;</span></span><br><span class="line">sourceCompatibility = <span class="string">&#x27;1.8&#x27;</span></span><br><span class="line"></span><br><span class="line">repositories &#123;</span><br><span class="line">    mavenCentral()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">ext &#123;</span><br><span class="line">    set(<span class="string">&#x27;snippetsDir&#x27;</span>, file(<span class="string">&quot;build/generated-snippets&quot;</span>))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">dependencies &#123;</span><br><span class="line">    implementation <span class="string">&#x27;org.springframework.boot:spring-boot-starter-web&#x27;</span></span><br><span class="line">    testImplementation(<span class="string">&quot;org.springframework.boot:spring-boot-starter-test&quot;</span>) &#123;</span><br><span class="line">        exclude <span class="attr">group:</span> <span class="string">&quot;junit&quot;</span>, <span class="attr">module:</span> <span class="string">&quot;junit&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">    testImplementation <span class="string">&quot;org.junit.jupiter:junit-jupiter-api&quot;</span></span><br><span class="line">    testImplementation <span class="string">&quot;org.junit.jupiter:junit-jupiter-params&quot;</span></span><br><span class="line">    testRuntimeOnly <span class="string">&quot;org.junit.jupiter:junit-jupiter-engine&quot;</span></span><br><span class="line">    testImplementation <span class="string">&#x27;org.springframework.restdocs:spring-restdocs-mockmvc&#x27;</span></span><br><span class="line">    testImplementation <span class="string">&quot;com.nhaarman:mockito-kotlin:1.6.0&quot;</span></span><br><span class="line">    implementation <span class="string">&quot;org.jetbrains.kotlin:kotlin-stdlib-jdk8:$kotlinVersion&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">kapt &#123;</span><br><span class="line">    useBuildCache = <span class="literal">true</span></span><br><span class="line">    correctErrorTypes = <span class="literal">true</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">test &#123;</span><br><span class="line">    useJUnitPlatform()</span><br><span class="line">    outputs.dir snippetsDir</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">asciidoctor &#123;</span><br><span class="line">    inputs.dir snippetsDir</span><br><span class="line">    dependsOn test <span class="comment">//test Task 이후에 실행될 수 있도록 Dependency를 설정</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">asciidoctor.doFirst &#123;</span><br><span class="line">    println <span class="string">&quot;=====start asciidoctor&quot;</span></span><br><span class="line">    <span class="comment">//asciidoctor 실행전 기존에 생성된 API 문서 삭제</span></span><br><span class="line">    delete file(<span class="string">&#x27;src/main/resources/static/docs&#x27;</span>)</span><br><span class="line">&#125;</span><br><span class="line">asciidoctor.doLast &#123;</span><br><span class="line">    println <span class="string">&quot;=====finish asciidoctor&quot;</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">task copyDocument(<span class="attr">type:</span> Copy) &#123;</span><br><span class="line">    dependsOn asciidoctor</span><br><span class="line">    from file(<span class="string">&quot;build/asciidoc/html5&quot;</span>)</span><br><span class="line">    <span class="comment">// resources/static/docs 로 복사하여 서버가 돌아가고 있을때 /docs/index.html 로 접속하면 볼수 있음</span></span><br><span class="line">    into file(<span class="string">&quot;src/main/resources/static/docs&quot;</span>)  </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">build &#123;</span><br><span class="line">    dependsOn copyDocument</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">bootJar &#123;</span><br><span class="line">    archiveName = <span class="string">&#x27;app.jar&#x27;</span></span><br><span class="line">    dependsOn asciidoctor</span><br><span class="line">    <span class="comment">//실제 배포 시, BOOT-INF/classes가 classpath가 됩니다.</span></span><br><span class="line">    from (<span class="string">&quot;$&#123;asciidoctor.outputDir&#125;/html5&quot;</span>) &#123;</span><br><span class="line">        into <span class="string">&quot;BOOT-INF/classes/static/docs&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">compileKotlin &#123;</span><br><span class="line">    kotlinOptions &#123;</span><br><span class="line">        freeCompilerArgs = [<span class="string">&quot;-Xjsr305=strict&quot;</span>]</span><br><span class="line">        jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">compileTestKotlin &#123;</span><br><span class="line">    kotlinOptions &#123;</span><br><span class="line">        freeCompilerArgs = [<span class="string">&quot;-Xjsr305=strict&quot;</span>]</span><br><span class="line">        jvmTarget = <span class="string">&quot;1.8&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">jar.enabled = <span class="literal">false</span></span><br><span class="line">bootJar.enabled = <span class="literal">true</span></span><br><span class="line">bootJar.mainClassName = <span class="string">&#x27;com.example.restdocs.RestdocsApplication&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ul>
<li><code>testImplementation &#39;org.springframework.restdocs:spring-restdocs-mockmvc&#39;</code> : mockMvc 테스트를 통해 API adoc 파일을 생성해주도록 하는 라이브러리 입니다.</li>
<li><code>id &#39;org.asciidoctor.convert&#39; version &#39;1.5.9.2&#39;</code> : asciidoc 파일을 html 파일로 processing 해주는 플러그인 입니다.</li>
<li><code>asciidoctor</code> :  asciidoc 파일을 html 파일로 processing 해주는 Gradle Task를 정의합니다.</li>
</ul>
<h2 id="User-API-코드-작성"><a href="#User-API-코드-작성" class="headerlink" title="User API 코드 작성"></a>User API 코드 작성</h2><h2 id="UserController-kt"><a href="#UserController-kt" class="headerlink" title="UserController.kt"></a>UserController.kt</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@Suppress(<span class="string">&quot;SpringJavaInjectionPointsAutowiringInspection&quot;</span>)</span></span><br><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="meta">@RequestMapping(<span class="string">&quot;/user&quot;</span>)</span></span><br><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">UserController</span></span>(</span><br><span class="line">        <span class="keyword">val</span> userService: UserService</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(<span class="string">&quot;/&#123;userId&#125;&quot;</span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">getUser</span><span class="params">(<span class="meta">@PathVariable(value = <span class="string">&quot;userId&quot;</span>)</span> userId: <span class="type">Long</span>)</span></span>: Response&lt;User&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> searchUser = userService.search(userId)</span><br><span class="line">    <span class="keyword">return</span> Response.success(searchUser)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">createUser</span><span class="params">(<span class="meta">@RequestBody</span> userDto: <span class="type">UserDto</span>)</span></span>: Response&lt;User&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> createUser = userService.create(User(name = userDto.name, address = userDto.address, age = userDto.age))</span><br><span class="line">    <span class="keyword">return</span> Response.success(createUser)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="meta">@PutMapping(<span class="string">&quot;/&#123;userId&#125;&quot;</span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">updateUser</span><span class="params">(<span class="meta">@PathVariable(<span class="string">&quot;userId&quot;</span>)</span> userId: <span class="type">Long</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                 <span class="meta">@RequestBody</span> userDto: <span class="type">UserDto</span>)</span></span>: Response&lt;User&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> updateUser = userService.update(User(id = userId, name = userDto.name, address = userDto.address, age = userDto.age))</span><br><span class="line">    <span class="keyword">return</span> Response.success(updateUser)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@DeleteMapping(<span class="string">&quot;/&#123;userId&#125;&quot;</span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">deleteUser</span><span class="params">(<span class="meta">@PathVariable(value = <span class="string">&quot;userId&quot;</span>)</span> userId: <span class="type">Long</span>)</span></span>: Response&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    userService.delete(userId)</span><br><span class="line">    <span class="keyword">return</span> Response.success()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@PostMapping(<span class="string">&quot;/&#123;userId&#125;/role/&#123;roleId&#125;&quot;</span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">grantRole</span><span class="params">(<span class="meta">@PathVariable(value = <span class="string">&quot;userId&quot;</span>)</span> userId: <span class="type">Long</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="meta">@PathVariable(value = <span class="string">&quot;roleId&quot;</span>)</span> roleId: <span class="type">Long</span>)</span></span>: Response&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">     userService.grantRole(userId = userId, roleId = roleId)</span><br><span class="line">    <span class="keyword">return</span> Response.success()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="UserService-kt"><a href="#UserService-kt" class="headerlink" title="UserService.kt"></a>UserService.kt</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">interface</span> <span class="title">UserService</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">search</span><span class="params">(userId: <span class="type">Long</span>)</span></span>: User?</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">create</span><span class="params">(user: <span class="type">User</span>)</span></span>: User?</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">update</span><span class="params">(user: <span class="type">User</span>)</span></span>: User?</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">delete</span><span class="params">(userId: <span class="type">Long</span>)</span></span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">grantRole</span><span class="params">(userId: <span class="type">Long</span>, roleId: <span class="type">Long</span>)</span></span>: User?</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Response-kt"><a href="#Response-kt" class="headerlink" title="Response.kt"></a>Response.kt</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span>&lt;<span class="type">T</span>&gt;</span>(</span><br><span class="line">        <span class="keyword">val</span> code: <span class="built_in">Int</span>,</span><br><span class="line">        <span class="keyword">val</span> message: String,</span><br><span class="line">        <span class="keyword">val</span> <span class="keyword">data</span>: T?,</span><br><span class="line">        <span class="keyword">val</span> error: T?</span><br><span class="line">) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">success</span><span class="params">()</span></span>: Response&lt;<span class="built_in">Unit</span>&gt; = success(<span class="literal">null</span>)</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">success</span><span class="params">(<span class="keyword">data</span>: <span class="type">T</span>?)</span></span>: Response&lt;T&gt; = Response(<span class="number">200</span>, <span class="string">&quot;OK&quot;</span>, <span class="keyword">data</span>, <span class="literal">null</span>)</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">error</span><span class="params">(error: <span class="type">T</span>?)</span></span>: Response&lt;T&gt; = Response(<span class="number">500</span>, <span class="string">&quot;Server Error&quot;</span>, <span class="literal">null</span>, error)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="User-kt"><a href="#User-kt" class="headerlink" title="User.kt"></a>User.kt</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">data</span> <span class="class"><span class="keyword">class</span> <span class="title">User</span></span>(</span><br><span class="line">        <span class="keyword">val</span> id: <span class="built_in">Long</span>? = <span class="literal">null</span>,</span><br><span class="line">        <span class="keyword">val</span> name: String,</span><br><span class="line">        <span class="keyword">val</span> age: <span class="built_in">Int</span>,</span><br><span class="line">        <span class="keyword">val</span> address: String,</span><br><span class="line">        <span class="keyword">var</span> roles: MutableList&lt;Role&gt; = mutableListOf()</span><br><span class="line">)</span><br></pre></td></tr></table></figure>



<h2 id="Test-코드-작성"><a href="#Test-코드-작성" class="headerlink" title="Test 코드 작성"></a>Test 코드 작성</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(RestDocumentationExtension::class, SpringExtension::class)</span> <span class="comment">// (1)</span></span><br><span class="line"><span class="meta">@WebMvcTest(UserController::class, secure = false)</span> <span class="comment">// (2)</span></span><br><span class="line"><span class="meta">@AutoConfigureRestDocs</span> <span class="comment">// (3)</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">UserControllerTest</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">lateinit</span> <span class="keyword">var</span> mockMvc: MockMvc <span class="comment">// (4)</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@MockBean</span></span><br><span class="line">  <span class="keyword">lateinit</span> <span class="keyword">var</span> userService: UserService <span class="comment">// (5)</span></span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> `user search api docs`<span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//given</span></span><br><span class="line">    given(userService.search((eq(<span class="number">1L</span>))))</span><br><span class="line">            .willReturn(User(<span class="number">1</span>, <span class="string">&quot;배달이&quot;</span>, <span class="number">10</span>, <span class="string">&quot;서울특별시 송파구 올림픽로 295&quot;</span>)) <span class="comment">// (6)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//when</span></span><br><span class="line">    <span class="keyword">val</span> resultActions = mockMvc.perform(</span><br><span class="line">            RestDocumentationRequestBuilders.<span class="keyword">get</span>(<span class="string">&quot;/user/&#123;userId&#125;&quot;</span>, <span class="number">1</span>)</span><br><span class="line">                    .header(<span class="string">&quot;x-api-key&quot;</span>, <span class="string">&quot;API-KEY&quot;</span>)</span><br><span class="line">                    .accept(MediaType.APPLICATION_JSON_UTF8)</span><br><span class="line">    ).andDo(MockMvcResultHandlers.print()) <span class="comment">// (7)</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//then</span></span><br><span class="line">    resultActions</span><br><span class="line">            .andExpect(status().isOk) <span class="comment">// (8)</span></span><br><span class="line">            .andDo(</span><br><span class="line">                    document(</span><br><span class="line">                            <span class="string">&quot;user-search&quot;</span>, <span class="comment">// (9)</span></span><br><span class="line">                            getDocumentRequest(), <span class="comment">// (10)</span></span><br><span class="line">                            getDocumentResponse(), <span class="comment">// (11)</span></span><br><span class="line">                            requestHeaders(*header()),  <span class="comment">// (12)</span></span><br><span class="line">                      	    pathParameters(userIdPathParameter()),  <span class="comment">// (13)</span></span><br><span class="line">                            responseFields(*common())  <span class="comment">// (14)</span></span><br><span class="line">                                    .andWithPrefix(<span class="string">&quot;data.&quot;</span>, *user()) </span><br><span class="line">                                    .andWithPrefix(<span class="string">&quot;data.roles[].&quot;</span>, *role())</span><br><span class="line">                    )</span><br><span class="line">            )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  &#123;...&#125; <span class="comment">//중략..</span></span><br><span class="line">  </span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">getUserDto</span><span class="params">()</span></span>: String &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">      &#123;</span></span><br><span class="line"><span class="string">        &quot;name&quot;: &quot;배달이&quot;,</span></span><br><span class="line"><span class="string">        &quot;age&quot;: 10,</span></span><br><span class="line"><span class="string">        &quot;address&quot;: &quot;서울특별시 송파구 올림픽로 295&quot;</span></span><br><span class="line"><span class="string">      &#125;</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span>.trimIndent()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">header</span><span class="params">()</span></span>: Array&lt;HeaderDescriptor&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> arrayOf(headerWithName(<span class="string">&quot;x-api-key&quot;</span>).description(<span class="string">&quot;Api Key&quot;</span>))</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">userIdPathParameter</span><span class="params">()</span></span>: ParameterDescriptor &#123;</span><br><span class="line">    <span class="keyword">return</span> parameterWithName(<span class="string">&quot;userId&quot;</span>).description(<span class="string">&quot;USER ID&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">roleIdPathParameter</span><span class="params">()</span></span>: ParameterDescriptor &#123;</span><br><span class="line">    <span class="keyword">return</span> parameterWithName(<span class="string">&quot;roleId&quot;</span>).description(<span class="string">&quot;ROLE ID&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">common</span><span class="params">()</span></span>: Array&lt;FieldDescriptor&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> arrayOf(</span><br><span class="line">            fieldWithPath(<span class="string">&quot;code&quot;</span>).type(JsonFieldType.NUMBER).description(<span class="string">&quot;응답 코드&quot;</span>),</span><br><span class="line">            fieldWithPath(<span class="string">&quot;message&quot;</span>).type(JsonFieldType.STRING).description(<span class="string">&quot;응답 메세지&quot;</span>),</span><br><span class="line">            subsectionWithPath(<span class="string">&quot;error&quot;</span>).type(JsonFieldType.OBJECT).description(<span class="string">&quot;에러 Data&quot;</span>).optional(),</span><br><span class="line">            subsectionWithPath(<span class="string">&quot;data&quot;</span>).type(JsonFieldType.OBJECT).description(<span class="string">&quot;응답 Data&quot;</span>).optional()</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">user</span><span class="params">()</span></span>: Array&lt;FieldDescriptor&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> arrayOf(</span><br><span class="line">            fieldWithPath(<span class="string">&quot;id&quot;</span>).type(JsonFieldType.NUMBER).description(<span class="string">&quot;User ID&quot;</span>),</span><br><span class="line">            fieldWithPath(<span class="string">&quot;name&quot;</span>).type(JsonFieldType.STRING).description(<span class="string">&quot;이름&quot;</span>),</span><br><span class="line">            fieldWithPath(<span class="string">&quot;age&quot;</span>).type(JsonFieldType.NUMBER).description(<span class="string">&quot;나이&quot;</span>),</span><br><span class="line">            fieldWithPath(<span class="string">&quot;address&quot;</span>).type(JsonFieldType.STRING).description(<span class="string">&quot;주소&quot;</span>)</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">role</span><span class="params">()</span></span>: Array&lt;FieldDescriptor&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> arrayOf(</span><br><span class="line">            fieldWithPath(<span class="string">&quot;id&quot;</span>).type(JsonFieldType.NUMBER).description(<span class="string">&quot;Role ID&quot;</span>).optional(),</span><br><span class="line">            fieldWithPath(<span class="string">&quot;name&quot;</span>).type(JsonFieldType.STRING).description(<span class="string">&quot;Role명&quot;</span>).optional()</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">object</span> RestApiDocumentUtils &#123;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">getDocumentRequest</span><span class="params">()</span></span>: OperationRequestPreprocessor &#123; <span class="comment">// (10)</span></span><br><span class="line">    <span class="keyword">return</span> Preprocessors.preprocessRequest(</span><br><span class="line">            modifyUris()</span><br><span class="line">              .scheme(<span class="string">&quot;http&quot;</span>)</span><br><span class="line">              .host(<span class="string">&quot;user.api.com&quot;</span>)</span><br><span class="line">              .removePort(),</span><br><span class="line">            Preprocessors.prettyPrint()</span><br><span class="line">    )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">getDocumentResponse</span><span class="params">()</span></span>: OperationResponsePreprocessor &#123; <span class="comment">// (11)</span></span><br><span class="line">    <span class="keyword">return</span> Preprocessors.preprocessResponse(Preprocessors.prettyPrint())</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="코드-설명"><a href="#코드-설명" class="headerlink" title="코드 설명"></a>코드 설명</h3><ol>
<li>Junit5에서 Spring Rest Docs를 사용할 때, RestDocumentationExtension::class, SpringExtension::class Extension 두개를 사용합니다.<br>  ExtendWith는 Junit 4 에서 RunWith와 같은 기능입니다.</li>
<li>@WebMvcTest annotation을 사용하여, mockMvc를 사용할 수 있는 환경을 설정합니다.  </li>
<li>이 예제에서는 UserController에 대한 테스트와 API문서를 작성하므로, controller를 UserController로 지정합니다.</li>
<li>spring security를 사용하는 경우, <code>secure=false</code> 옵션을 통해 Spring Security 사용 안함으로 설정할 수 있습니다.</li>
<li>Spring Rest Docs에 대한 Auto Configuration을 설정합니다.</li>
<li>mockMvc를 사용하기 위해 MockMvc bean을 Autowiring 해줍니다.</li>
<li>UserService에 대한 Mocking을 위해 @MockBean annotation을 통해 Test Context에 bean으로 등록해줍니다.</li>
<li>UserService.search() function에 대한 stubbing을 해줍니다. (호출 시, return 되는 값 지정)</li>
<li>mockMvc를 이용하여, <code>GET /user/1</code> API를 호출 합니다.</li>
<li>API 호출 결과에 대해 간단한 status체크 정도로 테스트 항목을 추가했습니다.</li>
<li>andDo function으로 Asciidoc을 생성하도록 설정합니다.<br>  <code>user-search</code>는 테스트가 수행 된 후, adoc 파일이 생성될 디렉토리 이름입니다.<br>  <code>/build/generate-snippets/user-search/*.adoc</code> path에 adoc 파일이 생성됩니다.</li>
<li>DocumentRequest에 대한 설정을 추가합니다.</li>
<li>modifyUris()를 통해 adoc 파일에 어떤 도메인으로 API를 호출 할 지, 정의할 수 있습니다.<br>(Default는 <code>http://localhost:8080</code> 입니다.)</li>
<li>Request Json을 이쁘장하게 출력하도록 해줍니다</li>
<li>DocumentResponse에 대한 설정을 추가합니다.</li>
<li>Response Json을 이쁘장하게 출력하도록 해줍니다</li>
<li>requestHeader 정보를 추가합니다.</li>
<li>path parameter 정보를 추가합니다.</li>
<li>responseFields 정보를 추가합니다.</li>
</ol>
<h2 id="Document-생성하기"><a href="#Document-생성하기" class="headerlink" title="Document 생성하기"></a>Document 생성하기</h2><p>asciidoctor를 이용하면 6개의 snippet 파일을 기본적으로 생성해줍니다.</p>
<h3 id="예시-1"><a href="#예시-1" class="headerlink" title="예시"></a>예시</h3><ul>
<li><code>&lt;output-directory&gt;/&lt;document-name&gt;/curl-request.adoc</code> <figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[source,bash]</span><br><span class="line">----</span><br><span class="line">$ curl &#x27;http://user.api.com/user/1&#x27; -i -X GET \</span><br><span class="line">    -H &#x27;Accept: application/json;charset=UTF-8&#x27; \</span><br><span class="line">    -H &#x27;x-api-key: API-KEY&#x27;</span><br><span class="line">----</span><br></pre></td></tr></table></figure></li>
<li><code>&lt;output-directory&gt;/&lt;document-name&gt;/http-request.adoc</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[source,http,options=&quot;nowrap&quot;]</span><br><span class="line">----</span><br><span class="line">GET /user/1 HTTP/1.1</span><br><span class="line">Accept: application/json;charset=UTF-8</span><br><span class="line">Host: user.api.com</span><br><span class="line">x-api-key: API-KEY</span><br><span class="line"></span><br><span class="line">----</span><br></pre></td></tr></table></figure></li>
<li><code>&lt;output-directory&gt;/&lt;document-name&gt;/http-response.adoc</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[source,http,options=&quot;nowrap&quot;]</span><br><span class="line">----</span><br><span class="line">GET /user/1 HTTP/1.1</span><br><span class="line">Accept: application/json;charset=UTF-8</span><br><span class="line">Host: user.api.com</span><br><span class="line">x-api-key: API-KEY</span><br><span class="line"></span><br><span class="line">----</span><br></pre></td></tr></table></figure></li>
<li><code>&lt;output-directory&gt;/&lt;document-name&gt;/httpie-request.adoc</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[source,bash]</span><br><span class="line">----</span><br><span class="line">$ http GET &#x27;http://user.api.com/user/1&#x27; \</span><br><span class="line">    &#x27;Accept:application/json;charset=UTF-8&#x27; \</span><br><span class="line">    &#x27;x-api-key:API-KEY&#x27;</span><br><span class="line">----</span><br></pre></td></tr></table></figure></li>
<li><code>&lt;output-directory&gt;/&lt;document-name&gt;/request-body.adoc</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[source,http,options=&quot;nowrap&quot;]</span><br><span class="line">----</span><br><span class="line">&#123;</span><br><span class="line">  &quot;name&quot;: &quot;홍길동&quot;</span><br><span class="line">&#125;</span><br><span class="line">----</span><br></pre></td></tr></table></figure></li>
<li><code>&lt;output-directory&gt;/&lt;document-name&gt;/response-body.adoc</code><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[source,options=&quot;nowrap&quot;]</span><br><span class="line">----</span><br><span class="line">&#123;</span><br><span class="line">  &quot;code&quot; : 200,</span><br><span class="line">  &quot;message&quot; : &quot;OK&quot;,</span><br><span class="line">  &quot;data&quot; : &#123;</span><br><span class="line">    &quot;id&quot; : 1,</span><br><span class="line">    &quot;name&quot; : &quot;배달이&quot;,</span><br><span class="line">    &quot;age&quot; : 10,</span><br><span class="line">    &quot;address&quot; : &quot;서울특별시 송파구 올림픽로 295&quot;,</span><br><span class="line">    &quot;roles&quot; : [ ]</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;error&quot; : null</span><br><span class="line">&#125;</span><br><span class="line">----</span><br></pre></td></tr></table></figure></li>
</ul>
<p>Optional하게 생성되는 snippet도 존재합니다.</p>
<ul>
<li><code>&lt;output-directory&gt;/&lt;document-name&gt;/path-parameters.adoc.adoc</code> : Path Parameters에 대한 정보를 표로 나타냅니다.</li>
<li><code>&lt;output-directory&gt;/&lt;document-name&gt;/request-headers.adoc.adoc</code> : request header에 대한 정보를 표로 나타냅니다.</li>
<li><code>&lt;output-directory&gt;/&lt;document-name&gt;/request-fieldadoc</code> : request fields에 대한 정보를 표로 나타냅니다.</li>
<li><code>&lt;output-directory&gt;/&lt;document-name&gt;/response-fields.adoc</code> : response fields에 대한 정보를 표로 나타냅니다.</li>
</ul>
<h3 id="API-Document-생성하기"><a href="#API-Document-생성하기" class="headerlink" title="API Document 생성하기"></a>API Document 생성하기</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">ifndef::snippets[]</span><br><span class="line">:snippets: ../../../build/generated-snippets</span><br><span class="line">endif::[]</span><br><span class="line">:doctype: book</span><br><span class="line">:icons: font</span><br><span class="line">:source-highlighter: highlightjs</span><br><span class="line">:toc: left</span><br><span class="line">:toclevels: 4</span><br><span class="line">:sectlinks:</span><br><span class="line">:site-url: /build/asciidoc/html5/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">== Request</span><br><span class="line"></span><br><span class="line">=== [Request URL]</span><br><span class="line">....</span><br><span class="line">GET /user/&#123;userId&#125;</span><br><span class="line">Content-Type: application/json;charset=UTF-8</span><br><span class="line">....</span><br><span class="line"></span><br><span class="line">=== [Request Headers]</span><br><span class="line">include::&#123;snippets&#125;/user-search/request-headers.adoc[]</span><br><span class="line"></span><br><span class="line">=== [Request Path Parameters]</span><br><span class="line"></span><br><span class="line">include::&#123;snippets&#125;/user-search/path-parameters.adoc[]</span><br><span class="line"></span><br><span class="line">=== [Request HTTP Example]</span><br><span class="line"></span><br><span class="line">include::&#123;snippets&#125;/user-search/http-request.adoc[]</span><br><span class="line"></span><br><span class="line">== Response</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">=== [Response Fields]</span><br><span class="line"></span><br><span class="line">include::&#123;snippets&#125;/user-search/response-fields.adoc[]</span><br><span class="line"></span><br><span class="line">=== [Response HTTP Example]</span><br><span class="line"></span><br><span class="line">include::&#123;snippets&#125;/user-search/http-response.adoc[]</span><br></pre></td></tr></table></figure>
<ul>
<li>&#x2F;src&#x2F;docs&#x2F;asciidoc 디렉토리를 생성하고 user-search.adoc 파일을 생성합니다.</li>
<li>이 파일은 html로 변환될 adoc 파일입니다.</li>
<li>snippet에 대한 path를 지정하고 <code>include::</code> 를 통해 adoc 파일을 include하여 processing 할 수 있습니다.</li>
<li>include 된 파일은 include한 부분에 html 태그로 직접 삽입됩니다.</li>
<li>processing 된 html 파일은 <code>/build/docs/html5</code> 디렉토리에 생성됩니다 (default)</li>
<li>부가적으로 API 문서에 대한 내용을 작성하여 API 문서를 만들 수 있습니다. (ex: API 설명, 담당자, 주의사항)</li>
</ul>
<h1 id="HTML-문서-Serving-해보기"><a href="#HTML-문서-Serving-해보기" class="headerlink" title="HTML 문서 Serving 해보기"></a>HTML 문서 Serving 해보기</h1><p>Spring Rest Docs로 만들어진 API 문서의 최종 형태는 HTML 파일로 제공됩니다.<br>그렇기 때문에 Spring Static Resource Handler를 이용하여 간단하게 html 파일을 Serving하여 웹 브라우져를 통해 사용자에게 API문서를 제공 할 수 있습니다.  </p>
<p>SpringBoot의 WebMvcConfigure를 상속하여 Configuration을 추가합니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.example.restdocs.configuration</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.<span class="keyword">annotation</span>.Configuration</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.<span class="keyword">annotation</span>.ResourceHandlerRegistry</span><br><span class="line"><span class="keyword">import</span> org.springframework.web.servlet.config.<span class="keyword">annotation</span>.WebMvcConfigurer</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="keyword">open</span> <span class="class"><span class="keyword">class</span> <span class="title">WebMvcConfig</span>: <span class="type">WebMvcConfigurer &#123;</span></span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">addResourceHandlers</span><span class="params">(registry: <span class="type">ResourceHandlerRegistry</span>)</span></span> &#123;</span><br><span class="line">    registry.addResourceHandler(<span class="string">&quot;/docs/**&quot;</span>).addResourceLocations(<span class="string">&quot;classpath:/static/docs/&quot;</span>)</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위와 같이 설정을 추가하게 되면<br> <code>localhost:8080/docs/index.html</code>  과 같이 <code>/docs/**</code> 패턴으로 유입되는 url에 대해<br>classpath 하위의 &#x2F;static&#x2F;docs&#x2F; 디렉토리 아래의 파일을 찾아 반환하도록 해줍니다.</p>
<p><img src="./static-resource-path.png"></p>
<h1 id="여러가지-Function-사용해보기"><a href="#여러가지-Function-사용해보기" class="headerlink" title="여러가지 Function 사용해보기"></a>여러가지 Function 사용해보기</h1><h2 id="PathParameters"><a href="#PathParameters" class="headerlink" title="PathParameters"></a>PathParameters</h2><ul>
<li>API의 Path Parameter에 대한 Snippet을 생성합니다. </li>
<li>&#x2F;build&#x2F;generated-snippets&#x2F;&lt;document-name&gt;&#x2F;path-parameters.adoc 인 파일명으로 생성됩니다.</li>
<li>pathParameter(parameterWithName(“key 명칭”).description(“key가 의미 하는 내용”)) 으로 코드를 작성합니다.</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">resultActions</span><br><span class="line">            .andExpect(status().isOk)</span><br><span class="line">            .andDo(</span><br><span class="line">                    document(</span><br><span class="line">                            <span class="string">&quot;user-update&quot;</span>,</span><br><span class="line">                            getDocumentRequest(),</span><br><span class="line">                            getDocumentResponse(),</span><br><span class="line">                            requestHeaders(*header()),</span><br><span class="line">                            pathParameters(parameterWithName(<span class="string">&quot;userId&quot;</span>).description(<span class="string">&quot;유저 ID&quot;</span>)),</span><br><span class="line">                            responseFields(*common())</span><br><span class="line">                                    .andWithPrefix(<span class="string">&quot;data.&quot;</span>, *user())</span><br><span class="line">                                    .andWithPrefix(<span class="string">&quot;data.roles[].&quot;</span>, *role())</span><br><span class="line">                    )</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>



<h2 id="requestHeader"><a href="#requestHeader" class="headerlink" title="requestHeader"></a>requestHeader</h2><ul>
<li>API의 Request Header에 대한 Snippet을 생성합니다.</li>
<li>&#x2F;build&#x2F;generated-snippets&#x2F;&lt;document-name&gt;&#x2F;request-headers.adoc 인 파일명으로 생성됩니다.</li>
<li>requestHeader(headerWithName(“header-key명”).description(“header-key가 의미하는 내용”))</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">resultActions</span><br><span class="line">          .andExpect(status().isOk)</span><br><span class="line">          .andDo(</span><br><span class="line">                  document(</span><br><span class="line">                          <span class="string">&quot;user-grant-role&quot;</span>,</span><br><span class="line">                          getDocumentRequest(),</span><br><span class="line">                          getDocumentResponse(),</span><br><span class="line">                          requestHeaders(headerWithName(<span class="string">&quot;api-auth-key&quot;</span>).description(<span class="string">&quot;API 인증 키&quot;</span>)),</span><br><span class="line">                    	  pathParameters(userIdPathParameter(), roleIdPathParameter()),</span><br><span class="line">                          responseFields(*common())</span><br><span class="line">                                  .andWithPrefix(<span class="string">&quot;data.&quot;</span>, *user())</span><br><span class="line">                                  .andWithPrefix(<span class="string">&quot;data.roles[].&quot;</span>, *role())</span><br><span class="line">                  )</span><br><span class="line">          )</span><br></pre></td></tr></table></figure>



<h2 id="fieldWithPath"><a href="#fieldWithPath" class="headerlink" title="fieldWithPath"></a>fieldWithPath</h2><ul>
<li>API의 Request, Response Snippet을 구성하는 요소를 정의하는 가장 기본적인 function입니다.</li>
<li>fieldWithPath(“key”) 형태로 API Request, Response 내의 요소를 정의 할 수 있습니다.</li>
<li>Attributes<ul>
<li>description(“내용”) : Request, Response 내의 요소의 내용을 정의합니다.</li>
<li>type(JsonFieldType.TYPE) : Request, Response 내의 요소의 타입을 정의합니다.</li>
<li>optional() : Request, Response 내의 요소의 필수값 여부를 정의합니다. (optional()를 선언하면 필수값 아님)</li>
</ul>
</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">resultActions</span><br><span class="line">            .andExpect(status().isOk)</span><br><span class="line">            .andDo(</span><br><span class="line">                    document(</span><br><span class="line">                            <span class="string">&quot;user-grant-role&quot;</span>,</span><br><span class="line">                            getDocumentRequest(),</span><br><span class="line">                            getDocumentResponse(),</span><br><span class="line">                            requestHeaders(*header()),</span><br><span class="line">                            pathParameters(userIdPathParameter(), roleIdPathParameter()),</span><br><span class="line">                            responseFields(</span><br><span class="line">                            fieldWithPath(<span class="string">&quot;code&quot;</span>).type(JsonFieldType.NUMBER).description(<span class="string">&quot;응답 코드&quot;</span>),</span><br><span class="line">            		    fieldWithPath(<span class="string">&quot;message&quot;</span>).type(JsonFieldType.STRING).description(<span class="string">&quot;응답 메세지&quot;</span>),</span><br><span class="line">            		    subsectionWithPath(<span class="string">&quot;error&quot;</span>).type(JsonFieldType.OBJECT).description(<span class="string">&quot;에러 Data&quot;</span>).optional(),</span><br><span class="line">            		    subsectionWithPath(<span class="string">&quot;data&quot;</span>).type(JsonFieldType.OBJECT).description(<span class="string">&quot;응답 Data&quot;</span>).optional()</span><br><span class="line">		      )</span><br><span class="line">                      .andWithPrefix(<span class="string">&quot;data.&quot;</span>, *user())</span><br><span class="line">                      .andWithPrefix(<span class="string">&quot;data.roles[].&quot;</span>, *role())</span><br><span class="line">                    )</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>



<h2 id="subSectionWithPath"><a href="#subSectionWithPath" class="headerlink" title="subSectionWithPath"></a>subSectionWithPath</h2><ul>
<li>API Request, Response Snippet을 구성하는 요소를 정의하는 function입니다.</li>
<li>요소의 하위를 선언하고 싶지 않거나, 가변적인 Request, Response가 오는 경우 사용하기 좋습니다.</li>
<li>subSectionWithPath는 root key가 존재하는 지만 체크하고 하위 key에 대한 체크는 하지 않습니다.</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;Parameter validation error&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">4000</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;receivers[0].phone&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;010469090&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;errorMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;유효하지 않은 수신자 번호입니다.&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>위와 같은 응답이 오는 경우</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">resultActions</span><br><span class="line">            .andExpect(status().isOk)</span><br><span class="line">            .andDo(</span><br><span class="line">                    document(</span><br><span class="line">                            <span class="string">&quot;user-grant-role&quot;</span>,</span><br><span class="line">                            getDocumentRequest(),</span><br><span class="line">                            getDocumentResponse(),</span><br><span class="line">                            requestHeaders(*header()),</span><br><span class="line">                            pathParameters(userIdPathParameter(), roleIdPathParameter()),</span><br><span class="line">                            responseFields(*common())</span><br><span class="line">                                    .and(fieldWithPath(<span class="string">&quot;errors&quot;</span>).type(JsonFieldType.ARRAY).description(<span class="string">&quot;에러 Data&quot;</span>)) <span class="comment">//에러 발생!!</span></span><br><span class="line">                    )</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<p>아래와 같은 에러가 발생하게 됩니다.<br>에러 내용을 요약하자면, payload에 있는 정보를 문서화 하지 않았다는 에러입니다.<br>즉, errors 하위에 field, value, errorMessage 정보를 문서화 하지 않았기 때문에 발생하는 에러입니다.</p>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">org.springframework.restdocs.snippet.SnippetException<span class="punctuation">:</span> The following parts of the payload were not documented<span class="punctuation">:</span></span><br><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;errors&quot;</span><span class="punctuation">:</span> <span class="punctuation">[</span></span><br><span class="line">    <span class="punctuation">&#123;</span></span><br><span class="line">      <span class="attr">&quot;field&quot;</span><span class="punctuation">:</span> <span class="string">&quot;receivers[0].phone&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;value&quot;</span><span class="punctuation">:</span> <span class="string">&quot;010469090&quot;</span><span class="punctuation">,</span></span><br><span class="line">      <span class="attr">&quot;errorMessage&quot;</span><span class="punctuation">:</span> <span class="string">&quot;유효하지 않은 수신자 번호입니다.&quot;</span></span><br><span class="line">    <span class="punctuation">&#125;</span></span><br><span class="line">  <span class="punctuation">]</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>하지만 subSectionWithPath를 사용하게 되면 errors 하위에 대한 정보는 문서화 하지 않겠다!를 의미하므로<br>에러가 발생하지 않고, errors 까지만 문서화 됩니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">resultActions</span><br><span class="line">            .andExpect(status().isOk)</span><br><span class="line">            .andDo(</span><br><span class="line">                    document(</span><br><span class="line">                            <span class="string">&quot;user-grant-role&quot;</span>,</span><br><span class="line">                            getDocumentRequest(),</span><br><span class="line">                            getDocumentResponse(),</span><br><span class="line">                            requestHeaders(*header()),</span><br><span class="line">                            pathParameters(userIdPathParameter(), roleIdPathParameter()),</span><br><span class="line">                            responseFields(*common())</span><br><span class="line">                                    .and(subSectionWithPath(<span class="string">&quot;errors&quot;</span>).type(JsonFieldType.ARRAY).description(<span class="string">&quot;에러 Data&quot;</span>)) </span><br><span class="line">                    )</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>



<h2 id="responseField-and"><a href="#responseField-and" class="headerlink" title="responseField().and()"></a>responseField().and()</h2><ul>
<li>response에 대한 Field정보가 많은 경우 가독성을 해칠 수 있고, Field Snippet에 대한 재사용성이 떨어질 수 있습니다.</li>
<li>이럴때 and를 사용하면 좋습니다.</li>
<li>requestField(), responseField() 함수 뒤에 and() 함수를 사용하여 FieldDescriptor에 대한 Concatenation이 가능합니다.</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;OK&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;배달이&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;서울특별시 송파구 올림픽로 295&quot;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>위와 같이 모든 요소가 1레벨인 Json이 Response로 오는 경우<br>code, message 는 모든 API Response에 대한 공통 요소 입니다.<br>id, name, age, address는 User API Response에만 응답오는 요소라고 할 떄,<br>두 요소에 대한 관리를 별도로 하여 재사용성을 높일 수 있습니다.</p>
<p>아래와 같이 and를 사용하여 Response에 대한 FieldDesciptor를 concatenation 하여 구성할 수 있습니다. </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">resultActions</span><br><span class="line">            .andExpect(status().isOk)</span><br><span class="line">            .andDo(</span><br><span class="line">                    document(</span><br><span class="line">                            <span class="string">&quot;user-update&quot;</span>,</span><br><span class="line">                            getDocumentRequest(),</span><br><span class="line">                            getDocumentResponse(),</span><br><span class="line">                            requestHeaders(*header()),</span><br><span class="line">                            pathParameters(userIdPathParameter()),</span><br><span class="line">                            responseFields(*common())</span><br><span class="line">                                    .and(*user())</span><br><span class="line">                    )</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>



<h2 id="responseField-andWithPrefix"><a href="#responseField-andWithPrefix" class="headerlink" title="responseField().andWithPrefix()"></a>responseField().andWithPrefix()</h2><ul>
<li>and()의 사용예제와 동일합니다.</li>
<li>하지만, andWithPrefix는 key 앞에 prefix를 붙여 depth를 표현할 수 있도록 해줍니다.</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;OK&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  	<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;배달이&quot;</span><span class="punctuation">,</span></span><br><span class="line">  	<span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  	<span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;서울특별시 송파구 올림픽로 295&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<p>위와 같이 data에 대한 키가 2레벨인 Json이 Response로 오는 경우<br>아래와 같이 and를 사용하여 Response에 대한 FieldDesciptor를 concatination 하여 구성할 수 있습니다. </p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">resultActions</span><br><span class="line">            .andExpect(status().isOk)</span><br><span class="line">            .andDo(</span><br><span class="line">                    document(</span><br><span class="line">                            <span class="string">&quot;user-update&quot;</span>,</span><br><span class="line">                            getDocumentRequest(),</span><br><span class="line">                            getDocumentResponse(),</span><br><span class="line">                            requestHeaders(*header()),</span><br><span class="line">                            pathParameters(userIdPathParameter()),</span><br><span class="line">                            responseFields(*common())</span><br><span class="line">                                    .andWithPrefix(<span class="string">&quot;data.&quot;</span>, *user())</span><br><span class="line">                    )</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>



<h2 id="beneathPath"><a href="#beneathPath" class="headerlink" title="beneathPath"></a>beneathPath</h2><ul>
<li>API를 사용하다 보면 특정 Field의 명세만 별도로 추출하여 문서화 하는 needs가 있을 수 있습니다.</li>
<li>beneathPath(“data-path”) function을 사용하면 특정 data-path에 대한 field를 별도의 snippet으로 생성해 줍니다.</li>
</ul>
<figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="punctuation">&#123;</span></span><br><span class="line">  <span class="attr">&quot;code&quot;</span><span class="punctuation">:</span> <span class="number">200</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;message&quot;</span><span class="punctuation">:</span> <span class="string">&quot;OK&quot;</span><span class="punctuation">,</span></span><br><span class="line">  <span class="attr">&quot;data&quot;</span> <span class="punctuation">:</span> <span class="punctuation">&#123;</span></span><br><span class="line">    <span class="attr">&quot;id&quot;</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span></span><br><span class="line">  	<span class="attr">&quot;name&quot;</span><span class="punctuation">:</span> <span class="string">&quot;배달이&quot;</span><span class="punctuation">,</span></span><br><span class="line">  	<span class="attr">&quot;age&quot;</span><span class="punctuation">:</span> <span class="number">10</span><span class="punctuation">,</span></span><br><span class="line">  	<span class="attr">&quot;address&quot;</span><span class="punctuation">:</span> <span class="string">&quot;서울특별시 송파구 올림픽로 295&quot;</span></span><br><span class="line">  <span class="punctuation">&#125;</span></span><br><span class="line"><span class="punctuation">&#125;</span></span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">resultActions</span><br><span class="line">            .andExpect(status().isOk)</span><br><span class="line">            .andDo(</span><br><span class="line">                    document(</span><br><span class="line">                            <span class="string">&quot;user-search&quot;</span>,</span><br><span class="line">                            getDocumentRequest(),</span><br><span class="line">                            getDocumentResponse(),</span><br><span class="line">                            requestHeaders(*header()),</span><br><span class="line">                            pathParameters(userIdPathParameter()),</span><br><span class="line">                            responseFields(</span><br><span class="line">                                    beneathPath(<span class="string">&quot;data&quot;</span>).withSubsectionId(<span class="string">&quot;user&quot;</span>),</span><br><span class="line">                                    *user(),</span><br><span class="line">                                    subsectionWithPath(<span class="string">&quot;roles&quot;</span>).description(<span class="string">&quot;User Role&quot;</span>)</span><br><span class="line">                    )</span><br></pre></td></tr></table></figure>
<ul>
<li>data 필드 하위의 내용을 문서화 해줍니다.</li>
<li>beneathPath(“data”) : data 필드 하위의 내용이라는 Path 지정</li>
<li>.withSubsectionId(“user”) : response-fields-user.adoc이라고 SubSectionId로 response-fields.adoc 파일이 별도로 만들어 집니다.</li>
</ul>
<h1 id="Spring-Rest-Docs-추가-기능"><a href="#Spring-Rest-Docs-추가-기능" class="headerlink" title="Spring Rest Docs 추가 기능"></a>Spring Rest Docs 추가 기능</h1><h2 id="Custom-필드-삽입하기"><a href="#Custom-필드-삽입하기" class="headerlink" title="Custom 필드 삽입하기"></a>Custom 필드 삽입하기</h2><ul>
<li>Spring Rest Docs에서 기본적으로 제공하는 path, description, optional, type 이외에 다른 메타정보를 추가하고 싶을 때 Custom 필드를 만들어 사용할 수 있습니다.</li>
<li>AbstractDescriptor에서 제공하는 attributes라는 Map을 이용합니다.</li>
<li>저는 비고, 최대길이라는 필드를 표현하기 위해 Kotlin Extension Function을 이용하여 기능을 추가해보았습니다.</li>
<li>기본적으로 AbstractDescriptor의 attributes라는 Map에 key, value라는 내용을 넣어주면 됩니다.<br>(Java에서는 이 방식을 사용하세요)</li>
</ul>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : AbstractDescriptor&lt;T&gt;</span>&gt; AbstractDescriptor<span class="type">&lt;T&gt;</span>.<span class="title">remarks</span><span class="params">(remarks: <span class="type">String</span>)</span></span>: T &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.attributes(key(<span class="string">&quot;remarks&quot;</span>).value(remarks))</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="type">&lt;T : AbstractDescriptor&lt;T&gt;</span>&gt; AbstractDescriptor<span class="type">&lt;T&gt;</span>.<span class="title">maxLength</span><span class="params">(length: <span class="type">Int</span>)</span></span>: T &#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="keyword">this</span>.attributes(key(<span class="string">&quot;maxLength&quot;</span>).value(length))</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">resultActions</span><br><span class="line">            .andExpect(status().isOk)</span><br><span class="line">            .andDo(</span><br><span class="line">                    document(</span><br><span class="line">                            <span class="string">&quot;user-update&quot;</span>,</span><br><span class="line">                            getDocumentRequest(),</span><br><span class="line">                            getDocumentResponse(),</span><br><span class="line">                            requestHeaders(*header()),</span><br><span class="line">                            pathParameters(userIdPathParameter()</span><br><span class="line">                              .maxLength(<span class="number">10</span>)</span><br><span class="line">                              .remarks(<span class="string">&quot;User ID가 없는 경우는 먼저 생성하세요&quot;</span>)),</span><br><span class="line">                            responseFields(*common())</span><br><span class="line">                                    .andWithPrefix(<span class="string">&quot;data.&quot;</span>, *user())</span><br><span class="line">                                    .andWithPrefix(<span class="string">&quot;data.roles[].&quot;</span>, *role())</span><br><span class="line">                    )</span><br><span class="line">            )</span><br></pre></td></tr></table></figure>

<p>위의 예제에서는 일단 ParameterDescriptor에 maxLength와 remark 속성을 추가 했습니다.<br>ParameterDescriptor 뿐만 아니라, AbstractDescriptor를 구현하는 모든 Descriptor에 적용이 가능합니다.<br>(FieldDescriptor, SubsectionDescriptor, HeaderDescriptor등…)</p>
<p>이렇게 추가한 속성을 snippet에 출력해보도록 하겠습니다.<br>위의 예시는 path parameter에 추가한 속성이므로, path-parameters snippet을 override하여 출력해 줄 수 있습니다.  </p>
<h3 id="path-parameters-snippet-override"><a href="#path-parameters-snippet-override" class="headerlink" title="path-parameters snippet override"></a>path-parameters snippet override</h3><ul>
<li>&#x2F;test&#x2F;org&#x2F;springframework&#x2F;restdocs&#x2F;templates 하위에 path-parameters.snippet 파일을 새로 등록합니다.</li>
<li>snippet 파일은 mustache 문법을 사용합니다.</li>
<li>여기에 제가 추가한 최대길이, 비고 컬럼을 추가하였습니다.</li>
<li>mustache 문법 중 <code>#maxLength</code> 문법은 maxLength 속성이 존재하는가? 라는 if문과 비슷한 문법입니다.</li>
<li>반대되는 문법으로 <code>^maxLength</code> 문법은 maxLength 속성이 존재하지 않는가? 라는 문법입니다.</li>
</ul>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.+&#123;&#123;path&#125;&#125;+</span><br><span class="line">|===</span><br><span class="line">|Parameter|Description|최대길이|비고</span><br><span class="line">&#123;&#123;#parameters&#125;&#125;</span><br><span class="line">|&#123;&#123;#tableCellContent&#125;&#125;`+&#123;&#123;name&#125;&#125;+`&#123;&#123;/tableCellContent&#125;&#125;</span><br><span class="line">|&#123;&#123;#tableCellContent&#125;&#125;&#123;&#123;description&#125;&#125;&#123;&#123;/tableCellContent&#125;&#125;</span><br><span class="line">|&#123;&#123;#tableCellContent&#125;&#125;&#123;&#123;#maxLength&#125;&#125;&#123;&#123;maxLength&#125;&#125;&#123;&#123;/maxLength&#125;&#125;&#123;&#123;/tableCellContent&#125;&#125;</span><br><span class="line">|&#123;&#123;#tableCellContent&#125;&#125;&#123;&#123;#remarks&#125;&#125;&#123;&#123;remarks&#125;&#125;&#123;&#123;/remarks&#125;&#125;&#123;&#123;/tableCellContent&#125;&#125;</span><br><span class="line">&#123;&#123;/parameters&#125;&#125;</span><br><span class="line">|===</span><br></pre></td></tr></table></figure>

<h3 id="결과"><a href="#결과" class="headerlink" title="결과"></a>결과</h3><p><img src="./add-path-parameter-custom-fields.png" alt="add-path-parameter-custom-fields"></p>
<h2 id="Custom-Snippet-생성하기"><a href="#Custom-Snippet-생성하기" class="headerlink" title="Custom Snippet 생성하기"></a>Custom Snippet 생성하기</h2><p>API 문서를 작성하다 보면, 특정 API와 관계없는 응답코드나, Status 값에 대한 명세를 정의하고 문서화 해야 할 요구사항이 있을 수 있습니다.<br>그런 경우 Custom Snippet을 생성하여 문서화하면, 별도로 응답코드나 Status가 추가되거나 변경되어도 항상 문서를 최신화 할 수 있습니다.</p>
<p>생성해야 할 것은 4가지 입니다.</p>
<ol>
<li>Test 용 Controller</li>
<li>Custom Snippet Template 파일</li>
<li>ResponseCodeSnippet 클래스 (AbstractFieldsSnippet 상속)</li>
<li>Test Code</li>
</ol>
<h3 id="Test용-Controller"><a href="#Test용-Controller" class="headerlink" title="Test용 Controller"></a>Test용 Controller</h3><p>MockMvc 기반에서 생성되는 문서이다 보니 사용하지 않더라도, Test용 Controller가 하나 필요합니다.<br>실제 코드에 영향이 없도록 <code>/test</code> 디렉토리 하위에 Controller를 만들었습니다.</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@RestController</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResponseCodeController</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@GetMapping(<span class="string">&quot;/response-code&quot;</span>)</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">getResponseCode</span><span class="params">()</span></span>: Response&lt;<span class="built_in">Unit</span>&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> Response.success()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="Custom-Snippet-Template-파일"><a href="#Custom-Snippet-Template-파일" class="headerlink" title="Custom Snippet Template 파일"></a>Custom Snippet Template 파일</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123;title&#125;&#125;</span><br><span class="line">|===</span><br><span class="line">|Code|Message</span><br><span class="line">&#123;&#123;#fields&#125;&#125;</span><br><span class="line">|&#123;&#123;#tableCellContent&#125;&#125;`+&#123;&#123;path&#125;&#125;+`&#123;&#123;/tableCellContent&#125;&#125;</span><br><span class="line">|&#123;&#123;#tableCellContent&#125;&#125;&#123;&#123;description&#125;&#125;&#123;&#123;/tableCellContent&#125;&#125;</span><br><span class="line">&#123;&#123;/fields&#125;&#125;</span><br><span class="line">|===</span><br></pre></td></tr></table></figure>

<ul>
<li>title을 변수로 받아서 출력할 예정입니다.</li>
<li>표에 출력할 필드는 code값과 description입니다.</li>
</ul>
<h3 id="ResponseCodeSnippet-클래스"><a href="#ResponseCodeSnippet-클래스" class="headerlink" title="ResponseCodeSnippet 클래스"></a>ResponseCodeSnippet 클래스</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResponseCodeSnippet</span></span>(</span><br><span class="line">        name: String, </span><br><span class="line">        descriptors: MutableList&lt;FieldDescriptor&gt;,</span><br><span class="line">        attributes: Map&lt;String, Any&gt;,</span><br><span class="line">        ignoreUndocumentedFields: <span class="built_in">Boolean</span></span><br><span class="line">) : AbstractFieldsSnippet(name, descriptors, attributes, ignoreUndocumentedFields) &#123;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getContentType</span><span class="params">(operation: <span class="type">Operation</span>)</span></span>: MediaType? &#123;</span><br><span class="line">    <span class="keyword">return</span> operation.response.headers.contentType</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getContent</span><span class="params">(operation: <span class="type">Operation</span>)</span></span>: ByteArray &#123;</span><br><span class="line">    <span class="keyword">return</span> operation.response.content</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>name: 생성할 snippet 템플릿의 prefix입니다. (실제 파일은 {name}-fields.snippet 파일로 생성됩니다.)</li>
</ul>
<p><img src="./AbstractFieldSnippet-Constructor.png" alt="AbstractFieldSnippet-Constructor"></p>
<ul>
<li>descriptors : snippet에 출력될 field 정보들입니다. (예제에서는 ResponseCode 하나하나가 Row가 됩니다.)</li>
<li>attributes: snippet에 출력할 추가적인 속성입니다.</li>
</ul>
<h3 id="Test-Code"><a href="#Test-Code" class="headerlink" title="Test Code"></a>Test Code</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@ExtendWith(RestDocumentationExtension::class, SpringExtension::class)</span></span><br><span class="line"><span class="meta">@WebMvcTest(ResponseCodeController::class, secure = false)</span></span><br><span class="line"><span class="meta">@AutoConfigureRestDocs</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ResponseCodeDocs</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">lateinit</span> <span class="keyword">var</span> mockMvc: MockMvc</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Test</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> `build response code snippet`<span class="params">()</span></span> &#123;</span><br><span class="line"></span><br><span class="line">    mockMvc.perform(<span class="keyword">get</span>(<span class="string">&quot;/response-code&quot;</span>)</span><br><span class="line">            .accept(MediaType.APPLICATION_JSON)</span><br><span class="line">    ).andDo(MockMvcResultHandlers.print())</span><br><span class="line">            .andExpect(status().isOk)</span><br><span class="line">            .andDo(</span><br><span class="line">                    document(</span><br><span class="line">                            <span class="string">&quot;common&quot;</span>,</span><br><span class="line">                            responseCodeFields(</span><br><span class="line">                                    <span class="string">&quot;response-code&quot;</span>, <span class="comment">//&#123;name&#125;-fields.snippet 이라는 파일명으로 생성</span></span><br><span class="line">                                    Attributes.attributes(Attributes.key(<span class="string">&quot;title&quot;</span>).value(<span class="string">&quot;공통 응답 코드&quot;</span>)),</span><br><span class="line">                                    *convertResponseCodeToFieldDescriptor(ResponseCode.values())</span><br><span class="line">                            )</span><br><span class="line">                    )</span><br><span class="line">            )</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">responseCodeFields</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">          name: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">          attributes: <span class="type">Map</span>&lt;<span class="type">String</span>, Any&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">          <span class="keyword">vararg</span> descriptors: <span class="type">FieldDescriptor</span></span></span></span><br><span class="line"><span class="params"><span class="function">  )</span></span>: ResponseCodeSnippet &#123;</span><br><span class="line">    <span class="keyword">return</span> ResponseCodeSnippet(name, mutableListOf(*descriptors), attributes, <span class="literal">true</span>)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">convertResponseCodeToFieldDescriptor</span><span class="params">(enumTypes: <span class="type">Array</span>&lt;<span class="type">ResponseCode</span>&gt;)</span></span>: Array&lt;FieldDescriptor&gt; &#123;</span><br><span class="line">    <span class="keyword">return</span> Arrays.stream(enumTypes)</span><br><span class="line">            .map &#123;</span><br><span class="line">              fieldWithPath(it.code.toString()).type(JsonFieldType.NUMBER).description(it.message).optional()</span><br><span class="line">            &#125;</span><br><span class="line">            .collect(Collectors.toList())</span><br><span class="line">            .toTypedArray()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="결과-1"><a href="#결과-1" class="headerlink" title="결과"></a>결과</h3><p><img src="./custom-snippet.png" alt="custom-snippet"></p>
<h3 id="추가"><a href="#추가" class="headerlink" title="추가"></a>추가</h3><p>위의 예시에서는 Custom Field Snippet으로 예시를 들었지만</p>
<ul>
<li>AbstractParametersSnippet</li>
<li>AbstractBodySnippet</li>
<li>AbstractHeadersSnippet</li>
</ul>
<p>위의 AbstractSnippet이 더 있는 걸로 보아 다른 Custom Snippet도 생성할 수 있는 것 같습니다.<br>필요할 때마다 한번씩 써보면 좋겠죠?</p>
<h1 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h1><ul>
<li><a target="_blank" rel="noopener" href="https://docs.spring.io/spring-restdocs/docs/current/reference/html5/#introduction">https://docs.spring.io/spring-restdocs/docs/current/reference/html5/#introduction</a></li>
<li><a target="_blank" rel="noopener" href="https://asciidoctor.org/docs/asciidoctor-gradle-plugin/">https://asciidoctor.org/docs/asciidoctor-gradle-plugin/</a></li>
<li><a target="_blank" rel="noopener" href="https://asciidoctor.org/docs/asciidoc-syntax-quick-reference/">https://asciidoctor.org/docs/asciidoc-syntax-quick-reference/</a></li>
<li><a target="_blank" rel="noopener" href="http://woowabros.github.io/experience/2018/12/28/spring-rest-docs.html">http://woowabros.github.io/experience/2018/12/28/spring-rest-docs.html</a></li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/06/23/2019-06-23-event-driven-architecture/">Event-Driven-Architecture란?</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-06-23</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Kafka/">Kafka</a><span class="article-meta__link">-</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Architecture/">Architecture</a></span><div class="content"><h1 id="Event-Driven-란"><a href="#Event-Driven-란" class="headerlink" title="Event Driven 란?"></a>Event Driven 란?</h1><p><img src="./EDA.png" alt="EDA"></p>
<p>Event Driven은 IT 영역에서 오래 사용된 키워드이며, 현재도 그 영향력이 대단하여 2018년 Gartner에서 선정한 유망한 기술 트렌드 중 하나로 뽑히기도 했다.<br>(Top 10 Strategic Technology Trends for 2018: Event-Driven Model)  </p>
<p>Event Driven이라는 용어는 programming, architecture와 연결되어 다양한 정의로 표현된다.  </p>
<blockquote>
<p><strong>EDA (Event-driven architecture)</strong><br>분산된 시스템 간에 이벤트를 생성, 발행 (publishing)하고 발행된 이벤트를 필요로하는 수신자에게 전송된다.<br>이벤트를 수신한 수신자가 이벤트를 처리하는 형태의 시스템 아키텍쳐</p>
</blockquote>
<ul>
<li>Event Driven Pattern - 특정 행동이 자동으로&#x2F;순서에 따라 발생하는 것이 아닌 어떤 일에 대한 반응으로 동작하는 디자인 패턴</li>
<li>IO Event - 컴퓨터 회로를 구동시키기 위해 발생하는 일  ( ex)  마우스 클릭, 키보드 타이핑, 모바일 터치 등)</li>
<li>IOT 기기 등의 센서로부터 유입되는 데이터 스트리밍 기반의 동작</li>
<li>시스템의 내,외부에서 발생한 <strong>주목할 만한 상태의 변화(a significant change in state)</strong></li>
</ul>
<p>주로 Event Driven 시스템은 Message Broker(Kafka, Rabbit MQ, Redis)와 결합하여, Message Driven 시스템으로 구성된다.</p>
<h2 id="EDA-Event-driven-architecture-의-구성요소"><a href="#EDA-Event-driven-architecture-의-구성요소" class="headerlink" title="EDA (Event-driven architecture)의 구성요소"></a>EDA (Event-driven architecture)의 구성요소</h2><p>EDA는 크게 3개의 구성요소로 나누어 볼 수 있다.</p>
<ul>
<li>Event generator : 시스템 내,외부의 상태 변화를 감지하여 표준화된 형식의 이벤트를 생성</li>
<li>Event channel : 이벤트를 필요로 하는 시스템까지 발송</li>
<li>Event processing engine : 수신한 이벤트를 식별, 적절한 처리를 함. 때에 따라 이벤트 처리의 결과로 또 다른 이벤트를 발생시킬 수 있다.</li>
</ul>
<h2 id="Event-Processing-Style"><a href="#Event-Processing-Style" class="headerlink" title="Event Processing Style"></a>Event Processing Style</h2><p>수신한 이벤트를 처리하는 방법에는 세가지 종류가 있다.</p>
<h3 id="Simple-event-processing"><a href="#Simple-event-processing" class="headerlink" title="Simple event processing"></a>Simple event processing</h3><p>각각의 이벤트가 직접적으로 수행해야할 action과 매핑되어 처리 된다.<br>실시간으로 작업의 흐름을 처리할 때 사용되며, 이벤트 처리 시간과 비용의 손실이 적다.</p>
<h3 id="Event-Stream-Processing"><a href="#Event-Stream-Processing" class="headerlink" title="Event Stream Processing"></a>Event Stream Processing</h3><p>이벤트를 중요도에 따라  필터링하여 걸러진 이벤트만을 수신자에게 전송.<br>실시간으로 정보의 흐름을 처리할 때 사용되며, 기업에 적용될 경우 신속한 의사 결정을 가능케한다.(BAM)</p>
<h3 id="Complex-event-processing"><a href="#Complex-event-processing" class="headerlink" title="Complex event processing"></a>Complex event processing</h3><p>일상적인 이벤트의 패턴을 감지하여 더 복잡한 이벤트의 발생을 추론하는 것.<br>예를 들어 ‘주식의 등락’이라는 일상적인 이벤트의 패턴을 감지하여 ‘투자 적기’라는 상위의 이벤트를 추론해 낼 수 있다.</p>
<h2 id="Event-Driven-Architecture의-장단점"><a href="#Event-Driven-Architecture의-장단점" class="headerlink" title="Event Driven Architecture의 장단점"></a>Event Driven Architecture의 장단점</h2><h3 id="장점"><a href="#장점" class="headerlink" title="장점"></a>장점</h3><ul>
<li>Decoupling - 시스템 간의 느슨한 결합이 가능 하므로 분산 시스템, Microservice 환경에서 시스템 간 의존성을 배제 할 수 있다<br>(시스템은 Event Channel인 Message Broker에 대한 의존성만 가진다.)</li>
<li>다른 시스템의 정보를 알 필요가 없다 - 약속된 Event message를 가지고 상호 정보를 교환한다.</li>
<li>micro service 단위로 시스템을 분리하기 쉽기 때문에 확장성, 탄력성을 고려하기 쉽다.</li>
</ul>
<h3 id="단점"><a href="#단점" class="headerlink" title="단점"></a>단점</h3><ul>
<li>Broker Dependency - Event를 전송하기 위한 Message Broker에 대한 의존성이 커지기 때문에<br>Message Broker 장애 상황 시, 전체 장애로 이어질 수 있다.</li>
<li>Transaction 단위가 격리되기 때문에 서비스 장애 발생시 retry&#x2F;rollback을 고려해야 한다.</li>
<li>시스템 전체 Flow를 파악하기 어렵다. - 명확한 Flow를 보기 위해서는 시스템을 모니터링하여야 한다.</li>
<li>디버깅이 어렵다.</li>
</ul>
<h1 id="Microservice에서의-Event"><a href="#Microservice에서의-Event" class="headerlink" title="Microservice에서의 Event"></a>Microservice에서의 Event</h1><p><img src="./EDM.png" alt="EDM"></p>
<blockquote>
<p><strong>EDM(Event Driven Microservice)</strong><br>MSA가 적용된 시스템에서 이벤트 발생시 해당 이벤트 로그를 보관하고 이를 기반으로 동작하며,<br>비동기 통신을 통해 시스템 내 통합(integration)을 수행하는 Architecture </p>
</blockquote>
<h2 id="Event"><a href="#Event" class="headerlink" title="Event"></a>Event</h2><p>IT 영역에서의 이벤트는 다양한 정의를 포함하지만, MSA에서 의미하는 이벤트는<br>시스템의 내,외부에서 발생한 <strong>주목할 만한 상태의 변화(a significant change in state)</strong><br>데이터의 생성, 변경, 삭제를 통해 발생하는 서비스의 의미 있는 변화를 의미</p>
<h2 id="이벤트-로그를-보관"><a href="#이벤트-로그를-보관" class="headerlink" title="이벤트 로그를 보관"></a>이벤트 로그를 보관</h2><ul>
<li>github를 예시들어 이해하면 이해가 편할 것 같습니다.</li>
</ul>
<h3 id="현재의-데이터는-상태-변경의-누적이다"><a href="#현재의-데이터는-상태-변경의-누적이다" class="headerlink" title="현재의 데이터는 상태 변경의 누적이다."></a>현재의 데이터는 상태 변경의 누적이다.</h3><ul>
<li>github의 commit 한 스냅샷의 연속으로 현재의 소스가 변경</li>
</ul>
<h3 id="상태-변경은-이벤트를-의미하고-이를-누적하는-행위는-이벤트-로그를-보관하는-것"><a href="#상태-변경은-이벤트를-의미하고-이를-누적하는-행위는-이벤트-로그를-보관하는-것" class="headerlink" title="상태 변경은 이벤트를 의미하고 이를 누적하는 행위는 이벤트 로그를 보관하는 것"></a>상태 변경은 이벤트를 의미하고 이를 누적하는 행위는 이벤트 로그를 보관하는 것</h3><ul>
<li>github에 commit &#x3D; Event<br>commit 로그는 이벤트를 보관하는 행위</li>
</ul>
<h3 id="보관된-이벤트는-데이터의-현재-상태를-구성하는-근간"><a href="#보관된-이벤트는-데이터의-현재-상태를-구성하는-근간" class="headerlink" title="보관된 이벤트는 데이터의 현재 상태를 구성하는 근간"></a>보관된 이벤트는 데이터의 현재 상태를 구성하는 근간</h3><ul>
<li>github는 commit이라는 이벤트를 보관하는 store의 역할을 해주며<br>commit의 누적으로 인해 현재의 소스를 구성할 수 있다.</li>
</ul>
<h3 id="보관된-이벤트를-바탕으로-장애-발생-또는-특정-요구사항에-따라-지정된-시점으로-복원을-수행"><a href="#보관된-이벤트를-바탕으로-장애-발생-또는-특정-요구사항에-따라-지정된-시점으로-복원을-수행" class="headerlink" title="보관된 이벤트를 바탕으로 장애 발생 또는 특정 요구사항에 따라 지정된 시점으로 복원을 수행"></a>보관된 이벤트를 바탕으로 장애 발생 또는 특정 요구사항에 따라 지정된 시점으로 복원을 수행</h3><ul>
<li>github는 특정시점으로 롤백 및 revert가 가능</li>
</ul>
<h2 id="비동기-통신"><a href="#비동기-통신" class="headerlink" title="비동기 통신"></a>비동기 통신</h2><p>amqp, mqtt, jms 등 메세징 프로토콜을 통한 메세지 큐 방식이 자주 사용됩니다.<br>서비스에서 데이터의 생성,변경,삭제(CUD)를 통해 이벤트가 발생하면 발행 서비스는 <strong>메세지의 형태로 이벤트를 발행</strong>하고, 해당 이벤트에 관심이 있는 서비스에서 구독을 수행합니다.<br>메세지 큐를 사용함으로 requeue&#x2F;dlq(dead letter queue) 등의 기능을 활용할 수 있습니다.</p>
<h2 id="시스템-내-통합-integration"><a href="#시스템-내-통합-integration" class="headerlink" title="시스템 내 통합(integration)"></a>시스템 내 통합(integration)</h2><p>이상적으로 구현된 MSA는 서비스 간 데이터 참조를 위한 내부 통신이 필요없지만, 현실적으로 서비스 간 내부 통신이 전혀 없는 시스템을 구현하기란 불가능에 가깝습니다. 다양한 사유로 여러 서비스 간 통신을 통해 연동이 발생합니다.</p>
<h2 id="트랜잭션-관리"><a href="#트랜잭션-관리" class="headerlink" title="트랜잭션 관리"></a>트랜잭션 관리</h2><p>microservice 단위로 분리된 환경이기 때문에 각자 데이터베이스를 적용한 시스템에 대해 데이터 무결성을 보장할 수는 없지만<br>Event를 통해 최종적인 일관성을 유지 할 수는 있습니다.<br><strong>all commit or rollback → eventually consistency</strong> (언젠가는 맞는다.)</p>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li><a target="_blank" rel="noopener" href="https://bigstory.tistory.com/entry/Event-Driven-Architecture">https://bigstory.tistory.com/entry/Event-Driven-Architecture</a></li>
<li><a target="_blank" rel="noopener" href="https://en.wikipedia.org/wiki/Event-driven_architecture">https://en.wikipedia.org/wiki/Event-driven_architecture</a></li>
<li><a target="_blank" rel="noopener" href="https://medium.com/dtevangelist/event-driven-microservice-%EB%9E%80-54b4eaf7cc4a">https://medium.com/dtevangelist/event-driven-microservice-%EB%9E%80-54b4eaf7cc4a</a></li>
<li><a target="_blank" rel="noopener" href="https://www.confluent.io/blog/event-streaming-platform-1">https://www.confluent.io/blog/event-streaming-platform-1</a></li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/03/17/effective-java-item88/">Item 88. readObject 메서드는 방어적으로 작성하라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-17</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>Item 50에서는 불변인 날짜 범위 클래스를 만드는데 가변인 Date 필드를 이용했다.<br>그래서 불변식을 지키고 불변을 유지하기 위해 생성자와 접근자에서 Date객체를 방어적으로 복사하느라 코드가 상당히 길어졌다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">Period</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Date start;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> Date end;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> start 시작 시각</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> end 종료 시각; 시작 시각보다 뒤여야 한다.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> IllegalArgumentException 시작 시각이 종료 시각보다 늦을 때 발생한다.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@throws</span> NullPointerException start나 end가 null이면 발행한다.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Period</span><span class="params">(Date start, Date end)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.start = <span class="keyword">new</span> <span class="title class_">Date</span>(start.getTime());</span><br><span class="line">        <span class="built_in">this</span>.end = <span class="keyword">new</span> <span class="title class_">Date</span>(end.getTime());</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">this</span>.start.compareTo(<span class="built_in">this</span>.end) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(start + <span class="string">&quot;가 &quot;</span> + end + <span class="string">&quot;보다 늦다.&quot;</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">start</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(start.getTime()); &#125;</span><br><span class="line">    <span class="keyword">public</span> Date <span class="title function_">end</span><span class="params">()</span> &#123; <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">Date</span>(end.getTime()); &#125;</span><br><span class="line">    <span class="keyword">public</span> String <span class="title function_">toString</span><span class="params">()</span> &#123; <span class="keyword">return</span> start + <span class="string">&quot;-&quot;</span> + end; &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이 클래스는 물리적 표현과 논리적 표현이 부합하므로 기본 직렬화를 사용해도 좋다.<br>하지만 이렇게 해서는 주요한 Date의 불변식을 보장하지 못한다.</p>
<h1 id="필요하다면-매개변수를-방어적으로-복사하라"><a href="#필요하다면-매개변수를-방어적으로-복사하라" class="headerlink" title="필요하다면 매개변수를 방어적으로 복사하라"></a>필요하다면 매개변수를 방어적으로 복사하라</h1><ul>
<li>readObject 메서드는 실질적으로는 또 다른 public 생성자이기 때문에 생성자와 똑같은 수준으로 주의를 기울여야한다.</li>
<li>readObject 메서드에서 <strong>인수가 유효한지 검사해야하고 필요하다면 방어적으로 복사하라</strong></li>
<li>readObject에서 이 작업을 제대로 하지 못하면 공격자는 쉽게 클래스의 불변식을 깨뜨릴 수 있다.</li>
</ul>
<h2 id="불변식을-깨뜨릴-용도로-스트림을-조작하면-문제가-생긴다"><a href="#불변식을-깨뜨릴-용도로-스트림을-조작하면-문제가-생긴다" class="headerlink" title="불변식을 깨뜨릴 용도로 스트림을 조작하면 문제가 생긴다"></a>불변식을 깨뜨릴 용도로 스트림을 조작하면 문제가 생긴다</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">BogusPeriod</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">byte</span>[] serializedForm = &#123;</span><br><span class="line">        (<span class="type">byte</span>)<span class="number">0xac</span>, (<span class="type">byte</span>)<span class="number">0xed</span>, <span class="number">0x00</span>, <span class="number">0x05</span>, <span class="number">0x73</span>, <span class="number">0x72</span>, <span class="number">0x00</span>, <span class="number">0x06</span>....</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">        <span class="type">Period</span> <span class="variable">p</span> <span class="operator">=</span> (Period) deserialize(serializedForm);</span><br><span class="line">        System.out.println(p);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">static</span> Object <span class="title function_">deserialize</span><span class="params">(<span class="type">byte</span>[] sf)</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(sf)).readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span>(IOException | ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">IllegalArgumentException</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>이 코드의 serializedForm에서 상위 비트가 1인 바이트 값들은 byte로 형변환했는데,<br>이는 자바가 바이트 리터럴을 지원하지 않고 byte 타입은 부호가 있는 (signed) 타입이기 때문이다.</li>
<li>위의 프로그램을 실행하면<br><code>Fri Jan 01 12:00:00 PST 1999 - Sun Jan 01 12:00:00 PST 1984</code>를 출력한다.</li>
<li>Period를 직렬화할 수 있도록 선언한 것 만으로도 불변식을 깨뜨리는 객체를 만들 수 있다.</li>
</ul>
<h1 id="역직렬화-시-불변식을-만족하는-유효성-검사를-해야한다"><a href="#역직렬화-시-불변식을-만족하는-유효성-검사를-해야한다" class="headerlink" title="역직렬화 시, 불변식을 만족하는 유효성 검사를 해야한다."></a>역직렬화 시, 불변식을 만족하는 유효성 검사를 해야한다.</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 불변식을 만족하는지 검사한다.</span></span><br><span class="line">    <span class="keyword">if</span>(start.compareTo(end) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(start + <span class="string">&quot;가 &quot;</span> + end + <span class="string">&quot;보다 늦다.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>위의 if문 추가로 허용되지 않는 Period 인스턴스가 생성되는 일을 막을 수 있지만, 아직도 미묘한 문제가 숨어있다.</li>
<li>정상 Period 인스턴스에서 시작된 바이트 스트림 끝에 private Date 필드로의 참조를 추가하면 가변 Period 인스턴스를 만들 수 있다.</li>
</ul>
<h1 id="가변-공격을-막기위해서는-방어적-복사본을-만들어야-한다"><a href="#가변-공격을-막기위해서는-방어적-복사본을-만들어야-한다" class="headerlink" title="가변 공격을 막기위해서는 방어적 복사본을 만들어야 한다."></a>가변 공격을 막기위해서는 방어적 복사본을 만들어야 한다.</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">MutablePeriod</span> &#123;</span><br><span class="line">    <span class="comment">//Period 인스턴스</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Period period;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//시작 시각 필드 - 외부에서 접근할 수 없어야 한다.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Date start;</span><br><span class="line">    <span class="comment">//종료 시각 필드 - 외부에서 접근할 수 없어야 한다.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> Date end;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">MutablePeriod</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="type">ByteArrayOutputStream</span> <span class="variable">bos</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ByteArrayOutputStream</span>();</span><br><span class="line">            <span class="type">ObjectArrayOutputStream</span> <span class="variable">out</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectArrayOutputStream</span>(bos);</span><br><span class="line">            </span><br><span class="line">            <span class="comment">//유효한 Period 인스턴스를 직렬화한다.</span></span><br><span class="line">            out.writeObject(<span class="keyword">new</span> <span class="title class_">Period</span>(<span class="keyword">new</span> <span class="title class_">Date</span>(), <span class="keyword">new</span> <span class="title class_">Date</span>()));</span><br><span class="line">            </span><br><span class="line">            <span class="comment">/**</span></span><br><span class="line"><span class="comment">             * 악의적인 &#x27;이전 객체 참조&#x27;, 즉 내부 Date 필드로의 참조를 추가한다.</span></span><br><span class="line"><span class="comment">             * 상세 내용은 자바 객체 직렬화 명세의 6.4절을 참고</span></span><br><span class="line"><span class="comment">             */</span></span><br><span class="line">            <span class="type">byte</span>[] ref = &#123;<span class="number">0x71</span>, <span class="number">0</span>, <span class="number">0x7e</span>, <span class="number">0</span>, <span class="number">5</span>&#125;; <span class="comment">// 참조 #5</span></span><br><span class="line">            bos.write(ref); <span class="comment">// 시작 start 필드 참조 추가</span></span><br><span class="line">            ref[<span class="number">4</span>] = <span class="number">4</span>; <span class="comment">//참조 #4</span></span><br><span class="line">            bos.write(ref); <span class="comment">// 종료(end) 필드 참조 추가</span></span><br><span class="line">            </span><br><span class="line">            <span class="comment">// Period 역직렬화 후 Date 참조를 훔친다.</span></span><br><span class="line">            <span class="type">ObjectInputStream</span> <span class="variable">in</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">ObjectInputStream</span>(<span class="keyword">new</span> <span class="title class_">ByteArrayInputStream</span>(bos.toByteArray()));</span><br><span class="line">            period = (Period) in.readObject();</span><br><span class="line">            start = (Date) in.readObject();</span><br><span class="line">            end = (Date) in.readObject();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IOException | ClassNotFoundException e) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(e);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>다음 공격 코드를 실행하면 이 공격이 실제로 이뤄지는 모습을 확인할 수 있다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    <span class="type">MutablePeriod</span> <span class="variable">mp</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">MutablePeriod</span>();</span><br><span class="line">    <span class="type">Period</span> <span class="variable">p</span> <span class="operator">=</span> mp.period;</span><br><span class="line">    <span class="type">Date</span> <span class="variable">pEnd</span> <span class="operator">=</span> mp.end;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//시간 되돌리기</span></span><br><span class="line">    pEnd.setYear(<span class="number">78</span>);</span><br><span class="line">    System.out.println(p); <span class="comment">// Wed Nov 22 00:21:29 PST 2017 - Wed Nov 22 00:21:29 PST 1978</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">//60년대로 회귀</span></span><br><span class="line">    pEnd.setYear(<span class="number">60</span>);</span><br><span class="line">    System.out.println(p); <span class="comment">// Wed Nov 22 00:21:29 PST 2017 - Wed Nov 22 00:21:29 PST 1969</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>이 예시에서 Period 인스턴스는 불변식을 유지한 채 생성됐지만 의도적으로 내부의 값을 수정할 수 있었다.<br>이처럼 변경할 수 있는 Period 인스턴스를 획득한 공격자는 인스턴스가 불변이라고 가정하는 클래스에 넘겨 엄청난 보안 문제를 일으킬 수 있다.</p>
<p>이 문제의 근원은 <strong>Period의 readObject메서드가 방어적 복사를 충분히 하지 않은 데 있다.</strong><br>객체를 직렬화할 때는 클라이언트가 소유해서는 안 되는 객체 참조를 갖는 필드를 모두 방어적으로 복사해야 한다.<br>따라서 <code>readObject에서는 불변 클래스 안의 모든 private 가변 요소를 방어적으로 복사 해야한다.</code></p>
<h1 id="readObject-메서드에서는-private-가변요소를-방어-복사하라"><a href="#readObject-메서드에서는-private-가변요소를-방어-복사하라" class="headerlink" title="readObject 메서드에서는 private 가변요소를 방어 복사하라"></a>readObject 메서드에서는 private 가변요소를 방어 복사하라</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 가변 요소들을 방어적으로 복사한다.</span></span><br><span class="line">    start = <span class="keyword">new</span> <span class="title class_">Date</span>(start.getTime());</span><br><span class="line">    end = <span class="keyword">new</span> <span class="title class_">Date</span>(end.getTime());</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 불변식을 만족하는지 검사한다.</span></span><br><span class="line">    <span class="keyword">if</span>(start.compareTo(end) &gt; <span class="number">0</span>) &#123;</span><br><span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">InvalidObjectException</span>(start + <span class="string">&quot;가 &quot;</span> + end + <span class="string">&quot;보다 늦다.&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>방어적 복사를 유효성 검사보다 앞서 수행하며, Date의 clone 메서드는 사용하지 않았음에 주목하자.  </li>
<li>두 조치 모두 Period를 공격으로 부터 보호하는데 필요하다. </li>
<li>또한 final 필드는 방어적 복사가 불가능 하니 주의하자 </li>
<li>그래서 이 readObject를 사용하려면 start와 end필드에서 final 한정자를 제거해야 한다.</li>
</ul>
<h1 id="기본-readObject를-사용해도-되는지에-대한-체크리스트"><a href="#기본-readObject를-사용해도-되는지에-대한-체크리스트" class="headerlink" title="기본 readObject를 사용해도 되는지에 대한 체크리스트"></a>기본 readObject를 사용해도 되는지에 대한 체크리스트</h1><ul>
<li>transient 필드를 제외한 모든 필드의 값을 매개변수로 받아 유효성 검사 없이 필드에 대입하는 public 생성자를 추가해도 괜찮은가?<ul>
<li>아니오 -&gt; 커스텀 readObject 메서드를 만들어 유효성 검사와 방어적 복사를 수행</li>
<li>예 -&gt; 기본 readObject 메서드 사용</li>
</ul>
</li>
<li>직렬화 프록시 패턴을 사용해도 된다 .<ul>
<li>역직렬화를 안전하게 만드는 데 필요한 노력을 경감해 준다. (권장)</li>
</ul>
</li>
</ul>
<h1 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h1><ul>
<li>readObject 메서드를 작성할 때는 언제나 public 생성자를 만든다고 생각하고 만들어야 한다.</li>
<li>private 이어야 하는 객체 참조 필드는 각 필드가 가리키는 객체를 방어적으로 복사하라 (불변 클래스 내의 가변 요소)</li>
<li>모든 불변식을 검사하여 어긋나는 게 발견되면 InvalidObjectException을 던진다.<br>방어적 복사 다음에는 반드시 불변식 검사가 뒤따라야 한다.</li>
<li>역직렬화 후 객체 그래프 전체의 유효성을 검사해야 한다면 ObjectInputValidation 인터페이스를 사용하라</li>
<li>직접적이든 간접적이든 readObject메서드에서 재정의 가능한 메서드를 호출해서는 안된다.</li>
<li>재정의 가능한 메서드가 재정의되면 하위 클래스의 상태가 완전히 역직렬화 되기전에 하위 클래스에서 재정의된 메서드가 실행되므로<br>프로그램 오작동을 일으킬 수 있다.</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 88. readObject 메서드는 방어적으로 작성하라</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/03/17/effective-java-item87/">Item 87. 커스텀 직렬화 형태를 고려해보라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-17</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>개발 일정에 쫓기는 상황에서는 API 설계에 노력을 집중하는 편이 낫다.<br>다음 릴리스에서 세부적인 기능을 제대로 구현하고 이번 릴리즈는 대충 동작만하게 하면 된다는 뜻이다.<br>하지만 클래스가 Serializable을 구현하고 기본 직렬화 형태를 사용한다면 다음 릴리즈때 버리려 한 현재의 구현에 영원히 발이 묶이게 된다.<br>(현재의 기본 직렬화 형태를 버릴 수 없게 되기 때문이다.)</p>
<h1 id="먼저-고민해보고-괜찮다고-판단될-때만-기본-직렬화-형태를-사용하라"><a href="#먼저-고민해보고-괜찮다고-판단될-때만-기본-직렬화-형태를-사용하라" class="headerlink" title="먼저 고민해보고 괜찮다고 판단될 때만 기본 직렬화 형태를 사용하라"></a>먼저 고민해보고 괜찮다고 판단될 때만 기본 직렬화 형태를 사용하라</h1><ul>
<li>기본 직렬화 형태는 유연성,  성능, 정확성, 측면에서 신중히 고민한 후 합당할 때만 사용해야 한다.  </li>
<li>직접 설계하더라도 기본 직렬화 형태와 거의 같은 결과가 나올 경우에만 기본 형태를 써야 한다. </li>
<li>기본 직렬화 형태는 그 객체를 루트로 하는 객체 그래프의 물리적 모습을 나름 효율적으로 인코딩한다.</li>
<li>객체가 포함한 데이터들과 그 객체에서부터 시작해 접근할 수 있는 모든 객체를 담아내며 객체들이 연결된 위상(topology)까지 기술한다.</li>
<li>하지만 이상적인 직렬화 형태는 <strong>물리적인 모습과 독립된 논리적인 모습만을 표현해야 한다.</strong></li>
</ul>
<h1 id="객체의-물리적-표현과-논리적-내용이-같다면-기본-직렬화-형태라도-무방하다"><a href="#객체의-물리적-표현과-논리적-내용이-같다면-기본-직렬화-형태라도-무방하다" class="headerlink" title="객체의 물리적 표현과 논리적 내용이 같다면 기본 직렬화 형태라도 무방하다"></a>객체의 물리적 표현과 논리적 내용이 같다면 기본 직렬화 형태라도 무방하다</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Name</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 성. null이 아니어야함</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@serial</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String lastName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 이름. null이 아니어야 함.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@serial</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String firstName;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 중간이름. 중간이름이 없다면 null.</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@serial</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> String middleName;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>기본 직렬화 형태가 적합하다고 결정했더라고 불변식 보장과 보안을 위해 readObject 메서드를 제공해야 할 때가 많다.</li>
<li>Name의 3개의 필드는 private임에도 불구하고 문서화 주석이 달려있다. </li>
<li>이 필드들은 결국 클래스의 직렬화 형태에 포함되는 공개 API에 속하며 공개 API는 모두 문서화 해야 하기 때문이다. </li>
<li>private 필드의 설명을 API 문서에 포함하라고 자바독에 알려주는 역할은 @serial태그가 한다.</li>
<li>@serial 태그로 기술한 내용은 API 문서에서 직렬화 형태를 설명하는 특별한 페이지에 기록된다.</li>
</ul>
<h1 id="기본-직렬화-형태에-적합하지-않은-클래스"><a href="#기본-직렬화-형태에-적합하지-않은-클래스" class="headerlink" title="기본 직렬화 형태에 적합하지 않은 클래스"></a>기본 직렬화 형태에 적합하지 않은 클래스</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">StringList</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">Entry</span> <span class="variable">head</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">        String data;</span><br><span class="line">        Entry next;</span><br><span class="line">        Entry previous;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>논리적으로는 이클래스는 일련의 문자열을 표현한다.<br>물리적으로는 문자열을 이중 연결 리스트로 연결했다. 이 클래스에 기본 직렬화 형태를 사용하면 각 노드의 양방향 연결 정보를 포함해 모든 엔트리(Entry)를 철두철미하게 기록한다.</p>
<h1 id="객체의-물리적-표현과-논리적-표현의-차이가-클-때-기본-직렬화-형태를-사용하는-경우-생기는-문제"><a href="#객체의-물리적-표현과-논리적-표현의-차이가-클-때-기본-직렬화-형태를-사용하는-경우-생기는-문제" class="headerlink" title="객체의 물리적 표현과 논리적 표현의 차이가 클 때 기본 직렬화 형태를 사용하는 경우 생기는 문제"></a>객체의 물리적 표현과 논리적 표현의 차이가 클 때 기본 직렬화 형태를 사용하는 경우 생기는 문제</h1><h2 id="공개-API가-현재의-내부-표현-방식에-영구히-묶인다"><a href="#공개-API가-현재의-내부-표현-방식에-영구히-묶인다" class="headerlink" title="공개 API가 현재의 내부 표현 방식에 영구히 묶인다."></a>공개 API가 현재의 내부 표현 방식에 영구히 묶인다.</h2><ul>
<li>앞의 예에서 private 클래스인 StringList.Entry가 공개 API가 되어버린다.</li>
<li>다음 릴리스에서 내부 표현 방식을 바꾸더라도 StringList 클래스는 여전히 연결 리스트로 표현된 입력도 처리할 수 있어야 한다.</li>
<li>즉 연결 리스트를 더 이상 사용하지 않더라도 관련 코드를 제거할 수 없다.</li>
</ul>
<h2 id="너무-많은-공간을-차지할-수-있다"><a href="#너무-많은-공간을-차지할-수-있다" class="headerlink" title="너무 많은 공간을 차지할 수 있다."></a>너무 많은 공간을 차지할 수 있다.</h2><ul>
<li>앞 예의 직렬화 형태는 연결 리스트의 모든 엔트리와 연결 정보까지 기록했지만, 엔트리와 연결 정보는 내부 구현에 해당하니 직렬화 형태에 포함할 가치가 없다.</li>
<li>이처럼 직렬화 형태가 너무 커져서 디스크에 저장하거나 네트워크로 전송하는 속도가 느려진다.</li>
</ul>
<h2 id="시간이-너무-많이-걸릴-수-있다"><a href="#시간이-너무-많이-걸릴-수-있다" class="headerlink" title="시간이 너무 많이 걸릴 수 있다."></a>시간이 너무 많이 걸릴 수 있다.</h2><ul>
<li>직렬화 로직은 객체 그래프의 위상에 관한 정보가 없으니 그래프를 직접 순회해볼 수밖에 없다.</li>
<li>앞의 예제는 간단히 다음 참조를 따라가 보는 정도로 충분하다.</li>
</ul>
<h2 id="스택-오버플로를-일으킬-수-있다"><a href="#스택-오버플로를-일으킬-수-있다" class="headerlink" title="스택 오버플로를 일으킬 수 있다."></a>스택 오버플로를 일으킬 수 있다.</h2><ul>
<li>기본 직렬화 과정은 객체 그래프를 재귀 순회하는데 중간정도 크기의 객체 그래프에서도 스택 오버플로 에러가 날 수 있다.</li>
<li>그때그때 다른 시점에서 스택 오버플로가 날 수 있고, 어떤 플랫폼에서는 에러가 나지 않을 수도 있다.</li>
</ul>
<h1 id="합리적인-커스텀-직렬화-형태를-갖춘-StringList"><a href="#합리적인-커스텀-직렬화-형태를-갖춘-StringList" class="headerlink" title="합리적인 커스텀 직렬화 형태를 갖춘 StringList"></a>합리적인 커스텀 직렬화 형태를 갖춘 StringList</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">class</span> <span class="title class_">StringList</span> <span class="keyword">implements</span> <span class="title class_">Serializable</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">int</span> <span class="variable">size</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">transient</span> <span class="type">Entry</span> <span class="variable">head</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 이제는 직렬화되지 않는다.</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">class</span> <span class="title class_">Entry</span> &#123;</span><br><span class="line">        String data;</span><br><span class="line">        Entry next;</span><br><span class="line">        Entry previous;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 지정한 문자열을 이 리스트에 추가한다.</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title function_">add</span><span class="params">(String s)</span> &#123;...&#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 이 &#123;<span class="doctag">@code</span> StringList&#125; 인스턴스를 직렬화한다.</span></span><br><span class="line"><span class="comment">     * </span></span><br><span class="line"><span class="comment">     * <span class="doctag">@serialData</span> 이 리스트의 크기(포함된 문자열의 개수)를 기록한 후</span></span><br><span class="line"><span class="comment">     * (&#123;<span class="doctag">@code</span> int&#125;), 이어서 모든 원소를(각각은 &#123;<span class="doctag">@code</span> String&#125;)</span></span><br><span class="line"><span class="comment">     * 순서대로 기록한다.</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">     	<span class="comment">//기본 직렬화를 수행한다.</span></span><br><span class="line">        s.defaultWriteObject();</span><br><span class="line">        s.writeInt(size);</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 커스텀 역직렬화를 수행한다.</span></span><br><span class="line">        <span class="comment">// 모든 원소를 올바른 순서로 기록한다.</span></span><br><span class="line">        <span class="keyword">for</span> (<span class="type">Entry</span> <span class="variable">e</span> <span class="operator">=</span> head; e != <span class="literal">null</span>; e = e.next)</span><br><span class="line">            s.writeObject(e.data);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">readObject</span><span class="params">(ObjectInputStream s)</span> <span class="keyword">throws</span> IOException, ClassNotFoundException &#123;</span><br><span class="line">        <span class="comment">//기본 역직렬화를 수행한다.</span></span><br><span class="line">        s.defaultReadObject();</span><br><span class="line">        <span class="type">int</span> <span class="variable">numElements</span> <span class="operator">=</span> s.readInt();</span><br><span class="line">        </span><br><span class="line">        <span class="comment">// 커스텀 역직렬화 부분</span></span><br><span class="line">        <span class="comment">// 모든 원소를 읽어 이 리스트에 삽입한다.</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; numElements; i++) &#123;</span><br><span class="line">            add((String) s.readObject());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li><p>StringList의 필드 모두가 transient더라도 writeObject와 readObject는 각각 먼저 defaultWriteObject와 defaultReadObject를 호출한다.</p>
</li>
<li><p>클래스의 인스턴스가 모두 transient더라도 defaultWriteObject와 defaultReadObject를 호출해줘야 한다.<br>(향후 릴리즈에서 transient가 아닌 필드가 추가되더라도 상호 호환되기 때문이다)</p>
</li>
<li><p>신버전 인스턴스를 직렬화한 후 구버전으로 역직렬화하면 새로 추가된 필드들은 무시될 것이다.</p>
</li>
<li><p>구버전 readObject 메서드에서 defaultReadObject를 호출하지 않는다면 역직렬화할 때 StreamCorruptedException이 발생할 것이다.</p>
</li>
<li><p>writeObject는 private 메서드임에도 문서화 주석이 달려 있다.<br>이 private 메서드는 직렬화 형태에 포함되는 공개 API에 속하며 공개 API는 모두 문서화 해야한다.</p>
</li>
<li><p>메서드에 달린 @serialData 태그는 자바독 유틸리티에게 이 내용을 직렬화 형태 페이지에 추가하도록 요청한다.</p>
</li>
<li><p>개선한 StringList는 원래버전의 절반정도의 공간을 차지하며 수행속도 또한 두 배 이상 빠르다.</p>
</li>
<li><p>개선한 StringList는 스택 오버플로 에러가 발생하지 않는다. (크기의 제한이 사라짐)</p>
</li>
<li><p>객체를 직렬화한 후 역직렬화하면 원래 객체를 그 불변식까지 포함해 제대로 복원해낸다는 점에서 정확하다 할 수 있다.</p>
</li>
<li><p>하지만 불변식이 세부 구현에 따라 달라지는 객체에서는 이 정확성마저 깨질 수 있다.</p>
</li>
</ul>
<h1 id="객체의-불변식이-깨지는-경우에는-직렬화를-주의해야한다"><a href="#객체의-불변식이-깨지는-경우에는-직렬화를-주의해야한다" class="headerlink" title="객체의 불변식이 깨지는 경우에는 직렬화를 주의해야한다."></a>객체의 불변식이 깨지는 경우에는 직렬화를 주의해야한다.</h1><p>해시 테이블을 예로 생각해보면 이해할 수 있다.  해시 테이블은 물리적으로는 key-value 엔트리를 담은 해시 버킷을 차례로 나열한 형태다.<br>어떤 엔트리를 어떤 버킷에 담을지는 key에서 구한 hashcode가 결정하는데 <strong>그 계산 방식은 구현에 따라 달라질 수 있다.</strong><br>혹은 계산할 때마다 달라지기도 한다.<br>따라서 해시테이블을 직렬화한 후 역직렬화하면 불변식이 심각하게 훼손된 객체들이 생겨날 수 있는 것이다.</p>
<h1 id="객체의-논리적-상태와-무관한-필드라고-확신하면-transient-한정자를-생략하라"><a href="#객체의-논리적-상태와-무관한-필드라고-확신하면-transient-한정자를-생략하라" class="headerlink" title="객체의 논리적 상태와 무관한 필드라고 확신하면 transient 한정자를 생략하라"></a>객체의 논리적 상태와 무관한 필드라고 확신하면 transient 한정자를 생략하라</h1><ul>
<li>기본 직렬화를 수용하든 하지 않든 defaultWriteObject 메서드를 호출하면 transient로 선언하지 않은 모든 인스턴스 필드가 직렬화된다.</li>
<li>따라서 transient로 선언해되 되는 인스턴스 필드에는 모두 transient를 붙여야 한다.</li>
<li>JVM을 실행할 때마다 값이 달라지는 필드도 transient를 붙여야 한다.</li>
<li>커스텀 직렬화 형태를 사용한다면 앞서의 StringList 처럼 대부분의(혹은 모든) 인스턴스 필드를 transient로 선언해야 한다.</li>
</ul>
<h1 id="동기화-메커니즘을-직렬화에도-적용해야-한다"><a href="#동기화-메커니즘을-직렬화에도-적용해야-한다" class="headerlink" title="동기화 메커니즘을 직렬화에도 적용해야 한다."></a>동기화 메커니즘을 직렬화에도 적용해야 한다.</h1><p>모든 메서드를 synchronized로 선언하여 스레드 안전하게 만든 객체에서 기본 직렬화를 사용하려면<br>writeObject도 다음 코드 처럼 synchronized로 선언해야 한다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">writeObject</span><span class="params">(ObjectOutputStream s)</span> <span class="keyword">throws</span> IOException &#123;</span><br><span class="line">    s.defaultWriteObject();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>writeObject 메서드 안에서 동기화 하고 싶다면 클래스의 다른 부분에서 사용하는 락 순서를 똑같이 따라야 한다.<br>그렇지 않으면 교착상태 (resource-ordering deadlock)에 빠질 수 있다.</p>
<h1 id="직렬-버전-UID를-명시적으로-부여하자"><a href="#직렬-버전-UID를-명시적으로-부여하자" class="headerlink" title="직렬 버전 UID를 명시적으로 부여하자"></a>직렬 버전 UID를 명시적으로 부여하자</h1><p>어떤 직렬화 형태를 사용하든 직렬 가능 클래스에 모두 직렬 버전 UID를 명시적으로 부여하자.<br>이렇게 하면 직렬 버전 UID가 일으키는 잠재적인 호환성 문제가 사라진다.<br>성능도 조금 빨라지는데 직렬 버전 UID를 명시하지 않으면 런타임에 이 값을 생성하느라 복잡한 연산을 수행하기 때문이다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">long</span> <span class="variable">serialVersionUID</span> <span class="operator">=</span> -<span class="number">232923283928929</span>;</span><br></pre></td></tr></table></figure>

<p>위와 같은 형태로 사용하면 된다.<br>Intellij 에서는 alt+insert 단축키를 누르면 serialVersionUID를 자동으로 생성해 주는 메뉴가 있다.<br>기존 클래스를 구버전으로 직렬화된 인스턴스와 호환성을 유지한 채 사용하고 싶다면<br>기존 클래스를 구버전에서 사용한 자동 생성된 값을 그대로 사용해야 한다.  </p>
<h2 id="주의할-점"><a href="#주의할-점" class="headerlink" title="주의할 점"></a>주의할 점</h2><p><strong>직렬버전 UID는 클래스의 명세가 변경되면 자동 생성된 값이 바뀌기 때문에 이부분도 주의해야 한다.</strong><br>구버전과 호환이 되지 않아 역직렬화가 되지 않는다.<br>기존 버전의 직렬화된 인스턴스를 역직렬화할 때 InvalidClassException이 던져질 것이다.<br>구버전으로 직렬화된 인스턴스들과 호환성을 끊으려는 경우를 제외하고는 직렬 버전 UID를 절대 수정하면 안된다.</p>
<h1 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h1><ul>
<li>클래스를 직렬화하기로 했다면 어떤 직렬화 형태를 사용할지 심사숙고 해야한다.</li>
<li>자바의 기본 직렬화 형태는 객체를 직렬화한 결과가 해당 객체의 논리적 표현에 부합할 때만 사용하고 그렇지 않으면 객체를 적절히 설명하는 커스텀 직렬화 형태를 고안해야 한다.</li>
<li>직렬화 형태도 공개 메서드를 설계할 때에 준하는 시간을 들여 설계 해야 한다.</li>
<li>한번 공개된 메서드는 향후 릴리즈에서 제거할 수 없듯이 직렬화 형태에 포함된 필드도 마음대로 제거할 수 없다.</li>
<li>직렬화 호환성을 유지하기 위해 영원히 지원해야 한다.</li>
<li>잘못된 직렬화 형태를 선택하면 해당 클래스의 복잡성과 성능에 영구히 부정적인 영향을 남긴다.</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 87. 커스텀 직렬화 형태를 고려해보라</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/03/11/effective-java-item79/">Item 79. 과도한 동기화는 피하라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-12</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>과도한 동기화는 성능을 떨어뜨리고, 교착상태에 빠뜨리고, 심지어 예측할 수 없는 동작을 낳기도 한다.<br><strong>응답 불가와 안전 실패를 피하려면 동기화 메서드나 동기화 블록 안에서는 제어를 절대로 클라이언트에 양도하면 안 된다.</strong>  </p>
<ul>
<li>동기화(synchronized) 된 코드 블럭 안에서는 재정의 가능한 메서드를 호출해선 안된다.</li>
<li>클라이언트가 넘겨준 함수객체를 호출해서도 안된다.</li>
<li>이런 메서드는 동기화도니 클래스 관점에서 외계인 메서드(alien method)라고 칭한다.<br>(무슨일을 할지 모르니, 이 메서드가 예외를 발생시키거나, 교착상태를 만들거나, 데이터를 훼손시킬 수 있다.)</li>
</ul>
<h1 id="외계인-메서드"><a href="#외계인-메서드" class="headerlink" title="외계인 메서드"></a>외계인 메서드</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ObservableSet</span>&lt;E&gt; <span class="keyword">extends</span> <span class="title class_">ForwardingSet</span>&lt;E&gt; &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ObservableSet</span><span class="params">(Set&lt;E&gt; set)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(set);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">final</span> List&lt;SetObserver&lt;E&gt;&gt; observers = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addObserver</span><span class="params">(SetObserver&lt;E&gt; observer)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (observers) &#123;</span><br><span class="line">            observers.add(observer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">removeObserver</span><span class="params">(SetObserver&lt;E&gt; observer)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (observers) &#123;</span><br><span class="line">            <span class="keyword">return</span> observers.remove(observer);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">notifyElementAdded</span><span class="params">(E element)</span> &#123;</span><br><span class="line">        <span class="keyword">synchronized</span> (observers) &#123;</span><br><span class="line">            <span class="keyword">for</span>(SetObserver&lt;E&gt; observer : observers) &#123;</span><br><span class="line">                observer.added(<span class="built_in">this</span>, element);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">add</span><span class="params">(E element)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">added</span> <span class="operator">=</span> <span class="built_in">super</span>.add(element);</span><br><span class="line">        <span class="keyword">if</span>(added) &#123;</span><br><span class="line">            notifyElementAdded(element);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> added;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">addAll</span><span class="params">(Collection&lt;? extends E&gt; c)</span> &#123;</span><br><span class="line">        <span class="type">boolean</span> <span class="variable">result</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">        <span class="keyword">for</span> (E element : c) &#123;</span><br><span class="line">            result |= add(element); <span class="comment">//notifyElementAdded를 호출</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> result;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>관찰자들은 addObserver와 removeObserver 메서드를 호출해 구독을 신청하거나 해지한다.</li>
<li>두 경우 다음 콜백 인터페이스의 인스턴스를 메서드에 전달</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@FunctionalInterface</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">SetObserver</span>&lt;E&gt; &#123;</span><br><span class="line">    <span class="comment">//ObservableSet에 원소가 더해지면 호출된다.</span></span><br><span class="line">    <span class="keyword">void</span> <span class="title function_">added</span><span class="params">(ObservableSet&lt;E&gt; set, E element)</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>이 인터페이스는 구조적으로 BiConsumer&lt;ObservableSet<E>,  E&gt;와 똑같다.</li>
<li>커스텀 함수형 인터페이스를 정의한 이유는 이름이 더 직관적이고 다중 콜백을 지원하도록 확장할 수 있기 때문이다.</li>
</ul>
<h1 id="외계인-메서드-예제1"><a href="#외계인-메서드-예제1" class="headerlink" title="외계인 메서드 - 예제1"></a>외계인 메서드 - 예제1</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> &#123;</span><br><span class="line">    ObservableSet&lt;Integer&gt; set = <span class="keyword">new</span> <span class="title class_">ObservableSet</span>&lt;&gt;(<span class="keyword">new</span> <span class="title class_">HashSet</span>&lt;&gt;());</span><br><span class="line">    set.addObserver(<span class="keyword">new</span> <span class="title class_">SetObserver</span>&lt;&gt;() &#123;</span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">added</span><span class="params">(ObservableSet&lt;Integer&gt; s, Integer e)</span> &#123;</span><br><span class="line">            System.out.println(e);</span><br><span class="line">            <span class="keyword">if</span>(e == <span class="number">23</span>) &#123;</span><br><span class="line">                s.removeObserver(<span class="built_in">this</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">        set.add(i);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>s.removeObserver에 this를 넘겨야하는데 람다에서는 방법이 없으므로 익명클래스의 형태로 사용</li>
<li>이 프로그램은 0~23까지 출력한 후 Observer 자신을 구독해제 한 후 아무런 로그도 뜨지 않고 종료할 것 같다.</li>
<li>하지만 그렇지 않다. 프로그램은 0~23까지 출력한 후 <code>ConcurrentModificationException</code> 을 던진다.</li>
<li>왜냐하면 Observer의 added 메서드 호출이 일어난 시점이 notifyElementAdded가 Observer들의 리스트를 순회하는 도중이기 때문이다.</li>
<li>added 메서드 -&gt; ObservableSet.removeObserver를 호출 -&gt; observers.remove 호출</li>
<li>리스트에서 원소를 제거하려는데 마침 지금은 이 원소를 순회하는 중 <strong>(허용되지 않은 동작)</strong></li>
<li>notifyElementAdded 메서드에서 수행하는 순회는 동기화 블록 안에 있으므로 동시 수정이 일어나지 않지만<br>정작 자신이 콜백을 거쳐 되돌아와 수정하는 것을 막진 못한다.</li>
</ul>
<h1 id="외계인-메서드-예제-2"><a href="#외계인-메서드-예제-2" class="headerlink" title="외계인 메서드 - 예제 2"></a>외계인 메서드 - 예제 2</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">set.addObserver(<span class="keyword">new</span> <span class="title class_">SetObserver</span>&lt;&gt;() &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">added</span><span class="params">(ObservableSet&lt;Integer&gt; s, Integer e)</span> &#123;</span><br><span class="line">        System.out.println(e);</span><br><span class="line">        <span class="keyword">if</span>(e == <span class="number">23</span>) &#123;</span><br><span class="line">            <span class="type">ExecutorService</span> <span class="variable">exec</span> <span class="operator">=</span> Executors.newSingleThreadExecutor();</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                exec.submit(() -&gt; s.removeObserver(<span class="built_in">this</span>)).get(); <span class="comment">//여기서 lock이 걸려서 못들어감</span></span><br><span class="line">               													 <span class="comment">//하지만 메인 스레드는 너의 작업을 기다리고 있어</span></span><br><span class="line">            &#125; <span class="keyword">catch</span>(ExecutionException | InterruptedException ex) &#123;</span><br><span class="line">                <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">AssertionError</span>(ex);</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                exec.shutdown();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<ul>
<li>이 프로그램을 실행하면 에러는 나진 않지만 교착상태(Dead-lock)에 빠진다.</li>
<li>백그라운드 스레드가 s.removeObserver를 호출하면 Observer를 잠그려 시도하지만 락을 얻을 수 없다.<br>(메인스레드가 이미 락을 쥐고 있기 때문 - removeObserver는 synchronized 키워드가 달려있어서 실행 시 락이 걸린다.)</li>
<li>그와 동시에 메인 스레드는 백그라운드 스레드가 Observer를 제거하기만을 기다리는 중이다.</li>
</ul>
<h1 id="교착상태-해결방법"><a href="#교착상태-해결방법" class="headerlink" title="교착상태 해결방법"></a>교착상태 해결방법</h1><p>자바 언어의 락은 재진입(reentrant)을 허용하므로 교착상태에 빠지지는 않는다.<br>재진입 가능 락은 객체 지향 멀티스레드 프로그램을 쉽게 구현 할 수 있도록 해준다.<br>하지만 응답 불가(교착상태)가 될 상황을 안전 실패(데이터 훼손)으로 변모시킬 수도 있다.  </p>
<p>이런 경우 외계인 메서드 호출을 동기화 블록 바깥으로 옮기면 된다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">notifyElementAdded</span><span class="params">(E element)</span> &#123;</span><br><span class="line">    List&lt;SetObserver&lt;E&gt;&gt; snapshot = <span class="literal">null</span>;</span><br><span class="line">    <span class="keyword">synchronized</span>(observers) &#123;</span><br><span class="line">        snapshot = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;(observers);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">for</span> (SetObserver&lt;E&gt; observer : snapshot) &#123;</span><br><span class="line">        observer.added(<span class="built_in">this</span>, element); <span class="comment">//외계인 메서드를 동기화 블록 바깥으로 옮겼다.</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="CopyOnWriteArrayList"><a href="#CopyOnWriteArrayList" class="headerlink" title="CopyOnWriteArrayList"></a>CopyOnWriteArrayList</h1><p>외계인 메서드 호출을 동기화 블록 바깥으로 옮기는 것 보다 더 나은 방법은 java.util.concurrent 패키지의 CopyOnWriteArrayList를 사용하는 것이 좋다.<br>내부를 변경하는 작업은 항상 깨끗한 복사본을 만들어 수행한다.<br>내부의 배열은 절대 수정되지 않아 락이 없어 빠르다.<br>다른 용도로 쓰인다면 매번 복사해서 느리겠지만, 수정할 일은 드물고 순회만 빈번히 일어나는 Observer 리스트 용으로는 딱이다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">final</span> List&lt;SetObserser&lt;E&gt;&gt; observers = <span class="keyword">new</span> <span class="title class_">CopyOnWriteArrayList</span>&lt;&gt;();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">addObserver</span><span class="params">(SetObserver&lt;E&gt; observer)</span> &#123;</span><br><span class="line">    observers.add(observer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">removeObserver</span><span class="params">(SetObserver&lt;E&gt; observer)</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> observers.remove(observer);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">notifyElementAdded</span><span class="params">(E element)</span> &#123;</span><br><span class="line">    <span class="keyword">for</span> (SetObserver&lt;E&gt; observer : observers) &#123;</span><br><span class="line">         observers.added(<span class="built_in">this</span>, element);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="동기화의-성능"><a href="#동기화의-성능" class="headerlink" title="동기화의 성능"></a>동기화의 성능</h1><p>자바의 동기화 비용은 빠르게 낮아져 왔지만, 과도한 동기화를 피하는일은 오히려 과거 어느 때보다 중요하다.<br>멀티코어가 일반화된 오늘날 과도한 동기화가 초래하는 진짜 비용은 락을 얻는데 드는 CPU 시간이 아니다.<br>서로 스레드끼리 경쟁하는 Race Condition에 낭비가 발생한다.  </p>
<ul>
<li>병렬로 실행할 기회를 잃는다.</li>
<li>모든 코어가 메모리를 일관되게 보기위한 지연시간이 진짜 비용</li>
<li>가상머신의 코드최적화를 제한하는 점도 숨은 비용</li>
</ul>
<h2 id="가변-클래스를-작성하는-경우-동기화에-대해-고려할-점"><a href="#가변-클래스를-작성하는-경우-동기화에-대해-고려할-점" class="headerlink" title="가변 클래스를 작성하는 경우 동기화에 대해 고려할 점"></a>가변 클래스를 작성하는 경우 동기화에 대해 고려할 점</h2><ol>
<li>동기화를 전혀 하지 말고 가변 클래스를 동시에 사용해야하는 클래스가 외부에서 동기화하자</li>
<li>동기화를 내부에서 수행해 스레드 안전한 클래스로 만들자.<br>(단 클라이언트가 외부에서 객체 전체에 락을 거는 것보다 동시성을 월등히 개선할 수 있을 때만 두번째 방법을 쓴다)</li>
</ol>
<h1 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h1><ul>
<li>기본 규칙은 동기화 영역에서 가능한 한 일을 적게하는 것이다.<br>(락을 얻고 공유 데이터를 검사하고, 필요하면 수정하고, 락을 놓는다.)</li>
<li>오래 걸리는 작업이라면 동기화 영역 밖으로 옮기는 방법을 찾아보자.</li>
<li>여러 스레드가 호출할 가능성이 있는 메서드가 정적 필드를 수정한다면 그 필드를 사용하기 전에 반드시 동기화 해야 한다.</li>
<li>교착상태와 데이터 훼손을 피하려면 동기화 영역 안에서 외계인 메서드를 절대 호출하지 말자</li>
<li>동기화 영역 안에서 작업은 최소한으로 줄이자</li>
<li>가변 클래스를 설계할 때는 스스로 동기화해야 할지 고민하자</li>
<li>지금은 과도한 동기화를 피하는게 제일 중요하다</li>
<li>합당한 이유가 있을때만 내부에서 동기화하고 동기화 여부를 문서에 남기자.<br>(웬만하면 외부에서 동기화를 하자)</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 79. 과도한 동기화는 피하라</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/03/11/effective-java-item78/">Item 78. 공유 중인 가변 데이터는 동기화해 사용하라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-11</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>싱글 스레드 기반의 프로그램에서는 하나의 스레드가 하나의 객체를 사용하면 되기 때문에 동기화에 대한 걱정을 하지 않아도 되지만,<br>멀티 스레드 기반의 환경에서는 여러개의 스레드가 하나의 객체를 공유해서 사용하는 경우가 있다.<br>하나의 객체를 공유하며 사용하는 경우 불변 객체에 대해서는 동기화를 걱정할 필요가 없지만,<br>스레드가 메서드를 실행하면서 변수의 데이터를 변경하는 경우 다른 스레드에서 동기화되지 않은 데이터를 읽을 수 있다.<br>이런 경우에는 프로그래머가 기대한 결과와는 다른 결과를 초래할 수 있기 때문에 주의해야 한다.</p>
<h1 id="동기화란"><a href="#동기화란" class="headerlink" title="동기화란?"></a>동기화란?</h1><p>동기화(Syncronized)란 멀티스레드 환경에서 하나의 메서드나 블록을 한번에 한 스레드씩 수행하도록 보장하는 것을 의미한다.  </p>
<h2 id="동기화의-특징"><a href="#동기화의-특징" class="headerlink" title="동기화의 특징"></a>동기화의 특징</h2><ul>
<li>한 객체가 일관된 상태를 가지고 생성되었을 때, 이 객체에 접근하는 메서드는 그 객체에 Lock을 건다.<br>(다른 스레드가 메서드를 실행할 때 실행되지 못하도록 Lock을 건다)</li>
<li>Lock을 건 메서드는 객체의 상태를 확인하거나 필요하면 수정한다.</li>
<li>즉 일관된 하나의 상태 -&gt; 다른 일관된 하나의 상태로 변화한다.</li>
<li>메서드 실행이 끝나면 Lock을 해제한다.</li>
<li>동기화를 제대로 사용하면 어떤 메서드도 이 객체의 상태가 일관되지 않은 순간을 볼 수 없다.</li>
<li><strong>동기화 없이는</strong> 한 스레드가 만든 변화를 다른 스레드에서 확인하지 못할 수 있다.<br>(동기화가 없다면, 너도나도 접근하는데 시점에 따라 일관된 상태가 아닐 수도 있기 때문)</li>
<li>언어 명세상 long과 double 외의 변수를 읽고 쓰는 동작은 원자적(atomic)이다.<br>(여러 스레드가 하나의 변수에 동기화 없이 접근해도 항상 어떤 스레드가 정상적으로 저장한 값을 온전히 읽어옴을 보장)</li>
<li>성능을 높이려면 원자적 데이터를 읽고 쓸 때는 동기화 하지 말아야겠다 <strong>(위험한 발상)</strong><br>(필드를 읽을 때 항상 <strong>수정이 완전히 반영된 값</strong> 을 얻지만, <strong>한 스레드가 저장한 값이 다른 스레드에도 보이는가?</strong> 는 보장하지 않음)</li>
</ul>
<h1 id="Java에서의-가변-데이터-동기화-방법"><a href="#Java에서의-가변-데이터-동기화-방법" class="headerlink" title="Java에서의 가변 데이터 동기화 방법"></a>Java에서의 가변 데이터 동기화 방법</h1><p>Java에서는 <strong>synchronized</strong> 키워드를 통해 동기화 처리를 할 수 있다.</p>
<ul>
<li>가변데이터를 수정하거나 읽는 메서드를 동기화</li>
<li>가변 객체에 대한 동기화</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">countup</span><span class="params">()</span> &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">synchronized</span>(list) &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="한-스레드가-저장한-값이-다른-스레드에도-보이는가"><a href="#한-스레드가-저장한-값이-다른-스레드에도-보이는가" class="headerlink" title="한 스레드가 저장한 값이 다른 스레드에도 보이는가?"></a>한 스레드가 저장한 값이 다른 스레드에도 보이는가?</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StopThread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> stopRequested;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">backgroundThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>(!stopRequested) &#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        backgroundThread.start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        stopRequested = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>위의 코드는 대충 보면 1초뒤에 <code>stopRequested</code> 필드가 false로 바뀌면서 스레드 내의 while문이 종료될 것 처럼 보인다.</li>
<li>하지만 무한루프!!!</li>
<li>원인은 동기화에 있다.</li>
<li>동기화하지 않으면 메인 스레드에서 수정한 <code>stopRequested</code> 필드가 언제 false로 보일지 모른다.<br>(맨 마지막에 stopRequested가 false가 되면서 실제 원잣값은 false가 된다)</li>
<li>위의 문제를 해결하기 위해서는 <code>stopRequested</code> 필드에 대한 동기화 처리가 필요하다</li>
</ul>
<h2 id="동기화가-빠지는-경우-JVM에서-최적화를-수행할-수도-있다"><a href="#동기화가-빠지는-경우-JVM에서-최적화를-수행할-수도-있다" class="headerlink" title="동기화가 빠지는 경우 JVM에서 최적화를 수행할 수도 있다."></a>동기화가 빠지는 경우 JVM에서 최적화를 수행할 수도 있다.</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//원래 코드</span></span><br><span class="line"><span class="keyword">while</span>(!stopRequested) &#123;</span><br><span class="line">    i++;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 최적화한 코드</span></span><br><span class="line"><span class="keyword">if</span>(!stopRequested) &#123;</span><br><span class="line">    <span class="keyword">while</span>(<span class="literal">true</span>) &#123;</span><br><span class="line">        i++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>JVM의 호이스팅 기법을 통해 최적화 할 수 있다.</li>
<li>이 결과 프로그램은 응답 불가 상태가 되어 더 이상 진전이 없다.</li>
</ul>
<h1 id="위의-코드를-동기화-해보자"><a href="#위의-코드를-동기화-해보자" class="headerlink" title="위의 코드를 동기화 해보자"></a>위의 코드를 동기화 해보자</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StopThread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="type">boolean</span> stopRequested;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="keyword">void</span> <span class="title function_">requestStop</span><span class="params">()</span> &#123;</span><br><span class="line">        stopRequested = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="type">boolean</span> <span class="title function_">stopRequested</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> stopRequested;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">backgroundThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>(!stopRequested()) &#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        backgroundThread.start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        stopRequested();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>위와 같이 <strong>stopRequested</strong> 필드의 읽기&#x2F;쓰기에 대한 동기화처리를 하면 위의 프로그램이 1초뒤에 종료된다.</li>
<li>읽기&#x2F;쓰기 메서드 모두 동기화 처리를 하였음에 주목하자</li>
<li>쓰기 메서드만 동기화처리를 하고 읽기 메서드에는 동기화처리를 하지 않으면 동작을 보장할 수 없다.</li>
</ul>
<h1 id="volatile-키워드"><a href="#volatile-키워드" class="headerlink" title="volatile 키워드"></a>volatile 키워드</h1><p>volatile 키워드의 의미는 <code>volatile 변수를 읽어 들일 때 CPU 캐시가 아니라 컴퓨터의 메인 메모리로 부터 읽어들인다.</code><br>즉 read 할 때도 CPU 캐시가 아닌 메인메모리에서 read하고, write할 때도 메인 메모리에 write를 수행 </p>
<p><img src="./java-volatile.png" alt="java-volatile"></p>
<p>long, double을 제외한 기본타입은 <strong>volitile</strong> 키워드를 사용하면 동기화를 생략해도 된다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">StopThread</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">boolean</span> stopRequested;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> InterruptedException &#123;</span><br><span class="line"></span><br><span class="line">        <span class="type">Thread</span> <span class="variable">backgroundThread</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Thread</span>(() -&gt; &#123;</span><br><span class="line">            <span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">            <span class="keyword">while</span>(!stopRequested) &#123;</span><br><span class="line">                i++;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;);</span><br><span class="line"></span><br><span class="line">        backgroundThread.start();</span><br><span class="line"></span><br><span class="line">        TimeUnit.SECONDS.sleep(<span class="number">1</span>);</span><br><span class="line">        stopRequested = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>volitile 예약어는 배타적 수행(한 블록을 한 스레드가 실행) 하는것과는 관계없다</li>
<li>volatile 변수는 CPU캐시에서 값을 읽는게 아닌 메인 메모리에서 읽기 때문에 항상 최근에 기록된 값을 읽는다.<br>(그렇기 때문에 위의 프로그램이 1초 뒤에 종료됨)</li>
</ul>
<h1 id="volatile-사용-시-주의할-점"><a href="#volatile-사용-시-주의할-점" class="headerlink" title="volatile 사용 시 주의할 점"></a>volatile 사용 시 주의할 점</h1><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">nextSerialNumber</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">int</span> <span class="title function_">generateSerialNumber</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nextSerialNumber++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>이 메서드는 호출 될 때 마다 1씩 증가하여 스레드에서 고유한 값을 반환할 의도로 만들어 졌다.</li>
<li>겉보기에는 int이기 때문에 원자적으로 접근할 수 있을 것 같다</li>
<li>Volatile 키워드가 쓰여져있기 때문에 최신 값을 읽을 수 있을 것 같지만 제대로 된 고유한 값이 나오지 않는다.</li>
</ul>
<h2 id="원인은-nextSerialNumber"><a href="#원인은-nextSerialNumber" class="headerlink" title="원인은 nextSerialNumber++"></a>원인은 nextSerialNumber++</h2><p>원인은 nextSerialNumber++에 있었다.<br>실제 이 코드는 1줄이지만 풀어쓰면 nextSerialNumber &#x3D; nextSerialNumber + 1; 와 같은 형태이다.<br>결국 nextSerialNumber 값을 한번 읽어와 +1 한다음에 다시 nextSerialNumber 변수에 저장하는 형태이다.<br>만약 두번째 스레드가 nextSerialNumber + 1 연산이 이루어지는 시점을 비집고 들어온다면 1이 두번 리턴되는 형국이다.<br>이런 오류를 <strong>안전 실패(safety failure)</strong> 이라고 한다.</p>
<h2 id="문제-해결은-synchronized"><a href="#문제-해결은-synchronized" class="headerlink" title="문제 해결은 synchronized"></a>문제 해결은 synchronized</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">int</span> <span class="variable">nextSerialNumber</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">synchronized</span> <span class="type">int</span> <span class="title function_">generateSerialNumber</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nextSerialNumber++;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>위와 같이 generateSerialNumber 메서드에 synchronized만 붙여주면 문제는 해결된다.<br>동시에 호출해도 배타적으로 실행 (한번에 한 스레드만 실행) 되기 때문이다.<br>만약 위 처럼 generateSerialNumber 메서드에 synchronized를 붙였다면 nextSerialNumber 변수에는 volatile을 제거해야 한다.<br>만약 메서드를 더 견고하게 하려면 int 대신 long을 사용하는게 더 많은 수를 사용할 수 있다.</p>
<h1 id="long-double을-사용할-때는-더욱-더-주의하자"><a href="#long-double을-사용할-때는-더욱-더-주의하자" class="headerlink" title="long, double을 사용할 때는 더욱 더 주의하자"></a>long, double을 사용할 때는 더욱 더 주의하자</h1><ul>
<li>Java.util.concurrent.atomic 패키지의 AtomicLong, AtomicDouble을 사용하는 것이 좋다.  </li>
<li>이 패키지는 락 없이도(lock-free) 스레드 안전한 프로그래밍을 지원하는 클래스들이 담겨 있다.</li>
<li>volatile은 동기화 속성 중 통신에 대해서만 보장</li>
<li>Java.util.concurrent.atomic 패키지는 원자성(배타적 실행) 까지 지원한다.</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">AtomicLong</span> <span class="variable">nextSerialNum</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AtomicLong</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="type">long</span> <span class="title function_">generateSerialNumber</span><span class="params">()</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> nextSerialNum.getAndIncrement();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h1><ul>
<li>동기화에 대한 문제를 피하는 가장 좋은 방법은 가변 데이터를 공유하지 않는 것이다.</li>
<li>가변데이터는 단일 스레드에서만 사용하는 것이 좋다</li>
<li>가변데이터를 단일 스레드에서만 사용한다면 문서에 남겨 유지보수 정책에서도 지켜지는것이 중요하다</li>
<li>멀티 스레드 환경에서 한 스레드가 데이터를 수정한 후에 다른 스레드에 공유할 때는 해당 객체에서 공유하는 부분만 동기화해도 된다.</li>
<li>클래스 초기화 과정에서 객체를 정적필드, volatile필드, final 필드, 혹은 보통의 락을 통해 접근하는 필드에 저장해도 된다.</li>
<li>여러 스레드가 가변 데이터를 공유한다면 그 데이터를 읽고 쓰는 메서드 모두에 반드시 synchronized 키워드를 붙인다.</li>
<li>배타적 실행 (한번에 한스레드) 동작이 필요없고, 스레드 간 최신데이터만 읽는 거로도 충분하면 가변 변수에 volatile 키워드만으로도 동기화가 가능하다</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 78. 공유 중인 가변 데이터는 동기화해 사용하라</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/03/10/effective-java-item74/">Item 74. 메서드가 던지는 모든 예외를 문서화하라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-10</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>메서드가 던지는 예외는 그 메서드를 올바로 사용하는 데 아주 중요한 정보다.<br>따라서 각 메서드가 던지는 예외 하나하나를 문서화하는 데 충분한 시간을 쏟아야 한다.  </p>
<h1 id="검사-예외는-throws-태그로-문서화하라"><a href="#검사-예외는-throws-태그로-문서화하라" class="headerlink" title="검사 예외는 @throws 태그로 문서화하라"></a>검사 예외는 @throws 태그로 문서화하라</h1><p>검사 예외(Checked Exception)는 항상 따로따로 선언하고, 각 예외가 발생하는 상황을 자바독의 @throws 태그를 사용하여 정확히 문서화하자.<br>공통 상위 예외 클래스 하나로 뭉뚱그려 선언하는 일은 삼가야 한다.<br>극단적인 예로 Exception이나 Throwable을 던진다고 선언해서는 안된다.<br>메서드 사용자에게 각 예외에 대처할 수 있는 힌트를 주지 못할뿐더러 같은 맥락에서 발생할 여지가 있는 다른 예외들 까지 삼켜버릴 수 있기 때문에 API 사용성을 크게 떨어뜨린다.</p>
<h2 id="잘못된-방법"><a href="#잘못된-방법" class="headerlink" title="잘못된 방법"></a>잘못된 방법</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">()</span> <span class="keyword">throws</span> Exception &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>같은 맥락에서 발생할 수 있는 다른 예외들까지 삼켜버려 API 사용성이 떨어진다.</li>
<li>main메서드는 JVM만이 호출하므로 Exception을 던지도록 선언해도 괜찮다.</li>
</ul>
<h2 id="권장하는-방법"><a href="#권장하는-방법" class="headerlink" title="권장하는 방법"></a>권장하는 방법</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> IllegalStateException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> SQLException</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@throws</span> NumberFormatException - params가 숫자형 데이터가 아닌경우 throw</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">method</span><span class="params">(String params)</span> <span class="keyword">throws</span> IllegalStateException, SQLException, NumberFormatException &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="비검사-예외-Runtime-Exception-도-문서로-남기면-좋다"><a href="#비검사-예외-Runtime-Exception-도-문서로-남기면-좋다" class="headerlink" title="비검사 예외(Runtime Exception)도 문서로 남기면 좋다."></a>비검사 예외(Runtime Exception)도 문서로 남기면 좋다.</h1><p>자바 언어에서 요구하는 것은 아니지만 비검사 예외(Runtime Exception)도 검사 예외(Checked Exception) 처럼 정성껏 문서화 해두면 좋다.<br>비검사 예외(Runtime Exception)는 일반적으로 프로그래밍 오류를 뜻하는데 자신이 일으킬 수 있는 오류들이 무엇인지 알려주면<br>프로그래머는 자연스럽게 해당 오류가 나지 않도록 코딩하게 된다.<br>잘 정비된 비검사 예외 문서는 그 메서드를 성공적으로 수행하기 위한 전제조건이 된다.</p>
<p>public 메서드라면 필요한 전제조건을 문서화해야 하며, 그 수단으로 가장 좋은 것이 비검사 예외들을 문서화 하는것이다.<br><strong>특히 인터페이스에서 중요하다.</strong><br>이 조건이 인터페이스의 일반 규약에 속하게 되어 인터페이스를 구현한 모든 구현체가 일관되게 동작하도록 해주기 때문이다.  </p>
<h1 id="비검사-예외-Runtime-Exception-은-메서드-시그니처에-추가하지-말자"><a href="#비검사-예외-Runtime-Exception-은-메서드-시그니처에-추가하지-말자" class="headerlink" title="비검사 예외(Runtime Exception)은 메서드 시그니처에 추가하지 말자"></a>비검사 예외(Runtime Exception)은 메서드 시그니처에 추가하지 말자</h1><p>메서드가 던질 수 있는 예외를 각각 @throws 태그로 문서화하되, 비검사 예외는 메서드 선언의 throws 목록에 넣지 말자.<br>검사냐 비검사냐에 따라 사용자가 해야할 일이 달라지므로 이 둘을 확실히 구분하는게 좋다.<br>자바독은 메서드 시그니처에 throws 절에 등장하고 메서드 주석의 @throws 태그에도 명시한 예외와 @throws 태그에만 명시한 예외를 시각적으로 구분해준다.<br>그래서 프로그래머는 어떤 것이 비검사 예외인지 바로 알 수 있다.</p>
<h1 id="거의-모든-메서드에서-같은-예외를-던진다면-Class-설명에-추가하라"><a href="#거의-모든-메서드에서-같은-예외를-던진다면-Class-설명에-추가하라" class="headerlink" title="거의 모든 메서드에서 같은 예외를 던진다면 Class 설명에 추가하라"></a>거의 모든 메서드에서 같은 예외를 던진다면 Class 설명에 추가하라</h1><p>한 클래스에 정의된 웬만한 메서드에서 같은 이유로 같은 예외를 던진다면 그 예외를 각각의 메서드가 아니라 클래스 설명에 추가하는 방법도 있다.<br>NullPointerException이 가장 흔한 사례다.<br>이럴 때는 클래스의 문서화 주석에 <strong>이 클래스의 모든 메서드는 인수로 null이 넘어오면 NullPointerException을 던진다.</strong> 라고 적어도 좋다.</p>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 74. 메서드가 던지는 모든 예외를 문서화하라</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/03/10/effective-java-item73/">Item 73. 추상화 수준에 맞는 예외를 던지라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-10</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>수행하려는 일과 관련 없어 보이는 예외가 튀어나오면 당황스럽다.<br>메서드가 저수준 예외를 처리하지 않고 바깥으로 throw 해버릴 때 상위 메서드에서 종종 발생하는 일이다.<br>내부 구현방식을 상위에 드러내어 윗 레벨 API를 오염 시킬 수 있고, 다음 릴리스에서 구현방식이 변경되면 다른 예외가 튀어나와<br>기존 클라이언트 프로그램을 깨지게 할 수도 있다.</p>
<h1 id="상위-메서드에서-저수준-예외를-번역해야-한다"><a href="#상위-메서드에서-저수준-예외를-번역해야-한다" class="headerlink" title="상위 메서드에서 저수준 예외를 번역해야 한다."></a>상위 메서드에서 저수준 예외를 번역해야 한다.</h1><p>상위 메서드에서는 저수준 예외를 잡아 자신의 추상화 수준에 맞는 예외로 바꿔 던져야 한다.<br>이를 예외 번역(Exception Translation)이라 한다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">	..<span class="comment">// 저수준 추상화를 이용</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (LowerLevelException e) &#123;</span><br><span class="line">  <span class="comment">// 추상화 수준에 맞게 번역</span></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HigherLevelException</span>(...);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="저수준-예외의-내용이-필요하다면-예외-연쇄를-사용하라"><a href="#저수준-예외의-내용이-필요하다면-예외-연쇄를-사용하라" class="headerlink" title="저수준 예외의 내용이 필요하다면 예외 연쇄를 사용하라"></a>저수준 예외의 내용이 필요하다면 예외 연쇄를 사용하라</h1><p>예외 연쇄(Exception chaining)이란 문제의 근본 원인(cause)인 저수준 예외를 고수준 예외에 실어 보내는 방식이다.<br>별도의 접근자 메서드(Throwable의 getCause메서드)를 통해 필요하면 언제든 저수준 예외를 꺼내 볼 수 있다.</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  <span class="comment">// 저수준 추상화를 이용한다.</span></span><br><span class="line">&#125; <span class="keyword">catch</span> (LowerLevelException cause) &#123;</span><br><span class="line">  <span class="comment">// 저수준 예외를 고수준 예외에 실어 보낸다.</span></span><br><span class="line">  <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">HigherLevelException</span>(cause);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">HigherLevelException</span> <span class="keyword">extends</span> <span class="title class_">Exception</span> &#123;</span><br><span class="line">  HigherLevelException(Throwable cause) &#123;</span><br><span class="line">    <span class="built_in">super</span>(cause);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>대부분의 표준 예외는 예외 연쇄용 생성자를 갖추고 있다.<br>그렇지 않은 예외라도 Throwable의 initCause 메서드를 이용해 <code>원인</code> 을 직접 못박을 수 있다.<br>예외 연쇄는 문제의 원인을 프로그램에서 접근할 수 있게 해주며 원인과 고수준 예외의 Stack trace를 잘 통합해준다.</p>
<h1 id="예외-번역을-남용하지-말자"><a href="#예외-번역을-남용하지-말자" class="headerlink" title="예외 번역을 남용하지 말자"></a>예외 번역을 남용하지 말자</h1><p>가능하다면 저수준 메서드가 반드시 성공하도록 하여 아래 계층에서는 예외가 발생하지 않도록 하는 것이 최선이다.<br>때로는 상위 계층 메서드의 매개변수 값을 아래 계층 메서드로 건네기 전에 Validator를 이용하여 미리 검사하는 것이 좋다. </p>
<p>아래 계층에서의 예외를 피할 수 없다면, 상위 계층에서 그 예외를 조용히 처리하여 문제를 API 호출자에 전파하지 않는 방법이 있다.<br>이 경우 발생한 예외는 log를 활용하여 개발자가 디버깅을 할 수 있는 정도면 충분하다</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">  lowerLevelMethod();</span><br><span class="line">&#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">  <span class="comment">//Exception을 먹어버리고 상위로 전파되지 않도록 한다.</span></span><br><span class="line">  log.error(e.getMessage());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="정리"><a href="#정리" class="headerlink" title="정리"></a>정리</h1><ul>
<li>아래 계층의 예외를 예방하거나 스스로 처리할 수 없고, 그 예외를 상위 계층에 그대로 노출하기 곤란하다면 예외 번역을 사용하라</li>
<li>예외 연쇄를 이용하면 상위 계층에는 맥락에 어울리는 고수준 예외를 던지면서 근본 원인도 함께 알려주어 오류를 분석하기에  좋다.</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 73. 추상화 수준에 맞는 예외를 던지라</li>
</ul>
</div><hr></div><div class="recent-post-item article-container"><a class="article-title" href="../../2019/03/10/effective-java-item72/">Item 72. 표준 예외를 사용하라</a><time class="post-meta__date"><i class="fa fa-calendar" aria-hidden="true"></i> 2019-03-10</time><span class="article-meta tags"><span class="article-meta__separator">|</span><i class="fa fa-tag article-meta__icon" aria-hidden="true"></i><a class="article-meta__tags" href="../../tags/Effective-Java/">Effective-Java</a></span><div class="content"><h1 id="서론"><a href="#서론" class="headerlink" title="서론"></a>서론</h1><p>숙련된 프로그래머는 그렇지 못한 프로그래머보다 더 많은 코드를 재사용한다.<br>예외도 마찬가지로 재사용하는 것이 좋으며, 자바 라이브러리는 대부분 API에서 쓰기에 충분한 수의 예외를 제공한다.</p>
<h1 id="표준-예외를-재사용하라"><a href="#표준-예외를-재사용하라" class="headerlink" title="표준 예외를 재사용하라"></a>표준 예외를 재사용하라</h1><ul>
<li>표준 예외를 사용하면 다른사람이 API를 익히고 사용하기 쉬워진다 (많은 개발자들이 이미 익숙하게 사용하기 때문)</li>
<li>표준 예외를 사용한 API는 다른 개발자가 API를 사용하더라도 낯선 예외를 사용하지 않아 코드의 가독성이 높아진다.</li>
<li>예외 클래스 수가 적을수록 메모리 사용량도 줄고 클래스를 로딩하는 시간도 적게 걸린다.<br>(무분별하게 커스텀 예외 클래스를 만들면 빌드하는 시간도 오래 걸리고 클래스 로딩 시간도 더 걸린다는 소리)</li>
</ul>
<h1 id="가장-많이-사용되는-예외"><a href="#가장-많이-사용되는-예외" class="headerlink" title="가장 많이 사용되는 예외"></a>가장 많이 사용되는 예외</h1><h2 id="IllegalArgumentException"><a href="#IllegalArgumentException" class="headerlink" title="IllegalArgumentException"></a>IllegalArgumentException</h2><ul>
<li>호출자가 인수로 부적절한 값을 넘길 때 던지는 예외</li>
<li>반복 횟수 (loop count)를 지정하는 매개변수에 음수를 건넬 때 쓸 수 있다.</li>
<li>메서드의 파라미터로 <code>null 값</code>이 들어오면 관례상 IllegalArgumentException보다는 <code>NullPointerException</code>을 던진다.</li>
<li>시퀀스의 허용 범위를 넘는 값을 건넬 때도 IllegalArgumentException보다는 <code>IndexOutOfBoundsException</code>을 던진다.</li>
</ul>
<h2 id="IllegalStateException"><a href="#IllegalStateException" class="headerlink" title="IllegalStateException"></a>IllegalStateException</h2><ul>
<li>대상 객체의 상태가 호출된 메서드를 수행하기에 적합하지 않을 때 주로 던진다.</li>
<li>예를 들면, 초기화되지 않은 객체를 사용하려 할 때 던질 수 있다.</li>
</ul>
<h2 id="ConcurrentModificationException"><a href="#ConcurrentModificationException" class="headerlink" title="ConcurrentModificationException"></a>ConcurrentModificationException</h2><ul>
<li>단일 스레드에서 사용하려고 설계한 객체를 여러 스레드가 동시에 수정하려 할 때 던진다.<br>(외부 동기화 방식으로 사용하려고 설계한 객체도 마찬가지다.)</li>
<li>동시 수정을 확실히 검출할 수 있는 안정된 방법은 없으나, 문제가 생길 가능성 정도만 알려주는 역할도 쓰인다.</li>
</ul>
<h2 id="UnsupportedOperationException"><a href="#UnsupportedOperationException" class="headerlink" title="UnsupportedOperationException"></a>UnsupportedOperationException</h2><ul>
<li>예외는 클라이언트가 요청한 동작을 대상 객체가 지원하지 않을 때 던진다.</li>
<li>보통 구현하려는 인터페이스의 메서드 일부를 구현할 수 없는 경우에 사용</li>
</ul>
<h2 id="ArithmeticException-NumberFormatException"><a href="#ArithmeticException-NumberFormatException" class="headerlink" title="ArithmeticException, NumberFormatException"></a>ArithmeticException, NumberFormatException</h2><ul>
<li>복소수나 유리수를 다루는 객체를 사용할 때 사용</li>
<li>10 &#x2F; 0 과 같은 연산을 할 때 ArithmeticException이 발생한다. </li>
<li>숫자형 파라미터가 와야 하는 부분에 String이라든지 다른 형식의 데이터가 들어오는 경우 NumberFormatException이 발생</li>
</ul>
<h1 id="예외-사용-시-주의할-점"><a href="#예외-사용-시-주의할-점" class="headerlink" title="예외 사용 시 주의할 점"></a>예외 사용 시 주의할 점</h1><ul>
<li>Exception, RuntimeException, Throwable, Error는 직접 재사용하지 말자.<br>(다른 예외들의 상위 클래스이기 때문에 안정적으로 테스트 할 수 없다.)</li>
<li>예외에서 더 많은 정보를 제공하길 원한다면 표준 예외를 확장해도 좋다.<br>(단 예외는 직렬화할 수 있기 때문에 주의해야 한다.)</li>
</ul>
<h1 id="참고"><a href="#참고" class="headerlink" title="참고"></a>참고</h1><ul>
<li>Effective Java 3rd Edition - Item 72. 표준 예외를 사용하라</li>
</ul>
</div><hr></div><nav id="pagination"><div class="pagination"><a class="extend prev" rel="prev" href="../2/"><i class="fa fa-chevron-left"></i></a><a class="page-number" href="../../">1</a><a class="page-number" href="../2/">2</a><span class="page-number current">3</span><a class="page-number" href="../4/">4</a><span class="space">&hellip;</span><a class="page-number" href="../12/">12</a><a class="extend next" rel="next" href="../4/"><i class="fa fa-chevron-right"></i></a></div></nav></div></div><footer><div class="layout" id="footer"><div class="copyright">&copy;2018 - 2022 By Carrey</div><div class="framework-info"><span>Driven - </span><a target="_blank" rel="noopener" href="http://hexo.io"><span>Hexo</span></a><span class="footer-separator">|</span><span>Theme - </span><a target="_blank" rel="noopener" href="https://github.com/Molunerfinn/hexo-theme-melody"><span>Melody</span></a></div><div class="busuanzi"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><span id="busuanzi_container_site_uv"><i class="fa fa-user"></i><span id="busuanzi_value_site_uv"></span><span></span></span><span class="footer-separator">|</span><span id="busuanzi_container_site_pv"><i class="fa fa-eye"></i><span id="busuanzi_value_site_pv"></span><span></span></span></div></div></footer><i class="fa fa-arrow-up" id="go-up" aria-hidden="true"></i><script src="https://cdn.jsdelivr.net/npm/animejs@latest/anime.min.js"></script><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@latest/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-ui-pack@latest/velocity.ui.min.js"></script><script src="../../js/utils.js?version=1.9.0"></script><script src="../../js/fancybox.js?version=1.9.0"></script><script src="../../js/sidebar.js?version=1.9.0"></script><script src="../../js/copy.js?version=1.9.0"></script><script src="../../js/fireworks.js?version=1.9.0"></script><script src="../../js/transition.js?version=1.9.0"></script><script src="../../js/scroll.js?version=1.9.0"></script><script src="../../js/head.js?version=1.9.0"></script><script>if(/Android|webOS|iPhone|iPod|iPad|BlackBerry/i.test(navigator.userAgent)) {
  $('#nav').addClass('is-mobile')
  $('footer').addClass('is-mobile')
  $('#top-container').addClass('is-mobile')
}</script></body></html>